<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç½æ°‘è£œåŠ©ç”³è«‹ - ç·šä¸Šç”³è«‹ç³»çµ±</title>
    <link rel="stylesheet" href="static/styles/applicant.css" />
  </head>

  <body>
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginOnlyScreen">
      <header class="page-header">
        <h1>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</h1>
        <nav class="header-nav">
          <a href="/">è¿”å›é¦–é </a>
        </nav>
      </header>

      <main class="main-content">
        <h2 class="page-title">ç™»å…¥å¾Œç¹¼çºŒ</h2>

        <div class="login-container">
          <div class="login-tabs">
            <div class="login-tab" data-tab="general">
              <span class="icon-spacer">ğŸ“§</span>ä¸€èˆ¬ç™»å…¥
            </div>
            <div class="login-tab active" data-tab="digital">
              ğŸ“± æ•¸ä½èº«åˆ†è­‰æ†‘è­‰ç™»å…¥ (æ¨è–¦)
            </div>
          </div>

          <div id="general-login-form" class="login-form">
            <div class="form-group">
              <label for="email">é›»å­ä¿¡ç®±</label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="è¼¸å…¥ä¿¡ç®±å¸³è™Ÿ"
                required
              />
            </div>

            <div class="form-group">
              <div class="flex-center-gap">
                <label for="password" class="no-margin-bottom">é©—è­‰ç¢¼</label>
                <small class="hint-text"> é©—è­‰ç¢¼å°‡ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®± </small>
              </div>
              <div class="input-with-button">
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="è¼¸å…¥é©—è­‰ç¢¼"
                  required
                />
                <button type="button" class="verification-send-btn">
                  ç™¼é€é©—è­‰ç¢¼
                </button>
              </div>
            </div>

            <div class="verification-container">
              <div class="verification-code">10541</div>
              <button type="button" class="refresh-captcha">
                <img
                  src="static/assets/refresh.png"
                  alt="æ›´æ–°é©—è­‰ç¢¼"
                  width="24"
                  height="24"
                />
              </button>
              <input
                type="text"
                class="verification-input"
                placeholder="è«‹è¼¸å…¥å·¦æ–¹åœ–ç‰‡ä¸­çš„æ–‡å­—"
                required
              />
            </div>

            <button type="submit" class="login-btn">ç™»å…¥</button>

            <div class="divider">
              <div class="divider-line"></div>
              <span class="divider-text">æˆ–</span>
              <div class="divider-line"></div>
            </div>

            <button type="button" class="google-btn">ä½¿ç”¨Googleç¹¼çºŒç™»å…¥</button>
          </div>

          <div id="digital-login-form" class="login-form hidden">
            <div class="digital-header">
              <div class="digital-title">æ•¸ä½æ†‘è­‰çš®å¤¾APP</div>
              <div class="digital-subtitle">æ•¸ä½èº«åˆ†æ†‘è­‰ç™»å…¥æ–¹å¼</div>
            </div>

            <div class="qr-code-container">
              <div class="qr-code-inner">
                <img
                  src=""
                  alt="QR Code"
                  width="188"
                  height="188"
                  role="img"
                  aria-label="æ•¸ä½æ†‘è­‰ QR ç¢¼"
                />
                <div class="qr-code-timer">
                  <span class="timer-text">è«‹æ–¼ </span>
                  <span class="countdown-time">5:00</span>
                  <span class="timer-text"> å…§å®Œæˆæƒæ</span>
                </div>
              </div>
            </div>

            <p class="qr-hint">ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼ç™»å…¥</p>

            <div class="divider">
              <div class="divider-line"></div>
            </div>

            <a
              href="https://moda.gov.tw/major-policies/wallet/1695"
              target="_blank"
              class="link-text"
              >é—œæ–¼æ•¸ä½èº«åˆ†è­‰æ†‘è­‰èªªæ˜</a
            >

            <p class="register-text">
              å°šæœªåŠ å…¥æœƒå“¡? <a href="/register">é¦¬ä¸Šè¨»å†Š</a>
            </p>
          </div>
        </div>
      </main>
    </div>

    <!-- ç™»å…¥æˆåŠŸä¸»é¸å–® -->
    <div class="success-screen" id="mainMenu">
      <header class="page-header">
        <h1>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</h1>
        <nav class="header-nav">
          <a href="#" onclick="logout(); return false;">ç™»å‡º</a>
        </nav>
      </header>

      <div class="success-content">
        <div class="success-form">
          <div class="success-title">æˆåŠŸç™»å…¥</div>
          <div class="success-icon-container">
            <svg
              width="48"
              height="48"
              viewBox="0 0 48 48"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M20 32L10 22L12.8 19.2L20 26.4L35.2 11.2L38 14L20 32Z"
                fill="#0F172A"
              />
            </svg>
          </div>
          <div class="success-subtitle">æ‚¨å·²ç™»å…¥</div>
          <div class="success-email" id="successEmailDisplay">
            user@example.com
          </div>
        </div>
      </div>

      <div class="success-buttons">
        <button class="success-button secondary" onclick="showMyApplications()">
          æŸ¥è©¢ç”³è«‹æ­·å²ç´€éŒ„
        </button>
        <button class="success-button primary" onclick="showApplyForm()">
          å‰å¾€è£œåŠ©ç”³è«‹
        </button>
      </div>
    </div>

    <!-- ç”³è«‹æ­·å²è¨˜éŒ„ç•«é¢ -->
    <div class="history-screen" id="myApplicationsScreen">
      <header class="page-header">
        <h1>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</h1>
        <nav class="header-nav">
          <a href="#" onclick="backToMainMenu(); return false;">è¿”å›</a>
        </nav>
      </header>

      <main class="history-container" role="main">
        <h2 class="history-title">ç”³è«‹è¨˜éŒ„</h2>

        <div class="records" id="applicationsList">
          <!-- å‹•æ…‹è¼‰å…¥çš„ç”³è«‹è¨˜éŒ„ -->
        </div>

        <div class="history-actions">
          <button class="success-button secondary" onclick="backToMainMenu()">
            è¿”å›
          </button>
          <button class="success-button primary" onclick="showApplyForm()">
            å‰å¾€è£œåŠ©ç”³è«‹
          </button>
        </div>
      </main>
    </div>

    <!-- ç”³è«‹è¡¨å–®ç•«é¢ -->
    <div id="applyForm" class="hidden">
      <header class="page-header">
        <h1>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</h1>
        <nav class="header-nav">
          <a href="#" onclick="backToMainMenu(); return false;">è¿”å›</a>
        </nav>
      </header>

      <div class="card form-card">
        <div class="steps">
          <div class="step" id="step1">1</div>
          <div class="step" id="step2">2</div>
          <div class="step" id="step3">3</div>
          <div class="step" id="step4">4</div>
          <div class="step" id="step5">5</div>
        </div>

        <!-- æ­¥é©Ÿ1ï¼šåŸºæœ¬è³‡æ–™ -->
        <div id="form-step1">
          <h2 class="section-title">åŸºæœ¬è³‡æ–™</h2>

          <div class="form-group">
            <label>å§“å <span class="required">*</span></label>
            <input type="text" id="appName" />
          </div>

          <div class="form-group">
            <label>èº«åˆ†è­‰å­—è™Ÿ <span class="required">*</span></label>
            <input type="text" id="appIdNumber" />
          </div>

          <div class="form-group">
            <label>æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></label>
            <input type="tel" id="appPhone" />
          </div>

          <div class="form-group">
            <label>è¯çµ¡åœ°å€</label>
            <input
              type="text"
              id="appAddress"
              placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€ï¼ˆé¸å¡«ï¼‰"
            />
            <div class="helper-text">å¦‚èˆ‡ç½æåœ°é»ä¸åŒï¼Œè«‹å¡«å¯«</div>
          </div>

          <button class="btn btn-primary" onclick="nextStep(2)">
            ä¸‹ä¸€æ­¥ â†’
          </button>
          <button class="btn btn-secondary" onclick="backToMainMenu()">
            å–æ¶ˆ
          </button>
        </div>

        <!-- æ­¥é©Ÿ2ï¼šç½å®³è³‡è¨Š -->
        <div id="form-step2" class="hidden">
          <h2 class="section-title">ç½å®³è³‡è¨Š</h2>

          <div class="form-group">
            <label>ç½å®³ç™¼ç”Ÿæ—¥æœŸ <span class="required">*</span></label>
            <input type="date" id="appDate" />
          </div>

          <div class="form-group">
            <label>ç½å®³é¡å‹ <span class="required">*</span></label>
            <select id="appType">
              <option value="flood">æ°´ç½</option>
              <option value="typhoon">é¢±é¢¨</option>
              <option value="earthquake">åœ°éœ‡</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label>ç½æåœ°é» <span class="required">*</span></label>
            <input
              type="text"
              id="appDamageLocation"
              placeholder="ç½æç™¼ç”Ÿçš„å…·é«”åœ°é»"
            />
          </div>

          <div class="form-group">
            <label>ç½ææè¿° <span class="required">*</span></label>
            <textarea
              id="appDescription"
              rows="4"
              placeholder="è«‹è©³ç´°æè¿°ç½ææƒ…æ³ï¼Œä¾‹å¦‚ï¼šä¸€æ¨“æ·¹æ°´ç´„50å…¬åˆ†ï¼Œå®¶å…·é›»å™¨å—æ..."
            ></textarea>
            <div class="helper-text">è«‹ç›¡é‡è©³ç´°æè¿°ï¼Œæœ‰åŠ©æ–¼åŠ å¿«å¯©æ ¸é€Ÿåº¦</div>
          </div>

          <button class="btn btn-primary" onclick="nextStep(3)">
            ä¸‹ä¸€æ­¥ â†’
          </button>
          <button class="btn btn-secondary" onclick="prevStep(1)">
            â† ä¸Šä¸€æ­¥
          </button>
        </div>

        <!-- æ­¥é©Ÿ3ï¼šè£œåŠ©é‡‘é¡ -->
        <div id="form-step3" class="hidden">
          <h2 class="section-title">ç”³è«‹è£œåŠ©</h2>

          <div class="info-box">
            ğŸ’° è«‹æ ¹æ“šå¯¦éš›æå¤±å¡«å¯«ç”³è«‹é‡‘é¡ï¼Œå¯©æ ¸äººå“¡æœƒä¾æ“šç½ææƒ…æ³æ ¸å®š
          </div>

          <div class="form-group">
            <label>é ä¼°æå¤±é‡‘é¡ <span class="required">*</span></label>
            <input type="number" id="appEstimatedLoss" placeholder="50000" />
            <div class="helper-text">è«‹å¡«å¯«é ä¼°çš„ç¸½æå¤±é‡‘é¡ï¼ˆæ–°å°å¹£ï¼‰</div>
          </div>

          <div class="form-group">
            <label>ç”³è«‹è£œåŠ©é‡‘é¡ <span class="required">*</span></label>
            <input type="number" id="appAmount" placeholder="30000" />
            <div class="helper-text">æ‚¨å¸Œæœ›ç”³è«‹çš„è£œåŠ©é‡‘é¡</div>
          </div>

          <div class="form-group">
            <label>è£œåŠ©é¡å‹</label>
            <select id="appSubsidyType">
              <option value="housing">æˆ¿å±‹ä¿®ç¹•</option>
              <option value="furniture">å®¶å…·å®¶é›»</option>
              <option value="living">ç”Ÿæ´»è£œåŠ©</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>

          <button class="btn btn-primary" onclick="nextStep(4)">
            ä¸‹ä¸€æ­¥ â†’
          </button>
          <button class="btn btn-secondary" onclick="prevStep(2)">
            â† ä¸Šä¸€æ­¥
          </button>
        </div>

        <!-- æ­¥é©Ÿ4ï¼šä¸Šå‚³è­‰æ˜æ–‡ä»¶ -->
        <div id="form-step4" class="hidden">
          <h2 class="section-title">ä¸Šå‚³è­‰æ˜æ–‡ä»¶</h2>

          <div class="info-box">
            ğŸ“„ è«‹ä¸Šå‚³ç›¸é—œè­‰æ˜æ–‡ä»¶ï¼Œå¦‚æˆ¶ç±è¬„æœ¬ã€è²¡ç”¢è­‰æ˜ã€ç½æç…§ç‰‡ç­‰ï¼ˆé¸å¡«ï¼‰
          </div>

          <div class="form-group">
            <label>è­‰æ˜æ–‡ä»¶</label>
            <input
              type="file"
              id="appDocuments"
              multiple
              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
              onchange="handleDocumentSelect(event)"
            />
            <div class="helper-text">
              æ”¯æ´æ ¼å¼ï¼šPDF, JPG, PNG, DOC, DOCXï¼ˆæœ€å¤š5å€‹æª”æ¡ˆï¼Œæ¯å€‹æœ€å¤§10MBï¼‰
            </div>
          </div>

          <div id="documentPreview" class="document-preview">
            <!-- å·²é¸æ“‡çš„æ–‡ä»¶åˆ—è¡¨ -->
          </div>

          <button class="btn btn-primary" onclick="nextStep(5)">
            ä¸‹ä¸€æ­¥ â†’
          </button>
          <button class="btn btn-secondary" onclick="prevStep(3)">
            â† ä¸Šä¸€æ­¥
          </button>
        </div>

        <!-- æ­¥é©Ÿ5ï¼šç¢ºèªé€å‡º -->
        <div id="form-step5" class="hidden">
          <h2 class="section-title">ç¢ºèªè³‡æ–™</h2>

          <div class="info-box">ğŸ“‹ è«‹ç¢ºèªä»¥ä¸‹è³‡æ–™ç„¡èª¤å¾Œé€å‡ºç”³è«‹</div>

          <div id="confirmData" class="confirm-data-box">
            <!-- å°‡ç”± JS å¡«å…… -->
          </div>

          <div class="warning-box">
            âš ï¸ æé†’ï¼šè«‹ç¢ºä¿æ‰€å¡«è³‡æ–™çœŸå¯¦æ­£ç¢ºï¼Œè™›å ±æˆ–ä¸å¯¦ç”³å ±å°‡å½±éŸ¿æ‚¨çš„æ¬Šç›Š
          </div>

          <button class="btn btn-primary" onclick="submitApplication()">
            ç¢ºèªé€å‡ºç”³è«‹
          </button>
          <button class="btn btn-secondary" onclick="prevStep(4)">
            â† ä¸Šä¸€æ­¥
          </button>
        </div>
      </div>
    </div>

    <!-- ç”³è«‹æäº¤æˆåŠŸç•«é¢ -->
    <div id="successScreen" class="hidden">
      <header class="page-header">
        <h1>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</h1>
        <nav class="header-nav">
          <a href="#" onclick="backToMainMenu(); return false;">è¿”å›</a>
        </nav>
      </header>

      <div class="card form-card">
        <div class="success-icon">âœ“</div>
        <h2 class="success-card-title">ç”³è«‹å·²é€å‡ºï¼</h2>
        <p class="success-card-text">
          æ‚¨çš„ç”³è«‹æ¡ˆä»¶ç·¨è™Ÿï¼š<strong id="caseNumber"></strong>
        </p>

        <div class="info-box">
          ğŸ“± æˆ‘å€‘å·²å°‡ç”³è«‹è³‡è¨Šç™¼é€è‡³æ‚¨çš„æ‰‹æ©Ÿï¼Œè«‹ä¿æŒæ‰‹æ©Ÿæš¢é€šã€‚<br />
          ğŸ‘¨â€ğŸ’¼ é‡Œé•·å°‡åœ¨ 3 å€‹å·¥ä½œå¤©å…§å¯©æ ¸æ‚¨çš„ç”³è«‹ã€‚<br />
          ğŸ”” å¯©æ ¸çµæœå°‡ä»¥ç°¡è¨Šé€šçŸ¥ï¼Œè«‹ç•™æ„è¨Šæ¯ã€‚
        </div>

        <button class="btn btn-primary" onclick="backToMainMenu()">
          è¿”å›ä¸»é¸å–®
        </button>
      </div>
    </div>

    <!-- è¼‰å…¥é…ç½®ç®¡ç†æ¨¡çµ„ -->
    <script src="/static/js/config.js"></script>
    <script>
      // å…¨åŸŸè®Šæ•¸
      let API_BASE = null; // å°‡ç”±é…ç½®æ¨¡çµ„è¨­å®š
      let accessToken = localStorage.getItem("applicant_token");
      let currentUser = JSON.parse(
        localStorage.getItem("applicant_user") || "null"
      );
      let currentStep = 1;
      let selectedDocuments = []; // å­˜å„²é¸ä¸­çš„æ–‡ä»¶

      // Digital ID flow control
      let pollingIntervalId = null;
      let countdownIntervalId = null;
      let activePolling = false;

      // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
      async function initializeApp() {
        // è¼‰å…¥é…ç½®
        await initializeConfig();
        API_BASE = getApiBase();

        // ğŸ¯ å…ˆæª¢æŸ¥ Google OAuth callback
        const isGoogleLogin = checkGoogleAuthToken();

        // å¦‚æœæ­£åœ¨è™•ç† Google ç™»å…¥ï¼Œå°±ä¸è¦ç¹¼çºŒåŸ·è¡Œ
        if (isGoogleLogin) {
          console.log("ğŸ”„ æ­£åœ¨è™•ç† Google ç™»å…¥ï¼Œè·³éå…¶ä»–åˆå§‹åŒ–");
          return;
        }

        // å¦‚æœæ²’æœ‰å¾ Google ç™»å…¥ï¼Œæª¢æŸ¥ç¾æœ‰ç™»å…¥ç‹€æ…‹
        if (!accessToken || !currentUser) {
          accessToken = localStorage.getItem("applicant_token");
          const userStr = localStorage.getItem("applicant_user");
          if (userStr) {
            try {
              currentUser = JSON.parse(userStr);
            } catch (e) {
              console.error("è§£æ currentUser å¤±æ•—:", e);
            }
          }
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        if (accessToken && currentUser) {
          console.log("âœ… å·²æœ‰ç™»å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºä¸»é¸å–®");
          showMainMenu();
        } else {
          console.log("âŒ æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥ç•Œé¢");
          // åˆå§‹åŒ–ç™»å…¥ç•Œé¢
          initializeLoginUI();
        }
      }

      // åˆå§‹åŒ–ç™»å…¥ç•Œé¢
      function initializeLoginUI() {
        const DEFAULT_QR = "";
        const tabs = document.querySelectorAll(".login-tab");
        const forms = {
          general: document.getElementById("general-login-form"),
          digital: document.getElementById("digital-login-form"),
        };

        const qrImg = document.querySelector(".qr-code-container img");
        const countdownEl = document.querySelector(".countdown-time");
        let verification_code = "";

        // ç¢ºä¿ QR æœ‰é è¨­åœ–ç‰‡
        if (
          qrImg &&
          (!qrImg.getAttribute("src") || qrImg.getAttribute("src") === "")
        ) {
          qrImg.src = DEFAULT_QR;
        }
        if (
          countdownEl &&
          (!countdownEl.textContent || countdownEl.textContent.trim() === "")
        ) {
          countdownEl.textContent = "5:00";
        }

        // Tab åˆ‡æ›åŠŸèƒ½
        function setActiveTab(tabEl, startFlow = true) {
          tabs.forEach((t) => t.classList.remove("active"));
          tabEl.classList.add("active");

          Object.values(forms).forEach((form) => form.classList.add("hidden"));

          const formId = tabEl.getAttribute("data-tab");
          if (forms[formId]) forms[formId].classList.remove("hidden");
        }

        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const formId = this.getAttribute("data-tab");
            if (formId === "general") {
              clearDigitalIntervals();
            }
            setActiveTab(this, false);
          });
        });

        // åˆå§‹åŒ– active tab
        const initialActive =
          document.querySelector(".login-tab.active") || tabs[0];
        if (initialActive) setActiveTab(initialActive, false);

        // Email é©—è­‰ç¢¼ç™¼é€æŒ‰éˆ•
        const verificationBtn = document.querySelector(
          ".verification-send-btn"
        );
        let timeLeft = 180;
        let countdownTimer = null;

        function startCountdown() {
          if (!verificationBtn) return;
          verificationBtn.disabled = true;
          timeLeft = 180;

          function updateButtonText() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            verificationBtn.textContent = `é‡æ–°ç™¼é€ (${minutes}:${seconds
              .toString()
              .padStart(2, "0")})`;

            if (timeLeft <= 0) {
              clearInterval(countdownTimer);
              verificationBtn.disabled = false;
              verificationBtn.textContent = "ç™¼é€é©—è­‰ç¢¼";
              return;
            }
            timeLeft--;
          }

          updateButtonText();
          countdownTimer = setInterval(updateButtonText, 1000);
        }

        if (verificationBtn) {
          verificationBtn.addEventListener("click", async function () {
            const email = document.getElementById("email").value;

            if (!email) {
              alert("è«‹è¼¸å…¥ Email");
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/email/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  is_verified: false,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                startCountdown();
                if (data.verification_code) {
                  verification_code = data.verification_code;
                  console.log("é©—è­‰ç¢¼(é–‹ç™¼ç”¨):", data.verification_code);
                  alert(
                    "âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼\n\n(é–‹ç™¼ç’°å¢ƒï¼šé©—è­‰ç¢¼å·²è¼¸å‡ºåˆ°Console)"
                  );
                } else {
                  alert("âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼");
                }
              } else {
                const error = await response.json();
                alert("ç™¼é€å¤±æ•—ï¼š" + (error.detail || "è«‹ç¨å¾Œå†è©¦"));
              }
            } catch (error) {
              console.error("ç™¼é€é©—è­‰ç¢¼éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // ç™»å…¥æŒ‰éˆ•
        const loginBtn = document.querySelector(".login-btn");
        if (loginBtn) {
          loginBtn.addEventListener("click", async function () {
            const email = document.getElementById("email").value;
            const verificationCode = document.getElementById("password").value;
            const captchaInputEl = document.querySelector(
              ".verification-input"
            );
            const captchaInput = captchaInputEl ? captchaInputEl.value : "";
            const captchaTextEl = document.querySelector(".verification-code");
            const captchaText = captchaTextEl ? captchaTextEl.textContent : "";

            if (!email) {
              alert("è«‹å¡«å¯«email");
              return;
            } else if (!verificationCode) {
              alert("è«‹å¡«å¯«é©—è­‰ç¢¼");
              return;
            } else if (!captchaInput) {
              alert("è«‹å¡«å¯«åœ–å½¢é©—è­‰ç¢¼");
              return;
            }

            if (verificationCode.length !== 6) {
              alert("é©—è­‰ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—");
              return;
            }

            if (verificationCode !== verification_code) {
              alert("é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            if (captchaInput !== captchaText) {
              alert("åœ–å½¢é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  login_type: "password",
                  verification_code: verificationCode,
                  verify: true,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                accessToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem("applicant_token", accessToken);
                localStorage.setItem(
                  "applicant_user",
                  JSON.stringify(currentUser)
                );

                // ç™»å…¥æˆåŠŸï¼Œé¡¯ç¤ºä¸»é¸å–®
                showMainMenu();
              } else {
                const error = await response.json();
                alert(
                  "ç™»å…¥å¤±æ•—ï¼š" +
                    (error.detail?.message || error.detail || "è«‹ç¨å¾Œå†è©¦")
                );
              }
            } catch (error) {
              console.error("ç™»å…¥éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // Google ç™»å…¥æŒ‰éˆ•
        const googleBtn = document.querySelector(".google-btn");
        if (googleBtn) {
          googleBtn.addEventListener("click", function () {
            window.location.href = "/api/v1/auth/google/login";
          });
        }

        // åˆ·æ–°åœ–å½¢é©—è­‰ç¢¼
        const refreshCaptchaBtn = document.querySelector(".refresh-captcha");
        function generateCaptcha() {
          const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          let captcha = "";
          for (let i = 0; i < 5; i++) {
            captcha += chars[Math.floor(Math.random() * chars.length)];
          }
          const captchaEl = document.querySelector(".verification-code");
          if (captchaEl) captchaEl.textContent = captcha;
        }

        if (refreshCaptchaBtn)
          refreshCaptchaBtn.addEventListener("click", generateCaptcha);
        generateCaptcha();

        // å¦‚æœæ•¸ä½ tab æ˜¯ activeï¼Œå•Ÿå‹•æ•¸ä½ç™»å…¥æµç¨‹
        const activeTabOnLoad = document.querySelector(".login-tab.active");
        if (
          activeTabOnLoad &&
          activeTabOnLoad.getAttribute("data-tab") === "digital"
        ) {
          loginWithDigitalID();
        }

        // æ•¸ä½ tab é»æ“Šäº‹ä»¶
        const digitalTab = document.querySelector(
          '.login-tab[data-tab="digital"]'
        );
        if (digitalTab) {
          digitalTab.addEventListener("click", () => {
            clearDigitalIntervals();
            setTimeout(() => loginWithDigitalID(), 100);
          });
        }
      }

      function clearDigitalIntervals() {
        if (pollingIntervalId) {
          clearInterval(pollingIntervalId);
          pollingIntervalId = null;
        }
        if (countdownIntervalId) {
          clearInterval(countdownIntervalId);
          countdownIntervalId = null;
        }
        activePolling = false;
        try {
          window._mixcurry_digital_flow_started = false;
        } catch (e) {
          /* ignore */
        }
      }

      window.stopVpPolling = function () {
        clearDigitalIntervals();
      };

      async function loginWithDigitalID() {
        if (window._mixcurry_digital_flow_started) return;
        window._mixcurry_digital_flow_started = true;

        try {
          console.debug("loginWithDigitalID invoked");
        } catch (e) {}

        clearDigitalIntervals();
        if (activePolling) return;
        activePolling = true;

        const vpRef = "00000000_mixcurry_idcard";
        let transactionId = null;
        let remainingSeconds = 300;

        const qrImg = document.querySelector(".qr-code-container img");
        const countdownEl = document.querySelector(".countdown-time");
        const DEFAULT_QR = "";

        if (qrImg) qrImg.src = qrImg.getAttribute("src") || DEFAULT_QR;

        function updateCountdownDisplay() {
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          if (countdownEl)
            countdownEl.textContent = `${minutes}:${seconds
              .toString()
              .padStart(2, "0")}`;
        }

        updateCountdownDisplay();
        countdownIntervalId = setInterval(() => {
          remainingSeconds--;
          if (remainingSeconds <= 0) {
            clearDigitalIntervals();
            updateCountdownDisplay();
            alert("é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°å˜—è©¦ç™»å…¥");
            return;
          }
          updateCountdownDisplay();
        }, 1000);

        try {
          const result = await fetch(
            `/api/v1/complete-flow/generate-vp-qrcode`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ ref: vpRef }),
            }
          );

          const data = await result.json();
          console.log("æ•¸ä½èº«åˆ†é©—è­‰å›æ‡‰:", data);

          if (!data || !data.success) {
            console.warn("generate-vp-qrcode failed or returned no success");
            return;
          }

          if (qrImg && data.qrcode_image) qrImg.src = data.qrcode_image;
          transactionId = data.transaction_id;

          if (transactionId) {
            pollingIntervalId = setInterval(async () => {
              try {
                const pollResult = await fetch(
                  `/api/v1/complete-flow/verify-vp`,
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ transaction_id: transactionId }),
                  }
                );
                const pollData = await pollResult.json();

                if (pollData && pollData.verified) {
                  console.log("é©—è­‰æˆåŠŸï¼Œä½¿ç”¨è€…è³‡æ–™ï¼š", pollData);
                  clearDigitalIntervals();

                  try {
                    const loginResponse = await fetch("/api/v1/auth/login", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                        email: pollData.email,
                        password: "",
                        login_type: "password",
                      }),
                    });

                    if (loginResponse.ok) {
                      const loginData = await loginResponse.json();
                      accessToken = loginData.access_token;
                      currentUser = loginData.user;
                      localStorage.setItem("applicant_token", accessToken);
                      localStorage.setItem(
                        "applicant_user",
                        JSON.stringify(currentUser)
                      );

                      // ç™»å…¥æˆåŠŸï¼Œé¡¯ç¤ºä¸»é¸å–®
                      showMainMenu();
                    } else {
                      const error = await loginResponse.json();
                      alert(
                        "ç™»å…¥å¤±æ•—ï¼š" +
                          (error.detail?.message ||
                            error.detail ||
                            "è«‹ç¨å¾Œå†è©¦")
                      );
                    }
                  } catch (error) {
                    console.error("Digital ID login error:", error);
                    alert("ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                  }
                }
              } catch (err) {
                console.error("Polling error:", err);
              }
            }, 2000);
          }
        } catch (error) {
          console.error("æ•¸ä½èº«åˆ†é©—è­‰éŒ¯èª¤:", error);
        }
      }

      // é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", initializeApp);

      // æª¢æŸ¥ URL ä¸­çš„ Google OAuth tokenï¼ˆå¾ callback é‡å®šå‘å›ä¾†ï¼‰
      function checkGoogleAuthToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("access_token");
        const refreshToken = urlParams.get("refresh_token");

        if (token) {
          console.log("âœ… æª¢æ¸¬åˆ° Google OAuth tokenï¼Œè™•ç†ç™»å…¥...");

          // å„²å­˜ token
          accessToken = token;
          localStorage.setItem("applicant_token", token);
          if (refreshToken) {
            localStorage.setItem("applicant_refresh_token", refreshToken);
          }

          // æ¸…ç† URLï¼ˆç§»é™¤ token åƒæ•¸ï¼‰
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );

          // å–å¾—ä½¿ç”¨è€…è³‡è¨Šä¸¦é¡¯ç¤ºä¸»é¸å–®
          getUserInfoAndShowMenu();

          return true; // è¡¨ç¤ºæ­£åœ¨è™•ç† Google ç™»å…¥
        }

        return false; // æ²’æœ‰ Google token
      }

      // å–å¾—ä½¿ç”¨è€…è³‡è¨Šä¸¦é¡¯ç¤ºä¸»é¸å–®
      async function getUserInfoAndShowMenu() {
        if (!API_BASE) {
          await initializeConfig();
          API_BASE = getApiBase();
        }

        try {
          const response = await fetch(`${API_BASE}/users/me`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const userData = await response.json();
            currentUser = userData.data || userData;
            localStorage.setItem("applicant_user", JSON.stringify(currentUser));
            showMainMenu();
          } else {
            console.error("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š");
            alert("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦");
            logout();
          }
        } catch (error) {
          console.error("å–å¾—ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:", error);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦");
          logout();
        }
      }

      // Google ç™»å…¥å‡½æ•¸
      function loginWithGoogle() {
        console.log("å•Ÿå‹• Google OAuth ç™»å…¥...");
        // é‡å®šå‘åˆ°å¾Œç«¯çš„ Google OAuth ç«¯é»
        window.location.href = "/api/v1/auth/google/login";
      }

      function showScreen(screenId) {
        // éš±è—æ‰€æœ‰ç•«é¢
        const screens = [
          "loginOnlyScreen",
          "mainMenu",
          "myApplicationsScreen",
          "applyForm",
          "successScreen",
        ];

        screens.forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            if (
              el.classList.contains("success-screen") ||
              el.classList.contains("history-screen")
            ) {
              el.classList.remove("active");
            } else if (id === "loginOnlyScreen") {
              el.style.display = "none";
            } else {
              el.classList.add("hidden");
            }
          }
        });

        // é¡¯ç¤ºç›®æ¨™ç•«é¢
        const targetEl = document.getElementById(screenId);
        if (targetEl) {
          if (
            targetEl.classList.contains("success-screen") ||
            targetEl.classList.contains("history-screen")
          ) {
            targetEl.classList.add("active");
          } else if (screenId === "loginOnlyScreen") {
            targetEl.style.display = "block";
          } else {
            targetEl.classList.remove("hidden");
          }
        }
      }

      function showMainMenu() {
        // æ›´æ–°é¡¯ç¤ºçš„ email
        const emailDisplay = document.getElementById("successEmailDisplay");
        if (emailDisplay && currentUser) {
          emailDisplay.textContent =
            currentUser.email || currentUser.id_number || "ç”¨æˆ¶";
        }
        showScreen("mainMenu");
      }

      function backToMainMenu() {
        showMainMenu();
      }

      function logout() {
        accessToken = null;
        currentUser = null;
        localStorage.removeItem("applicant_token");
        localStorage.removeItem("applicant_user");
        showScreen("loginOnlyScreen");
        // åˆ·æ–°é é¢
        location.reload();
        window.location.href = "/applicant";
      }

      function showApplyForm() {
        showScreen("applyForm");
        currentStep = 1;
        updateSteps();
        // é å¡«è³‡æ–™
        document.getElementById("appName").value = currentUser.full_name;
        document.getElementById("appIdNumber").value = currentUser.id_number;
        document.getElementById("appPhone").value = currentUser.phone || "";
      }

      function backToMenu() {
        showMainMenu();
      }

      function updateSteps() {
        for (let i = 1; i <= 5; i++) {
          const step = document.getElementById(`step${i}`);
          step.className = "step";
          if (i < currentStep) step.classList.add("completed");
          if (i === currentStep) step.classList.add("active");

          document
            .getElementById(`form-step${i}`)
            .classList.toggle("hidden", i !== currentStep);
        }
      }

      function nextStep(step) {
        // é©—è­‰ç•¶å‰æ­¥é©Ÿ
        if (currentStep === 4) {
          showConfirmData();
        }
        currentStep = step;
        updateSteps();
      }

      function prevStep(step) {
        currentStep = step;
        updateSteps();
      }

      function showConfirmData() {
        document.getElementById("confirmData").innerHTML = `
                <p><strong>å§“åï¼š</strong>${
                  document.getElementById("appName").value
                }</p>
                <p><strong>èº«åˆ†è­‰å­—è™Ÿï¼š</strong>${
                  document.getElementById("appIdNumber").value
                }</p>
                <p><strong>æ‰‹æ©Ÿï¼š</strong>${
                  document.getElementById("appPhone").value
                }</p>
                <p><strong>åœ°å€ï¼š</strong>${
                  document.getElementById("appAddress").value
                }</p>
                <hr class="confirm-separator">
                <p><strong>ç½å®³æ—¥æœŸï¼š</strong>${
                  document.getElementById("appDate").value
                }</p>
                <p><strong>ç½å®³é¡å‹ï¼š</strong>${
                  document.getElementById("appType").selectedOptions[0].text
                }</p>
                <p><strong>ç”³è«‹é‡‘é¡ï¼š</strong>NT$ ${parseInt(
                  document.getElementById("appAmount").value
                ).toLocaleString()}</p>
            `;
      }

      async function submitApplication() {
        const data = {
          applicant_id: currentUser.id,
          applicant_name: document.getElementById("appName").value,
          id_number: document.getElementById("appIdNumber").value,
          phone: document.getElementById("appPhone").value,
          address: document.getElementById("appAddress").value,
          disaster_date: document.getElementById("appDate").value,
          disaster_type: document.getElementById("appType").value,
          damage_description: document.getElementById("appDescription").value,
          damage_location: document.getElementById("appDamageLocation").value,
          estimated_loss: parseFloat(
            document.getElementById("appEstimatedLoss").value
          ),
          subsidy_type: document.getElementById("appSubsidyType").value,
          requested_amount: parseFloat(
            document.getElementById("appAmount").value
          ),
        };

        const result = await fetch(`${API_BASE}/applications/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${accessToken}`,
          },
          body: JSON.stringify(data),
        });

        if (result.ok) {
          const appResponse = await result.json();
          const appData = appResponse.data || appResponse;
          const applicationId = appData.id;
          const caseNo = appData.case_no;

          // ä¸Šå‚³æ–‡ä»¶ï¼ˆå¦‚æœæœ‰é¸æ“‡æ–‡ä»¶ï¼‰
          if (selectedDocuments.length > 0) {
            console.log(`ğŸ“¤ é–‹å§‹ä¸Šå‚³ ${selectedDocuments.length} å€‹æ–‡ä»¶...`);

            // é¡¯ç¤ºä¸Šå‚³é€²åº¦
            const uploadStatus = document.createElement("div");
            uploadStatus.id = "uploadStatus";
            uploadStatus.style.cssText =
              "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 10000; text-align: center;";
            uploadStatus.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“¤</div>
                        <h3 style="margin: 0 0 10px 0; color: #333;">æ­£åœ¨ä¸Šå‚³æ–‡ä»¶</h3>
                        <p style="color: #666; margin: 0;" id="uploadProgress">0 / ${selectedDocuments.length}</p>
                    `;
            document.body.appendChild(uploadStatus);

            try {
              await uploadDocuments(applicationId);
            } catch (error) {
              console.error("æ–‡ä»¶ä¸Šå‚³å¤±æ•—:", error);
            } finally {
              // ç§»é™¤ä¸Šå‚³ç‹€æ…‹æç¤º
              document.body.removeChild(uploadStatus);
            }
          }

          document.getElementById("caseNumber").textContent = caseNo;
          showScreen("successScreen");
        } else {
          alert("ç”³è«‹æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      async function showMyApplications() {
        try {
          const result = await fetch(
            `${API_BASE}/applications/applicant/${currentUser.id}`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          const list = document.getElementById("applicationsList");

          if (result.ok) {
            const response = await result.json();
            // è™•ç† APIResponse æ ¼å¼
            const apps =
              response.data?.applications || response.data || response;

            if (apps.length === 0) {
              list.innerHTML = `
                            <div class="record">
                                <p style="text-align: center; color: #475569; padding: 20px 0;">å°šç„¡ç”³è«‹ç´€éŒ„</p>
                            </div>
                        `;
            } else {
              list.innerHTML = apps
                .map((app) => {
                  const statusInfo = getStatusInfo(app.status);
                  const progress = getProgressPercentage(app.status);

                  return `
                                <div class="record">
                                    <div class="record-head">
                                        <div class="record-type">${getDisasterTypeText(
                                          app.disaster_type
                                        )}</div>
                                        <div class="status-pill">${
                                          statusInfo.text
                                        }</div>
                                    </div>
                                    <div class="record-meta">
                                        ç”³è«‹ç·¨è™Ÿï¼š${
                                          app.case_no
                                        } | ç”³è«‹æ—¥æœŸï¼š${new Date(
                    app.submitted_at
                  ).toLocaleDateString("zh-TW")}
                                    </div>
                                    <div class="progress-row">
                                        <div class="progress-bar" aria-hidden="true">
                                            <div class="progress-fill" style="width:${progress}%"></div>
                                        </div>
                                        <div class="progress-percent">${progress}%</div>
                                    </div>
                                    <div class="card-bottom">
                                        <div class="label">
                                            ç”³è«‹é‡‘é¡ï¼šNT$ ${app.requested_amount?.toLocaleString()}
                                            ${
                                              app.approved_amount
                                                ? ` | æ ¸å‡†ï¼šNT$ ${app.approved_amount.toLocaleString()}`
                                                : ""
                                            }
                                        </div>
                                        <a class="view-link" href="#" onclick="viewApplicationDetail('${
                                          app.id
                                        }'); return false;">
                                            <span>æŸ¥çœ‹è©³æƒ…</span>
                                            <span>â†’</span>
                                        </a>
                                    </div>
                                </div>
                            `;
                })
                .join("");
            }
            showScreen("myApplicationsScreen");
          } else {
            const errorData = await result.json().catch(() => ({}));
            list.innerHTML = `
                        <div class="record">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                                <p style="color: #ef4444; font-size: 16px; margin-bottom: 8px;">ç„¡æ³•è¼‰å…¥ç”³è«‹ç´€éŒ„</p>
                                <p style="color: #999; font-size: 14px;">${
                                  errorData.detail || "è«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡å®¢æœ"
                                }</p>
                                <p style="color: #999; font-size: 12px; margin-top: 16px;">éŒ¯èª¤ä»£ç¢¼: ${
                                  result.status
                                }</p>
                            </div>
                        </div>
                    `;
            showScreen("myApplicationsScreen");
          }
        } catch (error) {
          console.error("Error loading applications:", error);
          alert("è¼‰å…¥å¤±æ•—ï¼š" + error.message);
        }
      }

      function getStatusInfo(status) {
        const map = {
          pending: { text: "å¾…å¯©æ ¸", color: "#94A3B8" },
          under_review: { text: "å¯©æ ¸ä¸­", color: "#3B82F6" },
          approved: { text: "å·²æ ¸å‡†", color: "#10B981" },
          rejected: { text: "å·²é§å›", color: "#EF4444" },
          completed: { text: "å·²é ˜å–", color: "#6366F1" },
        };
        return map[status] || { text: status, color: "#94A3B8" };
      }

      function getProgressPercentage(status) {
        const map = {
          pending: 50,
          under_review: 50,
          approved: 100,
          rejected: 100,
          completed: 100,
        };
        return map[status] || 0;
      }

      function getDisasterTypeText(type) {
        const map = {
          flood: "æ°´ç½è£œåŠ©",
          typhoon: "é¢±é¢¨è£œåŠ©",
          earthquake: "åœ°éœ‡è£œåŠ©",
          other: "å…¶ä»–ç½å®³è£œåŠ©",
        };
        return map[type] || "ç½å®³è£œåŠ©";
      }

      async function viewApplicationDetail(appId) {
        try {
          // å–å¾—ç”³è«‹è©³æƒ…
          const response = await fetch(`${API_BASE}/applications/${appId}`, {
            headers: { Authorization: `Bearer ${accessToken}` },
          });

          if (!response.ok) {
            throw new Error("ç„¡æ³•å–å¾—ç”³è«‹è©³æƒ…");
          }

          const result = await response.json();
          const app = result.data || result;

          // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºä¸åŒå…§å®¹
          if (app.application.status === "approved") {
            // å·²æ ¸å‡†ï¼šé¡¯ç¤º QR Code
            showQRCodeForApplicant(app);
          } else if (app.application.status === "rejected") {
            // å·²é§å›ï¼šé¡¯ç¤ºé§å›åŸå› 
            showRejectionReason(app);
          } else {
            // å¯©ç†ä¸­ï¼šé¡¯ç¤ºç­‰å¾…è¨Šæ¯
            showPendingMessage(app);
          }
        } catch (error) {
          console.error("æŸ¥çœ‹ç”³è«‹è©³æƒ…éŒ¯èª¤:", error);
          alert("ç„¡æ³•è¼‰å…¥ç”³è«‹è©³æƒ…ï¼š" + error.message);
        }
      }

      // é¡¯ç¤º QR Code çµ¦ç”³è«‹äººæƒæï¼ˆå·²æ ¸å‡†ï¼‰
      function showQRCodeForApplicant(app) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.cssText =
          "display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;";

        // å¾ç”³è«‹è³‡æ–™ä¸­å–å¾— QR Codeï¼ˆä½¿ç”¨ gov_qr_code_data æ¬„ä½ï¼‰
        const qrCodeDisplay = app.application.gov_qr_code_data
          ? `<img src="${app.application.gov_qr_code_data}" style="max-width: 300px; border: 3px solid #4CAF50; border-radius: 10px; padding: 10px;">`
          : `<div style="padding: 20px; background: #f0f0f0; border-radius: 10px; text-align: center;">
                <p style="margin-bottom: 10px;">âŒ QR Code å°šæœªç”Ÿæˆ</p>
                <p style="font-size: 12px; color: #666;">è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«é‡Œé•·</p>
             </div>`;

        modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px; line-height: 1;">&times;</button>
                    
                    <div style="padding: 30px;">
                        <h2 style="color: #4CAF50; text-align: center; margin-bottom: 20px;">âœ… ç”³è«‹å·²æ ¸å‡†ï¼</h2>
                        
                        <div style="text-align: center; margin: 30px 0;">
                            <h3 style="margin-bottom: 10px;">æ‚¨çš„æ•¸ä½æ†‘è­‰ QR Code</h3>
                            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">è«‹ä½¿ç”¨æ•¸ä½æ†‘è­‰ APP æƒæä»¥é ˜å–è£œåŠ©</p>
                            ${qrCodeDisplay}
                            
                            ${
                              app.application.gov_deep_link &&
                              app.application.gov_deep_link.startsWith(
                                "modadigitalwallet://"
                              )
                                ? `
                                <a href="${app.gov_deep_link}" target="_blank" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 500;">
                                    ğŸ“± é»æ­¤ç›´æ¥é–‹å•Ÿæ•¸ä½æ†‘è­‰ APP
                                </a>
                            `
                                : ""
                            }
                            
                            ${
                              app.application.gov_transaction_id
                                ? `<p style="margin-top: 15px; font-size: 12px; color: #888;">Transaction ID: ${app.application.gov_transaction_id}</p>`
                                : ""
                            }
                            
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left;">
                                <p style="margin: 5px 0;"><strong>æ¡ˆä»¶ç·¨è™Ÿï¼š</strong>${
                                  app.application.case_no
                                }</p>
                                <p style="margin: 5px 0;"><strong>ç”³è«‹é‡‘é¡ï¼š</strong>NT$ ${app.application.requested_amount?.toLocaleString()}</p>
                                <p style="margin: 5px 0;"><strong>æ ¸å‡†é‡‘é¡ï¼š</strong><span style="color: #10b981; font-weight: 600;">NT$ ${
                                  app.application.approved_amount?.toLocaleString() ||
                                  "NT$ " +
                                    app.application.requested_amount?.toLocaleString()
                                }</span></p>
                                ${
                                  app.application.review_notes
                                    ? `<p style="margin: 5px 0;"><strong>å¯©æ ¸å‚™è¨»ï¼š</strong>${app.application.review_notes}</p>`
                                    : ""
                                }
                            </div>
                        </div>

                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #3b82f6;">
                            <strong style="color: #1e40af;">ğŸ“± é ˜å–æ­¥é©Ÿï¼š</strong>
                            <ol style="margin: 10px 0 0 20px; color: #1e40af; font-size: 14px; line-height: 1.8;">
                                <li>æ‰“é–‹ã€ŒTW FidO æ•¸ä½æ†‘è­‰çš®å¤¾ã€APPï¼ˆå¯é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç›´æ¥é–‹å•Ÿï¼‰</li>
                                <li>æƒæä¸Šæ–¹ QR Code æˆ–é€é Deep Link è‡ªå‹•åŒ¯å…¥</li>
                                <li>ç¢ºèªä¸¦å„²å­˜æ†‘è­‰åˆ°æ‚¨çš„æ‰‹æ©Ÿ</li>
                                <li>æ”œå¸¶æ‰‹æ©Ÿå‰å¾€æŒ‡å®šåœ°é»é ˜å–è£œåŠ©</li>
                            </ol>
                        </div>

                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; padding: 14px; background: #4CAF50; color: white; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
      }

      // é¡¯ç¤ºé§å›åŸå› ï¼ˆå·²é§å›ï¼‰
      function showRejectionReason(app) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.cssText =
          "display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;";

        modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px; line-height: 1;">&times;</button>
                    
                    <div style="padding: 30px;">
                        <h2 style="color: #ef4444; text-align: center; margin-bottom: 20px;">âŒ ç”³è«‹å·²é§å›</h2>
                        
                        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
                            <h3 style="color: #991b1b; margin-bottom: 10px; font-size: 16px;">é§å›åŸå› ï¼š</h3>
                            <p style="color: #7f1d1d; font-size: 14px; line-height: 1.6; margin: 0;">
                                ${
                                  app.rejection_reason ||
                                  app.review_notes ||
                                  "æœªæä¾›å…·é«”åŸå› ï¼Œè«‹è¯ç¹«æ‰¿è¾¦äººå“¡"
                                }
                            </p>
                        </div>

                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 5px 0;"><strong>æ¡ˆä»¶ç·¨è™Ÿï¼š</strong>${
                              app.case_no
                            }</p>
                            <p style="margin: 5px 0;"><strong>ç”³è«‹é‡‘é¡ï¼š</strong>NT$ ${app.requested_amount?.toLocaleString()}</p>
                            <p style="margin: 5px 0;"><strong>ç½å®³é¡å‹ï¼š</strong>${getDisasterTypeText(
                              app.disaster_type
                            )}</p>
                            <p style="margin: 5px 0;"><strong>æäº¤æ—¥æœŸï¼š</strong>${new Date(
                              app.submitted_at
                            ).toLocaleDateString("zh-TW")}</p>
                        </div>

                        <div style="background: #fff7ed; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <strong style="color: #92400e;">ğŸ’¡ å»ºè­°ï¼š</strong>
                            <ul style="margin: 10px 0 0 20px; color: #92400e; font-size: 14px; line-height: 1.6;">
                                <li>è«‹è©³é–±é§å›åŸå› ä¸¦æº–å‚™ç›¸é—œè£œå……è³‡æ–™</li>
                                <li>æ‚¨å¯ä»¥ä¿®æ­£å•é¡Œå¾Œé‡æ–°æå‡ºç”³è«‹</li>
                                <li>å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯ç¹«é‡Œé•·æˆ–æ‰¿è¾¦äººå“¡</li>
                            </ul>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex: 1; padding: 14px; background: #f3f4f6; color: #666; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                é—œé–‰
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove(); showApplyForm();" style="flex: 1; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                                é‡æ–°ç”³è«‹
                            </button>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
      }

      // é¡¯ç¤ºå¯©ç†ä¸­è¨Šæ¯
      function showPendingMessage(app) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.cssText =
          "display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;";

        const statusInfo = getStatusInfo(app.application.status);

        modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px; line-height: 1;">&times;</button>
                    
                    <div style="padding: 30px;">
                        <h2 style="color: #3b82f6; text-align: center; margin-bottom: 20px;">â³ ç”³è«‹å¯©æ ¸ä¸­</h2>
                        
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: flex-start; justify-content: center; font-size: 48px; padding-top: 10px;">
                                â±ï¸
                            </div>
                            <p style="font-size: 18px; font-weight: 500; color: #333; margin-bottom: 10px;">
                                æ‚¨çš„ç”³è«‹æ­£åœ¨å¯©æ ¸ä¸­
                            </p>
                            <p style="color: #666; font-size: 14px;">
                                ç›®å‰ç‹€æ…‹ï¼š<span style="color: ${
                                  statusInfo.color
                                }; font-weight: 500;">${statusInfo.text}</span>
                            </p>
                        </div>

                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 5px 0;"><strong>æ¡ˆä»¶ç·¨è™Ÿï¼š</strong>${
                              app.case_no
                            }</p>
                            <p style="margin: 5px 0;"><strong>ç”³è«‹é‡‘é¡ï¼š</strong>NT$ ${app.requested_amount?.toLocaleString()}</p>
                            <p style="margin: 5px 0;"><strong>ç½å®³é¡å‹ï¼š</strong>${getDisasterTypeText(
                              app.disaster_type
                            )}</p>
                            <p style="margin: 5px 0;"><strong>æäº¤æ—¥æœŸï¼š</strong>${new Date(
                              app.submitted_at
                            ).toLocaleDateString("zh-TW")}</p>
                        </div>

                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <strong style="color: #1e40af;">ğŸ“‹ å¯©æ ¸æµç¨‹ï¼š</strong>
                            <ol style="margin: 10px 0 0 20px; color: #1e40af; font-size: 14px; line-height: 1.8;">
                                <li>è³‡æ–™å¯©æŸ¥ï¼ˆé€²è¡Œä¸­ï¼‰</li>
                                <li>é‡Œé•·å¯©æ ¸</li>
                                <li>æ ¸ç™¼è£œåŠ©æ†‘è­‰</li>
                                <li>é ˜å–è£œåŠ©</li>
                            </ol>
                        </div>

                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <p style="color: #92400e; font-size: 13px; margin: 0;">
                                âš ï¸ å¯©æ ¸é€šå¸¸éœ€è¦ <strong>3-5 å€‹å·¥ä½œå¤©</strong>ï¼Œå¯©æ ¸çµæœå°‡ä»¥ç°¡è¨Šæˆ– Email é€šçŸ¥æ‚¨ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚
                            </p>
                        </div>

                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
      }

      // è™•ç†æ–‡ä»¶é¸æ“‡
      function handleDocumentSelect(event) {
        const files = Array.from(event.target.files);
        const maxFiles = 5;
        const maxSize = 10 * 1024 * 1024; // 10MB

        // é©—è­‰æ–‡ä»¶æ•¸é‡
        if (files.length > maxFiles) {
          alert(`æœ€å¤šåªèƒ½ä¸Šå‚³ ${maxFiles} å€‹æª”æ¡ˆ`);
          event.target.value = "";
          return;
        }

        // é©—è­‰æ–‡ä»¶å¤§å°
        const oversizedFiles = files.filter((f) => f.size > maxSize);
        if (oversizedFiles.length > 0) {
          alert(`æª”æ¡ˆ ${oversizedFiles[0].name} è¶…é 10MB é™åˆ¶`);
          event.target.value = "";
          return;
        }

        selectedDocuments = files;
        displayDocumentPreview();
      }

      // é¡¯ç¤ºæ–‡ä»¶é è¦½
      function displayDocumentPreview() {
        const container = document.getElementById("documentPreview");
        if (selectedDocuments.length === 0) {
          container.innerHTML = "";
          return;
        }

        const html = selectedDocuments
          .map((file, index) => {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            const icon = getFileIcon(file.name);

            return `
                    <div style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 24px; margin-right: 10px;">${icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${file.name}</div>
                            <div style="font-size: 12px; color: #666;">${sizeInMB} MB</div>
                        </div>
                        <button type="button" onclick="removeDocument(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            ç§»é™¤
                        </button>
                    </div>
                `;
          })
          .join("");

        container.innerHTML = `
                <div style="margin-bottom: 10px; color: #28a745; font-weight: 500;">
                    âœ“ å·²é¸æ“‡ ${selectedDocuments.length} å€‹æª”æ¡ˆ
                </div>
                ${html}
            `;
      }

      // ç²å–æ–‡ä»¶åœ–ç¤º
      function getFileIcon(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const icons = {
          pdf: "ğŸ“„",
          doc: "ğŸ“",
          docx: "ğŸ“",
          jpg: "ğŸ–¼ï¸",
          jpeg: "ğŸ–¼ï¸",
          png: "ğŸ–¼ï¸",
        };
        return icons[ext] || "ğŸ“";
      }

      // ç§»é™¤æ–‡ä»¶
      function removeDocument(index) {
        const dt = new DataTransfer();
        const files = Array.from(selectedDocuments);
        files.splice(index, 1);

        files.forEach((file) => dt.items.add(file));
        document.getElementById("appDocuments").files = dt.files;
        selectedDocuments = files;
        displayDocumentPreview();
      }

      // ä¸Šå‚³æ–‡ä»¶åˆ°ä¼ºæœå™¨
      async function uploadDocuments(applicationId) {
        if (selectedDocuments.length === 0) {
          return { success: true, documents: [] };
        }

        const uploadedDocs = [];
        let uploadCount = 0;

        for (const file of selectedDocuments) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("application_id", applicationId);
          formData.append("document_type", "supporting_document");
          formData.append("description", file.name);
          formData.append("uploaded_by", currentUser.id); // åŠ å…¥ä¸Šå‚³è€… ID

          try {
            const response = await fetch(`${API_BASE}/documents/upload`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
              body: formData,
            });

            if (response.ok) {
              const result = await response.json();
              uploadedDocs.push(result.data);
              uploadCount++;

              // æ›´æ–°ä¸Šå‚³é€²åº¦
              const progressEl = document.getElementById("uploadProgress");
              if (progressEl) {
                progressEl.textContent = `${uploadCount} / ${selectedDocuments.length}`;
              }

              console.log(`âœ“ æª”æ¡ˆä¸Šå‚³æˆåŠŸ: ${file.name}`);
            } else {
              const errorData = await response.json().catch(() => ({}));
              console.error(`âœ— æª”æ¡ˆä¸Šå‚³å¤±æ•—: ${file.name}`, errorData);
              alert(
                `æª”æ¡ˆ ${file.name} ä¸Šå‚³å¤±æ•—: ${errorData.detail || "æœªçŸ¥éŒ¯èª¤"}`
              );
            }
          } catch (error) {
            console.error(`âœ— æª”æ¡ˆä¸Šå‚³éŒ¯èª¤: ${file.name}`, error);
            alert(`æª”æ¡ˆ ${file.name} ä¸Šå‚³éŒ¯èª¤: ${error.message}`);
          }
        }

        return { success: true, documents: uploadedDocs };
      }
    </script>
  </body>
</html>
