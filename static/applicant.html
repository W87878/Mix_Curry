<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç½æ°‘è£œåŠ©ç”³è«‹ - ç·šä¸Šç”³è«‹ç³»çµ±</title>
    <link rel="stylesheet" href="/static/styles/applicant.css" />
    <!-- Lottie å‹•ç•«åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js" defer></script>
  </head>

  <body>
    <!-- Loading å‹•ç•«å®¹å™¨ -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 9999; flex-direction: column; justify-content: center; align-items: center;">
      <div id="loadingAnimation" style="width: 300px; height: 300px;"></div>
      <p style="margin-top: 20px; font-size: 18px; color: #333; font-weight: 500;">é©—è­‰ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginScreen" class="hidden">
      <header class="page-header">
        <h1>
          <a class="header-href" href="/">ğŸšï¸ ç½å®³è£œåŠ©ç”³è«‹å¹³å°</a>
        </h1>
        <nav class="header-nav">
          <a href="/">è¿”å›é¦–é </a>
        </nav>
      </header>

      <main class="main-content">
        <h2 class="page-title">ç™»å…¥å¾Œç¹¼çºŒ</h2>
        <p class="page-subtitle">è«‹ç™»å…¥ä»¥é–‹å§‹ç”³è«‹æ°´ç½è£œåŠ©</p>

        <div class="login-container">
          <div class="login-tabs">
            <div class="login-tab" data-tab="general" style="background-color: #e4f1fa !important; color: #1e81b2 !important;">
              <span class="icon-spacer">ğŸ“§</span>ä¸€èˆ¬ç™»å…¥
            </div>
            <div class="login-tab active" data-tab="digital" style="background-color: #1e81b2 !important; color: #f8fafc !important;">
              ğŸ“± æ•¸ä½èº«åˆ†è­‰æ†‘è­‰ç™»å…¥ (æ¨è–¦)
            </div>
          </div>

          <div id="general-login-form-main" class="login-form hidden">
            <div class="form-group">
              <label for="email-main">é›»å­ä¿¡ç®±</label>
              <input
                type="email"
                id="email-main"
                name="email"
                placeholder="è¼¸å…¥ä¿¡ç®±å¸³è™Ÿ"
                required
              />
            </div>

            <div class="form-group">
              <div class="flex-center-gap">
                <label for="password-main" class="no-margin-bottom">é©—è­‰ç¢¼</label>
                <small class="hint-text"> é©—è­‰ç¢¼å°‡ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®± </small>
              </div>
              <div class="input-with-button">
                <input
                  type="password"
                  id="password-main"
                  name="password"
                  placeholder="è¼¸å…¥é©—è­‰ç¢¼"
                  required
                />
                <button type="button" class="verification-send-btn-main">
                  ç™¼é€é©—è­‰ç¢¼
                </button>
              </div>
            </div>

            <div class="verification-container">
              <div class="verification-code-main">10541</div>
              <button type="button" class="refresh-captcha-main">
                <img
                  src="static/assets/refresh.png"
                  alt="æ›´æ–°é©—è­‰ç¢¼"
                  width="24"
                  height="24"
                />
              </button>
              <input
                type="text"
                class="verification-input-main"
                placeholder="è«‹è¼¸å…¥å·¦æ–¹åœ–ç‰‡ä¸­çš„æ–‡å­—"
                required
              />
            </div>

            <button type="submit" class="login-btn-main">ç™»å…¥</button>

            <div class="divider">
              <div class="divider-line"></div>
              <span class="divider-text">æˆ–</span>
              <div class="divider-line"></div>
            </div>

            <button type="button" class="google-btn-main">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                x="0px"
                y="0px"
                width="30"
                height="30"
                viewBox="0 0 48 48"
                style="vertical-align: middle; position: relative; top: -0.5px"
              >
                <path
                  fill="#FFC107"
                  d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                ></path>
                <path
                  fill="#FF3D00"
                  d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
                ></path>
                <path
                  fill="#4CAF50"
                  d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
                ></path>
                <path
                  fill="#1976D2"
                  d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                ></path>
              </svg>
              Google å¸³è™Ÿç™»å…¥
            </button>
          </div>

          <div id="digital-login-form-main" class="login-form">
            <div class="digital-header">
              <div class="digital-title">æ•¸ä½æ†‘è­‰çš®å¤¾APP</div>
              <div class="digital-subtitle">æ•¸ä½èº«åˆ†æ†‘è­‰ç™»å…¥æ–¹å¼</div>
            </div>

            <div class="qr-code-container">
              <div class="qr-code-inner">
                <img
                  id="loginQrCode"
                  src=""
                  alt="QR Code"
                  width="188"
                  height="188"
                  role="img"
                  aria-label="æ•¸ä½æ†‘è­‰ QR ç¢¼"
                />
                <div class="qr-code-timer">
                  <span class="timer-text">è«‹æ–¼ </span>
                  <span class="countdown-time" id="loginCountdown">5:00</span>
                  <span class="timer-text"> å…§å®Œæˆæƒæ</span>
                </div>
              </div>
            </div>

            <p class="qr-hint">ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼ç™»å…¥</p>

            <div class="divider">
              <div class="divider-line"></div>
            </div>

            <a
              href="https://moda.gov.tw/major-policies/wallet/1695"
              target="_blank"
              class="link-text"
              >é—œæ–¼æ•¸ä½èº«åˆ†è­‰æ†‘è­‰èªªæ˜</a
            >

            <p class="register-text">
              é‚„æ²’æœ‰æ•¸ä½èº«åˆ†æ†‘è­‰å—ï¼Ÿ
              <a target="_blank" href="https://wallet.gov.tw/zh-tw"
                >é»æˆ‘ç«‹å³ç”³è«‹</a
              >
            </p>
          </div>
        </div>
      </main>
    </div>

    <!-- ç™»å…¥æˆåŠŸä¸»é¸å–® -->
    <div class="success-screen hidden" id="mainMenu">
      <header class="page-header">
        <h1>
          <a class="header-href" href="/">ğŸšï¸ ç½å®³è£œåŠ©ç”³è«‹å¹³å°</a>
        </h1>
        <nav class="header-nav">
          <a href="#" onclick="logout(); return false;">ç™»å‡º</a>
          <a href="/">è¿”å›é¦–é </a>
        </nav>
      </header>

      <div class="success-content">
        <div class="success-form">
          <div class="success-title">æˆåŠŸç™»å…¥</div>
          <div class="success-icon-container">
            <svg
              width="48"
              height="48"
              viewBox="0 0 48 48"
              fill="#1E81B2"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle cx="24" cy="24" r="20" fill="#1E81B2"/>
              <path
                d="M20 32L10 22L12.8 19.2L20 26.4L35.2 11.2L38 14L20 32Z"
                fill="#FFFFFF"
              />
            </svg>
          </div>
          <div class="success-subtitle">æ‚¨å·²ç™»å…¥</div>
          <div class="success-email" id="successEmailDisplay">
            user@example.com
          </div>
        </div>

        <div class="history-actions">
          <button class="success-button secondary" onclick="showMyApplications()">
            æŸ¥çœ‹ç”³è«‹é€²åº¦
          </button>
          <button class="success-button primary" onclick="startApplicationFlow()">
            å‰å¾€è£œåŠ©ç”³è«‹
          </button>
        </div>
      </div>
    </div>

    <!-- ç”³è«‹æ­·å²è¨˜éŒ„ç•«é¢ -->
    <div class="history-screen hidden" id="myApplicationsScreen">
      <header class="page-header">
        <h1>
          <a class="header-href" href="/">ğŸšï¸ ç½å®³è£œåŠ©ç”³è«‹å¹³å°</a>
        </h1>
        <nav class="header-nav">
          <a href="#" onclick="backToMainMenu(); return false;">è¿”å›</a>
        </nav>
      </header>

      <main class="history-container" role="main">
        <h2 class="history-title">ç”³è«‹è¨˜éŒ„</h2>

        <div class="records" id="applicationsList">
          <!-- å‹•æ…‹è¼‰å…¥çš„ç”³è«‹è¨˜éŒ„ -->
        </div>

        <div class="history-actions">
          <button class="success-button secondary" onclick="backToMainMenu()">
            è¿”å›
          </button>
          <button class="success-button primary" onclick="startApplicationFlow()">
            å‰å¾€è£œåŠ©ç”³è«‹
          </button>
        </div>
      </main>
    </div>

    <!-- ç”³è«‹è¡¨å–®ç•«é¢ -->
    <div id="applyForm" class="hidden">
      <header class="page-header">
        <h1>
          <a class="header-href" href="/">ğŸšï¸ ç½å®³è£œåŠ©ç”³è«‹å¹³å°</a>
        </h1>
        <nav class="header-nav">
          <a href="/" onclick="backToMainMenu(); return false;">è¿”å›</a>
        </nav>
      </header>

      <main class="form-main">
        <h2 class="form-page-title">æ°´ç½è£œåŠ©ç”³è«‹</h2>

        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
          <div class="step-item active" id="indicator-step1">
            <div class="step-number">1</div>
            <div class="step-label">é©—è­‰èº«åˆ†</div>
          </div>
          <div class="step-item" id="indicator-step2">
            <div class="step-number">2</div>
            <div class="step-label">é©—è­‰æˆ¿å±‹æŒæœ‰</div>
          </div>
          <div class="step-item" id="indicator-step3">
            <div class="step-number">3</div>
            <div class="step-label">ä¸Šå‚³ç½æç…§ç‰‡</div>
          </div>
        </div>

        <!-- æ­¥é©Ÿ 1ï¼šé©—è­‰èº«åˆ†ï¼ˆåŸç™»å…¥ç•«é¢ï¼‰ -->
        <div class="form-step-container" id="form-step1">
          <div class="form-card">
            <h3 class="step-title">é©—è­‰èº«åˆ†</h3>
            <p class="step-desc">è«‹é¸æ“‡ä»¥ä¸‹æ–¹å¼é©—è­‰æ‚¨çš„èº«åˆ†</p>

            <div class="login-container">
              <div class="login-tabs">
                <div class="login-tab" data-tab="general" style="background-color: #e4f1fa !important; color: #1e81b2 !important;">
                  <span class="icon-spacer">ğŸ“§</span>Email é©—è­‰
                </div>
                <div class="login-tab active" data-tab="digital" style="background-color: #1e81b2 !important; color: #f8fafc !important;">
                  ğŸ“± æ•¸ä½èº«åˆ†æ†‘è­‰ (æ¨è–¦)
                </div>
              </div>

              <div id="general-login-form" class="login-form hidden">
            <div class="form-group">
              <label for="email">é›»å­ä¿¡ç®±</label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="è¼¸å…¥ä¿¡ç®±å¸³è™Ÿ"
                required
              />
            </div>

            <div class="form-group">
              <div class="flex-center-gap">
                <label for="password" class="no-margin-bottom">é©—è­‰ç¢¼</label>
                <small class="hint-text"> é©—è­‰ç¢¼å°‡ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®± </small>
              </div>
              <div class="input-with-button">
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="è¼¸å…¥é©—è­‰ç¢¼"
                  required
                />
                <button type="button" class="verification-send-btn">
                  ç™¼é€é©—è­‰ç¢¼
                </button>
              </div>
            </div>

            <div class="verification-container">
              <div class="verification-code">10541</div>
              <button type="button" class="refresh-captcha">
                <img
                  src="static/assets/refresh.png"
                  alt="æ›´æ–°é©—è­‰ç¢¼"
                  width="24"
                  height="24"
                />
              </button>
              <input
                type="text"
                class="verification-input"
                placeholder="è«‹è¼¸å…¥å·¦æ–¹åœ–ç‰‡ä¸­çš„æ–‡å­—"
                required
              />
            </div>

            <button type="submit" class="login-btn">é–‹å§‹é©—è­‰</button>

            <div class="divider">
              <div class="divider-line"></div>
              <span class="divider-text">æˆ–</span>
              <div class="divider-line"></div>
            </div>

            <button type="button" class="google-btn">
              <!-- Google SVG Icon -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                x="0px"
                y="0px"
                width="30"
                height="30"
                viewBox="0 0 48 48"
                style="vertical-align: middle; position: relative; top: -0.5px"
              >
                <path
                  fill="#FFC107"
                  d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                ></path>
                <path
                  fill="#FF3D00"
                  d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
                ></path>
                <path
                  fill="#4CAF50"
                  d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
                ></path>
                <path
                  fill="#1976D2"
                  d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                ></path>
              </svg>
              Google å¸³è™Ÿé©—è­‰
            </button>
          </div>

              <div id="digital-login-form" class="login-form">
                <div class="digital-header">
                  <div class="digital-title">æ•¸ä½æ†‘è­‰çš®å¤¾APP</div>
                  <div class="digital-subtitle">æ•¸ä½èº«åˆ†æ†‘è­‰é©—è­‰æ–¹å¼</div>
                </div>

                <div class="qr-code-container">
                  <div class="qr-code-inner">
                    <img
                      id="identityQrCode"
                      src=""
                      alt="QR Code"
                      width="188"
                      height="188"
                      role="img"
                      aria-label="æ•¸ä½æ†‘è­‰ QR ç¢¼"
                    />
                    <div class="qr-code-timer">
                      <span class="timer-text">è«‹æ–¼ </span>
                      <span class="countdown-time" id="identityCountdown">5:00</span>
                      <span class="timer-text"> å…§å®Œæˆæƒæ</span>
                    </div>
                  </div>
                </div>

                <p class="qr-hint">ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼é©—è­‰èº«åˆ†</p>

                <div class="divider">
                  <div class="divider-line"></div>
                </div>

                <a
                  href="https://moda.gov.tw/major-policies/wallet/1695"
                  target="_blank"
                  class="link-text"
                  >é—œæ–¼æ•¸ä½èº«åˆ†è­‰æ†‘è­‰èªªæ˜</a
                >

                <p class="register-text">
                  é‚„æ²’æœ‰æ•¸ä½èº«åˆ†æ†‘è­‰å—ï¼Ÿ
                  <a target="_blank" href="https://wallet.gov.tw/zh-tw"
                    >é»æˆ‘ç«‹å³ç”³è«‹</a
                  >
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- æ­¥é©Ÿ 2ï¼šé©—è­‰æˆ¿å±‹æŒæœ‰æ†‘è­‰ -->
        <div class="form-step-container hidden" id="form-step2">
          <div class="form-card">
            <div class="login-container">
              <div class="login-form">
                <div class="digital-header">
                  <div class="digital-title">æ•¸ä½æ†‘è­‰çš®å¤¾APP</div>
                  <div class="digital-subtitle">æˆ¿å±‹æŒæœ‰æ†‘è­‰é©—è­‰æ–¹å¼</div>
                </div>

                <div class="qr-code-container">
                  <div class="qr-code-inner">
                    <img
                      id="propertyQrCode"
                      src=""
                      alt="æˆ¿å±‹æŒæœ‰æ†‘è­‰ QR Code"
                      width="188"
                      height="188"
                      role="img"
                      aria-label="æˆ¿å±‹æŒæœ‰æ†‘è­‰ QR ç¢¼"
                    />
                    <div class="qr-code-timer">
                      <span class="timer-text">è«‹æ–¼ </span>
                      <span class="countdown-time" id="propertyCountdown">5:00</span>
                      <span class="timer-text"> å…§å®Œæˆæƒæ</span>
                    </div>
                  </div>
                </div>

                <p class="qr-hint">ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼é©—è­‰æˆ¿å±‹æŒæœ‰</p>

                <div class="divider">
                  <div class="divider-line"></div>
                </div>

                <div class="security-notice" style="background: #eff6ff; border-left: 4px solid #1e81b2; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                  <h4 style="font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">ğŸ”’ å®‰å…¨æç¤º</h4>
                  <p style="font-size: 13px; color: #1e40af; line-height: 1.6; margin: 0;">
                    æ‚¨çš„å€‹äººè³‡æ–™å—åˆ°åš´æ ¼ä¿è­·ï¼Œæˆ‘å€‘åƒ…ç”¨æ­¤é€²è¡Œèº«ä»½æ ¸é©—ï¼Œå°‡åš´æ ¼éµå®ˆç›¸é—œéš±ç§æ³•è¦ã€‚æ‰€æœ‰è³‡æ–™å‚³è¼¸çš†ç¶“éåŠ å¯†è™•ç†ã€‚
                  </p>
                </div>

                <p class="register-text">
                  é‚„æ²’æœ‰æˆ¿å±‹æŒæœ‰æ†‘è­‰å—ï¼Ÿ
                  <a target="_blank" href="https://wallet.gov.tw/zh-tw">é»æˆ‘ç«‹å³ç”³è«‹</a>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- æ­¥é©Ÿ 3ï¼šä¸Šå‚³ç½æç…§ç‰‡ -->
        <div class="form-step-container hidden" id="form-step3">
          <div class="form-card">
            <h3 class="step-title">ä¸Šå‚³ç½æç…§ç‰‡</h3>
            <p class="step-desc">è«‹ä¸Šå‚³ç½å®³ç…§ç‰‡ï¼Œä»»æ„ä¸€ç¨®çš†æœ‰é–€æª»</p>

            <div class="form-group">
              <label for="disasterDate">ç½å®³ç™¼ç”Ÿæ—¥æœŸ <span class="required">*</span></label>
              <input type="date" id="disasterDate" class="form-input" placeholder="è¥¿å…ƒ xxxxå¹´ xxæœˆ xxæ—¥" required />
            </div>

            <div class="form-group">
              <label for="disasterDesc">ç½å®³æè¿°ï¼ˆé¸å¡«ï¼‰</label>
              <textarea 
                id="disasterDesc" 
                class="form-textarea" 
                placeholder="è«‹ç°¡å–®æè¿°ç½å®³æƒ…æ³"
                maxlength="200"
                rows="4"
              ></textarea>
              <div class="char-counter">
                <span id="charCount">0</span>/200
              </div>
            </div>

            <div class="form-group">
              <label>ç½å®³ç…§ç‰‡ <span class="required">*</span></label>
              <div class="file-upload-box" onclick="document.getElementById('disasterPhotos').click()">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-text">
                  <p><strong>é»æ“Šä¸Šå‚³æˆ–æ‹–æ›³åœ–æª”å€</strong></p>
                  <p class="upload-hint">æ”¯æ´ JPGãƒ»PNGãƒ»PDF æª”æ¡ˆ</p>
                </div>
              </div>
              <input 
                type="file" 
                id="disasterPhotos" 
                class="file-input-hidden" 
                multiple 
                accept=".jpg,.jpeg,.png,.pdf"
                onchange="handlePhotoUpload(event)"
              />
            </div>

            <div id="photoPreviewContainer" class="photo-preview-container">
              <!-- å·²ä¸Šå‚³çš„ç…§ç‰‡é è¦½å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>

            <div class="form-actions-row">
              <button class="btn btn-outline" onclick="prevFormStep(2)">
                æš«å­˜è‰ç¨¿
              </button>
              <button class="btn btn-primary" onclick="submitFloodApplication()">
                é€å‡ºç”³è«‹
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- ç”³è«‹æäº¤æˆåŠŸç•«é¢ -->
    <div id="successScreen" class="hidden">
      <header class="page-header">
        <h1>
          <a class="header-href" href="/">ğŸšï¸ ç½å®³è£œåŠ©ç”³è«‹å¹³å°</a>
        </h1>
        <nav class="header-nav">
          <a href="/">è¿”å›é¦–é </a>
        </nav>
      </header>

      <main class="form-main">
        <h2 class="form-page-title">æ°´ç½è£œåŠ©ç”³è«‹</h2>

        <div class="success-card-wrapper">
          <div class="success-card">
            <div class="success-icon-large">âœ“</div>
            <h3 class="success-title">æ‚¨å·²å®Œæˆç”³è«‹</h3>
            <p class="success-subtitle">
              å¯©æ ¸éœ€3-5å€‹å·¥ä½œå¤©ï¼Œè«‹è€å¿ƒç­‰å€™
            </p>

            <div class="success-actions">
              <button class="btn btn-outline" onclick="backToMainMenu()">
                å›åˆ°é¦–é 
              </button>
              <button class="btn btn-primary" onclick="showMyApplications()">
                æŸ¥çœ‹ç”³è«‹é€²åº¦
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- VP æ†‘è­‰é ˜å– Modal -->
    <div id="vpClaimModal" class="modal-overlay hidden">
      <div class="modal-container" style="max-width: 600px; width: 90%;">
        <div style="position: relative; background: white; border-radius: 16px; padding: 0; overflow: hidden;">
          <!-- é—œé–‰æŒ‰éˆ• -->
          <button 
            onclick="closeVPClaimModal()" 
            style="position: absolute; top: 20px; right: 20px; z-index: 10; background: none; border: none; font-size: 28px; cursor: pointer; color: #94a3b8; padding: 0; width: 32px; height: 32px; line-height: 1; transition: color 0.2s;"
            onmouseover="this.style.color='#64748b'" 
            onmouseout="this.style.color='#94a3b8'">
            Ã—
          </button>

          <div style="padding: 40px;">
            <!-- æ¨™é¡Œå€ -->
            <div class="digital-header" style="text-align: center; margin-bottom: 32px;">
              <div style="font-size: 48px; margin-bottom: 12px;">ğŸ…</div>
              <div class="digital-title" style="font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">
                é ˜å–ç½å®³è£œåŠ©è³‡æ ¼æ†‘è­‰
              </div>
              <div class="digital-subtitle" style="font-size: 14px; color: #64748b;">
                å°‡æ†‘è­‰å­˜å…¥æ‚¨çš„æ•¸ä½çš®å¤¾
              </div>
            </div>

            <!-- QR Code å€ -->
            <div class="qr-code-container" style="background: #f8fafc; border-radius: 12px; padding: 32px; margin-bottom: 24px;">
              <div class="qr-code-inner" style="text-align: center;">
                <div style="width: 188px; height: 188px; margin: 0 auto; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 16px;">
                  <img
                    id="vpQrCode"
                    src=""
                    alt="ç½å®³è£œåŠ©æ†‘è­‰ QR Code"
                    width="188"
                    height="188"
                    style="border-radius: 8px;"
                  />
                </div>
                <div class="qr-code-timer">
                  <span class="timer-text">è«‹æ–¼ </span>
                  <span class="countdown-time" id="vpCountdown">5:00</span>
                  <span class="timer-text"> å…§å®Œæˆæƒæ</span>
                </div>
              </div>
            </div>

            <!-- æç¤ºæ–‡å­— -->
            <p class="qr-hint" style="text-align: center; color: #64748b; font-size: 14px; margin-bottom: 24px;">
              ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼é ˜å–æ†‘è­‰
            </p>

            <!-- åˆ†éš”ç·š -->
            <div class="divider" style="margin: 24px 0;">
              <div class="divider-line"></div>
            </div>

            <!-- èªªæ˜å€ -->
            <div style="background: #eff6ff; border-left: 4px solid #1e81b2; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
              <h4 style="font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">ğŸ“± é—œæ–¼æ•¸ä½æ†‘è­‰</h4>
              <p style="font-size: 13px; color: #1e40af; line-height: 1.6; margin: 0;">
                æ­¤æ†‘è­‰å°‡å„²å­˜æ–¼æ‚¨çš„æ•¸ä½çš®å¤¾ä¸­ï¼Œå¯ä½œç‚ºç½å®³è£œåŠ©è³‡æ ¼çš„è­‰æ˜ã€‚æ‚¨å¯ä»¥åœ¨éœ€è¦æ™‚å‡ºç¤ºæ­¤æ†‘è­‰ï¼Œæˆ–ç”¨æ–¼å¾ŒçºŒè£œåŠ©é‡‘é ˜å–ã€‚
              </p>
            </div>

            <!-- é€£çµ -->
            <p class="register-text" style="text-align: center; font-size: 13px; color: #64748b; margin: 0;">
              é‚„æ²’æœ‰æ•¸ä½æ†‘è­‰çš®å¤¾å—ï¼Ÿ
              <a target="_blank" href="https://wallet.gov.tw/zh-tw" style="color: #1e81b2; text-decoration: none; font-weight: 500;">é»æˆ‘ç«‹å³ä¸‹è¼‰</a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- è¼‰å…¥é…ç½®ç®¡ç†æ¨¡çµ„ -->
    <script src="/static/js/config.js"></script>
    <script>
      // å…¨åŸŸè®Šæ•¸
      let API_BASE = null; // å°‡ç”±é…ç½®æ¨¡çµ„è¨­å®š
      let accessToken = localStorage.getItem("applicant_token");
      let currentUser = JSON.parse(
        localStorage.getItem("applicant_user") || "null"
      );
      let currentStep = 1;
      let selectedDocuments = []; // å­˜å„²é¸ä¸­çš„æ–‡ä»¶

      // Digital ID flow control
      let pollingIntervalId = null;
      let countdownIntervalId = null;
      let activePolling = false;
      
      // Property verification control
      let propertyPollingIntervalId = null;
      let propertyCountdownIntervalId = null;
      
      // èº«åˆ†é©—è­‰å’Œæˆ¿å±‹é©—è­‰è³‡æ–™
      let identityVerified = false;
      let propertyVerified = false;
      let idVerificationData = null;
      let propertyVerificationData = null;

      // Lottie å‹•ç•«å¯¦ä¾‹
      let lottieAnimation = null;

      // é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–ï¼ˆçµ±ä¸€çš„åˆå§‹åŒ–å‡½æ•¸ï¼‰
      document.addEventListener("DOMContentLoaded", function() {
        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        initializeApp();
        
        // åˆå§‹åŒ–æ–°èè¼ªæ’­
        initNewsCarousel();
        
        // åˆå§‹åŒ–å­—æ•¸çµ±è¨ˆ
        const textarea = document.getElementById('disasterDesc');
        const charCount = document.getElementById('charCount');
        if (textarea && charCount) {
          textarea.addEventListener('input', () => {
            charCount.textContent = textarea.value.length;
          });
        }
        
        // åˆå§‹åŒ– Lottie å‹•ç•«
        initLottieAnimation();
      });

      // åˆå§‹åŒ– Lottie å‹•ç•«
      function initLottieAnimation() {
        try {
          if (typeof lottie !== 'undefined') {
            const container = document.getElementById('loadingAnimation');
            if (container) {
              lottieAnimation = lottie.loadAnimation({
                container: container,
                renderer: 'svg',
                loop: true,
                autoplay: false,
                path: '/static/assets/loading-animation.json'
              });
              console.log('âœ… Lottie å‹•ç•«åˆå§‹åŒ–æˆåŠŸ');
            }
          }
        } catch (error) {
          console.warn('âš ï¸ Lottie å‹•ç•«åˆå§‹åŒ–å¤±æ•—:', error);
        }
      }

      // é¡¯ç¤º Loading å‹•ç•«
      function showLoadingAnimation(message = 'é©—è­‰ä¸­ï¼Œè«‹ç¨å€™...') {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
          const messageEl = overlay.querySelector('p');
          if (messageEl) {
            messageEl.textContent = message;
          }
          if (lottieAnimation) {
            lottieAnimation.play();
          }
        }
      }

      // éš±è— Loading å‹•ç•«
      function hideLoadingAnimation() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
          overlay.style.display = 'none';
          if (lottieAnimation) {
            lottieAnimation.stop();
          }
        }
      }

      // å³æ™‚æ¶ˆæ¯è¼ªæ’­åˆå§‹åŒ–
      function initNewsCarousel() {
        const newsItems = document.querySelectorAll('.news-item');
        if (newsItems.length === 0) return;

        let currentIndex = 0;

        function showNextNews() {
          // éš±è—ç•¶å‰é …ç›®
          newsItems[currentIndex].classList.remove('active');
          
          // ç§»å‹•åˆ°ä¸‹ä¸€å€‹é …ç›®
          currentIndex = (currentIndex + 1) % newsItems.length;
          
          // é¡¯ç¤ºä¸‹ä¸€å€‹é …ç›®
          newsItems[currentIndex].classList.add('active');
        }

        // æ¯ 5 ç§’åˆ‡æ›ä¸€æ¬¡
        setInterval(showNextNews, 5000);
      }

      // é–‹å§‹æ°´ç½è£œåŠ©ç”³è«‹
      function startFloodApplication() {
        console.log('ğŸŒŠ é–‹å§‹æ°´ç½è£œåŠ©ç”³è«‹');
        
        // éš±è—é¦–é 
        document.getElementById('subsidyHomePage').classList.add('hidden');
        
        // å¦‚æœå·²ç™»å…¥ï¼Œç›´æ¥é¡¯ç¤ºç”³è«‹è¡¨å–®
        if (accessToken && currentUser) {
          showApplyForm();
        } else {
          // å¦å‰‡é¡¯ç¤ºç™»å…¥ç•«é¢
          document.getElementById('loginScreen').classList.remove('hidden');
        }
      }

      // é¡¯ç¤ºå³å°‡é–‹æ”¾æç¤º
      function showComingSoon(subsidyType) {
        alert(`ğŸ“¢ ${subsidyType}å³å°‡é–‹æ”¾ç”³è«‹\n\nè«‹å¯†åˆ‡é—œæ³¨ç¶²ç«™å…¬å‘Šï¼Œæˆ‘å€‘æœƒåœ¨é–‹æ”¾å¾Œç¬¬ä¸€æ™‚é–“é€šçŸ¥æ‚¨ï¼`);
      }

      // è¿”å›é¦–é 
      function backToSubsidyHome() {
        // éš±è—æ‰€æœ‰ç•«é¢
        document.querySelectorAll('body > div').forEach(div => {
          div.classList.add('hidden');
        });
        
        // é¡¯ç¤ºé¦–é 
        document.getElementById('subsidyHomePage').classList.remove('hidden');
        
        // æ¸…é™¤æ•¸ä½èº«åˆ†é©—è­‰ç›¸é—œçš„å®šæ™‚å™¨
        clearDigitalIntervals();
      }

      // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
      async function initializeApp() {
        // è¼‰å…¥é…ç½®
        await initializeConfig();
        API_BASE = getApiBase();

        // ğŸ¯ å…ˆæª¢æŸ¥ Google OAuth callback
        const isGoogleLogin = checkGoogleAuthToken();

        // å¦‚æœæ­£åœ¨è™•ç† Google ç™»å…¥ï¼Œå°±ä¸è¦ç¹¼çºŒåŸ·è¡Œ
        if (isGoogleLogin) {
          console.log("ğŸ”„ æ­£åœ¨è™•ç† Google ç™»å…¥ï¼Œè·³éå…¶ä»–åˆå§‹åŒ–");
          return;
        }

        // å¦‚æœæ²’æœ‰å¾ Google ç™»å…¥ï¼Œæª¢æŸ¥ç¾æœ‰ç™»å…¥ç‹€æ…‹
        if (!accessToken || !currentUser) {
          accessToken = localStorage.getItem("applicant_token");
          const userStr = localStorage.getItem("applicant_user");
          if (userStr) {
            try {
              currentUser = JSON.parse(userStr);
            } catch (e) {
              console.error("è§£æ currentUser å¤±æ•—:", e);
            }
          }
        }

        // æª¢æŸ¥ URL åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        if (accessToken && currentUser) {
          console.log("âœ… å·²æœ‰ç™»å…¥ç‹€æ…‹");
          if (action === 'apply') {
            // å¾é¦–é é»æ“Šç”³è«‹é€²ä¾†ï¼Œé¡¯ç¤ºä¸»é¸å–®è®“ç”¨æˆ¶é¸æ“‡
            console.log("ğŸ“ é¡¯ç¤ºä¸»é¸å–®");
            showMainMenu();
          } else {
            // ç›´æ¥è¨ªå•é é¢ï¼Œé¡¯ç¤ºä¸»é¸å–®
            showMainMenu();
          }
        } else {
          console.log("âŒ æœªç™»å…¥");
          if (action === 'apply') {
            // å¾é¦–é é»æ“Šç”³è«‹é€²ä¾†ï¼Œé¡¯ç¤ºç™»å…¥ç•«é¢
            console.log("ğŸ“ é¡¯ç¤ºç™»å…¥ç•«é¢");
            showScreen('loginScreen');
            initializeMainLoginUI();
          } else {
            // ç›´æ¥è¨ªå•é é¢ï¼Œä¹Ÿé¡¯ç¤ºç™»å…¥ç•«é¢
            showScreen('loginScreen');
            initializeMainLoginUI();
          }
        }
      }

      // å‰å¾€è£œåŠ©ç”³è«‹ï¼ˆå¾ä¸»é¸å–®é»æ“Šå¾Œé€²å…¥ä¸‰æ­¥é©Ÿæµç¨‹ï¼‰
      function startApplicationFlow() {
        console.log('ğŸš€ é–‹å§‹ç”³è«‹æµç¨‹');
        showScreen('applyForm');
        // é‡ç½®æ­¥é©Ÿ
        currentFormStep = 1;
        // é¡¯ç¤ºæ­¥é©Ÿ1ä¸¦åˆå§‹åŒ–
        document.getElementById('form-step1').classList.remove('hidden');
        document.getElementById('form-step2').classList.add('hidden');
        document.getElementById('form-step3').classList.add('hidden');
        updateStepIndicators();
        
        // å¼·åˆ¶è¨­ç½®æ­¥é©Ÿä¸€çš„ Tab é¡è‰²ï¼ˆåœ¨ initializeStepOneUI ä¹‹å‰ï¼‰
        setTimeout(() => {
          const step1Tabs = document.querySelectorAll('#form-step1 .login-tab');
          step1Tabs.forEach(tab => {
            if (tab.getAttribute('data-tab') === 'digital' && tab.classList.contains('active')) {
              tab.style.backgroundColor = '#1e81b2';
              tab.style.color = '#f8fafc';
            } else {
              tab.style.backgroundColor = '#e4f1fa';
              tab.style.color = '#1e81b2';
            }
          });
        }, 50);
        
        // åˆå§‹åŒ–æ­¥é©Ÿ1çš„ç™»å…¥ç•Œé¢
        initializeStepOneUI();
        // è‡ªå‹•è§¸ç™¼æ•¸ä½èº«åˆ†é©—è­‰
        setTimeout(() => {
          loginWithDigitalIDStepOne();
        }, 500);
      }

      // åˆå§‹åŒ–ä¸»ç™»å…¥ç•«é¢
      function initializeMainLoginUI() {
        const DEFAULT_QR = "";
        const tabs = document.querySelectorAll(".login-tab");
        const forms = {
          general: document.getElementById("general-login-form-main"),
          digital: document.getElementById("digital-login-form-main"),
        };

        const qrImg = document.querySelector("#loginQrCode");
        const countdownEl = document.querySelector("#loginCountdown");
        let verification_code = "";

        // ç¢ºä¿ QR æœ‰é è¨­åœ–ç‰‡
        if (qrImg && (!qrImg.getAttribute("src") || qrImg.getAttribute("src") === "")) {
          qrImg.src = DEFAULT_QR;
        }
        if (countdownEl && (!countdownEl.textContent || countdownEl.textContent.trim() === "")) {
          countdownEl.textContent = "5:00";
        }

        // Tab åˆ‡æ›åŠŸèƒ½
        function setActiveTab(tabEl, startFlow = true) {
          tabs.forEach((t) => {
            t.classList.remove("active");
            // ç§»é™¤ active æ¨£å¼æ™‚ï¼Œè¨­å®šç‚ºé active çš„å…§è¯æ¨£å¼
            t.style.backgroundColor = "#e4f1fa";
            t.style.color = "#1e81b2";
          });
          tabEl.classList.add("active");
          // æ·»åŠ  active æ¨£å¼æ™‚ï¼Œè¨­å®šç‚º active çš„å…§è¯æ¨£å¼
          tabEl.style.backgroundColor = "#1e81b2";
          tabEl.style.color = "#f8fafc";

          Object.values(forms).forEach((form) => form.classList.add("hidden"));

          const formId = tabEl.getAttribute("data-tab");
          if (forms[formId]) forms[formId].classList.remove("hidden");
        }

        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const formId = this.getAttribute("data-tab");
            if (formId === "general") {
              clearDigitalIntervals();
            }
            setActiveTab(this, false);
          });
        });

        // åˆå§‹åŒ– active tab
        const initialActive = document.querySelector(".login-tab.active") || tabs[0];
        if (initialActive) setActiveTab(initialActive, false);

        // Email ç™»å…¥æŒ‰éˆ•
        const loginBtn = document.querySelector(".login-btn-main");
        if (loginBtn) {
          loginBtn.addEventListener("click", async function () {
            const email = document.getElementById("email-main").value;
            const verificationCode = document.getElementById("password-main").value;
            const captchaInput = document.querySelector(".verification-input-main").value;
            const captchaText = document.querySelector(".verification-code-main").textContent;

            if (!email || !verificationCode || !captchaInput) {
              alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
              return;
            }

            if (captchaInput !== captchaText) {
              alert("åœ–å½¢é©—è­‰ç¢¼éŒ¯èª¤");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  login_type: "password",
                  verification_code: verificationCode,
                  verify: true,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                accessToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem("applicant_token", accessToken);
                localStorage.setItem("applicant_user", JSON.stringify(currentUser));
                
                console.log("âœ… Email ç™»å…¥æˆåŠŸ");
                showMainMenu();
              } else {
                const error = await response.json();
                alert("ç™»å…¥å¤±æ•—ï¼š" + (error.detail?.message || error.detail || "è«‹ç¨å¾Œå†è©¦"));
              }
            } catch (error) {
              console.error("ç™»å…¥éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // Google ç™»å…¥æŒ‰éˆ•
        const googleBtn = document.querySelector(".google-btn-main");
        if (googleBtn) {
          googleBtn.addEventListener("click", function () {
            window.location.href = "/api/v1/auth/google/login";
          });
        }

        // åˆ·æ–°åœ–å½¢é©—è­‰ç¢¼
        const refreshCaptchaBtn = document.querySelector(".refresh-captcha-main");
        function generateCaptcha() {
          const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          let captcha = "";
          for (let i = 0; i < 5; i++) {
            captcha += chars[Math.floor(Math.random() * chars.length)];
          }
          const captchaEl = document.querySelector(".verification-code-main");
          if (captchaEl) captchaEl.textContent = captcha;
        }

        if (refreshCaptchaBtn)
          refreshCaptchaBtn.addEventListener("click", generateCaptcha);
        generateCaptcha();

        // å¦‚æœæ•¸ä½ tab æ˜¯ activeï¼Œå•Ÿå‹•æ•¸ä½ç™»å…¥æµç¨‹
        const activeTabOnLoad = document.querySelector(".login-tab.active");
        if (activeTabOnLoad && activeTabOnLoad.getAttribute("data-tab") === "digital") {
          loginWithDigitalIDMain();
        }

        // æ•¸ä½ tab é»æ“Šäº‹ä»¶
        const digitalTab = document.querySelector('.login-tab[data-tab="digital"]');
        if (digitalTab) {
          digitalTab.addEventListener("click", () => {
            clearDigitalIntervals();
            setTimeout(() => loginWithDigitalIDMain(), 100);
          });
        }
      }

      // ä¸»ç™»å…¥ç•«é¢çš„æ•¸ä½èº«åˆ†é©—è­‰
      async function loginWithDigitalIDMain() {
        if (window._mixcurry_main_login_started) return;
        window._mixcurry_main_login_started = true;

        clearDigitalIntervals();
        if (activePolling) return;
        activePolling = true;

        const vpRef = "00000000_mixcurry_idcard";
        let transactionId = null;
        let remainingSeconds = 300;

        const qrImg = document.querySelector("#loginQrCode");
        const countdownEl = document.querySelector("#loginCountdown");

        function updateCountdownDisplay() {
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          if (countdownEl)
            countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        updateCountdownDisplay();
        countdownIntervalId = setInterval(() => {
          remainingSeconds--;
          if (remainingSeconds <= 0) {
            clearDigitalIntervals();
            updateCountdownDisplay();
            alert("é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°å˜—è©¦ç™»å…¥");
            return;
          }
          updateCountdownDisplay();
        }, 1000);

        try {
          const result = await fetch(`/api/v1/complete-flow/generate-vp-qrcode`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ref: vpRef }),
          });

          const data = await result.json();
          console.log("æ•¸ä½èº«åˆ†é©—è­‰å›æ‡‰:", data);

          if (!data || !data.success) {
            console.warn("generate-vp-qrcode failed");
            return;
          }

          if (qrImg && data.qrcode_image) qrImg.src = data.qrcode_image;
          transactionId = data.transaction_id;

          if (transactionId) {
            pollingIntervalId = setInterval(async () => {
              try {
                const pollResult = await fetch(`/api/v1/complete-flow/verify-vp`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ transaction_id: transactionId }),
                });
                const pollData = await pollResult.json();

                if (pollData && pollData.verified) {
                  console.log("é©—è­‰æˆåŠŸï¼Œä½¿ç”¨è€…è³‡æ–™ï¼š", pollData);
                  clearDigitalIntervals();
                  
                  // é¡¯ç¤º Loading å‹•ç•«
                  showLoadingAnimation('ç™»å…¥ä¸­ï¼Œè«‹ç¨å€™...');

                  try {
                    const loginResponse = await fetch("/api/v1/auth/login", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                        email: pollData.email,
                        password: "",
                        login_type: "password",
                      }),
                    });

                    if (loginResponse.ok) {
                      const loginData = await loginResponse.json();
                      accessToken = loginData.access_token;
                      currentUser = loginData.user;
                      localStorage.setItem("applicant_token", accessToken);
                      localStorage.setItem("applicant_user", JSON.stringify(currentUser));

                      console.log("âœ… æ•¸ä½èº«åˆ†ç™»å…¥æˆåŠŸ");
                      
                      // ç­‰å¾… 10 ç§’è®“å‹•ç•«æ’­æ”¾å®Œæ•´ï¼Œç„¶å¾Œæ‰è·³åˆ°ä¸»é¸å–®
                      setTimeout(() => {
                        hideLoadingAnimation();
                        showMainMenu();
                      }, 10000);
                    } else {
                      hideLoadingAnimation();
                      const error = await loginResponse.json();
                      alert("ç™»å…¥å¤±æ•—ï¼š" + (error.detail?.message || error.detail || "è«‹ç¨å¾Œå†è©¦"));
                    }
                  } catch (error) {
                    hideLoadingAnimation();
                    console.error("æ•¸ä½èº«åˆ†ç™»å…¥éŒ¯èª¤:", error);
                    alert("ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                  }
                }
              } catch (err) {
                console.error("è¼ªè©¢éŒ¯èª¤:", err);
              }
            }, 2000);
          }
        } catch (error) {
          console.error("æ•¸ä½èº«åˆ†é©—è­‰éŒ¯èª¤:", error);
        }
      }

      // åˆå§‹åŒ–æ­¥é©Ÿ1çš„ç™»å…¥ç•Œé¢ï¼ˆç”³è«‹æµç¨‹ä¸­çš„èº«åˆ†é©—è­‰ï¼‰
      function initializeStepOneUI() {
        const DEFAULT_QR = "";
        const tabs = document.querySelectorAll(".login-tab");
        const forms = {
          general: document.getElementById("general-login-form"),
          digital: document.getElementById("digital-login-form"),
        };

        const qrImg = document.querySelector(".qr-code-container img");
        const countdownEl = document.querySelector(".countdown-time");
        let verification_code = "";

        // ç¢ºä¿ QR æœ‰é è¨­åœ–ç‰‡
        if (
          qrImg &&
          (!qrImg.getAttribute("src") || qrImg.getAttribute("src") === "")
        ) {
          qrImg.src = DEFAULT_QR;
        }
        if (
          countdownEl &&
          (!countdownEl.textContent || countdownEl.textContent.trim() === "")
        ) {
          countdownEl.textContent = "5:00";
        }

        // Tab åˆ‡æ›åŠŸèƒ½
        function setActiveTab(tabEl, startFlow = true) {
          tabs.forEach((t) => {
            t.classList.remove("active");
            // ç§»é™¤ active æ¨£å¼æ™‚ï¼Œè¨­å®šç‚ºé active çš„å…§è¯æ¨£å¼
            t.style.backgroundColor = "#e4f1fa";
            t.style.color = "#1e81b2";
          });
          tabEl.classList.add("active");
          // æ·»åŠ  active æ¨£å¼æ™‚ï¼Œè¨­å®šç‚º active çš„å…§è¯æ¨£å¼
          tabEl.style.backgroundColor = "#1e81b2";
          tabEl.style.color = "#f8fafc";

          Object.values(forms).forEach((form) => form.classList.add("hidden"));

          const formId = tabEl.getAttribute("data-tab");
          if (forms[formId]) forms[formId].classList.remove("hidden");
        }

        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const formId = this.getAttribute("data-tab");
            if (formId === "general") {
              clearDigitalIntervals();
            }
            setActiveTab(this, false);
          });
        });

        // åˆå§‹åŒ– active tab
        const initialActive =
          document.querySelector(".login-tab.active") || tabs[0];
        if (initialActive) setActiveTab(initialActive, false);

        // Email é©—è­‰ç¢¼ç™¼é€æŒ‰éˆ•
        const verificationBtn = document.querySelector(
          ".verification-send-btn"
        );
        let timeLeft = 180;
        let countdownTimer = null;

        function startCountdown() {
          if (!verificationBtn) return;
          verificationBtn.disabled = true;
          timeLeft = 180;

          function updateButtonText() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            verificationBtn.textContent = `é‡æ–°ç™¼é€ (${minutes}:${seconds
              .toString()
              .padStart(2, "0")})`;

            if (timeLeft <= 0) {
              clearInterval(countdownTimer);
              verificationBtn.disabled = false;
              verificationBtn.textContent = "ç™¼é€é©—è­‰ç¢¼";
              return;
            }
            timeLeft--;
          }

          updateButtonText();
          countdownTimer = setInterval(updateButtonText, 1000);
        }

        if (verificationBtn) {
          verificationBtn.addEventListener("click", async function () {
            const email = document.getElementById("email").value;

            if (!email) {
              alert("è«‹è¼¸å…¥ Email");
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/email/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  is_verified: false,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                startCountdown();
                if (data.verification_code) {
                  verification_code = data.verification_code;
                  console.log("é©—è­‰ç¢¼(é–‹ç™¼ç”¨):", data.verification_code);
                  alert(
                    "âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼\n\n(é–‹ç™¼ç’°å¢ƒï¼šé©—è­‰ç¢¼å·²è¼¸å‡ºåˆ°Console)"
                  );
                } else {
                  alert("âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼");
                }
              } else {
                const error = await response.json();
                alert("ç™¼é€å¤±æ•—ï¼š" + (error.detail || "è«‹ç¨å¾Œå†è©¦"));
              }
            } catch (error) {
              console.error("ç™¼é€é©—è­‰ç¢¼éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // ç™»å…¥æŒ‰éˆ•
        const loginBtn = document.querySelector(".login-btn");
        if (loginBtn) {
          loginBtn.addEventListener("click", async function () {
            const email = document.getElementById("email").value;
            const verificationCode = document.getElementById("password").value;
            const captchaInputEl = document.querySelector(
              ".verification-input"
            );
            const captchaInput = captchaInputEl ? captchaInputEl.value : "";
            const captchaTextEl = document.querySelector(".verification-code");
            const captchaText = captchaTextEl ? captchaTextEl.textContent : "";

            if (!email) {
              alert("è«‹å¡«å¯«email");
              return;
            } else if (!verificationCode) {
              alert("è«‹å¡«å¯«é©—è­‰ç¢¼");
              return;
            } else if (!captchaInput) {
              alert("è«‹å¡«å¯«åœ–å½¢é©—è­‰ç¢¼");
              return;
            }

            if (verificationCode.length !== 6) {
              alert("é©—è­‰ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—");
              return;
            }

            if (verificationCode !== verification_code) {
              alert("é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            if (captchaInput !== captchaText) {
              alert("åœ–å½¢é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  login_type: "password",
                  verification_code: verificationCode,
                  verify: true,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                accessToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem("applicant_token", accessToken);
                localStorage.setItem(
                  "applicant_user",
                  JSON.stringify(currentUser)
                );

                // èº«åˆ†é©—è­‰æˆåŠŸï¼Œé€²å…¥æ­¥é©Ÿ2ï¼ˆæˆ¿å±‹æŒæœ‰é©—è­‰ï¼‰
                console.log("âœ… æ­¥é©Ÿ1å®Œæˆï¼šEmail èº«åˆ†é©—è­‰æˆåŠŸ");
                
                // é¡¯ç¤º loading å‹•ç•«
                showLoadingAnimation('èº«åˆ†é©—è­‰æˆåŠŸï¼æ­£åœ¨è™•ç†...');
                
                // å»¶é² 6 ç§’è®“å‹•ç•«æ’­æ”¾å®Œæ•´ï¼Œç„¶å¾Œé€²å…¥ä¸‹ä¸€æ­¥
                setTimeout(() => {
                  hideLoadingAnimation();
                  moveToStep2();
                }, 10000);
              } else {
                const error = await response.json();
                alert(
                  "é©—è­‰å¤±æ•—ï¼š" +
                    (error.detail?.message || error.detail || "è«‹ç¨å¾Œå†è©¦")
                );
              }
            } catch (error) {
              console.error("é©—è­‰éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // Google ç™»å…¥æŒ‰éˆ•
        const googleBtn = document.querySelector(".google-btn");
        if (googleBtn) {
          googleBtn.addEventListener("click", function () {
            window.location.href = "/api/v1/auth/google/login";
          });
        }

        // åˆ·æ–°åœ–å½¢é©—è­‰ç¢¼
        const refreshCaptchaBtn = document.querySelector(".refresh-captcha");
        function generateCaptcha() {
          const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          let captcha = "";
          for (let i = 0; i < 5; i++) {
            captcha += chars[Math.floor(Math.random() * chars.length)];
          }
          const captchaEl = document.querySelector(".verification-code");
          if (captchaEl) captchaEl.textContent = captcha;
        }

        if (refreshCaptchaBtn)
          refreshCaptchaBtn.addEventListener("click", generateCaptcha);
        generateCaptcha();

        // å¦‚æœæ•¸ä½ tab æ˜¯ activeï¼Œå•Ÿå‹•æ•¸ä½ç™»å…¥æµç¨‹
        const activeTabOnLoad = document.querySelector(".login-tab.active");
        if (
          activeTabOnLoad &&
          activeTabOnLoad.getAttribute("data-tab") === "digital"
        ) {
          loginWithDigitalIDStepOne();
        }

        // æ•¸ä½ tab é»æ“Šäº‹ä»¶
        const digitalTab = document.querySelector(
          '.login-tab[data-tab="digital"]'
        );
        if (digitalTab) {
          digitalTab.addEventListener("click", () => {
            clearDigitalIntervals();
            setTimeout(() => loginWithDigitalIDStepOne(), 100);
          });
        }
      }

      // æ­¥é©Ÿ1çš„æ•¸ä½èº«åˆ†é©—è­‰
      async function loginWithDigitalIDStepOne() {
        if (window._mixcurry_step_one_started) return;
        window._mixcurry_step_one_started = true;

        clearDigitalIntervals();
        if (activePolling) return;
        activePolling = true;

        const vpRef = "00000000_mixcurry_idcard";
        let transactionId = null;
        let remainingSeconds = 300;

        const qrImg = document.querySelector("#identityQrCode");
        const countdownEl = document.querySelector("#identityCountdown");
        const DEFAULT_QR = "";

        if (qrImg) qrImg.src = qrImg.getAttribute("src") || DEFAULT_QR;

        function updateCountdownDisplay() {
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          if (countdownEl)
            countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
        }

        updateCountdownDisplay();
        countdownIntervalId = setInterval(() => {
          remainingSeconds--;
          if (remainingSeconds <= 0) {
            clearDigitalIntervals();
            updateCountdownDisplay();
            alert("é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°å˜—è©¦");
            return;
          }
          updateCountdownDisplay();
        }, 1000);

        try {
          const result = await fetch(`/api/v1/complete-flow/generate-vp-qrcode`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ref: vpRef }),
          });

          const data = await result.json();
          console.log("æ•¸ä½èº«åˆ†é©—è­‰å›æ‡‰:", data);

          if (!data || !data.success) {
            console.warn("generate-vp-qrcode failed");
            return;
          }

          if (qrImg && data.qrcode_image) qrImg.src = data.qrcode_image;
          transactionId = data.transaction_id;

          if (transactionId) {
            pollingIntervalId = setInterval(async () => {
              try {
                const pollResult = await fetch(`/api/v1/complete-flow/verify-vp`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ transaction_id: transactionId }),
                });
                const pollData = await pollResult.json();
                
                console.log('æ•¸ä½èº«åˆ†é©—è­‰è¼ªè©¢çµæœ:', pollData);

                if (pollData && pollData.verified) {
                  console.log("âœ… æ­¥é©Ÿ1å®Œæˆï¼šæ•¸ä½èº«åˆ†é©—è­‰æˆåŠŸ");
                  clearDigitalIntervals();
                  
                  // ä¿å­˜èº«åˆ†é©—è­‰è³‡æ–™ï¼ˆæ­¥é©Ÿ2éœ€è¦ç”¨æ–¼æ¯”å°ï¼‰
                  idVerificationData = {
                    email: pollData.email,
                    name: pollData.name,
                    id_number: pollData.id_number,
                    phone: pollData.phone,
                    verified_at: new Date().toISOString()
                  };
                  
                  console.log('å„²å­˜èº«åˆ†é©—è­‰è³‡æ–™:', idVerificationData);
                  
                  // å‰µå»ºè‡¨æ™‚ç™»å…¥ç‹€æ…‹ï¼ˆä½¿ç”¨é©—è­‰å¾Œçš„è³‡æ–™ï¼‰
                  try {
                    const loginResponse = await fetch('/api/v1/auth/login', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        email: pollData.email,
                        password: '',
                        login_type: 'password'
                      })
                    });
                    
                    if (loginResponse.ok) {
                      const loginData = await loginResponse.json();
                      accessToken = loginData.access_token;
                      currentUser = loginData.user;
                      localStorage.setItem('applicant_token', accessToken);
                      localStorage.setItem('applicant_user', JSON.stringify(currentUser));
                      console.log('âœ… ç™»å…¥ç‹€æ…‹å·²å»ºç«‹:', currentUser);
                    } else {
                      console.warn('ç™»å…¥å¤±æ•—ï¼Œä½†ç¹¼çºŒæµç¨‹');
                      // å³ä½¿ç™»å…¥å¤±æ•—ï¼Œä»ç„¶å¯ä»¥ç¹¼çºŒï¼ˆä½¿ç”¨é©—è­‰è³‡æ–™ï¼‰
                      currentUser = {
                        email: pollData.email,
                        full_name: pollData.name,
                        id_number: pollData.id_number,
                        phone: pollData.phone
                      };
                    }
                  } catch (loginError) {
                    console.error('ç™»å…¥éŒ¯èª¤:', loginError);
                    // ä½¿ç”¨é©—è­‰è³‡æ–™ä½œç‚ºè‡¨æ™‚ç”¨æˆ¶è³‡æ–™
                    currentUser = {
                      email: pollData.email,
                      full_name: pollData.name,
                      id_number: pollData.id_number,
                      phone: pollData.phone
                    };
                  }
                  
                  identityVerified = true;
                  console.log("âœ… æ­¥é©Ÿ1å®Œæˆï¼šæ•¸ä½èº«åˆ†é©—è­‰æˆåŠŸ");
                  
                  // é¡¯ç¤º loading å‹•ç•«
                  showLoadingAnimation('èº«åˆ†é©—è­‰æˆåŠŸï¼æ­£åœ¨è™•ç†...');
                  
                  // å»¶é² 6 ç§’è®“å‹•ç•«æ’­æ”¾å®Œæ•´ï¼Œç„¶å¾Œé€²å…¥ä¸‹ä¸€æ­¥
                  setTimeout(() => {
                    hideLoadingAnimation();
                    moveToStep2();
                  }, 10000);
                }
              } catch (err) {
                console.error("è¼ªè©¢éŒ¯èª¤:", err);
              }
            }, 2000);
          }
        } catch (error) {
          console.error("æ•¸ä½èº«åˆ†é©—è­‰éŒ¯èª¤:", error);
        }
      }

      function clearDigitalIntervals() {
        if (pollingIntervalId) {
          clearInterval(pollingIntervalId);
          pollingIntervalId = null;
        }
        if (countdownIntervalId) {
          clearInterval(countdownIntervalId);
          countdownIntervalId = null;
        }
        activePolling = false;
        try {
          window._mixcurry_digital_flow_started = false;
        } catch (e) {
          /* ignore */
        }
      }

      window.stopVpPolling = function () {
        clearDigitalIntervals();
      };

      // æª¢æŸ¥ URL ä¸­çš„ Google OAuth tokenï¼ˆå¾ callback é‡å®šå‘å›ä¾†ï¼‰
      function checkGoogleAuthToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("access_token");
        const refreshToken = urlParams.get("refresh_token");

        if (token) {
          console.log("âœ… æª¢æ¸¬åˆ° Google OAuth tokenï¼Œè™•ç†ç™»å…¥...");

          // å„²å­˜ token
          accessToken = token;
          localStorage.setItem("applicant_token", token);
          if (refreshToken) {
            localStorage.setItem("applicant_refresh_token", refreshToken);
          }

          // æ¸…ç† URLï¼ˆç§»é™¤ token åƒæ•¸ï¼‰
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );

          // å–å¾—ä½¿ç”¨è€…è³‡è¨Šä¸¦é¡¯ç¤ºä¸»é¸å–®
          getUserInfoAndShowMenu();

          return true; // è¡¨ç¤ºæ­£åœ¨è™•ç† Google ç™»å…¥
        }

        return false; // æ²’æœ‰ Google token
      }

      // å–å¾—ä½¿ç”¨è€…è³‡è¨Šä¸¦é¡¯ç¤ºä¸»é¸å–®
      async function getUserInfoAndShowMenu() {
        if (!API_BASE) {
          await initializeConfig();
          API_BASE = getApiBase();
        }

        try {
          const response = await fetch(`${API_BASE}/users/me`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            const userData = await response.json();
            currentUser = userData.data || userData;
            localStorage.setItem("applicant_user", JSON.stringify(currentUser));
            showMainMenu();
          } else {
            console.error("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š");
            alert("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦");
            logout();
          }
        } catch (error) {
          console.error("å–å¾—ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:", error);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦");
          logout();
        }
      }

      // Google ç™»å…¥å‡½æ•¸
      function loginWithGoogle() {
        console.log("å•Ÿå‹• Google OAuth ç™»å…¥...");
        // é‡å®šå‘åˆ°å¾Œç«¯çš„ Google OAuth ç«¯é»
        window.location.href = "/api/v1/auth/google/login";
      }

      function showScreen(screenId) {
        // éš±è—æ‰€æœ‰ç•«é¢
        const screens = [
          "loginScreen",
          "mainMenu",
          "myApplicationsScreen",
          "applyForm",
          "successScreen",
        ];

        screens.forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            if (
              el.classList.contains("success-screen") ||
              el.classList.contains("history-screen")
            ) {
              el.classList.remove("active");
            } else if (id === "loginScreen") {
              el.style.display = "none";
            } else {
              el.classList.add("hidden");
            }
          }
        });

        // é¡¯ç¤ºç›®æ¨™ç•«é¢
        const targetEl = document.getElementById(screenId);
        if (targetEl) {
          if (
            targetEl.classList.contains("success-screen") ||
            targetEl.classList.contains("history-screen")
          ) {
            targetEl.classList.add("active");
          } else if (screenId === "loginScreen") {
            targetEl.style.display = "block";
          } else {
            targetEl.classList.remove("hidden");
          }
        }
      }

      function showMainMenu() {
        // æ›´æ–°é¡¯ç¤ºçš„ email
        const emailDisplay = document.getElementById("successEmailDisplay");
        if (emailDisplay && currentUser) {
          emailDisplay.textContent =
            currentUser.email || currentUser.id_number || "ç”¨æˆ¶";
        }
        showScreen("mainMenu");
      }

      function backToMainMenu() {
        showMainMenu();
      }

      function logout() {
        accessToken = null;
        currentUser = null;
        localStorage.removeItem("applicant_token");
        localStorage.removeItem("applicant_user");
        showScreen("loginScreen");
        // åˆ·æ–°é é¢
        location.reload();
        window.location.href = "/applicant";
      }

      function showApplyForm() {
        showScreen("applyForm");
        currentStep = 1;
        updateSteps();
        // é å¡«è³‡æ–™
        document.getElementById("appName").value = currentUser.full_name;
        document.getElementById("appIdNumber").value = currentUser.id_number;
        document.getElementById("appPhone").value = currentUser.phone || "";
      }

      function backToMenu() {
        showMainMenu();
      }

      function updateSteps() {
        for (let i = 1; i <= 5; i++) {
          const step = document.getElementById(`step${i}`);
          step.className = "step";
          if (i < currentStep) step.classList.add("completed");
          if (i === currentStep) step.classList.add("active");

          document
            .getElementById(`form-step${i}`)
            .classList.toggle("hidden", i !== currentStep);
        }
      }

      function nextStep(step) {
        // é©—è­‰ç•¶å‰æ­¥é©Ÿ
        if (currentStep === 4) {
          showConfirmData();
        }
        currentStep = step;
        updateSteps();
      }

      function prevStep(step) {
        currentStep = step;
        updateSteps();
      }

      function showConfirmData() {
        document.getElementById("confirmData").innerHTML = `
                <p><strong>å§“åï¼š</strong>${
                  document.getElementById("appName").value
                }</p>
                <p><strong>èº«åˆ†è­‰å­—è™Ÿï¼š</strong>${
                  document.getElementById("appIdNumber").value
                }</p>
                <p><strong>æ‰‹æ©Ÿï¼š</strong>${
                  document.getElementById("appPhone").value
                }</p>
                <p><strong>åœ°å€ï¼š</strong>${
                  document.getElementById("appAddress").value
                }</p>
                <hr class="confirm-separator">
                <p><strong>ç½å®³æ—¥æœŸï¼š</strong>${
                  document.getElementById("appDate").value
                }</p>
                <p><strong>ç½å®³é¡å‹ï¼š</strong>${
                  document.getElementById("appType").selectedOptions[0].text
                }</p>
                <p><strong>ç”³è«‹é‡‘é¡ï¼š</strong>NT$ ${parseInt(
                  document.getElementById("appAmount").value
                ).toLocaleString()}</p>
            `;
      }

      async function submitApplication() {
        const data = {
          applicant_id: currentUser.id,
          applicant_name: document.getElementById("appName").value,
          id_number: document.getElementById("appIdNumber").value,
          phone: document.getElementById("appPhone").value,
          address: document.getElementById("appAddress").value,
          disaster_date: document.getElementById("appDate").value,
          disaster_type: document.getElementById("appType").value,
          damage_description: document.getElementById("appDescription").value,
          damage_location: document.getElementById("appDamageLocation").value,
          estimated_loss: parseFloat(
            document.getElementById("appEstimatedLoss").value
          ),
          subsidy_type: document.getElementById("appSubsidyType").value
        };

        const result = await fetch(`${API_BASE}/applications/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${accessToken}`,
          },
          body: JSON.stringify(data),
        });

        if (result.ok) {
          const appResponse = await result.json();
          const appData = appResponse.data || appResponse;
          const applicationId = appData.id;
          const caseNo = appData.case_no;

          // ä¸Šå‚³æ–‡ä»¶ï¼ˆå¦‚æœæœ‰é¸æ“‡æ–‡ä»¶ï¼‰
          if (selectedDocuments.length > 0) {
            console.log(`ğŸ“¤ é–‹å§‹ä¸Šå‚³ ${selectedDocuments.length} å€‹æ–‡ä»¶...`);

            // é¡¯ç¤ºä¸Šå‚³é€²åº¦
            const uploadStatus = document.createElement("div");
            uploadStatus.id = "uploadStatus";
            uploadStatus.style.cssText =
              "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 10000; text-align: center;";
            uploadStatus.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“¤</div>
                        <h3 style="margin: 0 0 10px 0; color: #333;">æ­£åœ¨ä¸Šå‚³æ–‡ä»¶</h3>
                        <p style="color: #666; margin: 0;" id="uploadProgress">0 / ${selectedDocuments.length}</p>
                    `;
            document.body.appendChild(uploadStatus);

            try {
              await uploadDocuments(applicationId);
            } catch (error) {
              console.error("æ–‡ä»¶ä¸Šå‚³å¤±æ•—:", error);
            } finally {
              // ç§»é™¤ä¸Šå‚³ç‹€æ…‹æç¤º
              document.body.removeChild(uploadStatus);
            }
          }

          document.getElementById("caseNumber").textContent = caseNo;
          showScreen("successScreen");
        } else {
          alert("ç”³è«‹æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      async function showMyApplications() {
        try {
          const result = await fetch(
            `${API_BASE}/applications/applicant/${currentUser.id}`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          const list = document.getElementById("applicationsList");

          if (result.ok) {
            const response = await result.json();
            // è™•ç† APIResponse æ ¼å¼
            const apps =
              response.data?.applications || response.data || response;

            if (apps.length === 0) {
              list.innerHTML = `
                            <div class="record">
                                <p style="text-align: center; color: #475569; padding: 20px 0;">å°šç„¡ç”³è«‹ç´€éŒ„</p>
                            </div>
                        `;
            } else {
              list.innerHTML = apps
                .map((app) => {
                  const statusInfo = getStatusInfo(app.status);
                  const progress = getProgressPercentage(app.status);
                  
                  // åˆ¤æ–·æ˜¯å¦é¡¯ç¤º VP é ˜å–æŒ‰éˆ•
                  const showVPButton = app.status === 'approved' && !app.vp_claimed;
                  const showVPSuccess = app.status === 'completed' && app.vp_claimed;

                  return `
                                <div class="record" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" onclick="showApplicationProgress('${app.id}')">
                                    <div class="record-head" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <div class="record-type" style="font-size: 18px; font-weight: 600; color: #0f172a;">${getDisasterTypeText(app.disaster_type)}</div>
                                        <div class="status-badge status-${app.status}" style="padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; ${getStatusStyle(app.status)}">${statusInfo.text}</div>
                                    </div>
                                    <div class="record-meta" style="color: #64748b; font-size: 13px; margin-bottom: 12px;">
                                        ç”³è«‹ç·¨è™Ÿï¼š${app.case_no} | ç”³è«‹æ—¥æœŸï¼š${new Date(app.created_at).toLocaleDateString('zh-TW')}
                                    </div>
                                    
                                    <div class="review-progress" style="margin: 16px 0;">
                                        <div class="progress-label" style="font-size: 13px; color: #64748b; margin-bottom: 8px;">å¯©æ ¸é€²åº¦</div>
                                        <div class="progress-bar-wrapper" style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                            <div class="progress-bar-fill" style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, #3b82f6 0%, #1e40af 100%); transition: width 0.3s;"></div>
                                        </div>
                                        <div class="progress-text" style="font-size: 13px; color: #64748b; margin-top: 4px; text-align: right;">${progress}%</div>
                                    </div>

                                    ${showVPButton ? `
                                    <div class="credential-section" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin-top: 16px;">
                                        <div class="credential-notice" style="color: #dc2626; font-size: 14px; font-weight: 500;">
                                            å°šæœªé ˜å–æ†‘è­‰
                                        </div>
                                        <button class="btn-get-credential" style="background: #1e81b2; color: white; padding: 8px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s;" onclick="showVPClaimModal('${app.id}'); event.stopPropagation();" onmouseover="this.style.background='#166a92'" onmouseout="this.style.background='#1e81b2'">
                                            é ˜å–
                                        </button>
                                    </div>
                                    ` : ''}
                                    ${showVPSuccess ? `
                                    <div class="credential-section" style="padding: 12px; background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 8px; margin-top: 16px; text-align: center;">
                                        <div class="credential-success" style="color: #047857; font-size: 14px; font-weight: 500;">
                                            âœ“ å·²é ˜å–
                                        </div>
                                    </div>
                                    ` : ''}

                                    <div class="record-actions" style="margin-top: 16px; text-align: right;">
                                        <button class="btn-view-progress" style="background: transparent; color: #1e81b2; padding: 8px 16px; border: 1px solid #1e81b2; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onclick="showApplicationProgress('${app.id}'); event.stopPropagation();" onmouseover="this.style.background='#1e81b2'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#1e81b2'">
                                            æŸ¥çœ‹å®Œæ•´é€²åº¦
                                        </button>
                                    </div>
                                </div>
                            `;
                })
                .join("");
            }
            showScreen("myApplicationsScreen");
          } else {
            const errorData = await result.json().catch(() => ({}));
            list.innerHTML = `
                        <div class="record">
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                                <p style="color: #ef4444; font-size: 16px; margin-bottom: 8px;">ç„¡æ³•è¼‰å…¥ç”³è«‹ç´€éŒ„</p>
                                <p style="color: #999; font-size: 14px;">${
                                  errorData.detail || "è«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡å®¢æœ"
                                }</p>
                                <p style="color: #999; font-size: 12px; margin-top: 16px;">éŒ¯èª¤ä»£ç¢¼: ${
                                  result.status
                                }</p>
                            </div>
                        </div>
                    `;
            showScreen("myApplicationsScreen");
          }
        } catch (error) {
          console.error("Error loading applications:", error);
          alert("è¼‰å…¥å¤±æ•—ï¼š" + error.message);
        }
      }

      function getStatusInfo(status) {
        const map = {
          pending: { text: "å¾…å¯©æ ¸", color: "#94A3B8" },
          under_review: { text: "å¯©æ ¸ä¸­", color: "#3B82F6" },
          approved: { text: "å·²æ ¸å‡†", color: "#10B981" },
          rejected: { text: "å·²é§å›", color: "#EF4444" },
          completed: { text: "å·²é ˜å–", color: "#6366F1" },
        };
        return map[status] || { text: status, color: "#94A3B8" };
      }

      function getStatusStyle(status) {
        const statusInfo = getStatusInfo(status);
        const bgColor = statusInfo.color + '20'; // æ·»åŠ é€æ˜åº¦
        return `background-color: ${bgColor}; color: ${statusInfo.color};`;
      }

      function getProgressPercentage(status) {
        const map = {
          pending: 50,
          under_review: 50,
          approved: 100,
          rejected: 100,
          completed: 100,
        };
        return map[status] || 0;
      }

      function getDisasterTypeText(type) {
        const map = {
          flood: "æ°´ç½è£œåŠ©",
          typhoon: "é¢±é¢¨è£œåŠ©",
          earthquake: "åœ°éœ‡è£œåŠ©",
          other: "å…¶ä»–ç½å®³è£œåŠ©",
        };
        return map[type] || "ç½å®³è£œåŠ©";
      }

      // é¡¯ç¤ºç”³è«‹é€²åº¦æ™‚é–“è»¸
      async function showApplicationProgress(appId) {
        try {
          const response = await fetch(`${API_BASE}/applications/${appId}`, {
            headers: { Authorization: `Bearer ${accessToken}` },
          });

          if (!response.ok) {
            throw new Error("ç„¡æ³•å–å¾—ç”³è«‹è©³æƒ…");
          }

          const result = await response.json();
          const app = result.data?.application || result.application || result;

          // å‰µå»ºé€²åº¦æ™‚é–“è»¸å½ˆçª—
          const modal = document.createElement("div");
          modal.className = "progress-modal-overlay";
          modal.innerHTML = `
            <div class="progress-modal">
              <div class="progress-modal-header">
                <h3>å¯©æ ¸é€²åº¦è©³æƒ…</h3>
                <button class="modal-close-btn" onclick="this.closest('.progress-modal-overlay').remove()">Ã—</button>
              </div>
              
              <div class="progress-modal-body">
                <div class="application-summary">
                  <div class="summary-row">
                    <span class="summary-label">ç”³è«‹ç·¨è™Ÿ</span>
                    <span class="summary-value">${app.case_no}</span>
                  </div>
                  <div class="summary-row">
                    <span class="summary-label">ç”³è«‹é …ç›®</span>
                    <span class="summary-value">${getDisasterTypeText(app.disaster_type)}</span>
                  </div>
                </div>

                <div class="progress-timeline">
                  <div class="timeline-item ${app.status ? 'completed' : ''}">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                      <div class="timeline-title">ç”³è«‹é€å‡º</div>
                      <div class="timeline-time">${app.submitted_at ? new Date(app.submitted_at).toLocaleString('zh-TW') : ''}</div>
                    </div>
                  </div>

                  <div class="timeline-item ${app.reviewed_at ? 'completed' : app.status === 'under_review' ? 'current' : ''}">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                      <div class="timeline-title">è³‡æ–™å¯©æ ¸</div>
                      <div class="timeline-time">${app.reviewed_at ? new Date(app.reviewed_at).toLocaleString('zh-TW') : 'é€²è¡Œä¸­'}</div>
                    </div>
                  </div>

                  <div class="timeline-item ${app.status === 'approved' || app.status === 'completed' ? 'completed' : ''}">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                      <div class="timeline-title">ç¾å ´å‹˜æŸ¥</div>
                      <div class="timeline-time">${app.reviewed_at ? new Date(app.reviewed_at).toLocaleString('zh-TW') : 'å¾…é€²è¡Œ'}</div>
                    </div>
                  </div>

                  <div class="timeline-item ${app.status === 'completed' ? 'completed' : ''}">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                      <div class="timeline-title">å¯©æ ¸çµæœ</div>
                      <div class="timeline-time">${app.status === 'approved' || app.status === 'completed' ? 'å·²å®Œæˆ' : 'å¾…å…¬å‘Š'}</div>
                    </div>
                  </div>
                </div>

                ${app.status === 'approved' && !app.vp_claimed ? `
                <div class="credential-reminder">
                  <div class="reminder-icon">ğŸ«</div>
                  <div class="reminder-text">
                    <strong>ç½å®³è£œåŠ©ç”³è«‹æ†‘è­‰</strong>
                    <p>æ‚¨çš„ç”³è«‹å·²é€šéå¯©æ ¸ï¼Œè«‹é»é¸ä¸‹æ–¹æŒ‰éˆ•é ˜å–æ†‘è­‰</p>
                  </div>
                  <button class="btn-claim-credential" onclick="showVPClaimModal('${app.id}'); this.closest('.progress-modal-overlay').remove();">
                    æœªç™¼æ”¾
                  </button>
                </div>
                ` : app.vp_claimed ? `
                <div class="credential-claimed">
                  <span class="check-icon">âœ“</span>
                  <span>å·²ç™¼æ”¾</span>
                </div>
                ` : ''}
              </div>
            </div>
          `;

          document.body.appendChild(modal);
        } catch (error) {
          console.error("æŸ¥çœ‹é€²åº¦éŒ¯èª¤:", error);
          alert("ç„¡æ³•è¼‰å…¥é€²åº¦è³‡è¨Šï¼š" + error.message);
        }
      }

      async function viewApplicationDetail(appId) {
        // ...existing code...
      }

      async function viewApplicationDetail(appId) {
        try {
          // å–å¾—ç”³è«‹è©³æƒ…
          const response = await fetch(`${API_BASE}/applications/${appId}`, {
            headers: { Authorization: `Bearer ${accessToken}` },
          });

          if (!response.ok) {
            throw new Error("ç„¡æ³•å–å¾—ç”³è«‹è©³æƒ…");
          }

          const result = await response.json();
          const app = result.data || result;

          // æ ¹æ“šç‹€æ…‹é¡¯ç¤ºä¸åŒå…§å®¹
          if (app.application.status === "approved") {
            // å·²æ ¸å‡†ï¼šé¡¯ç¤º QR Code
            showQRCodeForApplicant(app);
          } else if (app.application.status === "rejected") {
            // å·²é§å›ï¼šé¡¯ç¤ºé§å›åŸå› 
            showRejectionReason(app);
          } else {
            // å¯©ç†ä¸­ï¼šé¡¯ç¤ºç­‰å¾…è¨Šæ¯
            showPendingMessage(app);
          }
        } catch (error) {
          console.error("æŸ¥çœ‹ç”³è«‹è©³æƒ…éŒ¯èª¤:", error);
          alert("ç„¡æ³•è¼‰å…¥ç”³è«‹è©³æƒ…ï¼š" + error.message);
        }
      }

      // é¡¯ç¤º QR Code çµ¦ç”³è«‹äººæƒæï¼ˆå·²æ ¸å‡†ï¼‰ - æ”¹ç‚ºé¡ä¼¼ç”³è«‹æµç¨‹çš„ QR æƒææ¨£å¼
      async function showQRCodeForApplicant(app) {
        // å‰µå»ºå…¨å±é®ç½©
        const overlay = document.createElement("div");
        overlay.id = "credential-verification-overlay";
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 9999;
          display: flex;
          align-items: center;
          justify-content: center;
        `;

        const container = document.createElement("div");
        container.style.cssText = `
          background: white;
          border-radius: 16px;
          max-width: 600px;
          width: 90%;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        `;

        container.innerHTML = `
          <div style="padding: 40px;">
            <div style="text-align: right; margin-bottom: 20px;">
              <button onclick="document.getElementById('credential-verification-overlay').remove()" 
                style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">Ã—</button>
            </div>

            <div style="text-align: center;">
              <h2 style="font-size: 28px; font-weight: 700; color: #0f172a; margin-bottom: 12px;">
                ç½å®³æ†‘è­‰ç™¼é€è‡³çš®å¤¾
              </h2>
              <p style="color: #64748b; font-size: 14px; margin-bottom: 32px;">
                è«‹ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾ APP æƒæ QR Code é©—è­‰æ‚¨çš„ç½å®³æ†‘è­‰
              </p>
            </div>

            <div style="background: #f8fafc; border-radius: 12px; padding: 32px; margin-bottom: 24px;">
              <div style="width: 250px; height: 250px; margin: 0 auto; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                <img id="credentialQrCode" src="${app.application.gov_qr_code_data || ''}" 
                  style="max-width: 230px; max-height: 230px;" alt="ç½å®³æ†‘è­‰ QR Code" />
              </div>
              <div style="text-align: center; margin-top: 20px;">
                <span style="color: #475569; font-size: 16px;">è«‹æ–¼ </span>
                <span id="credentialCountdown" style="color: #1e81b2; font-size: 20px; font-weight: 700;">5:00</span>
                <span style="color: #475569; font-size: 16px;"> å…§å®Œæˆæƒæ</span>
              </div>
              <div style="text-align: center; margin-top: 16px;">
                <button onclick="regenerateCredentialQR(${app.application.id})" 
                  style="padding: 10px 24px; background: white; color: #1e81b2; border: 2px solid #1e81b2; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                  ğŸ”„ é‡æ–°ç”¢ç”Ÿ
                </button>
              </div>
            </div>

            <div style="background: #eff6ff; border-left: 4px solid #1e81b2; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
              <h4 style="font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">ğŸ”’ å®‰å…¨æç¤º</h4>
              <p style="font-size: 13px; color: #1e40af; line-height: 1.6; margin: 0;">
                æ‚¨çš„å€‹äººè³‡æ–™å—åˆ°åš´æ ¼ä¿è­·ï¼Œæˆ‘å€‘åƒ…ç”¨æ­¤é€²è¡Œæ†‘è­‰ç™¼æ”¾èˆ‡æ ¸é©—ï¼Œå°‡åš´æ ¼éµå®ˆç›¸é—œéš±ç§æ³•è¦ã€‚æ‰€æœ‰è³‡æ–™å‚³è¼¸çš†ç¶“éåŠ å¯†è™•ç†ã€‚
              </p>
            </div>

            <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
              <p style="margin: 5px 0;"><strong>æ¡ˆä»¶ç·¨è™Ÿï¼š</strong>${app.application.case_no}</p>
              <p style="margin: 5px 0;"><strong>æ ¸å‡†é‡‘é¡ï¼š</strong><span style="color: #10b981; font-weight: 600;">NT$ ${
                app.application.approved_amount?.toLocaleString() ||
                app.application.requested_amount?.toLocaleString()
              }</span></p>
              <p style="margin: 5px 0;"><strong>è£œåŠ©é¡å‹ï¼š</strong>${getDisasterTypeText(app.application.disaster_type)}</p>
            </div>
          </div>
        `;

        overlay.appendChild(container);
        document.body.appendChild(overlay);

        // å¦‚æœæ²’æœ‰ QR Codeï¼Œå˜—è©¦ç”Ÿæˆä¸€å€‹
        if (!app.application.gov_qr_code_data) {
          await generateCredentialQRCode(app.application.id);
        } else {
          // é–‹å§‹å€’æ•¸è¨ˆæ™‚
          startCredentialCountdown();
        }
      }

      // ç”Ÿæˆç½å®³æ†‘è­‰ QR Code
      async function generateCredentialQRCode(applicationId) {
        try {
          const response = await fetch(`${API_BASE}/complete-flow/generate-credential-qr`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              application_id: applicationId,
              user_id: currentUser.id
            })
          });

          const data = await response.json();
          if (data.success && data.qrcode_image) {
            const qrImg = document.getElementById('credentialQrCode');
            if (qrImg) {
              qrImg.src = data.qrcode_image;
              startCredentialCountdown();
            }
          }
        } catch (error) {
          console.error('ç”Ÿæˆç½å®³æ†‘è­‰ QR Code å¤±æ•—:', error);
          alert('ç„¡æ³•ç”Ÿæˆæ†‘è­‰ QR Codeï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      }

      // é‡æ–°ç”Ÿæˆç½å®³æ†‘è­‰ QR Code
      async function regenerateCredentialQR(applicationId) {
        await generateCredentialQRCode(applicationId);
      }

      // æ†‘è­‰å€’æ•¸è¨ˆæ™‚
      let credentialCountdownInterval = null;
      function startCredentialCountdown() {
        if (credentialCountdownInterval) {
          clearInterval(credentialCountdownInterval);
        }

        let remaining = 300; // 5 åˆ†é˜
        const countdownEl = document.getElementById('credentialCountdown');

        credentialCountdownInterval = setInterval(() => {
          const minutes = Math.floor(remaining / 60);
          const seconds = remaining % 60;
          
          if (countdownEl) {
            countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }

          remaining--;

          if (remaining < 0) {
            clearInterval(credentialCountdownInterval);
            if (countdownEl) {
              countdownEl.textContent = '0:00';
            }
          }
        }, 1000);
      }

      // é¡¯ç¤ºé§å›åŸå› ï¼ˆå·²é§å›ï¼‰
      function showRejectionReason(app) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.cssText =
          "display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;";

        modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px; line-height: 1;">&times;</button>
                    
                    <div style="padding: 30px;">
                        <h2 style="color: #ef4444; text-align: center; margin-bottom: 20px;">âŒ ç”³è«‹å·²é§å›</h2>
                        
                        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 20px;">
                            <h3 style="color: #991b1b; margin-bottom: 10px; font-size: 16px;">é§å›åŸå› ï¼š</h3>
                            <p style="color: #7f1d1d; font-size: 14px; line-height: 1.6; margin: 0;">
                                ${
                                  app.application.rejection_reason ||
                                  app.application.review_notes ||
                                  "æœªæä¾›å…·é«”åŸå› ï¼Œè«‹è¯ç¹«æ‰¿è¾¦äººå“¡"
                                }
                            </p>
                        </div>

                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 5px 0;"><strong>æ¡ˆä»¶ç·¨è™Ÿï¼š</strong>${
                              app.application.case_no
                            }</p>
                            <p style="margin: 5px 0;"><strong>ç”³è«‹é‡‘é¡ï¼š</strong>NT$ ${app.application.requested_amount?.toLocaleString()}</p>
                            <p style="margin: 5px 0;"><strong>ç½å®³é¡å‹ï¼š</strong>${getDisasterTypeText(
                              app.application.disaster_type
                            )}</p>
                            <p style="margin: 5px 0;"><strong>æäº¤æ—¥æœŸï¼š</strong>${new Date(
                              app.application.submitted_at
                            ).toLocaleDateString("zh-TW")}</p>
                        </div>

                        <div style="background: #fff7ed; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <strong style="color: #92400e;">ğŸ’¡ å»ºè­°ï¼š</strong>
                            <ul style="margin: 10px 0 0 20px; color: #92400e; font-size: 14px; line-height: 1.6;">
                                <li>è«‹è©³é–±é§å›åŸå› ä¸¦æº–å‚™ç›¸é—œè£œå……è³‡æ–™</li>
                                <li>æ‚¨å¯ä»¥ä¿®æ­£å•é¡Œå¾Œé‡æ–°æå‡ºç”³è«‹</li>
                                <li>å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯ç¹«é‡Œé•·æˆ–æ‰¿è¾¦äººå“¡</li>
                            </ul>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" style="flex: 1; padding: 14px; background: #f3f4f6; color: #666; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                é—œé–‰
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove(); showApplyForm();" style="flex: 1; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                                é‡æ–°ç”³è«‹
                            </button>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
      }

      // é¡¯ç¤ºå¯©ç†ä¸­è¨Šæ¯
      function showPendingMessage(app) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.cssText =
          "display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;";

        const statusInfo = getStatusInfo(app.application.status);

        modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px; line-height: 1;">&times;</button>
                    
                    <div style="padding: 30px;">
                        <h2 style="color: #3b82f6; text-align: center; margin-bottom: 20px;">â³ ç”³è«‹å¯©æ ¸ä¸­</h2>
                        
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: flex-start; justify-content: center; font-size: 48px; padding-top: 10px;">
                                â±ï¸
                            </div>
                            <p style="font-size: 18px; font-weight: 500; color: #333; margin-bottom: 10px;">
                                æ‚¨çš„ç”³è«‹æ­£åœ¨å¯©æ ¸ä¸­
                            </p>
                            <p style="color: #666; font-size: 14px;">
                                ç›®å‰ç‹€æ…‹ï¼š<span style="color: ${
                                  statusInfo.color
                                }; font-weight: 500;">${statusInfo.text}</span>
                            </p>
                        </div>

                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 5px 0;"><strong>æ¡ˆä»¶ç·¨è™Ÿï¼š</strong>${
                              app.application.case_no
                            }</p>
                            <p style="margin: 5px 0;"><strong>ç”³è«‹é‡‘é¡ï¼š</strong>NT$ ${app.application.requested_amount?.toLocaleString()}</p>
                            <p style="margin: 5px 0;"><strong>ç½å®³é¡å‹ï¼š</strong>${getDisasterTypeText(
                              app.application.disaster_type
                            )}</p>
                            <p style="margin: 5px 0;"><strong>æäº¤æ—¥æœŸï¼š</strong>${new Date(
                              app.application.submitted_at
                            ).toLocaleDateString("zh-TW")}</p>
                        </div>

                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <strong style="color: #1e40af;">ğŸ“‹ å¯©æ ¸æµç¨‹ï¼š</strong>
                            <ol style="margin: 10px 0 0 20px; color: #1e40af; font-size: 14px; line-height: 1.8;">
                                <li>è³‡æ–™å¯©æŸ¥ï¼ˆé€²è¡Œä¸­ï¼‰</li>
                                <li>é‡Œé•·å¯©æ ¸</li>
                                <li>æ ¸ç™¼è£œåŠ©æ†‘è­‰</li>
                                <li>é ˜å–è£œåŠ©</li>
                            </ol>
                        </div>

                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <p style="color: #92400e; font-size: 13px; margin: 0;">
                                âš ï¸ å¯©æ ¸é€šå¸¸éœ€è¦ <strong>3-5 å€‹å·¥ä½œå¤©</strong>ï¼Œå¯©æ ¸çµæœå°‡ä»¥ç°¡è¨Šæˆ– Email é€šçŸ¥æ‚¨ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚
                            </p>
                        </div>

                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;

        document.body.appendChild(modal);
      }

      // è™•ç†æ–‡ä»¶é¸æ“‡
      function handleDocumentSelect(event) {
        const files = Array.from(event.target.files);
        const maxFiles = 5;
        const maxSize = 10 * 1024 * 1024; // 10MB

        // é©—è­‰æ–‡ä»¶æ•¸é‡
        if (files.length > maxFiles) {
          alert(`æœ€å¤šåªèƒ½ä¸Šå‚³ ${maxFiles} å€‹æª”æ¡ˆ`);
          event.target.value = "";
          return;
        }

        // é©—è­‰æ–‡ä»¶å¤§å°
        const oversizedFiles = files.filter((f) => f.size > maxSize);
        if (oversizedFiles.length > 0) {
          alert(`æª”æ¡ˆ ${oversizedFiles[0].name} è¶…é 10MB é™åˆ¶`);
          event.target.value = "";
          return;
        }

        selectedDocuments = files;
        displayDocumentPreview();
      }

      // é¡¯ç¤ºæ–‡ä»¶é è¦½
      function displayDocumentPreview() {
        const container = document.getElementById("documentPreview");
        if (selectedDocuments.length === 0) {
          container.innerHTML = "";
          return;
        }

        const html = selectedDocuments
          .map((file, index) => {
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            const icon = getFileIcon(file.name);

            return `
                    <div style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 24px; margin-right: 10px;">${icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${file.name}</div>
                            <div style="font-size: 12px; color: #666;">${sizeInMB} MB</div>
                        </div>
                        <button type="button" onclick="removeDocument(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            ç§»é™¤
                        </button>
                    </div>
                `;
          })
          .join("");

        container.innerHTML = `
                <div style="margin-bottom: 10px; color: #28a745; font-weight: 500;">
                    âœ“ å·²é¸æ“‡ ${selectedDocuments.length} å€‹æª”æ¡ˆ
                </div>
                ${html}
            `;
      }

      // ç²å–æ–‡ä»¶åœ–ç¤º
      function getFileIcon(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const icons = {
          pdf: "ğŸ“„",
          doc: "ğŸ“",
          docx: "ğŸ“",
          jpg: "ğŸ–¼ï¸",
          jpeg: "ğŸ–¼ï¸",
          png: "ğŸ–¼ï¸",
        };
        return icons[ext] || "ğŸ“";
      }

      // ç§»é™¤æ–‡ä»¶
      function removeDocument(index) {
        const dt = new DataTransfer();
        const files = Array.from(selectedDocuments);
        files.splice(index, 1);

        files.forEach((file) => dt.items.add(file));
        document.getElementById("appDocuments").files = dt.files;
        selectedDocuments = files;
        displayDocumentPreview();
      }

      // ä¸Šå‚³æ–‡ä»¶åˆ°ä¼ºæœå™¨
      async function uploadDocuments(applicationId) {
        if (selectedDocuments.length === 0) {
          return { success: true, documents: [] };
        }

        const uploadedDocs = [];
        let uploadCount = 0;

        for (const file of selectedDocuments) {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("application_id", applicationId);
          formData.append("document_type", "supporting_document");
          formData.append("description", file.name);
          formData.append("uploaded_by", currentUser.id); // åŠ å…¥ä¸Šå‚³è€… ID

          try {
            const response = await fetch(`${API_BASE}/documents/upload`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
              body: formData,
            });

            if (response.ok) {
              const result = await response.json();
              uploadedDocs.push(result.data);
              uploadCount++;

              // æ›´æ–°ä¸Šå‚³é€²åº¦
              const progressEl = document.getElementById("uploadProgress");
              if (progressEl) {
                progressEl.textContent = `${uploadCount} / ${selectedDocuments.length}`;
              }

              console.log(`âœ“ æª”æ¡ˆä¸Šå‚³æˆåŠŸ: ${file.name}`);
            } else {
              const errorData = await response.json().catch(() => ({}));
              console.error(`âœ— æª”æ¡ˆä¸Šå‚³å¤±æ•—: ${file.name}`, errorData);
              alert(
                `æª”æ¡ˆ ${file.name} ä¸Šå‚³å¤±æ•—: ${errorData.detail || "æœªçŸ¥éŒ¯èª¤"}`
              );
            }
          } catch (error) {
            console.error(`âœ— æª”æ¡ˆä¸Šå‚³éŒ¯èª¤: ${file.name}`, error);
            alert(`æª”æ¡ˆ ${file.name} ä¸Šå‚³éŒ¯èª¤: ${error.message}`);
          }
        }

        return { success: true, documents: uploadedDocs };
      }

      // æ–°çš„ä¸‰æ­¥é©Ÿç”³è«‹æµç¨‹
      let currentFormStep = 1;
      let uploadedPhotos = [];

      function showApplyForm() {
        showScreen("applyForm");
        currentFormStep = 1;
        resetFormSteps();
        startIdentityVerification();
      }

      function resetFormSteps() {
        document.querySelectorAll('.form-step-container').forEach((el, index) => {
          el.classList.toggle('hidden', index !== 0);
        });
        updateStepIndicators();
      }

      function updateStepIndicators() {
        for (let i = 1; i <= 3; i++) {
          const indicator = document.getElementById(`indicator-step${i}`);
          indicator.classList.remove('active', 'completed');
          
          if (i < currentFormStep) {
            indicator.classList.add('completed');
          } else if (i === currentFormStep) {
            indicator.classList.add('active');
          }
        }
      }

      // æ­¥é©Ÿ 1ï¼šèº«åˆ†é©—è­‰
      async function startIdentityVerification() {
        console.log('ğŸ” é–‹å§‹èº«åˆ†é©—è­‰');
        const qrImg = document.getElementById('identityQrCode');
        const countdownEl = document.getElementById('identityCountdown');
        
        try {
          const response = await fetch(`${API_BASE}/complete-flow/generate-vp-qrcode`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              vp_ref: '00000000_mixcurry_idcard',
              user_id: currentUser.id
            })
          });

          const data = await response.json();
          if (data.success && data.qrcode_image) {
            qrImg.src = data.qrcode_image;
            startCountdown(countdownEl, 300);
            pollIdentityVerification(data.transaction_id);
          }
        } catch (error) {
          console.error('èº«åˆ†é©—è­‰ QR Code ç”Ÿæˆå¤±æ•—:', error);
          alert('ç„¡æ³•ç”Ÿæˆé©—è­‰ QR Codeï¼Œè«‹é‡è©¦');
        }
      }

      function regenerateIdentityQR() {
        startIdentityVerification();
      }

      async function pollIdentityVerification(transactionId) {
        const maxAttempts = 60;
        let attempts = 0;

        const interval = setInterval(async () => {
          attempts++;
          
          try {
            const response = await fetch(`${API_BASE}/complete-flow/verify-vp`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
              },
              body: JSON.stringify({
                transaction_id: transactionId,
                user_id: currentUser.id
              })
            });

            const data = await response.json();
            
            if (data.verified) {
              clearInterval(interval);
              identityVerified = true;
              console.log('âœ… èº«åˆ†é©—è­‰æˆåŠŸ');
              
              // é¡¯ç¤º loading å‹•ç•«
              showLoadingAnimation('èº«åˆ†é©—è­‰æˆåŠŸï¼æ­£åœ¨è™•ç†...');
              
              // å»¶é² 6 ç§’è®“å‹•ç•«æ’­æ”¾å®Œæ•´ï¼Œç„¶å¾Œé€²å…¥ä¸‹ä¸€æ­¥
              setTimeout(() => {
                hideLoadingAnimation();
                moveToStep2();
              }, 10000);
            } else if (attempts >= maxAttempts) {
              clearInterval(interval);
              alert('é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°ç”¢ç”Ÿ QR Code');
            }
          } catch (error) {
            if (attempts >= maxAttempts) {
              clearInterval(interval);
            }
          }
        }, 5000);
      }

      // æ­¥é©Ÿ 2ï¼šæˆ¿å±‹æŒæœ‰é©—è­‰
      function moveToStep2() {
        console.log('ğŸ“ é€²å…¥æ­¥é©Ÿ2ï¼šæˆ¿å±‹æŒæœ‰é©—è­‰');
        console.log('ç•¶å‰ç”¨æˆ¶è³‡æ–™:', currentUser);
        console.log('èº«åˆ†é©—è­‰è³‡æ–™:', idVerificationData);
        
        // æª¢æŸ¥å¿…è¦è³‡æ–™
        if (!idVerificationData || !idVerificationData.id_number) {
          console.error('âŒ éŒ¯èª¤ï¼šç¼ºå°‘èº«åˆ†é©—è­‰è³‡æ–™');
          alert('ç³»çµ±éŒ¯èª¤ï¼šèº«åˆ†é©—è­‰è³‡æ–™éºå¤±ï¼Œè«‹é‡æ–°é–‹å§‹');
          return;
        }
        
        currentFormStep = 2;
        
        // éš±è—æ­¥é©Ÿ1ï¼Œé¡¯ç¤ºæ­¥é©Ÿ2
        const step1 = document.getElementById('form-step1');
        const step2 = document.getElementById('form-step2');
        
        if (step1) {
          step1.classList.add('hidden');
          console.log('âœ“ æ­¥é©Ÿ1å·²éš±è—');
        } else {
          console.error('âŒ æ‰¾ä¸åˆ° form-step1 å…ƒç´ ');
        }
        
        if (step2) {
          step2.classList.remove('hidden');
          console.log('âœ“ æ­¥é©Ÿ2å·²é¡¯ç¤º');
        } else {
          console.error('âŒ æ‰¾ä¸åˆ° form-step2 å…ƒç´ ');
        }
        
        updateStepIndicators();
        
        // å•Ÿå‹•æˆ¿å±‹æŒæœ‰æ†‘è­‰é©—è­‰
        console.log('ğŸ  å•Ÿå‹•æˆ¿å±‹æŒæœ‰é©—è­‰...');
        startPropertyVerification();
      }

      async function startPropertyVerification() {
        console.log('ğŸ  é–‹å§‹æˆ¿å±‹æŒæœ‰æ†‘è­‰é©—è­‰');
        
        // é˜²æ­¢é‡è¤‡å•Ÿå‹•
        if (window._mixcurry_property_verification_started) {
          console.log('æˆ¿å±‹é©—è­‰å·²åœ¨é€²è¡Œä¸­ï¼Œè·³éé‡è¤‡å•Ÿå‹•');
          return;
        }
        window._mixcurry_property_verification_started = true;
        
        // æ¸…ç†ä¹‹å‰çš„è¨ˆæ™‚å™¨
        clearPropertyIntervals();
        
        const vpRef = "00000000_20251110";  // æˆ¿å±‹æŒæœ‰æ†‘è­‰é©—è­‰æœå‹™ä»£ç¢¼
        let transactionId = null;
        let remainingSeconds = 300; // 5åˆ†é˜
        
        const qrImg = document.getElementById('propertyQrCode');
        const countdownEl = document.getElementById('propertyCountdown');
        const DEFAULT_QR = "";
        
        if (qrImg) qrImg.src = qrImg.getAttribute("src") || DEFAULT_QR;
        
        // æ›´æ–°å€’æ•¸è¨ˆæ™‚é¡¯ç¤º
        function updateCountdownDisplay() {
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          if (countdownEl) {
            countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }
        }
        
        updateCountdownDisplay();
        propertyCountdownIntervalId = setInterval(() => {
          remainingSeconds--;
          if (remainingSeconds <= 0) {
            clearPropertyIntervals();
            updateCountdownDisplay();
            alert('é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°ç”¢ç”Ÿ QR Code');
            return;
          }
          updateCountdownDisplay();
        }, 1000);
        
        try {
          // ç”¢ç”Ÿæˆ¿å±‹æŒæœ‰é©—è­‰ QR Code
          const response = await fetch(`/api/v1/complete-flow/generate-vp-qrcode`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ref: vpRef
            })
          });
          
          const data = await response.json();
          console.log('æˆ¿å±‹æŒæœ‰æ†‘è­‰ QR Code å›æ‡‰:', data);
          
          if (!data || !data.success) {
            console.warn('ç”¢ç”Ÿ QR Code å¤±æ•—:', data);
            alert('ç”¢ç”Ÿ QR Code å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            clearPropertyIntervals();
            return;
          }
          
          // é¡¯ç¤º QR Code
          if (qrImg && data.qrcode_image) {
            qrImg.src = data.qrcode_image;
          }
          
          transactionId = data.transaction_id;
          console.log('æˆ¿å±‹é©—è­‰ Transaction ID:', transactionId);
          
          // é–‹å§‹è¼ªè©¢é©—è­‰çµæœ
          if (transactionId) {
            propertyPollingIntervalId = setInterval(async () => {
              try {
                // å–å¾—ç”³è«‹äººèº«åˆ†è­‰å­—è™Ÿï¼ˆå¾æ­¥é©Ÿ1çš„èº«åˆ†é©—è­‰è³‡æ–™ï¼‰
                const applicantIdNumber = currentUser?.id_number || idVerificationData?.id_number;
                
                if (!applicantIdNumber) {
                  console.error('âŒ æ‰¾ä¸åˆ°ç”³è«‹äººèº«åˆ†è­‰å­—è™Ÿ');
                  clearPropertyIntervals();
                  alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç”³è«‹äººèº«åˆ†è­‰å­—è™Ÿï¼Œè«‹é‡æ–°é–‹å§‹é©—è­‰æµç¨‹');
                  return;
                }
                
                console.log('è¼ªè©¢æˆ¿å±‹é©—è­‰çµæœ...', { transactionId, applicantIdNumber });
                
                // ä½¿ç”¨çµ±ä¸€çš„ verify-vp API
                const pollResult = await fetch(`/api/v1/complete-flow/verify-vp`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    transaction_id: transactionId,
                    applicant_id_number: applicantIdNumber
                  })
                });

                const pollData = await pollResult.json();
                console.log('æˆ¿å±‹æŒæœ‰é©—è­‰è¼ªè©¢çµæœ:', pollData);
                
                if (pollData && pollData.verified) {
                  console.log('âœ… æ­¥é©Ÿ2å®Œæˆï¼šæˆ¿å±‹æŒæœ‰é©—è­‰æˆåŠŸ');
                  clearPropertyIntervals();
                  
                  // æª¢æŸ¥èº«åˆ†è­‰æ˜¯å¦ç›¸ç¬¦
                  if (pollData.id_match === false) {
                    // èº«åˆ†è­‰ä¸ç¬¦ï¼Œé¡¯ç¤ºéŒ¯èª¤æç¤º
                    console.log('âŒ èº«åˆ†è­‰ä¸ç¬¦:', {
                      æˆ¿å±‹æŒæœ‰äºº: pollData.property_owner_id_number,
                      ç”³è«‹äºº: applicantIdNumber
                    });
                    showIdMismatchModal(pollData);
                    return;
                  }
                  
                  // èº«åˆ†è­‰ç›¸ç¬¦ï¼Œå„²å­˜æˆ¿å±‹æŒæœ‰è³‡æ–™
                  propertyVerified = true;
                  propertyVerificationData = {
                    id_number: pollData.property_owner_id_number,
                    name: pollData.property_owner_name,
                    address: pollData.property_address,
                    verified_at: new Date().toISOString()
                  };
                  
                  console.log('âœ… æˆ¿å±‹æŒæœ‰é©—è­‰æˆåŠŸï¼Œèº«åˆ†è­‰ç›¸ç¬¦');
                  
                  // é¡¯ç¤º loading å‹•ç•«
                  showLoadingAnimation('æˆ¿å±‹æŒæœ‰é©—è­‰æˆåŠŸï¼æ­£åœ¨è™•ç†...');
                  
                  // å»¶é² 6 ç§’è®“å‹•ç•«æ’­æ”¾å®Œæ•´ï¼Œç„¶å¾Œé€²å…¥ä¸‹ä¸€æ­¥
                  setTimeout(() => {
                    hideLoadingAnimation();
                    moveToStep3();
                  }, 10000);
                }
              } catch (err) {
                console.error('æˆ¿å±‹é©—è­‰è¼ªè©¢éŒ¯èª¤:', err);
              }
            }, 2000); // æ¯ 2 ç§’è¼ªè©¢ä¸€æ¬¡
          }
          
        } catch (error) {
          console.error('æˆ¿å±‹æŒæœ‰æ†‘è­‰é©—è­‰éŒ¯èª¤:', error);
          clearPropertyIntervals();
          alert('é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      }
      
      // æ¸…ç†æˆ¿å±‹é©—è­‰ç›¸é—œçš„è¨ˆæ™‚å™¨
      function clearPropertyIntervals() {
        if (propertyPollingIntervalId) {
          clearInterval(propertyPollingIntervalId);
          propertyPollingIntervalId = null;
        }
        if (propertyCountdownIntervalId) {
          clearInterval(propertyCountdownIntervalId);
          propertyCountdownIntervalId = null;
        }
        try {
          window._mixcurry_property_verification_started = false;
        } catch (e) {
          /* ignore */
        }
      }

      
      // é‡æ–°ç”¢ç”Ÿæˆ¿å±‹é©—è­‰ QR Code
      function regeneratePropertyQR() {
        console.log('ğŸ”„ é‡æ–°ç”¢ç”Ÿæˆ¿å±‹æŒæœ‰ QR Code');
        clearPropertyIntervals();
        startPropertyVerification();
      }
      
      // é¡¯ç¤ºèº«åˆ†è­‰ä¸ç¬¦æç¤ºè¦–çª—
      function showIdMismatchModal(data) {
        const modal = document.createElement('div');
        modal.className = 'id-mismatch-modal-overlay';
        modal.innerHTML = `
          <div class="id-mismatch-modal">
            <div class="id-mismatch-header">
              <span class="warning-icon">âš ï¸</span>
              <h3>èº«åˆ†è­‰å­—è™Ÿä¸ç¬¦</h3>
            </div>
            <div class="id-mismatch-body">
              <p class="warning-text">${data.message || 'æˆ¿å±‹æŒæœ‰äººèˆ‡ç”³è«‹äººé ˆç‚ºåŒä¸€äºº'}</p>
              <div class="id-comparison">
                <div class="id-item">
                  <span class="id-label">ç”³è«‹äººèº«åˆ†è­‰ï¼š</span>
                  <span class="id-value">${data.applicant_id_number || 'N/A'}</span>
                </div>
                <div class="id-item">
                  <span class="id-label">æˆ¿å±‹æŒæœ‰äººèº«åˆ†è­‰ï¼š</span>
                  <span class="id-value">${data.property_owner_id_number || 'N/A'}</span>
                </div>
              </div>
              <p class="hint-text">è«‹ç¢ºèªæ‚¨ä½¿ç”¨çš„æ˜¯æœ¬äººçš„æˆ¿ç”¢æŒæœ‰æ†‘è­‰</p>
            </div>
            <div class="id-mismatch-footer">
              <button class="btn-back-home" onclick="location.href='/'">å›åˆ°é¦–é </button>
              <button class="btn-regenerate-qr" onclick="closeIdMismatchModal(); regeneratePropertyQR();">ç”¢ç”Ÿæ–° QR Code</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }
      
      // é—œé–‰èº«åˆ†è­‰ä¸ç¬¦æç¤ºè¦–çª—
      function closeIdMismatchModal() {
        const modal = document.querySelector('.id-mismatch-modal-overlay');
        if (modal) {
          modal.remove();
        }
      }

      // æ­¥é©Ÿ 3ï¼šä¸Šå‚³ç½æç…§ç‰‡
      function moveToStep3() {
        currentFormStep = 3;
        document.getElementById('form-step2').classList.add('hidden');
        document.getElementById('form-step3').classList.remove('hidden');
        updateStepIndicators();
      }

      function prevFormStep(step) {
        currentFormStep = step;
        document.querySelectorAll('.form-step-container').forEach((el, index) => {
          el.classList.toggle('hidden', index + 1 !== step);
        });
        updateStepIndicators();
      }

      // ç…§ç‰‡ä¸Šå‚³è™•ç†
      function handlePhotoUpload(event) {
        const files = Array.from(event.target.files);
        const maxFiles = 10;
        
        if (uploadedPhotos.length + files.length > maxFiles) {
          alert(`æœ€å¤šåªèƒ½ä¸Šå‚³ ${maxFiles} å¼µç…§ç‰‡`);
          return;
        }

        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedPhotos.push({
              file: file,
              dataUrl: e.target.result
            });
            displayPhotoPreview();
          };
          reader.readAsDataURL(file);
        });
      }

      function displayPhotoPreview() {
        const container = document.getElementById('photoPreviewContainer');
        container.innerHTML = uploadedPhotos.map((photo, index) => `
          <div class="photo-preview-item">
            <img src="${photo.dataUrl}" alt="ç½æç…§ç‰‡ ${index + 1}" />
            <button class="photo-remove-btn" onclick="removePhoto(${index})">Ã—</button>
          </div>
        `).join('');
      }

      function removePhoto(index) {
        uploadedPhotos.splice(index, 1);
        displayPhotoPreview();
      }

      // æäº¤æ°´ç½ç”³è«‹
      async function submitFloodApplication() {
        const disasterDate = document.getElementById('disasterDate').value;
        const disasterDesc = document.getElementById('disasterDesc').value;

        if (!disasterDate) {
          alert('è«‹é¸æ“‡ç½å®³ç™¼ç”Ÿæ—¥æœŸ');
          return;
        }

        if (uploadedPhotos.length === 0) {
          alert('è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç½æç…§ç‰‡');
          return;
        }

        // é¡¯ç¤ºæäº¤ä¸­çš„ loading ç•«é¢
        const loadingOverlay = showLoadingOverlay();

        try {
          console.log('ğŸ“ æº–å‚™æäº¤ç”³è«‹');
          console.log('   ç•¶å‰ç”¨æˆ¶è³‡æ–™:', currentUser);
          console.log('   èº«åˆ†é©—è­‰è³‡æ–™:', idVerificationData);
          console.log('   æˆ¿å±‹é©—è­‰è³‡æ–™:', propertyVerificationData);

          // ğŸ”‘ å„ªå…ˆä½¿ç”¨æ­¥é©Ÿ1çš„èº«åˆ†é©—è­‰è³‡æ–™ï¼ˆçœŸå¯¦èº«åˆ†è­‰ï¼‰
          const applicantName = idVerificationData?.name || currentUser?.full_name || currentUser?.name || 'æœªæä¾›å§“å';
          const applicantIdNumber = idVerificationData?.id_number || currentUser?.id_number || 'TEMP_' + Date.now();
          const applicantPhone = idVerificationData?.phone || currentUser?.phone || '0900000000';
          const applicantAddress = propertyVerificationData?.address || currentUser?.address || 'å¾…è£œå……åœ°å€è³‡è¨Š';

          console.log('âœ… ä½¿ç”¨çš„ç”³è«‹äººè³‡æ–™:');
          console.log('   å§“å:', applicantName);
          console.log('   èº«åˆ†è­‰:', applicantIdNumber);
          console.log('   é›»è©±:', applicantPhone);
          console.log('   åœ°å€:', applicantAddress);

          // æ›´æ–°é€²åº¦ï¼šæäº¤ç”³è«‹è³‡æ–™
          updateLoadingProgress(loadingOverlay, 'æ­£åœ¨æäº¤ç”³è«‹è³‡æ–™...', 20);

          // å‰µå»ºç”³è«‹ - ä½¿ç”¨é©—è­‰å¾Œçš„çœŸå¯¦è³‡æ–™
          const appData = {
            applicant_id: currentUser?.id || idVerificationData?.user_id || 'temp_' + Date.now(),
            applicant_name: applicantName,
            id_number: applicantIdNumber,
            phone: applicantPhone,
            address: applicantAddress,
            disaster_date: disasterDate,
            disaster_type: 'flood',
            damage_description: disasterDesc || 'æ°´ç½é€ æˆè²¡ç‰©æå¤±',
            damage_location: applicantAddress,
            requested_amount: 20000,
            estimated_loss: 20000,
            subsidy_type: 'housing'
          };

          console.log('ğŸ“¤ ç™¼é€ç”³è«‹è³‡æ–™:', appData);

          const response = await fetch(`${API_BASE}/applications/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify(appData)
          });

          const result = await response.json();
          console.log('ğŸ“¥ å¾Œç«¯å›æ‡‰:', result);

          if (response.ok) {
            const applicationId = result.data?.id || result.id;

            if (!applicationId) {
              throw new Error('ç„¡æ³•å–å¾—ç”³è«‹ ID');
            }

            // æ›´æ–°é€²åº¦ï¼šç”³è«‹è³‡æ–™å·²æäº¤
            updateLoadingProgress(loadingOverlay, 'ç”³è«‹è³‡æ–™å·²æäº¤ï¼Œæ­£åœ¨ä¸Šå‚³ç…§ç‰‡...', 40);

            // ä¸Šå‚³ç…§ç‰‡ï¼ˆå¸¶é€²åº¦æ›´æ–°ï¼‰
            console.log('ğŸ“¸ é–‹å§‹ä¸Šå‚³ç…§ç‰‡...');
            await uploadPhotosToApplication(applicationId, loadingOverlay);

            // æ›´æ–°é€²åº¦ï¼šå®Œæˆ
            updateLoadingProgress(loadingOverlay, 'ç”³è«‹å®Œæˆï¼', 100);

            // çŸ­æš«å»¶é²å¾Œé—œé–‰ loading ä¸¦é¡¯ç¤ºæˆåŠŸç•«é¢
            setTimeout(() => {
              closeLoadingOverlay(loadingOverlay);
              console.log('âœ… ç”³è«‹æˆåŠŸï¼Œé¡¯ç¤ºæˆåŠŸç•«é¢');
              showScreen('successScreen');
            }, 500);

          } else {
            closeLoadingOverlay(loadingOverlay);
            const errorMsg = result.message || result.detail || 'ç”³è«‹æäº¤å¤±æ•—';
            throw new Error(errorMsg);
          }
        } catch (error) {
          closeLoadingOverlay(loadingOverlay);
          console.error('âŒ æäº¤ç”³è«‹éŒ¯èª¤:', error);
          alert('ç”³è«‹æäº¤å¤±æ•—ï¼š' + error.message);
        }
      }

      async function uploadPhotosToApplication(applicationId, loadingOverlay) {
        console.log(`ğŸ“¸ ä¸Šå‚³ ${uploadedPhotos.length} å¼µç…§ç‰‡åˆ°ç”³è«‹ ${applicationId}`);
        
        const totalPhotos = uploadedPhotos.length;
        
        for (let i = 0; i < totalPhotos; i++) {
          const photo = uploadedPhotos[i];
          
          // æ›´æ–°é€²åº¦
          const progress = 40 + Math.floor((i / totalPhotos) * 50);
          updateLoadingProgress(loadingOverlay, `æ­£åœ¨ä¸Šå‚³ç…§ç‰‡ ${i + 1}/${totalPhotos}...`, progress);
          
          const formData = new FormData();
          formData.append('file', photo.file);
          formData.append('application_id', applicationId);
          formData.append('document_type', 'damage_photo');
          formData.append('uploaded_by', currentUser.id);

          try {
            console.log(`ğŸ“¤ ä¸Šå‚³ç¬¬ ${i + 1} å¼µç…§ç‰‡:`, photo.file.name);
            
            const response = await fetch(`${API_BASE}/documents/upload`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${accessToken}`
              },
              body: formData
            });

            if (response.ok) {
              console.log(`âœ… ç…§ç‰‡ ${i + 1} ä¸Šå‚³æˆåŠŸ`);
            } else {
              const error = await response.json();
              console.error(`âŒ ç…§ç‰‡ ${i + 1} ä¸Šå‚³å¤±æ•—:`, error);
            }
          } catch (error) {
            console.error(`âŒ ç…§ç‰‡ ${i + 1} ä¸Šå‚³éŒ¯èª¤:`, error);
          }
        }
        
        // æ›´æ–°é€²åº¦ï¼šç…§ç‰‡ä¸Šå‚³å®Œæˆ
        updateLoadingProgress(loadingOverlay, `å·²ä¸Šå‚³ ${totalPhotos} å¼µç…§ç‰‡`, 90);
        console.log('âœ… æ‰€æœ‰ç…§ç‰‡ä¸Šå‚³å®Œæˆ');
      }

      // é¡¯ç¤º Loading é®ç½©
      function showLoadingOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'submit-loading-overlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;

        overlay.innerHTML = `
          <div style="background: white; border-radius: 16px; padding: 40px; text-align: center; min-width: 320px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
            <div style="width: 64px; height: 64px; margin: 0 auto 24px; border: 4px solid #e2e8f0; border-top-color: #1e81b2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <h3 id="loading-title" style="font-size: 20px; font-weight: 600; color: #0f172a; margin-bottom: 12px;">æ­£åœ¨è™•ç†...</h3>
            <p id="loading-message" style="color: #64748b; font-size: 14px; margin-bottom: 24px;">è«‹ç¨å€™ï¼Œä¸è¦é—œé–‰è¦–çª—</p>
            
            <div style="background: #f1f5f9; border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 12px;">
              <div id="loading-progress-bar" style="background: #1e81b2; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <p id="loading-progress-text" style="color: #94a3b8; font-size: 12px;">0%</p>
          </div>
        `;

        // æ·»åŠ æ—‹è½‰å‹•ç•«
        const style = document.createElement('style');
        style.textContent = `
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(overlay);
        return overlay;
      }

      // æ›´æ–° Loading é€²åº¦
      function updateLoadingProgress(overlay, message, progress) {
        const messageEl = overlay.querySelector('#loading-message');
        const progressBar = overlay.querySelector('#loading-progress-bar');
        const progressText = overlay.querySelector('#loading-progress-text');

        if (messageEl) messageEl.textContent = message;
        if (progressBar) progressBar.style.width = `${progress}%`;
        if (progressText) progressText.textContent = `${progress}%`;
      }

      // é—œé–‰ Loading é®ç½©
      function closeLoadingOverlay(overlay) {
        if (overlay && overlay.parentNode) {
          overlay.remove();
        }
      }

      // å€’æ•¸è¨ˆæ™‚å™¨
      function startCountdown(element, seconds) {
        let remaining = seconds;
        
        const interval = setInterval(() => {
          const minutes = Math.floor(remaining / 60);
          const secs = remaining % 60;
          element.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
          
          remaining--;
          
          if (remaining < 0) {
            clearInterval(interval);
            element.textContent = '0:00';
          }
        }, 1000);
      }

      // ========================================
      // VP (Verifiable Presentation) ç›¸é—œè®Šæ•¸
      // ç”¨æ–¼å…¶ä»– VP é©—è­‰åŠŸèƒ½ï¼ˆä¿ç•™ä¸å‹•ï¼‰
      // ========================================
      let vpPollingInterval = null;
      let vpCountdownInterval = null;
      let currentVPApplicationId = null;

      // ========================================
      // VC (Verifiable Credential) æ†‘è­‰ç™¼è¡Œç›¸é—œè®Šæ•¸
      // ç”¨æ–¼ç½å®³è£œåŠ©è³‡æ ¼æ†‘è­‰ç™¼è¡Œæµç¨‹
      // ========================================
      let vcPollingInterval = null;
      let vcCountdownInterval = null;
      let currentVCApplicationId = null;

      // ========================================
      // VC æ†‘è­‰é ˜å– Modalï¼ˆç½å®³è£œåŠ©è³‡æ ¼æ†‘è­‰ï¼‰
      // ========================================
      async function showVPClaimModal(applicationId) {
        console.log('ğŸ¯ ========================================');
        console.log('ğŸ¯ showVPClaimModal è¢«èª¿ç”¨');
        console.log('ğŸ¯ ========================================');
        console.log('   applicationId:', applicationId);
        console.log('   ç•¶å‰ URL:', window.location.href);
        console.log('   accessToken å­˜åœ¨:', !!accessToken);
        console.log('   currentUser:', currentUser);
        console.log('ğŸ“ æ³¨æ„ï¼šé€™æ˜¯ VC (æ†‘è­‰ç™¼è¡Œ) æµç¨‹ï¼Œä¸æ˜¯ VP (èº«åˆ†é©—è­‰)');
        
        currentVCApplicationId = applicationId;
        const modal = document.getElementById('vpClaimModal');
        
        console.log('ğŸ” æŸ¥æ‰¾ Modal å…ƒç´ ...');
        console.log('   Modal å…ƒç´ :', modal);
        console.log('   Modal classList:', modal ? modal.classList.toString() : 'null');
        
        if (!modal) {
          console.error('âŒ æ‰¾ä¸åˆ° vpClaimModal å…ƒç´ ');
          alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ†‘è­‰é ˜å–è¦–çª—\n\nè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡');
          return;
        }
        
        console.log('âœ… Modal å…ƒç´ æ‰¾åˆ°');
        console.log('ğŸ“± ç§»é™¤ hidden é¡åˆ¥...');
        modal.classList.remove('hidden');
        console.log('   ç§»é™¤å¾Œ classList:', modal.classList.toString());
        console.log('   Modal display style:', window.getComputedStyle(modal).display);
        console.log('âœ… Modal æ‡‰è©²å·²ç¶“é¡¯ç¤º');

        // ç”Ÿæˆ VC QR Codeï¼ˆç½å®³è£œåŠ©è³‡æ ¼æ†‘è­‰ï¼‰
        try {
          console.log('ğŸ« é–‹å§‹èª¿ç”¨ generateVCQRCode...');
          await generateVCQRCode(applicationId);
          console.log('âœ… generateVCQRCode å®Œæˆ');
        } catch (error) {
          console.error('âŒ generateVCQRCode éŒ¯èª¤:');
          console.error('   éŒ¯èª¤è¨Šæ¯:', error.message);
          console.error('   éŒ¯èª¤å †ç–Š:', error.stack);
          alert('ç”Ÿæˆæ†‘è­‰å¤±æ•—ï¼š' + error.message + '\n\nè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡å®¢æœ');
          closeVPClaimModal();
        }
      }

      function closeVPClaimModal() {
        const modal = document.getElementById('vpClaimModal');
        modal.classList.add('hidden');
        
        // æ¸…é™¤ VC è¼ªè©¢å’Œå€’æ•¸è¨ˆæ™‚
        if (vcPollingInterval) {
          clearInterval(vcPollingInterval);
          vcPollingInterval = null;
        }
        if (vcCountdownInterval) {
          clearInterval(vcCountdownInterval);
          vcCountdownInterval = null;
        }
        
        currentVCApplicationId = null;
      }

      async function generateVCQRCode(applicationId) {
        try {
          console.log('ğŸ« é–‹å§‹ç”¢ç”Ÿç½å®³è£œåŠ©æ†‘è­‰ QR Code');
          console.log('   applicationId:', applicationId);
          console.log('   API_BASE:', API_BASE);
          console.log('   accessToken å­˜åœ¨:', !!accessToken);
          
          // å…ˆå–å¾—ç”³è«‹è³‡æ–™
          const appURL = `${API_BASE}/applications/${applicationId}`;
          console.log('ğŸ“¡ èª¿ç”¨ API:', appURL);
          
          const appResponse = await fetch(appURL, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
          });
          
          console.log('ğŸ“¥ API å›æ‡‰ç‹€æ…‹:', appResponse.status);
          
          if (!appResponse.ok) {
            const errorText = await appResponse.text();
            console.error('âŒ API éŒ¯èª¤å›æ‡‰:', errorText);
            throw new Error(`ç„¡æ³•å–å¾—ç”³è«‹è³‡æ–™ (${appResponse.status})`);
          }
          
          const appData = await appResponse.json();
          console.log('ğŸ“¦ ç”³è«‹è³‡æ–™:', appData);
          
          const application = appData.data?.application || appData.application || appData;
          console.log('ğŸ“‹ è§£æå¾Œçš„ç”³è«‹:', application);
          
          // å¦‚æœæ²’æœ‰ QR Codeï¼Œç”¢ç”Ÿæ–°çš„ï¼ˆèª¿ç”¨å¾Œç«¯ç™¼è¡Œ APIï¼‰
          console.log('ğŸ“¤ ç”¢ç”Ÿæ–°çš„ç½å®³è£œåŠ©æ†‘è­‰ QR Code');
          console.log('   è«‹æ±‚åƒæ•¸:', {
            application_id: applicationId,
            approved: true,
            approved_amount: application.requested_amount || application.approved_amount
          });
          
          const issueResponse = await fetch(`${API_BASE}/complete-flow/review-and-issue`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              application_id: applicationId,
              approved: true,
              approved_amount: application.requested_amount || application.approved_amount
            })
          });

          console.log('ğŸ“¥ ç™¼è¡Œ API å›æ‡‰ç‹€æ…‹:', issueResponse.status);

          if (!issueResponse.ok) {
            const errorData = await issueResponse.json().catch(() => ({}));
            console.error('âŒ ç™¼è¡Œ API éŒ¯èª¤:', errorData);
            throw new Error(errorData.detail || `ç”Ÿæˆ QR Code å¤±æ•— (${issueResponse.status})`);
          }

          const result = await issueResponse.json();
          console.log('âœ… QR Code ç”Ÿæˆçµæœ:', result);
          console.log('   qr_code å­˜åœ¨:', !!result.qr_code);
          console.log('   qr_code é•·åº¦:', result.qr_code ? result.qr_code.length : 0);
          console.log('   transaction_id:', result.transaction_id);
          
          // é¡¯ç¤º QR Codeï¼ˆéœ€è¦åŠ ä¸Š data:image å‰ç¶´ï¼‰
          if (result.qr_code) {
            const qrCodeImg = document.getElementById('vpQrCode');
            
            if (!qrCodeImg) {
              console.error('âŒ æ‰¾ä¸åˆ° vpQrCode åœ–ç‰‡å…ƒç´ ');
              throw new Error('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° QR Code é¡¯ç¤ºå…ƒç´ ');
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“åŒ…å« data:image å‰ç¶´
            if (result.qr_code.startsWith('data:image')) {
              qrCodeImg.src = result.qr_code;
              console.log('âœ… QR Code å·²è¨­å®šï¼ˆå«å‰ç¶´ï¼‰');
            } else {
              // å¦‚æœæ˜¯ base64 å­—ä¸²ï¼ŒåŠ ä¸Šå‰ç¶´
              qrCodeImg.src = `data:image/png;base64,${result.qr_code}`;
              console.log('âœ… QR Code å·²è¨­å®šï¼ˆæ·»åŠ å‰ç¶´ï¼‰');
            }
            
            console.log('ğŸ“¸ æœ€çµ‚ img.src é•·åº¦:', qrCodeImg.src.length);
            
            // é–‹å§‹å€’æ•¸è¨ˆæ™‚ï¼ˆ5 åˆ†é˜ï¼‰
            startVCCountdown(300);
            
            // é–‹å§‹è¼ªè©¢æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²æƒæä¸¦å­˜å…¥æ†‘è­‰
            if (result.transaction_id) {
              startVCPolling(result.transaction_id, applicationId);
            } else {
              console.warn('âš ï¸  ç¼ºå°‘ transaction_idï¼Œç„¡æ³•å•Ÿå‹•è¼ªè©¢');
            }
          } else {
            console.error('âŒ å›æ‡‰ä¸­ç¼ºå°‘ qr_code æ¬„ä½');
            throw new Error('QR Code è³‡æ–™éºå¤±');
          }
        } catch (error) {
          console.error('âŒ ç”Ÿæˆ VC QR Code éŒ¯èª¤:', error);
          console.error('   éŒ¯èª¤å †ç–Š:', error.stack);
          alert('ç”Ÿæˆæ†‘è­‰å¤±æ•—ï¼š' + error.message + '\n\nè«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡å®¢æœ');
          closeVPClaimModal();
        }
      }

      // VC æ†‘è­‰å€’æ•¸è¨ˆæ™‚å‡½æ•¸
      function startVCCountdown(seconds) {
        const countdownElement = document.getElementById('vpCountdown');
        let remaining = seconds;

        vcCountdownInterval = setInterval(() => {
          const minutes = Math.floor(remaining / 60);
          const secs = remaining % 60;
          countdownElement.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;

          remaining--;

          if (remaining < 0) {
            clearInterval(vcCountdownInterval);
            countdownElement.textContent = '0:00';
            alert('QR Code å·²éæœŸï¼Œè«‹é‡æ–°ç”¢ç”Ÿ');
          }
        }, 1000);
      }

      // VC æ†‘è­‰é ˜å–è¼ªè©¢å‡½æ•¸
      function startVCPolling(transactionId, applicationId) {
        console.log('ğŸ”„ é–‹å§‹è¼ªè©¢æ†‘è­‰é ˜å–ç‹€æ…‹...', { transactionId, applicationId });
        
        let pollAttempts = 0;
        const maxAttempts = 150; // æœ€å¤šè¼ªè©¢ 150 æ¬¡ï¼ˆ5åˆ†é˜ï¼Œæ¯ 2 ç§’ä¸€æ¬¡ï¼‰
        
        vcPollingInterval = setInterval(async () => {
          pollAttempts++;
          
          try {
            // ğŸ¯ ä½¿ç”¨æ”¿åºœ APIï¼šGET /api/credential/nonce/{transactionId}
            // é€™å€‹ API æœƒæª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²æƒæä¸¦å­˜å…¥ VC å¡ç‰‡
            const response = await fetch(`${API_BASE}/complete-flow/check-credential-claim/${transactionId}`, {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${accessToken}`
              }
            });

            if (response.ok) {
              const result = await response.json();
              console.log(`è¼ªè©¢çµæœ (${pollAttempts}/${maxAttempts}):`, result);

              // ğŸ” æª¢æŸ¥ credential æ¬„ä½ä¸­çš„ JWT Token
              if (result.credential) {
                console.log('âœ… æ†‘è­‰é ˜å–æˆåŠŸï¼ç”¨æˆ¶å·²æƒæä¸¦å­˜å…¥ VC');
                
                // æ¸…é™¤è¨ˆæ™‚å™¨
                clearInterval(vcPollingInterval);
                clearInterval(vcCountdownInterval);
                vcPollingInterval = null;
                vcCountdownInterval = null;
                
                // æ†‘è­‰é ˜å–æ­·å²å·²åœ¨å¯©æ ¸é€šéæ™‚è¨˜éŒ„ï¼Œä¸éœ€è¦é‡è¤‡è¨˜éŒ„
                
                // æ›´æ–°ç”³è«‹ç‹€æ…‹ç‚ºã€Œå·²é ˜å–ã€
                try {
                  const updateResponse = await fetch(`${API_BASE}/applications/${applicationId}`, {
                    method: 'PATCH',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                      status: 'completed',
                      vp_claimed: true,
                      vp_claimed_at: new Date().toISOString()
                    })
                  });
                  
                  if (updateResponse.ok) {
                    console.log('âœ… ç”³è«‹ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œå·²é ˜å–ã€');
                  }
                } catch (updateError) {
                  console.error('æ›´æ–°ç”³è«‹ç‹€æ…‹å¤±æ•—:', updateError);
                }
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                alert('ğŸ‰ æ†‘è­‰é ˜å–æˆåŠŸï¼\n\næ‚¨çš„ç½å®³è£œåŠ©è³‡æ ¼æ†‘è­‰å·²å„²å­˜è‡³æ•¸ä½çš®å¤¾ä¸­ã€‚\n\næ‚¨å¯ä»¥åœ¨æ•¸ä½çš®å¤¾ APP ä¸­æŸ¥çœ‹æ­¤æ†‘è­‰ï¼Œä¸¦åœ¨éœ€è¦æ™‚å‡ºç¤ºè­‰æ˜æ‚¨çš„è£œåŠ©è³‡æ ¼ã€‚');
                
                // é—œé–‰ Modal
                closeVPClaimModal();
                
                // é‡æ–°è¼‰å…¥ç”³è«‹è¨˜éŒ„
                showMyApplications();
                
                return; // çµæŸè¼ªè©¢
              }
            } else {
              console.log(`è¼ªè©¢ä¸­... (${pollAttempts}/${maxAttempts})`);
            }
            
            // æª¢æŸ¥æ˜¯å¦è¶…æ™‚
            if (pollAttempts >= maxAttempts) {
              console.log('â±ï¸ è¼ªè©¢è¶…æ™‚');
              clearInterval(vcPollingInterval);
              clearInterval(vcCountdownInterval);
              vcPollingInterval = null;
              vcCountdownInterval = null;
              alert('é©—è­‰é€¾æ™‚\n\nè«‹ç¢ºèªæ˜¯å¦å·²æˆåŠŸæƒæ QR Codeã€‚\nå¦‚æœå·²æƒæä½†æœªæˆåŠŸï¼Œè«‹é‡æ–°å˜—è©¦æˆ–è¯çµ¡å®¢æœã€‚');
            }
          } catch (error) {
            console.error('è¼ªè©¢éŒ¯èª¤:', error);
            // å¦‚æœåˆ°é”æœ€å¤§æ¬¡æ•¸ï¼Œåœæ­¢è¼ªè©¢
            if (pollAttempts >= maxAttempts) {
              clearInterval(vcPollingInterval);
              clearInterval(vcCountdownInterval);
              vcPollingInterval = null;
              vcCountdownInterval = null;
            }
          }
        }, 2000); // æ¯ 2 ç§’æª¢æŸ¥ä¸€æ¬¡
      }

      // é‡æ–°ç”¢ç”Ÿ VC QR Code
      async function regenerateVPQR() {
        if (!currentVCApplicationId) return;

        console.log('ğŸ”„ é‡æ–°ç”¢ç”Ÿæ†‘è­‰ QR Code');
        
        // æ¸…é™¤ç¾æœ‰çš„å®šæ™‚å™¨
        if (vcPollingInterval) {
          clearInterval(vcPollingInterval);
        }
        if (vcCountdownInterval) {
          clearInterval(vcCountdownInterval);
        }

        // é‡æ–°ç”Ÿæˆ
        await generateVCQRCode(currentVCApplicationId);
      }
    </script>
  </body>
</html>
