<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans TC', sans-serif;
        }

        body {
            background: white;
            min-height: 100vh;
        }

        .header {
            background-color: #CBD5E1;
            padding: 48px 96px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            color: #000;
        }

        .header-nav {
            display: flex;
            gap: 24px;
            font-size: 20px;
            font-weight: 500;
            color: #000;
        }

        .header-nav a {
            text-decoration: none;
            color: inherit;
            letter-spacing: 0.4px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 80px;
        }

        .page-title {
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 40px;
            letter-spacing: 0.6px;
        }

        .login-container {
            width: 612px;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 48px;
        }

        .login-tabs {
            display: flex;
        }

        .login-tab {
            flex: 1;
            padding: 24px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.4px;
            cursor: pointer;
        }

        .login-tab.active {
            background-color: #64748B;
            color: #F8FAFC;
        }

        .login-tab:not(.active) {
            background-color: #CBD5E1;
            color: #000;
        }

        .login-form {
            background-color: #F1F5F9;
            padding: 48px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }

        .form-group label {
            font-size: 16px;
            color: #020618;
            letter-spacing: 0.64px;
        }

        .form-group input {
            padding: 8px 12px;
            height: 40px;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            background: #fff;
            font-size: 14px;
            color: #62748E;
        }

        .input-with-button {
            position: relative;
            width: 100%;
        }

        .input-with-button input {
            width: 100%;
            padding-right: 110px; /* ç‚ºæŒ‰éˆ•é ç•™ç©ºé–“ */
        }

        .input-with-button .verification-send-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            height: calc(100% - 4px);
            margin: 0;
            border-radius: 4px;
        }

        .verification-container {
            display: flex;
            gap: 24px;
            align-items: center;
            width: 100%;
        }

        .verification-code {
            background: #F8FAFC;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 20px;
            color: #334155;
            letter-spacing: 0.4px;
            line-height: 28px;
        }

        .verification-input {
            flex: 1;
            padding: 8px 12px;
            height: 40px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            background: #fff;
            font-size: 14px;
            color: #62748E;
        }

        .login-btn {
            width: 100%;
            padding: 8px 16px;
            background: #0F172A;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            letter-spacing: 0.64px;
            cursor: pointer;
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            margin: 8px 0;
        }

        .divider-line {
            flex: 1;
            height: 2px;
            background: #94A3B8;
            border-radius: 999px;
        }

        .divider-text {
            color: #94A3B8;
            font-size: 14px;
            letter-spacing: 0.56px;
        }

        .google-btn {
            width: 100%;
            padding: 8px 16px;
            background: #CBD5E1;
            color: #0F172A;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            letter-spacing: 0.64px;
            cursor: pointer;
        }

        /* ç§»é™¤ refresh-captcha æŒ‰éˆ•çš„å¤–æ¡†å’ŒèƒŒæ™¯ */
        .refresh-captcha {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            cursor: pointer;
        }

        .register-link a {
            color: inherit;
            text-decoration: underline;
        }
            .verification-send-btn {
                padding: 8px 16px;
                background: #0F172A;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                letter-spacing: 0.64px;
                cursor: pointer;
                white-space: nowrap;
                transition: background-color 0.3s;
            }

            .verification-send-btn:disabled {
                background: #94A3B8;
                cursor: not-allowed;
            }

            /* Digital ID Login Form Styles */
            .digital-header {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                width: 100%;
            }

            .digital-title {
                font-family: 'Noto Sans TC', sans-serif;
                font-weight: 700;
                font-size: 24px;
                line-height: 32px;
                text-align: center;
                letter-spacing: 0.48px;
                color: #020618;
            }

            .digital-subtitle {
                font-family: 'Noto Sans TC', sans-serif;
                font-weight: 400;
                font-size: 16px;
                line-height: 24px;
                text-align: center;
                letter-spacing: 0.64px;
                color: #020618;
            }



            .qr-code-inner {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 16px;
            }

            .qr-code-container img {
                width: 188px;
                height: 188px;
                border-radius: 8px;
                border: 1px solid #E2E8F0;
            }

            .qr-code-timer {
                display: flex;
                align-items: center;
                gap: 4px;
                color: #64748B;
                font-size: 14px;
            }

            .countdown-time {
                color: #0F172A;
                font-weight: 500;
            }

            .qr-hint {
                font-family: 'Noto Sans TC', sans-serif;
                font-weight: 400;
                font-size: 12px;
                line-height: 20px;
                text-align: center;
                letter-spacing: 0.48px;
                color: #475569;
                margin-bottom: 24px;
            }

            .link-text {
                font-family: 'Noto Sans TC', sans-serif;
                font-weight: 400;
                font-size: 16px;
                line-height: 24px;
                text-align: center;
                text-decoration-line: underline;
                color: #000000;
                letter-spacing: 0.64px;
                margin: 24px 0;
                display: block;
            }

            .register-text {
                font-family: 'Noto Sans TC', sans-serif;
                font-weight: 400;
                font-size: 16px;
                line-height: 24px;
                text-align: center;
                letter-spacing: 0.64px;
                color: #000000;
            }

            .register-text a {
                text-decoration-line: underline;
                color: inherit;
            }

        /* ç™»å…¥æˆåŠŸç•«é¢æ¨£å¼ */
        .success-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: white;
            z-index: 1000;
        }

        .success-screen.active {
            display: flex;
            flex-direction: column;
        }

        .success-screen .header {
            width: 100%;
        }

        .success-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 20px;
        }

        .success-form {
            width: 612px;
            background-color: #F1F5F9;
            border-radius: 16px;
            padding: 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            margin: 0 auto;
        }

        .success-title {
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            font-size: 24px;
            line-height: 32px;
            text-align: center;
            letter-spacing: 0.48px;
            color: #020618;
        }

        .success-icon-container {
            width: 96px;
            height: 96px;
            background-color: #CBD5E1;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success-icon {
            width: 48px;
            height: 48px;
        }

        .success-subtitle {
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 400;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
            letter-spacing: 0.64px;
            color: #475569;
        }

        .success-email {
            padding: 8px 12px;
            background-color: #64748B;
            border-radius: 999px;
            color: #F8FAFC;
            font-size: 16px;
            letter-spacing: 0.64px;
        }

        .success-buttons {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 48px;
            padding: 40px 0;
            margin-top: auto;
        }

        .success-button {
            width: 376px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            letter-spacing: 0.64px;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }

        .success-button:hover {
            opacity: 0.9;
        }

        .success-button.secondary {
            background-color: #CBD5E1;
            color: #0F172A;
        }

        .success-button.primary {
            background-color: #0F172A;
            color: white;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</h1>
        <nav class="header-nav">
            <a href="/">è¿”å›é¦–é </a>
        </nav>
    </header>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const DEFAULT_QR = '';

            const tabs = document.querySelectorAll('.login-tab');
            const forms = {
                'general': document.getElementById('general-login-form'),
                'digital': document.getElementById('digital-login-form')
            };

            // Elements used by digital flow
            const qrImg = document.querySelector('.qr-code-container img');
            const countdownEl = document.querySelector('.countdown-time');

            // Ensure QR has a default image so it's visible immediately
            if (qrImg && (!qrImg.getAttribute('src') || qrImg.getAttribute('src') === '')) {
                qrImg.src = DEFAULT_QR;
            }
            // initialize countdown visible text to 5:00
            if (countdownEl && (!countdownEl.textContent || countdownEl.textContent.trim() === '')) countdownEl.textContent = '5:00';

            // Helpers to show/hide forms and set active tab
            // startFlow (default true) controls whether to start the digital flow when switching to the digital tab.
            function setActiveTab(tabEl, startFlow = true) {
                tabs.forEach(t => t.classList.remove('active'));
                tabEl.classList.add('active');

                // Hide all forms
                Object.values(forms).forEach(form => form.style.display = 'none');

                const formId = tabEl.getAttribute('data-tab');
                if (forms[formId]) forms[formId].style.display = 'flex';

                // If digital tab activated, do not auto-start flow here to avoid accidental duplicate calls.
                // The flow is started explicitly either on page-load (if digital tab is active) or when the user clicks the digital tab.
                /*
                if (formId === 'digital' && startFlow) {
                    loginWithDigitalID();
                }
                */
            }

            // Generic tab clicks should switch UI but not automatically start the digital flow.
            // The digital tab has its own click handler below that will start/ restart the flow.
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const formId = this.getAttribute('data-tab');
                    if (formId === 'general') {
                        // å¦‚æœåˆ‡æ›åˆ°ä¸€èˆ¬ç™»å…¥tabï¼Œåœæ­¢æ•¸ä½èº«åˆ†è­‰çš„é©—è­‰API
                        clearDigitalIntervals();
                    }
                    setActiveTab(this, false);
                });
            });

            // On load: make sure the visible tab's flow is started
            const initialActive = document.querySelector('.login-tab.active') || tabs[0];
            if (initialActive) setActiveTab(initialActive, false);

            // Do NOT call loginWithDigitalID here to avoid duplicate API calls.
            // We'll start the digital flow once after the function is defined (below), and only when the digital tab is active.

            // é©—è­‰ç¢¼ç™¼é€æŒ‰éˆ•å€’è¨ˆæ™‚åŠŸèƒ½
            const verificationBtn = document.querySelector('.verification-send-btn');
            let timeLeft = 180; // 3åˆ†é˜ = 180ç§’
            let countdownTimer = null;

            function startCountdown() {
                if (!verificationBtn) return;
                verificationBtn.disabled = true;
                timeLeft = 180;

                function updateButtonText() {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    verificationBtn.textContent = `é‡æ–°ç™¼é€ (${minutes}:${seconds.toString().padStart(2, '0')})`;

                    if (timeLeft <= 0) {
                        clearInterval(countdownTimer);
                        verificationBtn.disabled = false;
                        verificationBtn.textContent = 'ç™¼é€é©—è­‰ç¢¼';
                        return;
                    }
                    timeLeft--;
                }

                updateButtonText();
                countdownTimer = setInterval(updateButtonText, 1000);
            }

            if (verificationBtn) {
                verificationBtn.addEventListener('click', async function() {
                    const email = document.getElementById('email').value;

                    if (!email) {
                        alert('è«‹è¼¸å…¥ Email');
                        return;
                    }

                    // Emailæ ¼å¼é©—è­‰
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼');
                        return;
                    }

                    try {
                        const response = await fetch('/api/v1/auth/email/auth', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: email,
                                is_verified: false
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            startCountdown();
                            if (data.verification_code) {
                                // é–‹ç™¼ç’°å¢ƒ: é¡¯ç¤ºé©—è­‰ç¢¼åœ¨console
                                console.log('é©—è­‰ç¢¼(é–‹ç™¼ç”¨):', data.verification_code);
                                alert('âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼\n\n(é–‹ç™¼ç’°å¢ƒï¼šé©—è­‰ç¢¼å·²è¼¸å‡ºåˆ°Console)');
                            } else {
                                // ç”Ÿç”¢ç’°å¢ƒï¼šä¸é¡¯ç¤ºé©—è­‰ç¢¼
                                alert('âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼');
                            }
                        } else {
                            const error = await response.json();
                            alert('ç™¼é€å¤±æ•—ï¼š' + (error.detail || 'è«‹ç¨å¾Œå†è©¦'));
                        }
                    } catch (error) {
                        console.error('ç™¼é€é©—è­‰ç¢¼éŒ¯èª¤:', error);
                        alert('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message);
                    }
                });
            }

            // ç™»å…¥æˆåŠŸç•«é¢æŒ‰éˆ•äº‹ä»¶è™•ç†
            const successScreen = document.querySelector('.success-screen');
            const successEmailText = successScreen ? successScreen.querySelector('.success-email') : null;
            const homeBtn = successScreen ? successScreen.querySelector('.success-button.secondary') : null; // å°å‘ç”³è«‹æ­·å²ç´€éŒ„é 
            const applyBtn = successScreen ? successScreen.querySelector('.success-button.primary') : null;

            if (homeBtn) homeBtn.addEventListener('click', function() { window.location.href = 'applicant_history.html'; });
            if (applyBtn) applyBtn.addEventListener('click', function() { window.location.href = '/applications'; });

            function showLoginSuccess(email) {
                if (!successEmailText || !successScreen) return;
                successEmailText.textContent = email;
                successScreen.classList.add('active');
                document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾åŠ¨
            }

            // ç™»å…¥æŒ‰éˆ•äº‹ä»¶è™•ç†
            const loginBtn = document.querySelector('.login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', async function() {
                    const email = document.getElementById('email').value;
                    const verificationCode = document.getElementById('password').value;
                    const captchaInputEl = document.querySelector('.verification-input');
                    const captchaInput = captchaInputEl ? captchaInputEl.value : '';
                    const captchaTextEl = document.querySelector('.verification-code');
                    const captchaText = captchaTextEl ? captchaTextEl.textContent : '';

                    // é©—è­‰è¼¸å…¥
                    if (!email || !verificationCode || !captchaInput) {
                        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                        return;
                    }

                    // é©—è­‰åœ–å½¢é©—è­‰ç¢¼
                    if (captchaInput !== captchaText) {
                        alert('åœ–å½¢é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥');
                        return;
                    }

                    try {
                        const response = await fetch('/api/v1/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: email,
                                login_type: 'password',
                                verification_code: verificationCode,
                                verify: true
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            // å„²å­˜tokenå’Œç”¨æˆ¶ä¿¡æ¯
                            localStorage.setItem('access_token', data.access_token);
                            localStorage.setItem('user_data', JSON.stringify(data.user));

                            // é¡¯ç¤ºç™»å…¥æˆåŠŸç•«é¢
                            showLoginSuccess(email);
                        } else {
                            const error = await response.json();
                            alert('ç™»å…¥å¤±æ•—ï¼š' + (error.detail?.message || error.detail || 'è«‹ç¨å¾Œå†è©¦'));
                        }
                    } catch (error) {
                        console.error('ç™»å…¥éŒ¯èª¤:', error);
                        alert('ç¶²è·¯éŒ¯èª¤ï¼š' + error.message);
                    }
                });
            }

            // Googleç™»å…¥æŒ‰éˆ•äº‹ä»¶è™•ç†
            const googleBtn = document.querySelector('.google-btn');
            if (googleBtn) googleBtn.addEventListener('click', function() { window.location.href = '/api/v1/auth/google/login'; });

            // åˆ·æ–°åœ–å½¢é©—è­‰ç¢¼åŠŸèƒ½
            const refreshCaptchaBtn = document.querySelector('.refresh-captcha');
            function generateCaptcha() {
                const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let captcha = '';
                for (let i = 0; i < 5; i++) {
                    captcha += chars[Math.floor(Math.random() * chars.length)];
                }
                const captchaEl = document.querySelector('.verification-code');
                if (captchaEl) captchaEl.textContent = captcha;
            }

            if (refreshCaptchaBtn) refreshCaptchaBtn.addEventListener('click', generateCaptcha);
            // åˆå§‹ç”Ÿæˆé©—è­‰ç¢¼
            generateCaptcha();

            // Digital ID flow - single clean implementation with live countdown and safe restart
            let pollingIntervalId = null;
            let countdownIntervalId = null;
            let activePolling = false;

            function clearDigitalIntervals() {
                if (pollingIntervalId) { clearInterval(pollingIntervalId); pollingIntervalId = null; }
                if (countdownIntervalId) { clearInterval(countdownIntervalId); countdownIntervalId = null; }
                activePolling = false;
                // allow restart after intervals cleared
                try { window._mixcurry_digital_flow_started = false; } catch(e) { /* ignore */ }
             }

             window.stopVpPolling = function() {
                 clearDigitalIntervals();
             };

             async function loginWithDigitalID() {
                // Global guard to prevent accidental duplicate starts (protects against multiple event triggers)
                if (window._mixcurry_digital_flow_started) return;
                window._mixcurry_digital_flow_started = true;

                // debug log to help verify single invocation
                try { console.debug('loginWithDigitalID invoked'); } catch(e) {}

                // Prevent multiple parallel polling sessions
                // Clear any previous intervals left running (defensive)
                clearDigitalIntervals();
                if (activePolling) return;
                activePolling = true;

                const vpRef = '00000000_mixcurry_idcard'; // VP åƒè€ƒç·¨è™Ÿ
                let transactionId = null;
                let remainingSeconds = 300; // 5 minutes

                // Immediately set a default QR so the user sees something right away
                if (qrImg) qrImg.src = qrImg.getAttribute('src') || DEFAULT_QR;

                // Update countdown display immediately and start the 1s interval
                function updateCountdownDisplay() {
                    const minutes = Math.floor(remainingSeconds / 60);
                    const seconds = remainingSeconds % 60;
                    if (countdownEl) countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }

                updateCountdownDisplay();
                countdownIntervalId = setInterval(() => {
                    remainingSeconds--;
                    if (remainingSeconds <= 0) {
                        clearDigitalIntervals();
                        updateCountdownDisplay();
                        alert('é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°å˜—è©¦ç™»å…¥');
                        return;
                    }
                    updateCountdownDisplay();
                }, 1000);

                try {
                    const result = await fetch(`/api/v1/complete-flow/generate-vp-qrcode`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ref: vpRef })
                    });

                    const data = await result.json();
                    console.log('æ•¸ä½èº«åˆ†é©—è­‰å›æ‡‰:', data);

                    if (!data || !data.success) {
                        // keep the countdown running so user sees time ticking even if API fails
                        console.warn('generate-vp-qrcode failed or returned no success');
                        return;
                    }

                    // Update QR image and transaction id when backend returns them
                    if (qrImg && data.qrcode_image) qrImg.src = data.qrcode_image;
                    transactionId = data.transaction_id;

                    // Start polling every 2s only if we have a transactionId
                    if (transactionId) {
                        pollingIntervalId = setInterval(async () => {
                            try {
                                const pollResult = await fetch(`/api/v1/complete-flow/verify-vp`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ transaction_id: transactionId })
                                });
                                const pollData = await pollResult.json();

                                if (pollData && pollData.verified) {
                                    console.log('é©—è­‰æˆåŠŸï¼Œä½¿ç”¨è€…è³‡æ–™ï¼š', pollData);
                                    clearDigitalIntervals();

                                    // Attempt backend login with returned user data
                                    try {
                                        const loginResponse = await fetch('/api/v1/auth/login', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                email: pollData.email,
                                                password: '',
                                                login_type: 'password'
                                            })
                                        });

                                        if (loginResponse.ok) {
                                            const loginData = await loginResponse.json();
                                            localStorage.setItem('access_token', loginData.access_token);
                                            localStorage.setItem('user_data', JSON.stringify(loginData.user));
                                            showLoginSuccess(loginData.user.email || loginData.user.id_number);
                                        } else {
                                            const error = await loginResponse.json();
                                            alert('ç™»å…¥å¤±æ•—ï¼š' + (error.detail?.message || error.detail || 'è«‹ç¨å¾Œå†è©¦'));
                                        }
                                    } catch (error) {
                                        console.error('Digital ID login error:', error);
                                        alert('ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                                    }
                                }
                            } catch (err) {
                                console.error('Polling error:', err);
                            }
                        }, 2000);
                    }

                } catch (error) {
                    console.error('æ•¸ä½èº«åˆ†é©—è­‰éŒ¯èª¤:', error);
                    // keep countdown running so the user sees the timeout behavior
                }
             }

            // If the digital tab is active on load, start the digital flow once (after function defined)
            const activeTabOnLoad = document.querySelector('.login-tab.active');
            if (activeTabOnLoad && activeTabOnLoad.getAttribute('data-tab') === 'digital') {
                // start polling/generation only once
                loginWithDigitalID();
            }

            // Attach click handler to the digital tab specifically so clicking it will restart the flow
             const digitalTab = document.querySelector('.login-tab[data-tab="digital"]');
             if (digitalTab) {
                 digitalTab.addEventListener('click', () => {
                     // If user explicitly clicks again, restart polling
                     clearDigitalIntervals();
                     setTimeout(() => loginWithDigitalID(), 100);
                 });
             }
         });
     </script>

    <main class="main-content">
        <h2 class="page-title">ç™»å…¥å¾Œç¹¼çºŒ</h2>

        <div class="login-container">
            <div class="login-tabs">
                <div class="login-tab" data-tab="general"><span style="margin-right:8px;">ğŸ“§</span>ä¸€èˆ¬ç™»å…¥</div>
                <div class="login-tab active" data-tab="digital">ğŸ“± æ•¸ä½èº«åˆ†è­‰æ†‘è­‰ç™»å…¥ (æ¨è–¦)</div>
            </div>

            <div id="general-login-form" class="login-form" style="display: none;">
                <div class="form-group">
                    <label for="email">é›»å­ä¿¡ç®±</label>
                    <input type="email" id="email" name="email" placeholder="è¼¸å…¥ä¿¡ç®±å¸³è™Ÿ" required>
                </div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label for="password" style="margin-bottom: 0;">é©—è­‰ç¢¼</label>
                        <small style="color: #666; margin: 0; display: inline; font-size: 12px;">
                            é©—è­‰ç¢¼å°‡ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±
                        </small>
                    </div>
                    <div class="input-with-button">
                        <input type="password" id="password" name="password" placeholder="è¼¸å…¥é©—è­‰ç¢¼" required>
                        <button type="button" class="verification-send-btn">ç™¼é€é©—è­‰ç¢¼</button>
                    </div>
                </div>

                <div class="verification-container">
                    <div class="verification-code">10541</div>
                    <button type="button" class="refresh-captcha">
                        <img src='./assets/refresh.png' alt="æ›´æ–°é©—è­‰ç¢¼" width="24" height="24">
                    </button>
                    <input type="text" class="verification-input" placeholder="è«‹è¼¸å…¥å·¦æ–¹åœ–ç‰‡ä¸­çš„æ–‡å­—" required>
                </div>

                <button type="submit" class="login-btn">ç™»å…¥</button>

                <div class="divider">
                    <div class="divider-line"></div>
                    <span class="divider-text">æˆ–</span>
                    <div class="divider-line"></div>
                </div>

                <button type="button" class="google-btn">ä½¿ç”¨Googleç¹¼çºŒç™»å…¥</button>
            </div>

            <div id="digital-login-form" class="login-form">
                <div class="digital-header">
                    <div class="digital-title">æ•¸ä½æ†‘è­‰çš®å¤¾APP</div>
                    <div class="digital-subtitle">æ•¸ä½èº«åˆ†æ†‘è­‰ç™»å…¥æ–¹å¼</div>
                </div>

                <div class="qr-code-container">
                    <div class="qr-code-inner">
                        <img src="" alt="QR Code" width="188" height="188" role="img" aria-label="æ•¸ä½æ†‘è­‰ QR ç¢¼">
                         <div class="qr-code-timer">
                             <span class="timer-text">è«‹æ–¼ </span>
                             <span class="countdown-time">5:00</span>
                             <span class="timer-text"> å…§å®Œæˆæƒæ</span>
                         </div>
                     </div>
                </div>

                <p class="qr-hint">ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼ç™»å…¥</p>

                <div class="divider">
                    <div class="divider-line"></div>
                </div>

                <a href="/digital-id-info" class="link-text">é—œæ–¼æ•¸ä½èº«åˆ†è­‰æ†‘è­‰èªªæ˜</a>

                <p class="register-text">
                    å°šæœªåŠ å…¥æœƒå“¡? <a href="/register">é¦¬ä¸Šè¨»å†Š</a>
                </p>
            </div>
        </div>

        <div class="success-screen">
            <div class="header">
                <h1>ç½å®³è£œåŠ©ç”³è«‹å¹³å°</h1>
                <nav class="header-nav">
                    <a href="/">è¿”å›é¦–é </a>
                </nav>
            </div>

            <div class="success-content">
                <div class="success-form">
                    <div class="success-title">æˆåŠŸç™»å…¥</div>
                    <div class="success-icon-container">
                        <img src="./assets/success-icon.svg" alt="Success" class="success-icon">
                    </div>
                    <div class="success-subtitle">æ‚¨å·²ç™»å…¥</div>
                    <div class="success-email">456789@gmail.com</div>
                </div>
            </div>

            <div class="success-buttons">
                <button class="success-button secondary">æŸ¥è©¢ç”³è«‹æ­·å²ç´€éŒ„</button>
                <button class="success-button primary">å‰å¾€è£œåŠ©ç”³è«‹</button>
            </div>
        </div>
    </main>
</body>
</html>
