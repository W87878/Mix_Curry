<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¯©æ ¸å¾Œå° - ç½æ°‘è£œåŠ©ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="/static/styles/admin.css" />
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbuTGzgDiR9WfXuvbPOZSc5nNm7NDucuQ&libraries=places,geometry"></script>
  </head>
  <body>
    <div class="header">
      <div class="logo">ğŸ‘¨â€ğŸ’¼ å¯©æ ¸äººå“¡å¾Œå°</div>
      <div class="user-info">
        <div>
          <div style="font-size: 14px; font-weight: 500" id="adminName">
            é‡Œé•·
          </div>
          <div style="font-size: 12px; color: #999" id="adminDistrict">
            å€åŸŸ
          </div>
        </div>
        <div class="user-avatar" id="adminAvatar">é‡Œ</div>
        <button
          class="btn btn-sm"
          onclick="logout()"
          style="background: #f3f4f6; color: #666"
        >
          ç™»å‡º
        </button>
      </div>
    </div>

    <div class="layout">
      <div class="sidebar">
        <div class="nav-item active" onclick="showPage('applications')">
          ğŸ“‹ æ¡ˆä»¶ç®¡ç†
        </div>
        <div class="nav-item" onclick="showPage('statistics')">
          ğŸ“Š çµ±è¨ˆæ•¸æ“š
        </div>
        <div class="nav-item" onclick="showPage('history')">
          ğŸ“œ æ†‘è­‰è¨˜éŒ„
        </div>
      </div>

      <div class="main-content">
        <!-- Applications Page -->
        <div id="applications-page">
          <!-- çµ±è¨ˆå¡ç‰‡ -->
          <div class="stats-header">
            <div class="stat-card" onclick="filterByStatus('pending')" style="cursor: pointer;">
              <div class="stat-label">éœ€å¯©æ ¸é€šçŸ¥</div>
              <div class="stat-value" id="statPending">-</div>
              <div class="stat-unit">ä»¶</div>
              <div class="stat-icon" style="background: #fee2e2;">â„¹ï¸</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('site_inspection')" style="cursor: pointer;">
              <div class="stat-label">å¾…å‹˜</div>
              <div class="stat-value" id="statInspection">-</div>
              <div class="stat-unit">ä»¶</div>
              <div class="stat-icon" style="background: #fef3c7;">ğŸ“‹</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('rejected')" style="cursor: pointer;">
              <div class="stat-label">å·²é§å›</div>
              <div class="stat-value" id="statRejected">-</div>
              <div class="stat-unit">ä»¶</div>
              <div class="stat-icon" style="background: #fed7aa;">âš ï¸</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('approved')" style="cursor: pointer;">
              <div class="stat-label">å·²å®Œæˆ</div>
              <div class="stat-value" id="statCompleted">-</div>
              <div class="stat-unit">ä»¶</div>
              <div class="stat-icon" style="background: #d1fae5;">âœ“</div>
            </div>
          </div>

          <!-- ç¯©é¸å·¥å…·åˆ— -->
          <div class="filters-toolbar">
            <div class="filters-left">
              <select class="filter-dropdown" id="filterCity" onchange="updateTownships()">
                <option value="">æ‰€æœ‰ç¸£å¸‚</option>
                <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
                <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
                <option value="å°å—å¸‚">å°å—å¸‚</option>
                <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
                <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
                <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
                <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
                <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
                <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                <option value="å±æ±ç¸£">å±æ±ç¸£</option>
                <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
                <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                <option value="å°æ±ç¸£">å°æ±ç¸£</option>
                <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
                <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
              </select>
              <select class="filter-dropdown" id="filterTownship" onchange="updateVillages()">
                <option value="">æ‰€æœ‰é„‰é®å¸‚å€</option>
              </select>
              <select class="filter-dropdown" id="filterVillage" onchange="filterApplications()">
                <option value="">æ‰€æœ‰æ‘/é‡Œ</option>
              </select>
              <select class="filter-dropdown" id="filterDisasterType" onchange="filterApplications()">
                <option value="">æ‰€æœ‰ç½å®³é¡å‹</option>
                <option value="flood">æ°´ç½</option>
                <option value="typhoon">é¢±é¢¨</option>
                <option value="earthquake">åœ°éœ‡</option>
              </select>
              <select class="filter-dropdown" id="filterStatus" onchange="filterApplications()">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="pending">å¾…å¯©æ ¸</option>
                <option value="site_inspection">å·²æŸ¥è¨ª</option>
                <option value="approved">å·²å®Œæˆ</option>
                <option value="rejected">å·²é§å›</option>
              </select>
            </div>
          </div>

          <!-- View Tabs -->
          <div class="view-tabs">
            <div class="view-tab active" onclick="switchView('list')" id="listViewTab">
              <span class="tab-icon">â‰¡</span> åˆ—è¡¨æª¢è¦–
            </div>
            <div class="view-tab" onclick="switchView('map')" id="mapViewTab">
              <span class="tab-icon">ğŸ—º</span> åœ°åœ–æª¢è¦–
            </div>
          </div>

          <!-- List View -->
          <div id="listView" class="list-view">
            <div class="applications-list" id="applicationsList">
              <!-- å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
          </div>

          <!-- Map View -->
          <div id="mapView" class="map-view" style="display: none;">
            <div id="applicationsMap" style="width: 100%; height: 600px; border-radius: 8px;"></div>
          </div>
        </div>

        <!-- Statistics Page -->
        <div id="statistics-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">çµ±è¨ˆæ•¸æ“š</h1>
          </div>
          <div id="statisticsContent"></div>
        </div>

        <!-- History Page -->
        <div id="history-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">ğŸ“œ æ†‘è­‰ä½¿ç”¨è¨˜éŒ„</h1>
          </div>
          
          <!-- çµ±è¨ˆå¡ç‰‡ -->
          <div class="stats-header" style="margin-bottom: 20px;">
            <div class="stat-card">
              <div class="stat-label">ç¸½è¨˜éŒ„</div>
              <div class="stat-value" id="historyStatTotal">-</div>
              <div class="stat-unit">ç­†</div>
              <div class="stat-icon" style="background: #e0e7ff;">ğŸ“Š</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">å·²ç™¼è¡Œæ†‘è­‰</div>
              <div class="stat-value" id="historyStatIssued">-</div>
              <div class="stat-unit">å¼µ</div>
              <div class="stat-icon" style="background: #fef3c7;">ğŸ“„</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">å·²é©—è­‰æ†‘è­‰</div>
              <div class="stat-value" id="historyStatVerified">-</div>
              <div class="stat-unit">å¼µ</div>
              <div class="stat-icon" style="background: #d1fae5;">âœ“</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">é©—è­‰ç‡</div>
              <div class="stat-value" id="historyStatRate">-</div>
              <div class="stat-unit">%</div>
              <div class="stat-icon" style="background: #dbeafe;">ğŸ“ˆ</div>
            </div>
          </div>
          
          <!-- ç¯©é¸å™¨å’Œæœå°‹æ¡† -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center; justify-content: space-between;">
            <div style="display: flex; gap: 10px; align-items: center;">
              <!-- çµ±ä¸€æœå°‹æ¡† -->
              <input 
                type="text" 
                id="historySearchInput" 
                placeholder="ğŸ” æœå°‹å§“åã€è£œåŠ©é¡å‹ã€ç™¼è¡Œ/é©—è­‰æ©Ÿæ§‹..." 
                style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; width: 400px; font-size: 14px;"
                onkeyup="loadHistory()"
              />
              
              <!-- é‡æ–°æ•´ç†å°ç¬¦è™Ÿ -->
              <button 
                onclick="loadHistory()" 
                title="é‡æ–°æ•´ç†"
                style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px; color: #666; transition: transform 0.3s;"
                onmouseover="this.style.transform='rotate(180deg)'"
                onmouseout="this.style.transform='rotate(0deg)'"
              >
                ğŸ”„
              </button>
            </div>
            
            <!-- æ’åºæŒ‰éˆ•ï¼ˆå³å´ï¼‰ -->
            <button 
              id="historySortBtn" 
              onclick="toggleHistorySort()"
              style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; color: #374151; display: flex; align-items: center; gap: 6px; transition: all 0.2s;"
              onmouseover="this.style.background='#f9fafb'"
              onmouseout="this.style.background='white'"
            >
              <span id="sortIcon">ğŸ”½</span>
              <span id="sortText">é©—è­‰æ™‚é–“ï¼ˆæ–°åˆ°èˆŠï¼‰</span>
            </button>
          </div>
          
          <div id="historyContent">
            <div class="empty-state">
              <div class="empty-state-icon">â³</div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Review Modal (ä¸­é–“å½ˆå‡º) -->
    <div id="reviewModal" class="review-modal-overlay" style="display: none;">
      <div class="review-modal">
        <div class="review-modal-header">
          <h3>å¯©æ ¸è©³æƒ…</h3>
          <button class="modal-close-btn" onclick="closeReviewModal()">Ã—</button>
        </div>
        
        <div class="review-modal-body">
          <!-- ç”³è«‹äººè³‡è¨Š -->
          <div class="info-section">
            <h4 class="section-title">ç”³è«‹äººè³‡è¨Š</h4>
            <div id="applicantInfo" class="info-grid"></div>
          </div>

          <!-- ç½å®³è³‡è¨Š -->
          <div class="info-section">
            <h4 class="section-title">ç½å®³è³‡è¨Š</h4>
            <div id="disasterInfo" class="info-grid"></div>
          </div>

          <!-- ç½æç…§ç‰‡ -->
          <div class="info-section">
            <h4 class="section-title">ç½æç…§ç‰‡</h4>
            <div id="damagePhotos" class="photos-grid">
              <p style="color: #999; font-size: 14px">è¼‰å…¥ä¸­...</p>
            </div>
          </div>

          <!-- å¯©æ ¸è¡¨å–® -->
          <div class="info-section">
            <h4 class="section-title">å¯©æ ¸æ„è¦‹</h4>
            <div class="form-group">
              <label>å¯©æ ¸çµæœ *</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="reviewResult" value="approve" checked>
                  <span class="radio-text">âœ“ æ ¸å‡†</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="reviewResult" value="reject">
                  <span class="radio-text">âœ— é§å›</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label>å¯©æ ¸æ„è¦‹</label>
              <textarea
                id="reviewComments"
                placeholder="è«‹å¡«å¯«å¯©æ ¸æ„è¦‹ï¼ˆé¸å¡«ï¼‰..."
                rows="4"
                class="form-textarea"
              ></textarea>
            </div>
          </div>
        </div>

        <div class="review-modal-footer">
          <button class="btn btn-secondary" onclick="closeReviewModal()">
            å–æ¶ˆ
          </button>
          <button class="btn btn-primary" onclick="submitReview()">
            é€å‡ºå¯©æ ¸
          </button>
        </div>
      </div>
    </div>

    <!-- åœ°åœ– Modal -->
    <div id="mapModal" class="map-modal hidden">
      <div class="map-modal-overlay" onclick="closeMapModal()"></div>
      <div class="map-modal-content">
        <div class="map-modal-header">
          <h3 id="mapModalTitle">æ¡ˆä»¶ä½ç½®</h3>
          <button class="close-btn" onclick="closeMapModal()">Ã—</button>
        </div>
        <div class="map-modal-body">
          <div id="singleLocationMap" style="width: 100%; height: 500px;"></div>
        </div>
        <div class="map-modal-footer">
          <button class="btn btn-secondary" onclick="closeMapModal()">é—œé–‰</button>
          <button class="btn btn-primary" onclick="openInGoogleMaps()">
            åœ¨ Google åœ°åœ–ä¸­é–‹å•Ÿ
          </button>
        </div>
      </div>
    </div>

    <!-- è¼‰å…¥é…ç½®ç®¡ç†æ¨¡çµ„ -->
    <script src="/static/js/config.js"></script>
    <script src="/static/js/taiwan-districts.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbuTGzgDiR9WfXuvbPOZSc5nNm7NDucuQ&libraries=places,geometry"></script>
    <script>
      // å…¨åŸŸè®Šæ•¸
      let API_BASE = null; // å°‡ç”±é…ç½®æ¨¡çµ„è¨­å®š
      let accessToken = localStorage.getItem("admin_token");
      let currentUser = JSON.parse(
        localStorage.getItem("admin_user") || "null"
      );
      let currentApplication = null;

      // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
      async function initializeApp() {
        // è¼‰å…¥é…ç½®
        await initializeConfig();
        API_BASE = getApiBase();

        // æª¢æŸ¥ç™»å…¥
        if (!accessToken || !currentUser || currentUser.role !== "reviewer") {
          showLoginPrompt();
        } else {
          showDashboard();
        }
      }

      // é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", initializeApp);

      function showDashboard() {
        document.getElementById("adminName").textContent =
          currentUser.full_name;
        document.getElementById("adminAvatar").textContent =
          currentUser.full_name.charAt(0);
        loadDashboardStats();
        loadPendingApplications();
        
        // åˆå§‹åŒ–æœå°‹å’Œç¯©é¸åŠŸèƒ½
        initializeFilters();
      }
      
      function initializeFilters() {
        // æœå°‹æ¡†äº‹ä»¶
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', filterApplications);
        }
        
        // ç¯©é¸å™¨äº‹ä»¶  
        const filterCity = document.getElementById('filterCity');
        const filterTownship = document.getElementById('filterTownship');
        const filterVillage = document.getElementById('filterVillage');
        const filterDisasterType = document.getElementById('filterDisasterType');
        const filterStatus = document.getElementById('filterStatus');
        
        if (filterCity) {
          filterCity.addEventListener('change', filterApplications);
        }
        if (filterTownship) {
          filterTownship.addEventListener('change', filterApplications);
        }
        if (filterVillage) {
          filterVillage.addEventListener('change', filterApplications);
        }
        if (filterDisasterType) {
          filterDisasterType.addEventListener('change', filterApplications);
        }
        if (filterStatus) {
          filterStatus.addEventListener('change', filterApplications);
        }
      }

      function showLoginPrompt() {
        // å‰µå»ºç™»å…¥å°è©±æ¡†ï¼ˆä½¿ç”¨èˆ‡ applicant.html ç›¸åŒçš„æ¨£å¼ï¼‰
        const loginModal = document.createElement("div");
        loginModal.id = "adminLoginModal";
        loginModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #F9F7F4; display: flex; flex-direction: column; z-index: 9999; overflow-y: auto;">
                    <!-- Header -->
                    <header style="background-color: #F9F7F4; padding: 48px 96px; display: flex; justify-content: space-between; align-items: center;">
                        <h1 style="font-size: 36px; font-weight: 700; color: #1E81B2;">ç½å®³è£œåŠ©ç”³è«‹å¹³å°
                        </h1>
                        <nav style="display: flex; gap: 24px; font-size: 20px; font-weight: 500; color: #000;">
                          <a href="/" style="text-decoration: none; color: black; letter-spacing: 0.4px;">è¿”å›é¦–é </a>
                        </nav>
                    </header>

                    <!-- Main Content -->
                    <main style="display: flex; flex-direction: column; align-items: center; padding-top: 80px; flex: 1;">
                        <h2 style="font-size: 30px; font-weight: 700; margin-bottom: 40px; letter-spacing: 0.6px;">å¯©æ ¸äººå“¡ç™»å…¥</h2>

                        <div style="width: 612px; border-radius: 16px; overflow: hidden; margin-bottom: 48px;">
                            <!-- Tabs -->
                            <div style="display: flex;">
                                <div class="admin-login-tab" data-tab="general" style="flex: 1; padding: 24px; text-align: center; font-size: 16px; font-weight: 600; letter-spacing: -0.4px; cursor: pointer; background-color: #E4F1FA; color: #1E81B2;">
                                    <span style="margin-right: 8px">ğŸ“§</span>ä¸€èˆ¬ç™»å…¥
                                </div>
                                <div class="admin-login-tab active" data-tab="digital" style="flex: 1; padding: 24px; text-align: center; font-size: 16px; font-weight: 600; letter-spacing: -0.4px; cursor: pointer; background-color: #1E81B2; color: #F4F7F7;">
                                    ğŸ“± æ•¸ä½èº«åˆ†è­‰æ†‘è­‰ç™»å…¥ (æ¨è–¦)
                                </div>
                            </div>

                            <!-- General Login Form -->
                            <div id="adminGeneralLoginForm" style="background-color: #FFFFFF; padding: 48px; display: none; flex-direction: column; gap: 24px;">
                                <div style="display: flex; flex-direction: column; gap: 4px; width: 100%; margin-bottom: 20px;">
                                    <label style="font-size: 16px; color: #020618; letter-spacing: 0.64px; display: block; font-weight: 500; margin-bottom: 8px;">é›»å­ä¿¡ç®±</label>
                                    <input type="email" id="adminEmail" name="email" placeholder="è¼¸å…¥ä¿¡ç®±å¸³è™Ÿ" required style="padding: 8px 12px; height: 40px; border: 1px solid #E2E8F0; border-radius: 6px; background: #fff; font-size: 14px; color: #62748E; width: 100%;" />
                                </div>

                                <div style="display: flex; flex-direction: column; gap: 4px; width: 100%; margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; gap: 12px">
                                        <label style="font-size: 16px; color: #020618; letter-spacing: 0.64px; display: block; font-weight: 500; margin-bottom: 0;">é©—è­‰ç¢¼</label>
                                        <small style="color: #666; margin: 0; display: inline; font-size: 12px;">é©—è­‰ç¢¼å°‡ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±</small>
                                    </div>
                                    <div style="position: relative; width: 100%;">
                                        <input type="password" id="adminPassword" name="password" placeholder="è¼¸å…¥é©—è­‰ç¢¼" required style="width: 100%; padding: 8px 110px 8px 12px; height: 40px; border: 1px solid #E2E8F0; border-radius: 6px; background: #fff; font-size: 14px; color: #62748E;" />
                                        <button type="button" class="admin-verification-send-btn" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); height: calc(100% - 4px); margin: 0; border-radius: 4px; padding: 8px 16px; background: #1E81B2; color: white; border: none; font-size: 14px; letter-spacing: 0.64px; cursor: pointer; white-space: nowrap; transition: background-color 0.3s;">
                                            ç™¼é€é©—è­‰ç¢¼
                                        </button>
                                        <style>
                                            .admin-verification-send-btn:disabled {
                                                background: #94A3B8 !important;
                                                cursor: not-allowed !important;
                                            }
                                        </style>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 24px; align-items: center; width: 100%;">
                                    <div style="background: #F8FAFC; padding: 8px 12px; border-radius: 8px; font-size: 20px; color: #334155; letter-spacing: 0.4px; line-height: 28px;" class="admin-verification-code">10541</div>
                                    <button type="button" class="admin-refresh-captcha" style="background: transparent; border: none; box-shadow: none; padding: 0; cursor: pointer;">
                                        <img src="static/assets/refresh.png" alt="æ›´æ–°é©—è­‰ç¢¼" width="24" height="24" />
                                    </button>
                                    <input type="text" class="admin-verification-input" placeholder="è«‹è¼¸å…¥å·¦æ–¹åœ–ç‰‡ä¸­çš„æ–‡å­—" required style="flex: 1; padding: 8px 12px; height: 40px; border: 1px solid #E2E8F0; border-radius: 8px; background: #fff; font-size: 14px; color: #62748E;" />
                                </div>

                                <button type="submit" class="admin-login-btn" style="width: 100%; padding: 8px 16px; background: #1E81B2; color: #F4F7F7; border: none; border-radius: 8px; font-size: 16px; letter-spacing: 0.64px; cursor: pointer;">ç™»å…¥</button>

                                <div style="display: flex; align-items: center; gap: 8px; width: 100%; margin: 8px 0;">
                                    <div style="flex: 1; height: 2px; background: #C9D5D8; border-radius: 999px;"></div>
                                    <span style="color: #779299; font-size: 14px; letter-spacing: 0.56px;">æˆ–</span>
                                    <div style="flex: 1; height: 2px; background: #C9D5D8; border-radius: 999px;"></div>
                                </div>

                                <button type="button" class="admin-google-btn" style="width: 100%; padding: 8px 16px; background: white; color: #0F172A; border: none; border-radius: 8px; font-size: 16px; letter-spacing: 0.64px; cursor: pointer;">
                                <!-- Google SVG Icon -->
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  x="0px"
                                  y="0px"
                                  width="30"
                                  height="30"
                                  viewBox="0 0 48 48"
                                  style="vertical-align: middle; position: relative; top: -0.5px"
                                >
                                  <path
                                    fill="#FFC107"
                                    d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                                  ></path>
                                  <path
                                    fill="#FF3D00"
                                    d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
                                  ></path>
                                  <path
                                    fill="#4CAF50"
                                    d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
                                  ></path>
                                  <path
                                    fill="#1976D2"
                                    d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                                  ></path>
                                </svg>
                                Google å¸³è™Ÿç™»å…¥</button>
                            </div>

                            <!-- Digital Login Form -->
                            <div id="adminDigitalLoginForm" style="background-color: #FFFFFF; padding: 48px; display: flex; flex-direction: column; gap: 24px;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                    <div style="font-weight: 700; font-size: 24px; line-height: 32px; text-align: center; letter-spacing: 0.48px; color: #020618;">æ•¸ä½æ†‘è­‰çš®å¤¾APP</div>
                                    <div style="font-weight: 400; font-size: 16px; line-height: 24px; text-align: center; letter-spacing: 0.64px; color: #020618;">æ•¸ä½èº«åˆ†æ†‘è­‰ç™»å…¥æ–¹å¼</div>
                                </div>

                                <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                                    <img id="adminQrImage" src="" style="width: 188px; height: 188px; border-radius: 8px; border: 1px solid #E2E8F0;">
                                    <div style="display: flex; align-items: center; gap: 4px; color: #64748B; font-size: 14px;">
                                        <span>è«‹æ–¼ </span>
                                        <span id="adminQrCountdown" style="color: #0F172A; font-weight: 500;">5:00</span>
                                        <span> å…§å®Œæˆæƒæ</span>
                                    </div>
                                </div>

                                <p style="font-weight: 400; font-size: 12px; line-height: 20px; text-align: center; letter-spacing: 0.48px; color: #779299; margin-bottom: 24px;">ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼ç™»å…¥</p>

                                <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
                                    <div style="flex: 1; height: 2px; background: #C9D5D8; border-radius: 999px;"></div>
                                </div>

                                <a href="https://moda.gov.tw/major-policies/wallet/1695" target="_blank" style="font-weight: 400; font-size: 16px; line-height: 24px; text-align: center; text-decoration-line: underline; color: #000000; letter-spacing: 0.64px; margin: 24px 0; display: block;">é—œæ–¼æ•¸ä½èº«åˆ†è­‰æ†‘è­‰èªªæ˜</a>

                                <p style="font-family: 'Noto Sans TC', sans-serif; font-weight: 400; font-size: 16px; line-height: 24px; text-align: center; letter-spacing: 0.64px; color: #000000;">
                                    é‚„æ²’æœ‰æ•¸ä½èº«åˆ†æ†‘è­‰å—ï¼Ÿ <a target="_blank" href="https://wallet.gov.tw/zh-twr" style="text-decoration-line: underline; color: inherit;">é»æˆ‘ç«‹å³ç”³è«‹</a>
                                </p>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        document.body.appendChild(loginModal);

        // Tab åˆ‡æ›åŠŸèƒ½
        const tabs = loginModal.querySelectorAll(".admin-login-tab");
        const digitalForm = document.getElementById("adminDigitalLoginForm");
        const generalForm = document.getElementById("adminGeneralLoginForm");

        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabType = this.getAttribute("data-tab");

            // æ›´æ–° tab æ¨£å¼
            tabs.forEach((t) => {
              if (t.getAttribute("data-tab") === tabType) {
                t.style.backgroundColor = "#1E81B2";
                t.style.color = "#F4F7F7";
                t.classList.add("active");
              } else {
                t.style.backgroundColor = "#E4F1FA";
                t.style.color = "#1E81B2";
                t.classList.remove("active");
              }
            });

            // åˆ‡æ›è¡¨å–®
            if (tabType === "digital") {
              digitalForm.style.display = "flex";
              generalForm.style.display = "none";
              // å•Ÿå‹•æ•¸ä½ç™»å…¥æµç¨‹
              adminLoginWithDigitalID();
            } else {
              digitalForm.style.display = "none";
              generalForm.style.display = "flex";
              // åœæ­¢æ•¸ä½ç™»å…¥çš„è¼ªè©¢å’Œå€’æ•¸è¨ˆæ™‚
              if (window.digitalLoginPollingInterval) {
                clearInterval(window.digitalLoginPollingInterval);
              }
              if (window.digitalLoginCountdownInterval) {
                clearInterval(window.digitalLoginCountdownInterval);
              }
            }
          });
        });

        // é è¨­å•Ÿå‹•æ•¸ä½ç™»å…¥
        adminLoginWithDigitalID();

        // ============================================
        // Email é©—è­‰ç™»å…¥äº‹ä»¶è™•ç†å™¨
        // ============================================
        let adminVerificationCode = "";

        // Email é©—è­‰ç¢¼ç™¼é€æŒ‰éˆ•
        const adminVerificationBtn = loginModal.querySelector(
          ".admin-verification-send-btn"
        );
        let adminTimeLeft = 180;
        let adminCountdownTimer = null;

        function adminStartCountdown() {
          if (!adminVerificationBtn) return;
          adminVerificationBtn.disabled = true;
          adminTimeLeft = 180;

          function updateButtonText() {
            const minutes = Math.floor(adminTimeLeft / 60);
            const seconds = adminTimeLeft % 60;
            adminVerificationBtn.textContent = `é‡æ–°ç™¼é€ (${minutes}:${seconds
              .toString()
              .padStart(2, "0")})`;

            if (adminTimeLeft <= 0) {
              clearInterval(adminCountdownTimer);
              adminVerificationBtn.disabled = false;
              adminVerificationBtn.textContent = "ç™¼é€é©—è­‰ç¢¼";
              return;
            }
            adminTimeLeft--;
          }

          updateButtonText();
          adminCountdownTimer = setInterval(updateButtonText, 1000);
        }

        if (adminVerificationBtn) {
          adminVerificationBtn.addEventListener("click", async function () {
            const email = document.getElementById("adminEmail").value;

            if (!email) {
              alert("è«‹è¼¸å…¥ Email");
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/email/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  is_verified: false,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                adminStartCountdown();
                if (data.verification_code) {
                  adminVerificationCode = data.verification_code;
                  console.log("é©—è­‰ç¢¼(é–‹ç™¼ç”¨):", data.verification_code);
                  alert(
                    "âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼\n\n(é–‹ç™¼ç’°å¢ƒï¼šé©—è­‰ç¢¼å·²è¼¸å‡ºåˆ°Console)"
                  );
                } else {
                  alert("âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼");
                }
              } else {
                const error = await response.json();
                alert("ç™¼é€å¤±æ•—ï¼š" + (error.detail || "è«‹ç¨å¾Œå†è©¦"));
              }
            } catch (error) {
              console.error("ç™¼é€é©—è­‰ç¢¼éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // ç™»å…¥æŒ‰éˆ•
        const adminLoginBtn = loginModal.querySelector(".admin-login-btn");
        if (adminLoginBtn) {
          adminLoginBtn.addEventListener("click", async function () {
            const email = document.getElementById("adminEmail").value;
            const verificationCode =
              document.getElementById("adminPassword").value;
            const captchaInputEl = loginModal.querySelector(
              ".admin-verification-input"
            );
            const captchaInput = captchaInputEl ? captchaInputEl.value : "";
            const captchaTextEl = loginModal.querySelector(
              ".admin-verification-code"
            );
            const captchaText = captchaTextEl ? captchaTextEl.textContent : "";

            if (!email) {
              alert("è«‹å¡«å¯«email");
              return;
            } else if (!verificationCode) {
              alert("è«‹å¡«å¯«é©—è­‰ç¢¼");
              return;
            } else if (!captchaInput) {
              alert("è«‹å¡«å¯«åœ–å½¢é©—è­‰ç¢¼");
              return;
            }

            if (verificationCode.length !== 6) {
              alert("é©—è­‰ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—");
              return;
            }

            if (verificationCode !== adminVerificationCode) {
              alert("é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            if (captchaInput !== captchaText) {
              alert("åœ–å½¢é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  login_type: "password",
                  verification_code: verificationCode,
                  verify: true,
                }),
              });

              if (response.ok) {
                const data = await response.json();

                // æª¢æŸ¥æ¬Šé™
                if (
                  data.user.role !== "reviewer" &&
                  data.user.role !== "admin"
                ) {
                  alert("âŒ æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†æ¬Šé™");
                  return;
                }

                accessToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem("admin_token", accessToken);
                localStorage.setItem("admin_user", JSON.stringify(currentUser));

                // ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢
                location.reload();
              } else {
                const error = await response.json();
                alert(
                  "ç™»å…¥å¤±æ•—ï¼š" +
                    (error.detail?.message || error.detail || "è«‹ç¨å¾Œå†è©¦")
                );
              }
            } catch (error) {
              console.error("ç™»å…¥éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // Google ç™»å…¥æŒ‰éˆ•
        const adminGoogleBtn = loginModal.querySelector(".admin-google-btn");
        if (adminGoogleBtn) {
          adminGoogleBtn.addEventListener("click", function () {
            window.location.href = "/api/v1/auth/google/login";
          });
        }

        // åˆ·æ–°åœ–å½¢é©—è­‰ç¢¼
        const adminRefreshCaptchaBtn = loginModal.querySelector(
          ".admin-refresh-captcha"
        );
        function adminGenerateCaptcha() {
          const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          let captcha = "";
          for (let i = 0; i < 5; i++) {
            captcha += chars[Math.floor(Math.random() * chars.length)];
          }
          const captchaEl = loginModal.querySelector(
            ".admin-verification-code"
          );
          if (captchaEl) captchaEl.textContent = captcha;
        }

        if (adminRefreshCaptchaBtn)
          adminRefreshCaptchaBtn.addEventListener(
            "click",
            adminGenerateCaptcha
          );
        adminGenerateCaptcha();

        // ============================================
        // æ•¸ä½èº«åˆ†æ†‘è­‰ç™»å…¥å‡½æ•¸
        // ============================================
        async function adminLoginWithDigitalID() {
          const vpRef = "00000000_mixcurry_idcard";
          let transactionId = null;
          let remainingSeconds = 300;
          // ä½¿ç”¨ window ç‰©ä»¶ä¾†å­˜å„²è¨ˆæ™‚å™¨ï¼Œä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹å¯ä»¥å­˜å–
          window.digitalLoginPollingInterval = null;
          window.digitalLoginCountdownInterval = null;

          const qrImg = document.getElementById("adminQrImage");
          const countdownEl = document.getElementById("adminQrCountdown");

          function updateCountdownDisplay() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            if (countdownEl)
              countdownEl.textContent = `${minutes}:${seconds
                .toString()
                .padStart(2, "0")}`;
          }

          updateCountdownDisplay();
          window.digitalLoginCountdownInterval = setInterval(() => {
            remainingSeconds--;
            if (remainingSeconds <= 0) {
              if (window.digitalLoginPollingInterval)
                clearInterval(window.digitalLoginPollingInterval);
              if (window.digitalLoginCountdownInterval)
                clearInterval(window.digitalLoginCountdownInterval);
              updateCountdownDisplay();
              alert("é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°å˜—è©¦ç™»å…¥");
              return;
            }
            updateCountdownDisplay();
          }, 1000);

          try {
            const result = await fetch(
              `/api/v1/complete-flow/generate-vp-qrcode`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ref: vpRef }),
              }
            );

            const data = await result.json();
            console.log("æ•¸ä½èº«åˆ†é©—è­‰å›æ‡‰:", data);

            if (!data || !data.success) {
              console.warn("generate-vp-qrcode failed or returned no success");
              return;
            }

            if (qrImg && data.qrcode_image) qrImg.src = data.qrcode_image;
            transactionId = data.transaction_id;

            if (transactionId) {
              window.digitalLoginPollingInterval = setInterval(async () => {
                try {
                  const pollResult = await fetch(
                    `/api/v1/complete-flow/verify-vp`,
                    {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ transaction_id: transactionId }),
                    }
                  );
                  const pollData = await pollResult.json();

                  if (pollData && pollData.verified) {
                    console.log("é©—è­‰æˆåŠŸï¼Œä½¿ç”¨è€…è³‡æ–™ï¼š", pollData);
                    if (window.digitalLoginPollingInterval)
                      clearInterval(window.digitalLoginPollingInterval);
                    if (window.digitalLoginCountdownInterval)
                      clearInterval(window.digitalLoginCountdownInterval);
                    try {
                      const loginResponse = await fetch("/api/v1/auth/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                          email: pollData.email,
                          password: "",
                          login_type: "password",
                        }),
                      });

                      if (loginResponse.ok) {
                        const loginData = await loginResponse.json();

                        // æª¢æŸ¥æ¬Šé™
                        if (
                          loginData.user.role !== "reviewer" &&
                          loginData.user.role !== "admin"
                        ) {
                          alert("âŒ æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†æ¬Šé™");
                          return;
                        }

                        accessToken = loginData.access_token;
                        currentUser = loginData.user;
                        localStorage.setItem("admin_token", accessToken);
                        localStorage.setItem(
                          "admin_user",
                          JSON.stringify(currentUser)
                        );
                        location.reload();
                      } else {
                        const error = await loginResponse.json();
                        alert(
                          "ç™»å…¥å¤±æ•—ï¼š" +
                            (error.detail?.message ||
                              error.detail ||
                              "è«‹ç¨å¾Œå†è©¦")
                        );
                      }
                    } catch (error) {
                      console.error("Digital ID login error:", error);
                      alert("ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                    }
                  }
                } catch (err) {
                  console.error("Polling error:", err);
                }
              }, 2000);
            }
          } catch (error) {
            console.error("æ•¸ä½èº«åˆ†é©—è­‰éŒ¯èª¤:", error);
          }
        }
      }

      function initDashboard() {
        document.getElementById("adminName").textContent =
          currentUser.full_name;
        document.getElementById("adminAvatar").textContent =
          currentUser.full_name.charAt(0);
        loadDashboardStats();
        loadPendingApplications();
      }

      function showPage(page) {
        // éš±è—æ‰€æœ‰é é¢
        const pages = document.querySelectorAll('.main-content > div');
        pages.forEach(div => {
          if (div.id && div.id.endsWith('-page')) {
            div.classList.add('hidden');
          }
        });
        
        // é¡¯ç¤ºç›®æ¨™é é¢
        const targetPage = document.getElementById(`${page}-page`);
        if (targetPage) {
          targetPage.classList.remove("hidden");
        }

        // æ›´æ–°å´é‚Šæ¬„æ¿€æ´»ç‹€æ…‹
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        if (event && event.target) {
          event.target.classList.add("active");
        }

        // è¼‰å…¥å°æ‡‰é é¢çš„è³‡æ–™
        if (page === 'applications') {
          loadPendingApplications();
        } else if (page === "statistics") {
          loadStatistics();
        } else if (page === "history") {
          loadHistory();
        }
      }

      async function loadDashboardStats() {
        const result = await fetch(`${API_BASE}/applications/status/pending`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        if (result.ok) {
          const response = await result.json();

          // è™•ç†ä¸åŒçš„å›æ‡‰æ ¼å¼
          let apps = [];
          if (Array.isArray(response)) {
            apps = response;
          } else if (response.data) {
            // è™•ç†åµŒå¥—çµæ§‹: {data: {applications: [...]}}
            if (
              response.data.applications &&
              Array.isArray(response.data.applications)
            ) {
              apps = response.data.applications;
            } else if (Array.isArray(response.data)) {
              apps = response.data;
            } else {
              apps = [response.data];
            }
          } else if (response.applications) {
            apps = Array.isArray(response.applications)
              ? response.applications
              : [response.applications];
          }

          document.getElementById("statPending").textContent = apps.length;
        }
      }

      // æ³¨æ„ï¼šallApplications è®Šæ•¸å·²åœ¨ admin-new-functions.js ä¸­å®£å‘Š
      // ä¸éœ€è¦åœ¨é€™è£¡é‡è¤‡å®£å‘Š

      async function loadPendingApplications() {
        try {
          // æ”¹ç‚ºè¼‰å…¥æ‰€æœ‰æ¡ˆä»¶ï¼Œè€Œä¸åªæ˜¯ pending
          const result = await fetch(`${API_BASE}/applications/?limit=1000`, {
            headers: { Authorization: `Bearer ${accessToken}` },
          });

          if (result.ok) {
            const response = await result.json();
            
            let apps = [];
            if (Array.isArray(response)) {
              apps = response;
            } else if (response.data) {
              if (response.data.applications && Array.isArray(response.data.applications)) {
                apps = response.data.applications;
              } else if (Array.isArray(response.data)) {
                apps = response.data;
              } else {
                apps = [response.data];
              }
            } else if (response.applications) {
              apps = Array.isArray(response.applications) ? response.applications : [response.applications];
            }

            console.log('è¼‰å…¥æ¡ˆä»¶æ•¸é‡:', apps.length, apps);
            
            allApplications = apps;
            
            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            updateStatCards(apps);
            
            // é¡¯ç¤ºæ¡ˆä»¶åˆ—è¡¨ï¼ˆé è¨­åªé¡¯ç¤ºå¾…å¯©æ ¸çš„ï¼‰
            const pendingApps = apps.filter(app => app.status === 'pending');
            displayApplications(pendingApps, "applicationsList");
          } else {
            console.error('è¼‰å…¥æ¡ˆä»¶å¤±æ•—:', result.status);
            allApplications = [];
            updateStatCards([]);
            displayApplications([], "applicationsList");
          }
        } catch (error) {
          console.error('è¼‰å…¥æ¡ˆä»¶éŒ¯èª¤:', error);
          allApplications = [];
          updateStatCards([]);
          displayApplications([], "applicationsList");
        }
      }

      // æ›´æ–°çµ±è¨ˆå¡ç‰‡
      function updateStatCards(apps) {
        const pending = apps.filter(app => app.status === 'pending').length;
        const siteInspection = apps.filter(app => app.status === 'site_inspection').length;
        const rejected = apps.filter(app => app.status === 'rejected').length;
        const approved = apps.filter(app => app.status === 'approved' || app.status === 'completed').length;
        
        const statPending = document.getElementById('statPending');
        const statInspection = document.getElementById('statInspection');
        const statRejected = document.getElementById('statRejected');
        const statCompleted = document.getElementById('statCompleted');
        
        if (statPending) statPending.textContent = pending || '0';
        if (statInspection) statInspection.textContent = siteInspection || '0';
        if (statRejected) statRejected.textContent = rejected || '0';
        if (statCompleted) statCompleted.textContent = approved || '0';
        
        console.log('çµ±è¨ˆæ›´æ–°:', { pending, siteInspection, rejected, approved, total: apps.length });
      }

      // æŒ‰ç‹€æ…‹ç¯©é¸æ¡ˆä»¶
      let currentStatusFilter = null;
      
      function filterByStatus(status) {
        console.log('ç¯©é¸ç‹€æ…‹:', status);
        
        // å¦‚æœé»æ“Šç›¸åŒçš„ç‹€æ…‹ï¼Œå‰‡å–æ¶ˆç¯©é¸
        if (currentStatusFilter === status) {
          currentStatusFilter = null;
          displayApplications(allApplications, "applicationsList");
        } else {
          currentStatusFilter = status;
          const filtered = allApplications.filter(app => {
            if (status === 'approved') {
              return app.status === 'approved' || app.status === 'completed';
            }
            return app.status === status;
          });
          displayApplications(filtered, "applicationsList");
        }
        
        // æ›´æ–°å¡ç‰‡æ¨£å¼
        document.querySelectorAll('.stat-mini-card').forEach(card => {
          card.classList.remove('active');
        });
        if (currentStatusFilter) {
          event.target.closest('.stat-mini-card').classList.add('active');
        }
      }

      function filterApplications() {
        const filterCity = document.getElementById('filterCity')?.value || '';
        const filterTownship = document.getElementById('filterTownship')?.value || '';
        const filterVillage = document.getElementById('filterVillage')?.value || '';
        const filterDisasterType = document.getElementById('filterDisasterType')?.value || '';
        const filterStatus = document.getElementById('filterStatus')?.value || '';

        let filtered = allApplications;

        // æŒ‰åœ°å€éæ¿¾ï¼ˆç¸£å¸‚/é„‰é®/æ‘é‡Œï¼‰
        if (filterCity || filterTownship || filterVillage) {
          filtered = filtered.filter(app => {
            const address = app.damage_location || app.address || '';
            
            // å¦‚æœæ²’æœ‰åœ°å€ï¼Œéæ¿¾æ‰
            if (!address || address === 'æœªæä¾›åœ°å€') {
              return false;
            }
            
            // ç¸£å¸‚ç¯©é¸
            if (filterCity) {
              const cityName = filterCity.replace('ç¸£', '').replace('å¸‚', '');
              if (!address.includes(cityName)) {
                return false;
              }
            }
            
            // é„‰é®å¸‚å€ç¯©é¸
            if (filterTownship && !address.includes(filterTownship)) {
              return false;
            }
            
            // æ‘é‡Œç¯©é¸
            if (filterVillage && !address.includes(filterVillage)) {
              return false;
            }
            
            return true;
          });
        }

        // æŒ‰ç½å®³é¡å‹éæ¿¾
        if (filterDisasterType) {
          filtered = filtered.filter(app => app.disaster_type === filterDisasterType);
        }

        // æŒ‰ç‹€æ…‹éæ¿¾
        if (filterStatus) {
          filtered = filtered.filter(app => app.status === filterStatus);
        }

        console.log('ç¯©é¸çµæœ:', {
          åŸå§‹æ•¸é‡: allApplications.length,
          ç¯©é¸å¾Œ: filtered.length,
          æ¢ä»¶: { filterCity, filterTownship, filterVillage, filterDisasterType, filterStatus }
        });

        displayApplications(filtered, "applicationsList");
      }

      function displayApplications(apps, containerId) {
        const container = document.getElementById(containerId);

        if (!container) {
          console.error('å®¹å™¨ä¸å­˜åœ¨:', containerId);
          return;
        }

        if (apps.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ç›®å‰æ²’æœ‰æ¡ˆä»¶</p></div>';
          return;
        }

        // æ–°çš„åˆ—è¡¨æ¨£å¼ - ä¸€æ’ä¸€å€‹æ¡ˆä»¶
        const html = apps.map(app => {
          const disasterType = app.disaster_type ? getDisasterTypeText(app.disaster_type) : 'æ°´ç½';
          const location = app.damage_location || app.address || 'æœªæä¾›åœ°å€';
          const date = app.submitted_at ? new Date(app.submitted_at).toLocaleDateString('zh-TW', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit' 
          }) : 'æœªçŸ¥æ—¥æœŸ';
          
          return `
          <div class="application-row" data-id="${app.id}">
            <div class="app-row-left">
              <div class="app-status-badge status-${app.status}">${getStatusText(app.status)}</div>
              <div class="app-info">
                <div class="app-name">${app.applicant_name}</div>
                <div class="app-case">æ¡ˆä»¶ç·¨è™Ÿï¼š${app.case_no}</div>
              </div>
            </div>
            
            <div class="app-row-middle">
              <div class="app-detail-item">
                <span class="app-label">ç”³è«‹é …ç›®ï¼š${disasterType}</span>
              </div>
              <div class="app-detail-item">
                <span class="app-location">${location}</span>
              </div>
            </div>
            
            <div class="app-row-right">
              <div class="app-date">${date}</div>
              <div class="app-actions">
                <button class="btn-å°èˆª" onclick="showLocationOnMap('${app.id}', '${location.replace(/'/g, "\\'")}'); event.stopPropagation();" title="åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹">
                  å°èˆª
                </button>
                <button class="btn-å‰å¾€å¯©æ ¸" onclick='openReviewModal(${JSON.stringify(app).replace(/'/g, "&apos;")})'>
                  å‰å¾€å¯©æ ¸ â†’
                </button>
              </div>
            </div>
          </div>
        `;
        }).join('');
        
        container.innerHTML = html;
      }

      async function openReviewModal(app) {
        currentApplication = app;

        // é¡¯ç¤ºç”³è«‹äººè³‡è¨Šï¼ˆä¸é¡¯ç¤ºèº«åˆ†è­‰å­—è™Ÿï¼‰
        document.getElementById("applicantInfo").innerHTML = `
          <div class="info-item">
            <span class="info-label">å§“å</span>
            <span class="info-value">${app.applicant_name}</span>
          </div>
          <div class="info-item">
            <span class="info-label">é›»è©±</span>
            <span class="info-value">${app.phone}</span>
          </div>
          <div class="info-item">
            <span class="info-label">è¯çµ¡åœ°å€</span>
            <span class="info-value">${app.address || "æœªæä¾›"}</span>
          </div>
        `;

        // é¡¯ç¤ºç½å®³è³‡è¨Šï¼ˆä¸é¡¯ç¤ºé‡‘é¡ï¼‰
        document.getElementById("disasterInfo").innerHTML = `
          <div class="info-item">
            <span class="info-label">ç½å®³æ—¥æœŸ</span>
            <span class="info-value">${app.disaster_date}</span>
          </div>
          <div class="info-item">
            <span class="info-label">ç½å®³é¡å‹</span>
            <span class="info-value">${getDisasterTypeText(app.disaster_type)}</span>
          </div>
          <div class="info-item">
            <span class="info-label">ç½æåœ°é»</span>
            <span class="info-value">${app.damage_location || "æœªæä¾›"}</span>
          </div>
          <div class="info-item full-width">
            <span class="info-label">ç½ææè¿°</span>
            <span class="info-value">${app.damage_description}</span>
          </div>
        `;

        // è¼‰å…¥ç½æç…§ç‰‡
        await loadApplicationDocuments(app.id);

        // é¡¯ç¤ºä¸­é–“å½ˆçª—
        document.getElementById("reviewModal").style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeReviewModal() {
        document.getElementById("reviewModal").style.display = "none";
        document.body.style.overflow = "auto";
        currentApplication = null;
      }

      // è¼‰å…¥ç½æç…§ç‰‡
      async function loadApplicationDocuments(applicationId) {
        const photosContainer = document.getElementById('damagePhotos');
        
        try {
          photosContainer.innerHTML = '<p style="color: #999; font-size: 14px; text-align: center;">è¼‰å…¥ä¸­...</p>';
          
          // å…ˆå˜—è©¦å¾ photos API ç²å–ç…§ç‰‡
          let photos = [];
          try {
            const photosResponse = await fetch(`${API_BASE}/photos/application/${applicationId}`, {
              headers: { Authorization: `Bearer ${accessToken}` },
            });
            
            if (photosResponse.ok) {
              const photosResult = await photosResponse.json();
              photos = photosResult.data?.photos || [];
              console.log('å¾ photos API è¼‰å…¥:', photos.length, 'å¼µç…§ç‰‡');
            }
          } catch (error) {
            console.log('photos API å¤±æ•—ï¼Œå˜—è©¦ documents API');
          }
          
          // å¦‚æœ photos API æ²’æœ‰è³‡æ–™ï¼Œå¾ documents API ç²å–
          if (photos.length === 0) {
            const docsResponse = await fetch(`${API_BASE}/documents/application/${applicationId}`, {
              headers: { Authorization: `Bearer ${accessToken}` },
            });
            
            if (!docsResponse.ok) {
              throw new Error(`HTTP ${docsResponse.status}: ç„¡æ³•è¼‰å…¥æ–‡ä»¶`);
            }
            
            const docsResult = await docsResponse.json();
            const documents = docsResult.data?.documents || [];
            
            // åªé¸æ“‡åœ–ç‰‡æª”æ¡ˆ
            photos = documents.filter(doc => 
              doc.mime_type && doc.mime_type.startsWith('image/')
            ).map(doc => ({
              ...doc,
              signed_url: doc.signed_url,
              photo_type: doc.document_type || 'other',
              created_at: doc.uploaded_at || doc.created_at
            }));
            
            console.log('å¾ documents API è¼‰å…¥:', photos.length, 'å¼µç…§ç‰‡');
          }
          
          if (photos.length === 0) {
            photosContainer.innerHTML = '<p style="color: #999; font-size: 14px; text-align: center;">æš«ç„¡ç…§ç‰‡</p>';
            return;
          }

          // é¡¯ç¤ºç…§ç‰‡ï¼ˆä½¿ç”¨ API è¿”å›çš„ signed_urlï¼‰
          photosContainer.innerHTML = photos.map(photo => {
            const photoUrl = photo.signed_url || '/static/assets/placeholder.png';
            const photoType = getPhotoTypeText(photo.photo_type) || photo.file_name;
            const photoDate = new Date(photo.created_at).toLocaleDateString('zh-TW');
            
            return `
              <div class="photo-item">
                <img 
                  src="${photoUrl}" 
                  alt="${photoType}" 
                  onclick="viewPhotoFullscreen('${photoUrl}')" 
                  onerror="this.onerror=null; this.src='/static/assets/placeholder.png'; this.parentElement.style.opacity='0.5';"
                >
                <div class="photo-info">
                  <small>${photoType} - ${photoDate}</small>
                </div>
              </div>
            `;
          }).join('');

        } catch (error) {
          console.error('è¼‰å…¥ç…§ç‰‡éŒ¯èª¤:', error);
          photosContainer.innerHTML = `<p style="color: #ef4444; font-size: 14px; text-align: center;">è¼‰å…¥ç…§ç‰‡å¤±æ•—ï¼š${error.message}</p>`;
        }
      }
      
      // ç…§ç‰‡é¡å‹æ–‡å­—è½‰æ›
      function getPhotoTypeText(type) {
        const typeMap = {
          'before_damage': 'ç½æå‰',
          'after_damage': 'ç½æå¾Œ',
          'site_inspection': 'ç¾å ´å‹˜æŸ¥',
          'other': 'å…¶ä»–'
        };
        return typeMap[type] || 'ç½æç…§ç‰‡';
      }

      // å…¨è¢å¹•æŸ¥çœ‹ç…§ç‰‡
      function viewPhotoFullscreen(url) {
        const modal = document.createElement('div');
        modal.className = 'photo-fullscreen-modal';
        modal.innerHTML = `
          <div class="photo-fullscreen-overlay" onclick="this.parentElement.remove()"></div>
          <div class="photo-fullscreen-content">
            <button class="photo-close-btn" onclick="this.closest('.photo-fullscreen-modal').remove()">Ã—</button>
            <img src="${url}" alt="ç½æç…§ç‰‡">
          </div>
        `;
        document.body.appendChild(modal);
      }

      // åœ°åœ–å°èˆªåŠŸèƒ½ - åœ¨å¡ç‰‡å…§é¡¯ç¤ºå°åœ°åœ–
      let miniMaps = {};

      // åœ°åœ–å°èˆªåŠŸèƒ½ - åœ¨æ¡ˆä»¶è¡Œä¸‹é¡¯ç¤ºå°åœ°åœ–
      async function showLocationOnMap(appId, location) {
        if (!location || location === 'æœªæä¾›åœ°å€' || location === 'null' || location === 'undefined') {
          alert('æ­¤æ¡ˆä»¶æœªæä¾›åœ°å€è³‡è¨Š');
          return;
        }

        // æ‰¾åˆ°å°æ‡‰çš„æ¡ˆä»¶è¡Œ
        const row = document.querySelector(`.application-row[data-id="${appId}"]`);
        if (!row) {
          console.error('æ‰¾ä¸åˆ°æ¡ˆä»¶è¡Œ:', appId);
          return;
        }

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰åœ°åœ–å®¹å™¨
        let existingMap = row.nextElementSibling;
        if (existingMap && existingMap.classList.contains('mini-map-container')) {
          // å¦‚æœå·²ç¶“é¡¯ç¤ºï¼Œå‰‡ç§»é™¤
          existingMap.remove();
          return;
        }

        // å‰µå»ºåœ°åœ–å®¹å™¨
        const mapContainer = document.createElement('div');
        mapContainer.className = 'mini-map-container';
        mapContainer.innerHTML = `
          <div class="mini-map-header">
            <span>ğŸ“ ${location}</span>
            <button class="close-mini-map" onclick="this.remove(); this.closest('.mini-map-container').remove();">Ã—</button>
          </div>
          <div class="mini-map" id="miniMap_${appId}" style="width: 100%; height: 300px;"></div>
          <div class="mini-map-actions">
            <button class="btn-open-gmaps" onclick="openInGoogleMaps('${encodeURIComponent(location)}')">
              åœ¨ Google Maps é–‹å•Ÿ
            </button>
          </div>
        `;

        // æ’å…¥åˆ°æ¡ˆä»¶è¡Œä¹‹å¾Œ
        row.after(mapContainer);

        // åˆå§‹åŒ– Google Maps
        setTimeout(async () => {
          const mapEl = document.getElementById(`miniMap_${appId}`);
          if (!mapEl) return;
          
          const map = new google.maps.Map(mapEl, {
            zoom: 15,
            center: { lat: 23.987, lng: 121.601 }, // èŠ±è“®é è¨­ä¸­å¿ƒ
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
          });

          // ä½¿ç”¨ Geocoding API å–å¾—åº§æ¨™
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address: location }, (results, status) => {
            if (status === 'OK' && results[0]) {
              const position = results[0].geometry.location;
              map.setCenter(position);
              
              // æ·»åŠ æ¨™è¨˜
              new google.maps.Marker({
                position: position,
                map: map,
                title: location,
                animation: google.maps.Animation.DROP
              });
            } else {
              console.error('Geocoding å¤±æ•—:', status);
              mapEl.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #ef4444;">
                  <p style="font-size: 16px; margin-bottom: 8px;">âŒ ç„¡æ³•å®šä½æ­¤åœ°å€</p>
                  <p style="font-size: 12px; color: #999;">${location}</p>
                </div>
              `;
            }
          });
        }, 100);
      }

      function openInGoogleMaps(location) {
        const url = `https://www.google.com/maps/search/?api=1&query=${location}`;
        window.open(url, '_blank');
      }

      // æäº¤å¯©æ ¸ï¼ˆæ•´åˆæ ¸å‡†å’Œé§å›ï¼‰
      async function submitReview() {
        const reviewResult = document.querySelector('input[name="reviewResult"]:checked').value;
        const comments = document.getElementById("reviewComments").value;

        if (reviewResult === 'reject' && !comments) {
          alert("è«‹å¡«å¯«é§å›åŸå› ");
          return;
        }

        const isApproved = reviewResult === 'approve';

        try {
          const result = await fetch(`/api/v1/complete-flow/review-and-issue`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              application_id: currentApplication.id,
              approved: isApproved,
              review_notes: comments,
              approved_amount: 0, // ä¸å†éœ€è¦é‡‘é¡
            }),
          });

          const data = await result.json();

          if (data.success) {
            if (isApproved) {
              alert(
                "âœ… æ ¸å‡†æˆåŠŸï¼\n\n" +
                  "æ•¸ä½æ†‘è­‰å·²ç”¢ç”Ÿä¸¦ç™¼é€çµ¦ç½æ°‘ã€‚\n" +
                  "ç½æ°‘å¯åœ¨ç”³è«‹è¨˜éŒ„ä¸­æŸ¥çœ‹ä¸¦æƒæ QR Code é ˜å–æ†‘è­‰ã€‚\n\n" +
                  `æ¡ˆä»¶ç·¨è™Ÿï¼š${currentApplication.case_no}`
              );
            } else {
              alert(`âŒ å·²é§å›ç”³è«‹\n\næ¡ˆä»¶ç·¨è™Ÿï¼š${currentApplication.case_no}`);
            }

            closeReviewModal();
            loadDashboardStats();
            loadPendingApplications();
          } else {
            alert(`æ“ä½œå¤±æ•—ï¼š${data.message || "è«‹ç¨å¾Œå†è©¦"}`);
          }
        } catch (error) {
          console.error("å¯©æ ¸éŒ¯èª¤:", error);
          alert(`ç³»çµ±éŒ¯èª¤ï¼š${error.message}`);
        }
      }



      function loadStatistics() {
        document.getElementById("statisticsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <p>çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            `;
      }

      // è¼‰å…¥æ­·å²ç´€éŒ„
      async function loadHistory() {
        const historyContent = document.getElementById('historyContent');
        if (!historyContent) return;

        try {
          // å–å¾—ç¯©é¸æ¢ä»¶
          const searchInput = document.getElementById('historySearchInput')?.value.trim().toLowerCase() || '';
          const sortBy = currentHistorySortOrder; // ä½¿ç”¨å…¨åŸŸè®Šæ•¸

          // é¡¯ç¤ºè¼‰å…¥ä¸­
          historyContent.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">â³</div>
              <p>è¼‰å…¥ä¸­...</p>
            </div>
          `;

          // ğŸ”§ å¾çœŸæ­£çš„ credential_history table è®€å–è³‡æ–™
          const params = new URLSearchParams();
          params.append('limit', '1000');

          const historyResponse = await fetch(
            `${API_BASE}/complete-flow/credential-history-list?${params.toString()}`, 
            {
              headers: { 
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
              }
            }
          );

          let allHistory = [];
          if (historyResponse.ok) {
            const historyData = await historyResponse.json();
            
            // å¾ credential_history table è®€å–çœŸå¯¦è³‡æ–™
            const records = historyData.data || [];
            
            console.log('ğŸ“Š è¼‰å…¥æ†‘è­‰æ­·å²è¨˜éŒ„:', records.length, 'ç­†');
            
            // è½‰æ›ç‚ºé¡¯ç¤ºæ ¼å¼
            allHistory = records.map(record => ({
              id: record.id,
              application_id: record.application_id,
              applicant_name: record.applicant_name,
              subsidy_type: getDisasterTypeText(record.disaster_type) + 'è£œåŠ©',
              disaster_region: extractRegion(record.disaster_address),
              result: record.status, // 'issued' or 'verified'
              action_time: record.action_time,
              issuer_organization: record.issuer_organization || 'N/A',
              verifier_organization: record.verifier_organization || 'N/A',
              verification_time: record.action_time,
              action_type: record.action_type // 'credential_issued' or 'credential_verified'
            }));
          }

          // æ‡‰ç”¨å‰ç«¯ç¯©é¸ï¼ˆçµ±ä¸€æœå°‹æ¡†ï¼‰
          let filteredHistory = allHistory;
          
          // çµ±ä¸€æœå°‹æ¡†ç¯©é¸ - æ”¯æ´å§“åã€è£œåŠ©é¡å‹ã€ç™¼è¡Œæ©Ÿæ§‹ã€é©—è­‰æ©Ÿæ§‹
          if (searchInput) {
            filteredHistory = filteredHistory.filter(h => {
              // æœå°‹å§“å
              if (h.applicant_name && h.applicant_name.toLowerCase().includes(searchInput)) {
                return true;
              }
              // æœå°‹è£œåŠ©é¡å‹
              if (h.subsidy_type && h.subsidy_type.toLowerCase().includes(searchInput)) {
                return true;
              }
              // æœå°‹ç™¼è¡Œæ©Ÿæ§‹
              if (h.issuer_organization && h.issuer_organization.toLowerCase().includes(searchInput)) {
                return true;
              }
              // æœå°‹é©—è­‰æ©Ÿæ§‹
              if (h.verifier_organization && h.verifier_organization.toLowerCase().includes(searchInput)) {
                return true;
              }
              return false;
            });
          }

          // æ’åº
          if (sortBy === 'desc') {
            // é©—è­‰æ™‚é–“ï¼ˆæ–°åˆ°èˆŠï¼‰
            filteredHistory.sort((a, b) => new Date(b.verification_time) - new Date(a.verification_time));
          } else if (sortBy === 'asc') {
            // é©—è­‰æ™‚é–“ï¼ˆèˆŠåˆ°æ–°ï¼‰
            filteredHistory.sort((a, b) => new Date(a.verification_time) - new Date(b.verification_time));
          }

          // æ›´æ–°çµ±è¨ˆå¡ç‰‡
          const totalRecords = allHistory.length;
          const issuedCount = allHistory.filter(h => h.result === 'issued').length;
          const verifiedCount = allHistory.filter(h => h.result === 'verified').length;
          const verificationRate = issuedCount > 0 ? Math.round((verifiedCount / issuedCount) * 100) : 0;
          
          document.getElementById('historyStatTotal').textContent = totalRecords || '0';
          document.getElementById('historyStatIssued').textContent = issuedCount || '0';
          document.getElementById('historyStatVerified').textContent = verifiedCount || '0';
          document.getElementById('historyStatRate').textContent = verificationRate || '0';

          console.log('ğŸ” ç¯©é¸çµæœ:', {
            ç¸½è¨˜éŒ„æ•¸: allHistory.length,
            ç¯©é¸å¾Œ: filteredHistory.length,
            æœå°‹: searchInput || 'ç„¡',
            æ’åº: sortBy === 'desc' ? 'æ–°åˆ°èˆŠ' : 'èˆŠåˆ°æ–°'
          });

          // æ¸²æŸ“é é¢
          historyContent.innerHTML = `
            <!-- æ­·å²è¨˜éŒ„è¡¨æ ¼ -->
            <div class="table-container" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <table class="data-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #64748b; width: 10%;">è£œåŠ©é¡å‹</th>
                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #64748b; width: 8%;">å§“å</th>
                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #64748b; width: 10%;">å—ç½åœ°å€</th>
                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #64748b; width: 10%;">é©—è­‰ç›®çš„</th>
                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #64748b; width: 18%;">ç™¼è¡Œæ©Ÿæ§‹</th>
                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #64748b; width: 14%;">é©—è­‰æ©Ÿæ§‹</th>
                    <th style="padding: 16px 12px; text-align: center; font-weight: 600; font-size: 13px; color: #64748b; width: 10%;">é©—è­‰çµæœ</th>
                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; font-size: 13px; color: #64748b; width: 20%;">é©—è­‰æ™‚é–“</th>
                  </tr>
                </thead>
                <tbody>
                  ${filteredHistory.length === 0 ? `
                    <tr>
                      <td colspan="8" style="text-align: center; color: #94a3b8; padding: 60px 20px; font-size: 14px;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
                        <div>ç›®å‰æ²’æœ‰æ†‘è­‰è¨˜éŒ„</div>
                      </td>
                    </tr>
                  ` : filteredHistory.map(record => `
                    <tr style="border-bottom: 1px solid #f1f5f9; transition: background-color 0.15s;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='white'">
                      <td style="padding: 16px 12px;">
                        <span class="badge badge-info" style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background: #dbeafe; color: #1e40af;">${record.subsidy_type || 'N/A'}</span>
                      </td>
                      <td style="padding: 16px 12px; font-weight: 600; color: #1e293b; font-size: 14px;">${record.applicant_name || 'N/A'}</td>
                      <td style="padding: 16px 12px; color: #64748b; font-size: 14px;">${record.disaster_region || 'N/A'}</td>
                      <td style="padding: 16px 12px; color: #64748b; font-size: 14px;">è£œåŠ©é ˜å–</td>
                      <td style="padding: 16px 12px; color: #475569; font-size: 14px;">${record.issuer_organization || 'N/A'}</td>
                      <td style="padding: 16px 12px; color: #475569; font-size: 14px;">${record.verifier_organization || 'N/A'}</td>
                      <td style="padding: 16px 12px; text-align: center;">
                        ${record.result === 'issued' ? 
                          '<span class="badge badge-secondary" style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background: #f1f5f9; color: #64748b;">æœªé©—è­‰</span>' : 
                          '<span class="badge badge-success" style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background: #d1fae5; color: #065f46;">âœ“ å·²é©—è­‰</span>'}
                      </td>
                      <td style="padding: 16px 12px; color: #64748b; font-size: 14px;">
                        ${record.verification_time ? formatDateTime(record.verification_time) : 'N/A'}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <!-- åˆ†é  -->
            ${filteredHistory.length > 0 ? `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 0 10px;">
                <div style="color: #64748b; font-size: 14px;">
                  1 / ${Math.ceil(filteredHistory.length / 10)} é 
                </div>
                <div style="display: flex; gap: 10px;">
                  <button class="btn btn-secondary" disabled style="opacity: 0.5; padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; cursor: not-allowed;">ä¸Šä¸€é </button>
                  <button class="btn btn-secondary" ${filteredHistory.length <= 10 ? 'disabled style="opacity: 0.5; padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; cursor: not-allowed;"' : 'style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #475569; cursor: pointer;" onmouseover="this.style.background=\'#f8fafc\'" onmouseout="this.style.background=\'white\'"'}>ä¸‹ä¸€é </button>
                </div>
              </div>
            ` : ''}
          `;

        } catch (error) {
          console.error('è¼‰å…¥æ†‘è­‰è¨˜éŒ„å¤±æ•—:', error);
          historyContent.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">âš ï¸</div>
              <p>è¼‰å…¥å¤±æ•—: ${error.message}</p>
              <button class="btn btn-primary" onclick="loadHistory()">é‡è©¦</button>
            </div>
          `;
        }
      }

      // è¼”åŠ©å‡½æ•¸ï¼šæå–åœ°å€ï¼ˆä¿è­·éš±ç§ï¼‰- å„ªå…ˆé¡¯ç¤ºåˆ°æ‘é‡Œï¼Œå…¶æ¬¡å€/é„‰é®ï¼Œæœ€å¾Œç¸£å¸‚
      function extractRegion(fullAddress) {
        if (!fullAddress || fullAddress === 'null' || fullAddress === 'undefined') {
          return 'N/A';
        }
        
        // ç§»é™¤ç©ºç™½å­—å…ƒ
        fullAddress = fullAddress.trim();
        
        console.log('ğŸ” åœ°å€æå– DEBUG - å®Œæ•´åœ°å€:', fullAddress);
        
        // å„ªå…ˆç´š 1: ç¸£å¸‚ + å€/é„‰é® + æ‘é‡Œ
        // ä¾‹å¦‚ï¼šèŠ±è“®ç¸£å…‰å¾©é„‰å¤§å®‰æ‘ â†’ èŠ±è“®ç¸£å…‰å¾©é„‰å¤§å®‰æ‘
        //       å°å—å¸‚ä¸­è¥¿å€æ°‘æ¬Šé‡Œ â†’ å°å—å¸‚ä¸­è¥¿å€æ°‘æ¬Šé‡Œ
        const villageMatch = fullAddress.match(/^(.{2,3}[å¸‚ç¸£])(.+?[å€é„‰é®])(.{1,3}[æ‘é‡Œ])/);
        if (villageMatch) {
          console.log('âœ“ æ‘é‡ŒåŒ¹é…æˆåŠŸ:', villageMatch[1] + villageMatch[2] + villageMatch[3]);
          return villageMatch[1] + villageMatch[2] + villageMatch[3]; // ç¸£å¸‚ + å€/é„‰é® + æ‘é‡Œ
        }
        
        // å„ªå…ˆç´š 2: ç¸£å¸‚ + å€/é„‰é®
        // ä¾‹å¦‚ï¼šæ–°ç«¹å¸‚æ±å€é£Ÿå“è·¯ â†’ æ–°ç«¹å¸‚æ±å€
        //       å°å—å¸‚ä¸­è¥¿å€ä¸­æ­£è·¯ â†’ å°å—å¸‚ä¸­è¥¿å€
        //       å°åŒ—å¸‚å¤§å®‰å€ â†’ å°åŒ—å¸‚å¤§å®‰å€
        // ä½¿ç”¨ .+? éè²ªå©ªåŒ¹é…ï¼Œé¿å…ã€Œæ–°ç«¹å¸‚ã€çš„ã€Œå¸‚ã€è¢«ç•¶ä½œå€/é„‰é®çµå°¾
        const districtMatch = fullAddress.match(/^(.{2,3}[å¸‚ç¸£])(.+?[å€é„‰é®])/);
        if (districtMatch) {
          console.log('âœ“ å€/é„‰é®åŒ¹é…æˆåŠŸ:', districtMatch[1] + districtMatch[2]);
          return districtMatch[1] + districtMatch[2]; // ç¸£å¸‚ + å€/é„‰é®
        }
        
        // å„ªå…ˆç´š 3: åªæœ‰ç¸£å¸‚
        // ä¾‹å¦‚ï¼šå°åŒ—å¸‚... â†’ å°åŒ—å¸‚
        const cityMatch = fullAddress.match(/^(.{2,3}[å¸‚ç¸£])/);
        if (cityMatch) {
          console.log('âœ“ ç¸£å¸‚åŒ¹é…æˆåŠŸ:', cityMatch[1]);
          return cityMatch[1];
        }
        
        console.log('âœ— ç„¡æ³•åŒ¹é…ï¼Œè¿”å› N/A');
        // å¦‚æœéƒ½ç„¡æ³•åŒ¹é…ï¼Œè¿”å› N/A
        return 'N/A';
      }

      // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ï¼ˆå°‡ UTC è½‰æ›ç‚ºå°åŒ—æ™‚é–“ï¼‰
      function formatDateTime(dateTimeStr) {
        console.log('ğŸ• formatDateTime è¼¸å…¥:', dateTimeStr);
        
        if (!dateTimeStr || dateTimeStr === 'null' || dateTimeStr === 'undefined') {
          console.log('âš ï¸ ç„¡æ•ˆçš„æ—¥æœŸå­—ä¸²');
          return 'N/A';
        }
        try {
          // è§£æ UTC æ™‚é–“ï¼ˆSupabase å„²å­˜çš„æ ¼å¼ï¼š2025-11-19 11:38:03.933727+00ï¼‰
          const utcDate = new Date(dateTimeStr);
          console.log('ğŸ“… è§£æå¾Œçš„ UTC Date:', utcDate);
          console.log('ğŸ“… UTC ISO String:', utcDate.toISOString());
          
          // æª¢æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
          if (isNaN(utcDate.getTime())) {
            console.log('âŒ æ—¥æœŸç„¡æ•ˆ');
            return 'N/A';
          }
          
          // æ‰‹å‹•è½‰æ›ç‚ºå°åŒ—æ™‚é–“ (UTC+8)
          // å–å¾— UTC çš„æ™‚é–“æˆ³è¨˜ï¼ŒåŠ ä¸Š 8 å°æ™‚ï¼ˆ8 * 60 * 60 * 1000 æ¯«ç§’ï¼‰
          const taipeiTime = new Date(utcDate.getTime());
          console.log('ğŸ‡¹ğŸ‡¼ å°åŒ—æ™‚é–“ Date:', taipeiTime);
          console.log('ğŸ‡¹ğŸ‡¼ å°åŒ—æ™‚é–“ ISO:', taipeiTime.toISOString());
          
          // æ ¼å¼åŒ–ç‚ºå°åŒ—æ™‚é–“å­—ä¸²
          const year = taipeiTime.getUTCFullYear();
          const month = String(taipeiTime.getUTCMonth() + 1).padStart(2, '0');
          const day = String(taipeiTime.getUTCDate()).padStart(2, '0');
          let hours = taipeiTime.getUTCHours();
          const minutes = String(taipeiTime.getUTCMinutes()).padStart(2, '0');
          
          console.log('ğŸ“Š è§£æçµæœ:', { year, month, day, hours, minutes });
          
          // è½‰æ›ç‚º 12 å°æ™‚åˆ¶
          const period = hours >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
          if (hours > 12) hours -= 12;
          if (hours === 0) hours = 12;
          const displayHours = String(hours);
          
          // è¿”å›æ ¼å¼ï¼š2025/11/19 ä¸‹åˆ7:38
          const result = `${year}/${month}/${day} ${period}${displayHours}:${minutes}`;
          console.log('âœ… æœ€çµ‚è¼¸å‡º:', result);
          return result;
        } catch (e) {
          console.error('âŒ formatDateTime éŒ¯èª¤:', e);
          return 'N/A';
        }
      }

      function logout() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          localStorage.removeItem("admin_token");
          localStorage.removeItem("admin_user");
          location.reload();
        }
      }

      function getStatusText(status) {
        const map = {
          pending: "å¾…å¯©æ ¸",
          under_review: "å¯©æ ¸ä¸­",
          approved: "å·²æ ¸å‡†",
          rejected: "å·²é§å›",
        };
        return map[status] || status;
      }

      function getDisasterTypeText(type) {
        const map = {
          flood: "æ°´ç½",
          typhoon: "é¢±é¢¨",
          earthquake: "åœ°éœ‡",
          other: "å…¶ä»–",
        };
        return map[type] || type;
      }

      // åˆ‡æ›åˆ—è¡¨/åœ°åœ–æª¢è¦–
      let applicationsMap = null;
      let mapMarkers = [];
      
      function switchView(view) {
        const listView = document.getElementById('listView');
        const mapView = document.getElementById('mapView');
        const listTab = document.getElementById('listViewTab');
        const mapTab = document.getElementById('mapViewTab');
        
        if (view === 'list') {
          listView.style.display = 'block';
          mapView.style.display = 'none';
          listTab.classList.add('active');
          mapTab.classList.remove('active');
        } else if (view === 'map') {
          listView.style.display = 'none';
          mapView.style.display = 'block';
          listTab.classList.remove('active');
          mapTab.classList.add('active');
          
          // åˆå§‹åŒ–åœ°åœ–ï¼ˆå¦‚æœé‚„æ²’æœ‰åˆå§‹åŒ–ï¼‰
          if (!applicationsMap) {
            initializeApplicationsMap();
          } else {
            // æ›´æ–°åœ°åœ–æ¨™è¨˜
            updateMapMarkers();
          }
        }
      }
      
      // åˆå§‹åŒ–åœ°åœ–
      function initializeApplicationsMap() {
        const mapElement = document.getElementById('applicationsMap');
        if (!mapElement) return;
        
        // é è¨­ä¸­å¿ƒé»ï¼ˆèŠ±è“®ï¼‰
        const defaultCenter = { lat: 23.9871, lng: 121.6015 };
        
        applicationsMap = new google.maps.Map(mapElement, {
          center: defaultCenter,
          zoom: 12,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
        });
        
        // é¡¯ç¤ºæ¡ˆä»¶æ¨™è¨˜
        updateMapMarkers();
      }
      
      // æ›´æ–°åœ°åœ–æ¨™è¨˜
      async function updateMapMarkers() {
        if (!applicationsMap) return;
        
        // æ¸…é™¤èˆŠæ¨™è¨˜
        mapMarkers.forEach(marker => marker.setMap(null));
        mapMarkers = [];
        
        // ç²å–ç¯©é¸å¾Œçš„æ¡ˆä»¶
        const filterCity = document.getElementById('filterCity')?.value || '';
        const filterTownship = document.getElementById('filterTownship')?.value || '';
        const filterVillage = document.getElementById('filterVillage')?.value || '';
        const filterStatus = document.getElementById('filterStatus')?.value || '';
        
        let filteredApps = allApplications;
        
        // æŒ‰åœ°å€ç¯©é¸
        if (filterCity || filterTownship || filterVillage) {
          filteredApps = filteredApps.filter(app => {
            const address = app.damage_location || app.address || '';
            if (filterCity && !address.includes(filterCity.replace('ç¸£', '').replace('å¸‚', ''))) {
              return false;
            }
            if (filterTownship && !address.includes(filterTownship)) {
              return false;
            }
            if (filterVillage && !address.includes(filterVillage)) {
              return false;
            }
            return true;
          });
        }
        
        // æŒ‰ç‹€æ…‹ç¯©é¸
        if (filterStatus) {
          filteredApps = filteredApps.filter(app => app.status === filterStatus);
        }
        
        console.log('åœ°åœ–é¡¯ç¤ºæ¡ˆä»¶æ•¸é‡:', filteredApps.length);
        
        if (filteredApps.length === 0) {
          alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¡ˆä»¶');
          return;
        }
        
        // ä½¿ç”¨ Geocoding API ç‚ºæ¯å€‹æ¡ˆä»¶å‰µå»ºæ¨™è¨˜
        const geocoder = new google.maps.Geocoder();
        const bounds = new google.maps.LatLngBounds();
        
        for (const app of filteredApps) {
          const address = app.damage_location || app.address;
          if (!address || address === 'æœªæä¾›åœ°å€') continue;
          
          try {
            const result = await new Promise((resolve, reject) => {
              geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                  resolve(results[0]);
                } else {
                  reject(new Error('Geocoding failed'));
                }
              });
            });
            
            const position = result.geometry.location;
            
            // æ ¹æ“šç‹€æ…‹é¸æ“‡æ¨™è¨˜é¡è‰²
            let markerColor = '#3B82F6'; // è—è‰²
            if (app.status === 'pending') markerColor = '#EF4444'; // ç´…è‰²
            else if (app.status === 'site_inspection') markerColor = '#F59E0B'; // æ©™è‰²
            else if (app.status === 'approved') markerColor = '#10B981'; // ç¶ è‰²
            else if (app.status === 'rejected') markerColor = '#F97316'; // æ·±æ©™è‰²
            
            const marker = new google.maps.Marker({
              position: position,
              map: applicationsMap,
              title: `${app.applicant_name} - ${app.case_no}`,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: markerColor,
                fillOpacity: 0.8,
                strokeColor: '#ffffff',
                strokeWeight: 2,
              }
            });
            
            // æ·»åŠ é»æ“Šäº‹ä»¶
            marker.addListener('click', () => {
              const infoWindow = new google.maps.InfoWindow({
                content: `
                  <div style="padding: 10px; min-width: 200px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 16px;">${app.applicant_name}</h4>
                    <p style="margin: 4px 0; font-size: 13px; color: #666;">
                      <strong>æ¡ˆä»¶ç·¨è™Ÿï¼š</strong>${app.case_no}
                    </p>
                    <p style="margin: 4px 0; font-size: 13px; color: #666;">
                      <strong>ç‹€æ…‹ï¼š</strong><span style="color: ${markerColor};">${getStatusText(app.status)}</span>
                    </p>
                    <p style="margin: 4px 0; font-size: 13px; color: #666;">
                      <strong>åœ°å€ï¼š</strong>${address}
                    </p>
                    <button onclick='openReviewModal(${JSON.stringify(app).replace(/'/g, "&apos;")})' 
                            style="margin-top: 8px; padding: 6px 12px; background: #1E81B2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                      æŸ¥çœ‹è©³æƒ…
                    </button>
                  </div>
                `
              });
              infoWindow.open(applicationsMap, marker);
            });
            
            mapMarkers.push(marker);
            bounds.extend(position);
            
          } catch (error) {
            console.error(`ç„¡æ³•å®šä½åœ°å€: ${address}`, error);
          }
        }
        
        // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
        if (mapMarkers.length > 0) {
          applicationsMap.fitBounds(bounds);
        }
      }

      // å…¨åŸŸæ’åºç‹€æ…‹ï¼ˆé è¨­ï¼šæ–°åˆ°èˆŠï¼‰
      let currentHistorySortOrder = 'desc'; // 'desc' or 'asc'
      
      // åˆ‡æ›æ­·å²è¨˜éŒ„æ’åºé †åº
      function toggleHistorySort() {
        // åˆ‡æ›æ’åºé †åº
        currentHistorySortOrder = currentHistorySortOrder === 'desc' ? 'asc' : 'desc';
        
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œåœ–ç¤º
        const sortIcon = document.getElementById('sortIcon');
        const sortText = document.getElementById('sortText');
        
        if (currentHistorySortOrder === 'desc') {
          sortIcon.textContent = 'ğŸ”½';
          sortText.textContent = 'é©—è­‰æ™‚é–“ï¼ˆæ–°åˆ°èˆŠï¼‰';
        } else {
          sortIcon.textContent = 'ğŸ”¼';
          sortText.textContent = 'é©—è­‰æ™‚é–“ï¼ˆèˆŠåˆ°æ–°ï¼‰';
        }
        
        // é‡æ–°è¼‰å…¥è³‡æ–™
        loadHistory();
      }

      function loadStatistics() {
        document.getElementById("statisticsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <p>çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            `;
      }
    </script>
    
    <!-- æ–°ç‰ˆåŠŸèƒ½è…³æœ¬ -->
    <script src="/static/js/admin-new-functions.js"></script>
  </body>
</html>
