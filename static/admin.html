<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¯©æ ¸å¾Œå° - ç½æ°‘è£œåŠ©ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="/static/styles/admin.css" />
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbuTGzgDiR9WfXuvbPOZSc5nNm7NDucuQ&libraries=places,geometry"></script>
  </head>
  <body>
    <div class="header">
      <div class="logo">ğŸ‘¨â€ğŸ’¼ å¯©æ ¸äººå“¡å¾Œå°</div>
      <div class="user-info">
        <div>
          <div style="font-size: 14px; font-weight: 500" id="adminName">
            é‡Œé•·
          </div>
          <div style="font-size: 12px; color: #999" id="adminDistrict">
            å€åŸŸ
          </div>
        </div>
        <div class="user-avatar" id="adminAvatar">é‡Œ</div>
        <button
          class="btn btn-sm"
          onclick="logout()"
          style="background: #f3f4f6; color: #666"
        >
          ç™»å‡º
        </button>
      </div>
    </div>

    <div class="layout">
      <div class="sidebar">
        <div class="nav-item active" onclick="showPage('dashboard')">
          ğŸ“Š å„€è¡¨æ¿
        </div>
        <div class="nav-item" onclick="showPage('applications')">
          ğŸ“‹ å¾…å¯©æ ¸æ¡ˆä»¶
        </div>
        <div class="nav-item" onclick="showPage('map')">ğŸ—ºï¸ æ¡ˆä»¶åœ°åœ–</div>
        <div class="nav-item" onclick="showPage('history')">ğŸ“œ å¯©æ ¸æ­·å²</div>
        <div class="nav-item" onclick="showPage('statistics')">ğŸ“ˆ çµ±è¨ˆå ±è¡¨</div>
      </div>

      <div class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboard-page">
          <div class="page-header">
            <h1 class="page-title">å„€è¡¨æ¿</h1>
            <p class="page-subtitle">ç¸½è¦½æœ¬å€ç”³è«‹æ¡ˆä»¶ç‹€æ…‹</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">å¾…å¯©æ ¸</div>
              <div class="stat-value" id="statPending">-</div>
              <div class="stat-change">éœ€è™•ç†çš„æ¡ˆä»¶</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">å¯©æ ¸ä¸­</div>
              <div class="stat-value" id="statReview">-</div>
              <div class="stat-change">è™•ç†ä¸­</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">å·²æ ¸å‡†</div>
              <div class="stat-value" id="statApproved">-</div>
              <div class="stat-change positive">âœ“ å®Œæˆå¯©æ ¸</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ç¸½ç”³è«‹é¡</div>
              <div class="stat-value" id="statTotal" style="font-size: 24px">
                -
              </div>
              <div class="stat-change">æœ¬æœˆçµ±è¨ˆ</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">æœ€è¿‘å¾…å¯©æ ¸æ¡ˆä»¶</h3>
              <button
                class="btn btn-primary btn-sm"
                onclick="loadPendingApplications()"
              >
                é‡æ–°æ•´ç†
              </button>
            </div>
            <div class="card-body">
              <div id="recentApplications"></div>
            </div>
          </div>
        </div>

        <!-- Applications Page -->
        <div id="applications-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">å¾…å¯©æ ¸æ¡ˆä»¶</h1>
            <p class="page-subtitle">å¯©æ ¸æœ¬å€ç½æ°‘çš„è£œåŠ©ç”³è«‹</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">æ¡ˆä»¶åˆ—è¡¨</h3>
              <button
                class="btn btn-primary btn-sm"
                onclick="loadPendingApplications()"
              >
                é‡æ–°æ•´ç†
              </button>
            </div>
            <div class="card-body">
              <div id="applicationsList"></div>
            </div>
          </div>
        </div>

        <!-- Map Page -->
        <div id="map-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">ğŸ—ºï¸ æ¡ˆä»¶åœ°åœ–è¦–åœ–</h1>
            <p class="page-subtitle">æŸ¥çœ‹æ¡ˆä»¶åˆ†å¸ƒä¸¦è¦åŠƒè¨ªå•è·¯ç·š</p>
          </div>

          <!-- é¸æ“‡æ¡ˆä»¶ -->
          <div class="select-applications-box">
            <h3 style="margin-bottom: 15px">ğŸ“‹ é¸æ“‡è¦æŸ¥çœ‹çš„æ¡ˆä»¶</h3>
            <div class="map-controls">
              <button
                class="btn btn-primary btn-sm"
                onclick="loadMapApplications()"
              >
                è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨
              </button>
              <button
                class="btn btn-success btn-sm"
                onclick="showSelectedOnMap()"
              >
                åœ¨åœ°åœ–ä¸Šé¡¯ç¤º (<span id="selectedCount">0</span>)
              </button>
              <button class="btn btn-primary btn-sm" onclick="planRoutes()">
                ğŸ¯ è¦åŠƒæœ€ä½³è·¯ç·š
              </button>
              <button
                class="btn btn-sm"
                onclick="clearMapSelection()"
                style="background: #f3f4f6; color: #666"
              >
                æ¸…é™¤é¸æ“‡
              </button>
            </div>
            <div id="mapApplicationsList" style="margin-top: 15px">
              <p style="color: #666; text-align: center; padding: 20px">
                é»æ“Šã€Œè¼‰å…¥æ¡ˆä»¶åˆ—è¡¨ã€é–‹å§‹
              </p>
            </div>
          </div>

          <!-- Google åœ°åœ– -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“ æ¡ˆä»¶åˆ†å¸ƒåœ°åœ–</h3>
              <div style="font-size: 14px; color: #666">
                é»æ“Šæ¨™è¨˜æŸ¥çœ‹æ¡ˆä»¶è©³æƒ…
              </div>
            </div>
            <div class="card-body">
              <div id="map"></div>
            </div>
          </div>

          <!-- è·¯ç·šè¦åŠƒçµæœ -->
          <div id="routesContainer" class="hidden">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ğŸ¯ Top 3 æœ€ä½³è·¯ç·šæ–¹æ¡ˆ</h3>
              </div>
              <div class="card-body">
                <div id="routesList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- History Page -->
        <div id="history-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">å¯©æ ¸æ­·å²</h1>
            <p class="page-subtitle">æŸ¥çœ‹å·²å®Œæˆçš„å¯©æ ¸è¨˜éŒ„</p>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“œ</div>
                <p>å¯©æ ¸æ­·å²è¨˜éŒ„</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Page -->
        <div id="statistics-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">çµ±è¨ˆå ±è¡¨</h1>
            <p class="page-subtitle">æœ¬å€ç”³è«‹æ¡ˆä»¶çµ±è¨ˆåˆ†æ</p>
          </div>

          <div class="card">
            <div class="card-body">
              <div id="statisticsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>å¯©æ ¸ç”³è«‹æ¡ˆä»¶</h3>
          <button class="close-btn" onclick="closeReviewModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <h4 style="margin-bottom: 16px">ç”³è«‹äººè³‡è¨Š</h4>
          <div id="applicantInfo"></div>

          <h4 style="margin: 24px 0 16px">ç½å®³è³‡è¨Š</h4>
          <div id="disasterInfo"></div>

          <h4 style="margin: 24px 0 16px">è­‰æ˜æ–‡ä»¶</h4>
          <div id="documentsInfo">
            <p style="color: #999; font-size: 14px">è¼‰å…¥ä¸­...</p>
          </div>

          <h4 style="margin: 24px 0 16px">å¯©æ ¸å‹•ä½œ</h4>
          <div class="form-group">
            <label>å¯©æ ¸æ„è¦‹</label>
            <textarea
              id="reviewComments"
              placeholder="è«‹å¡«å¯«å¯©æ ¸æ„è¦‹..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>æ ¸å‡†é‡‘é¡ï¼ˆæ ¸å‡†æ™‚å¿…å¡«ï¼‰</label>
            <input
              type="number"
              id="approvedAmount"
              placeholder="è«‹è¼¸å…¥æ ¸å‡†é‡‘é¡"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            onclick="closeReviewModal()"
            style="background: #f3f4f6; color: #666"
          >
            å–æ¶ˆ
          </button>
          <button class="btn btn-danger" onclick="rejectApplication()">
            âŒ é§å›
          </button>
          <button class="btn btn-success" onclick="approveApplication()">
            âœ… æ ¸å‡†
          </button>
        </div>
      </div>
    </div>

    <!-- è¼‰å…¥é…ç½®ç®¡ç†æ¨¡çµ„ -->
    <script src="/static/js/config.js"></script>
    <script>
      // å…¨åŸŸè®Šæ•¸
      let API_BASE = null; // å°‡ç”±é…ç½®æ¨¡çµ„è¨­å®š
      let accessToken = localStorage.getItem("admin_token");
      let currentUser = JSON.parse(
        localStorage.getItem("admin_user") || "null"
      );
      let currentApplication = null;

      // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
      async function initializeApp() {
        // è¼‰å…¥é…ç½®
        await initializeConfig();
        API_BASE = getApiBase();

        // æª¢æŸ¥ç™»å…¥
        if (!accessToken || !currentUser || currentUser.role !== "reviewer") {
          showLoginPrompt();
        } else {
          showDashboard();
        }
      }

      // é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", initializeApp);

      function showDashboard() {
        document.getElementById("adminName").textContent =
          currentUser.full_name;
        document.getElementById("adminAvatar").textContent =
          currentUser.full_name.charAt(0);
        loadDashboardStats();
        loadPendingApplications();
      }

      function showLoginPrompt() {
        // å‰µå»ºç™»å…¥å°è©±æ¡†ï¼ˆä½¿ç”¨èˆ‡ applicant.html ç›¸åŒçš„æ¨£å¼ï¼‰
        const loginModal = document.createElement("div");
        loginModal.id = "adminLoginModal";
        loginModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #F9F7F4; display: flex; flex-direction: column; z-index: 9999; overflow-y: auto;">
                    <!-- Header -->
                    <header style="background-color: #F9F7F4; padding: 48px 96px; display: flex; justify-content: space-between; align-items: center;">
                        <h1 style="font-size: 36px; font-weight: 700; color: #1E81B2;">ç½å®³è£œåŠ©ç”³è«‹å¹³å°
                        </h1>
                        <nav style="display: flex; gap: 24px; font-size: 20px; font-weight: 500; color: #000;">
                          <a href="/" style="text-decoration: none; color: black; letter-spacing: 0.4px;">è¿”å›é¦–é </a>
                        </nav>
                    </header>

                    <!-- Main Content -->
                    <main style="display: flex; flex-direction: column; align-items: center; padding-top: 80px; flex: 1;">
                        <h2 style="font-size: 30px; font-weight: 700; margin-bottom: 40px; letter-spacing: 0.6px;">å¯©æ ¸äººå“¡ç™»å…¥</h2>

                        <div style="width: 612px; border-radius: 16px; overflow: hidden; margin-bottom: 48px;">
                            <!-- Tabs -->
                            <div style="display: flex;">
                                <div class="admin-login-tab" data-tab="general" style="flex: 1; padding: 24px; text-align: center; font-size: 16px; font-weight: 600; letter-spacing: -0.4px; cursor: pointer; background-color: #E4F1FA; color: #1E81B2;">
                                    <span style="margin-right: 8px">ğŸ“§</span>ä¸€èˆ¬ç™»å…¥
                                </div>
                                <div class="admin-login-tab active" data-tab="digital" style="flex: 1; padding: 24px; text-align: center; font-size: 16px; font-weight: 600; letter-spacing: -0.4px; cursor: pointer; background-color: #1E81B2; color: #F4F7F7;">
                                    ğŸ“± æ•¸ä½èº«åˆ†è­‰æ†‘è­‰ç™»å…¥ (æ¨è–¦)
                                </div>
                            </div>

                            <!-- General Login Form -->
                            <div id="adminGeneralLoginForm" style="background-color: #FFFFFF; padding: 48px; display: none; flex-direction: column; gap: 24px;">
                                <div style="display: flex; flex-direction: column; gap: 4px; width: 100%; margin-bottom: 20px;">
                                    <label style="font-size: 16px; color: #020618; letter-spacing: 0.64px; display: block; font-weight: 500; margin-bottom: 8px;">é›»å­ä¿¡ç®±</label>
                                    <input type="email" id="adminEmail" name="email" placeholder="è¼¸å…¥ä¿¡ç®±å¸³è™Ÿ" required style="padding: 8px 12px; height: 40px; border: 1px solid #E2E8F0; border-radius: 6px; background: #fff; font-size: 14px; color: #62748E; width: 100%;" />
                                </div>

                                <div style="display: flex; flex-direction: column; gap: 4px; width: 100%; margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; gap: 12px">
                                        <label style="font-size: 16px; color: #020618; letter-spacing: 0.64px; display: block; font-weight: 500; margin-bottom: 0;">é©—è­‰ç¢¼</label>
                                        <small style="color: #666; margin: 0; display: inline; font-size: 12px;">é©—è­‰ç¢¼å°‡ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±</small>
                                    </div>
                                    <div style="position: relative; width: 100%;">
                                        <input type="password" id="adminPassword" name="password" placeholder="è¼¸å…¥é©—è­‰ç¢¼" required style="width: 100%; padding: 8px 110px 8px 12px; height: 40px; border: 1px solid #E2E8F0; border-radius: 6px; background: #fff; font-size: 14px; color: #62748E;" />
                                        <button type="button" class="admin-verification-send-btn" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); height: calc(100% - 4px); margin: 0; border-radius: 4px; padding: 8px 16px; background: #1E81B2; color: white; border: none; font-size: 14px; letter-spacing: 0.64px; cursor: pointer; white-space: nowrap; transition: background-color 0.3s;">
                                            ç™¼é€é©—è­‰ç¢¼
                                        </button>
                                        <style>
                                            .admin-verification-send-btn:disabled {
                                                background: #94A3B8 !important;
                                                cursor: not-allowed !important;
                                            }
                                        </style>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 24px; align-items: center; width: 100%;">
                                    <div style="background: #F8FAFC; padding: 8px 12px; border-radius: 8px; font-size: 20px; color: #334155; letter-spacing: 0.4px; line-height: 28px;" class="admin-verification-code">10541</div>
                                    <button type="button" class="admin-refresh-captcha" style="background: transparent; border: none; box-shadow: none; padding: 0; cursor: pointer;">
                                        <img src="static/assets/refresh.png" alt="æ›´æ–°é©—è­‰ç¢¼" width="24" height="24" />
                                    </button>
                                    <input type="text" class="admin-verification-input" placeholder="è«‹è¼¸å…¥å·¦æ–¹åœ–ç‰‡ä¸­çš„æ–‡å­—" required style="flex: 1; padding: 8px 12px; height: 40px; border: 1px solid #E2E8F0; border-radius: 8px; background: #fff; font-size: 14px; color: #62748E;" />
                                </div>

                                <button type="submit" class="admin-login-btn" style="width: 100%; padding: 8px 16px; background: #1E81B2; color: #F4F7F7; border: none; border-radius: 8px; font-size: 16px; letter-spacing: 0.64px; cursor: pointer;">ç™»å…¥</button>

                                <div style="display: flex; align-items: center; gap: 8px; width: 100%; margin: 8px 0;">
                                    <div style="flex: 1; height: 2px; background: #C9D5D8; border-radius: 999px;"></div>
                                    <span style="color: #779299; font-size: 14px; letter-spacing: 0.56px;">æˆ–</span>
                                    <div style="flex: 1; height: 2px; background: #C9D5D8; border-radius: 999px;"></div>
                                </div>

                                <button type="button" class="admin-google-btn" style="width: 100%; padding: 8px 16px; background: white; color: #0F172A; border: none; border-radius: 8px; font-size: 16px; letter-spacing: 0.64px; cursor: pointer;">
                                <!-- Google SVG Icon -->
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  x="0px"
                                  y="0px"
                                  width="30"
                                  height="30"
                                  viewBox="0 0 48 48"
                                  style="vertical-align: middle; position: relative; top: -0.5px"
                                >
                                  <path
                                    fill="#FFC107"
                                    d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                                  ></path>
                                  <path
                                    fill="#FF3D00"
                                    d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
                                  ></path>
                                  <path
                                    fill="#4CAF50"
                                    d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
                                  ></path>
                                  <path
                                    fill="#1976D2"
                                    d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                                  ></path>
                                </svg>
                                Google å¸³è™Ÿç™»å…¥</button>
                            </div>

                            <!-- Digital Login Form -->
                            <div id="adminDigitalLoginForm" style="background-color: #FFFFFF; padding: 48px; display: flex; flex-direction: column; gap: 24px;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                    <div style="font-weight: 700; font-size: 24px; line-height: 32px; text-align: center; letter-spacing: 0.48px; color: #020618;">æ•¸ä½æ†‘è­‰çš®å¤¾APP</div>
                                    <div style="font-weight: 400; font-size: 16px; line-height: 24px; text-align: center; letter-spacing: 0.64px; color: #020618;">æ•¸ä½èº«åˆ†æ†‘è­‰ç™»å…¥æ–¹å¼</div>
                                </div>

                                <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                                    <img id="adminQrImage" src="" style="width: 188px; height: 188px; border-radius: 8px; border: 1px solid #E2E8F0;">
                                    <div style="display: flex; align-items: center; gap: 4px; color: #64748B; font-size: 14px;">
                                        <span>è«‹æ–¼ </span>
                                        <span id="adminQrCountdown" style="color: #0F172A; font-weight: 500;">5:00</span>
                                        <span> å…§å®Œæˆæƒæ</span>
                                    </div>
                                </div>

                                <p style="font-weight: 400; font-size: 12px; line-height: 20px; text-align: center; letter-spacing: 0.48px; color: #779299; margin-bottom: 24px;">ä½¿ç”¨æ•¸ä½æ†‘è­‰çš®å¤¾APPæƒç¢¼ç™»å…¥</p>

                                <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
                                    <div style="flex: 1; height: 2px; background: #C9D5D8; border-radius: 999px;"></div>
                                </div>

                                <a href="https://moda.gov.tw/major-policies/wallet/1695" target="_blank" style="font-weight: 400; font-size: 16px; line-height: 24px; text-align: center; text-decoration-line: underline; color: #000000; letter-spacing: 0.64px; margin: 24px 0; display: block;">é—œæ–¼æ•¸ä½èº«åˆ†è­‰æ†‘è­‰èªªæ˜</a>

                                <p style="font-family: 'Noto Sans TC', sans-serif; font-weight: 400; font-size: 16px; line-height: 24px; text-align: center; letter-spacing: 0.64px; color: #000000;">
                                    é‚„æ²’æœ‰æ•¸ä½èº«åˆ†æ†‘è­‰å—ï¼Ÿ <a target="_blank" href="https://wallet.gov.tw/zh-twr" style="text-decoration-line: underline; color: inherit;">é»æˆ‘ç«‹å³ç”³è«‹</a>
                                </p>
                            </div>
                        </div>
                    </main>
                </div>
            `;
        document.body.appendChild(loginModal);

        // Tab åˆ‡æ›åŠŸèƒ½
        const tabs = loginModal.querySelectorAll(".admin-login-tab");
        const digitalForm = document.getElementById("adminDigitalLoginForm");
        const generalForm = document.getElementById("adminGeneralLoginForm");

        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabType = this.getAttribute("data-tab");

            // æ›´æ–° tab æ¨£å¼
            tabs.forEach((t) => {
              if (t.getAttribute("data-tab") === tabType) {
                t.style.backgroundColor = "#1E81B2";
                t.style.color = "#F4F7F7";
                t.classList.add("active");
              } else {
                t.style.backgroundColor = "#E4F1FA";
                t.style.color = "#1E81B2";
                t.classList.remove("active");
              }
            });

            // åˆ‡æ›è¡¨å–®
            if (tabType === "digital") {
              digitalForm.style.display = "flex";
              generalForm.style.display = "none";
              // å•Ÿå‹•æ•¸ä½ç™»å…¥æµç¨‹
              adminLoginWithDigitalID();
            } else {
              digitalForm.style.display = "none";
              generalForm.style.display = "flex";
              // åœæ­¢æ•¸ä½ç™»å…¥çš„è¼ªè©¢å’Œå€’æ•¸è¨ˆæ™‚
              if (window.digitalLoginPollingInterval) {
                clearInterval(window.digitalLoginPollingInterval);
              }
              if (window.digitalLoginCountdownInterval) {
                clearInterval(window.digitalLoginCountdownInterval);
              }
            }
          });
        });

        // é è¨­å•Ÿå‹•æ•¸ä½ç™»å…¥
        adminLoginWithDigitalID();

        // ============================================
        // Email é©—è­‰ç™»å…¥äº‹ä»¶è™•ç†å™¨
        // ============================================
        let adminVerificationCode = "";

        // Email é©—è­‰ç¢¼ç™¼é€æŒ‰éˆ•
        const adminVerificationBtn = loginModal.querySelector(
          ".admin-verification-send-btn"
        );
        let adminTimeLeft = 180;
        let adminCountdownTimer = null;

        function adminStartCountdown() {
          if (!adminVerificationBtn) return;
          adminVerificationBtn.disabled = true;
          adminTimeLeft = 180;

          function updateButtonText() {
            const minutes = Math.floor(adminTimeLeft / 60);
            const seconds = adminTimeLeft % 60;
            adminVerificationBtn.textContent = `é‡æ–°ç™¼é€ (${minutes}:${seconds
              .toString()
              .padStart(2, "0")})`;

            if (adminTimeLeft <= 0) {
              clearInterval(adminCountdownTimer);
              adminVerificationBtn.disabled = false;
              adminVerificationBtn.textContent = "ç™¼é€é©—è­‰ç¢¼";
              return;
            }
            adminTimeLeft--;
          }

          updateButtonText();
          adminCountdownTimer = setInterval(updateButtonText, 1000);
        }

        if (adminVerificationBtn) {
          adminVerificationBtn.addEventListener("click", async function () {
            const email = document.getElementById("adminEmail").value;

            if (!email) {
              alert("è«‹è¼¸å…¥ Email");
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/email/auth", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  is_verified: false,
                }),
              });

              if (response.ok) {
                const data = await response.json();
                adminStartCountdown();
                if (data.verification_code) {
                  adminVerificationCode = data.verification_code;
                  console.log("é©—è­‰ç¢¼(é–‹ç™¼ç”¨):", data.verification_code);
                  alert(
                    "âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼\n\n(é–‹ç™¼ç’°å¢ƒï¼šé©—è­‰ç¢¼å·²è¼¸å‡ºåˆ°Console)"
                  );
                } else {
                  alert("âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„Emailï¼Œè«‹æŸ¥æ”¶ï¼");
                }
              } else {
                const error = await response.json();
                alert("ç™¼é€å¤±æ•—ï¼š" + (error.detail || "è«‹ç¨å¾Œå†è©¦"));
              }
            } catch (error) {
              console.error("ç™¼é€é©—è­‰ç¢¼éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // ç™»å…¥æŒ‰éˆ•
        const adminLoginBtn = loginModal.querySelector(".admin-login-btn");
        if (adminLoginBtn) {
          adminLoginBtn.addEventListener("click", async function () {
            const email = document.getElementById("adminEmail").value;
            const verificationCode =
              document.getElementById("adminPassword").value;
            const captchaInputEl = loginModal.querySelector(
              ".admin-verification-input"
            );
            const captchaInput = captchaInputEl ? captchaInputEl.value : "";
            const captchaTextEl = loginModal.querySelector(
              ".admin-verification-code"
            );
            const captchaText = captchaTextEl ? captchaTextEl.textContent : "";

            if (!email) {
              alert("è«‹å¡«å¯«email");
              return;
            } else if (!verificationCode) {
              alert("è«‹å¡«å¯«é©—è­‰ç¢¼");
              return;
            } else if (!captchaInput) {
              alert("è«‹å¡«å¯«åœ–å½¢é©—è­‰ç¢¼");
              return;
            }

            if (verificationCode.length !== 6) {
              alert("é©—è­‰ç¢¼å¿…é ˆæ˜¯ 6 ä½æ•¸å­—");
              return;
            }

            if (verificationCode !== adminVerificationCode) {
              alert("é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            if (captchaInput !== captchaText) {
              alert("åœ–å½¢é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥");
              return;
            }

            try {
              const response = await fetch("/api/v1/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: email,
                  login_type: "password",
                  verification_code: verificationCode,
                  verify: true,
                }),
              });

              if (response.ok) {
                const data = await response.json();

                // æª¢æŸ¥æ¬Šé™
                if (
                  data.user.role !== "reviewer" &&
                  data.user.role !== "admin"
                ) {
                  alert("âŒ æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†æ¬Šé™");
                  return;
                }

                accessToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem("admin_token", accessToken);
                localStorage.setItem("admin_user", JSON.stringify(currentUser));

                // ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢
                location.reload();
              } else {
                const error = await response.json();
                alert(
                  "ç™»å…¥å¤±æ•—ï¼š" +
                    (error.detail?.message || error.detail || "è«‹ç¨å¾Œå†è©¦")
                );
              }
            } catch (error) {
              console.error("ç™»å…¥éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });
        }

        // Google ç™»å…¥æŒ‰éˆ•
        const adminGoogleBtn = loginModal.querySelector(".admin-google-btn");
        if (adminGoogleBtn) {
          adminGoogleBtn.addEventListener("click", function () {
            window.location.href = "/api/v1/auth/google/login";
          });
        }

        // åˆ·æ–°åœ–å½¢é©—è­‰ç¢¼
        const adminRefreshCaptchaBtn = loginModal.querySelector(
          ".admin-refresh-captcha"
        );
        function adminGenerateCaptcha() {
          const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          let captcha = "";
          for (let i = 0; i < 5; i++) {
            captcha += chars[Math.floor(Math.random() * chars.length)];
          }
          const captchaEl = loginModal.querySelector(
            ".admin-verification-code"
          );
          if (captchaEl) captchaEl.textContent = captcha;
        }

        if (adminRefreshCaptchaBtn)
          adminRefreshCaptchaBtn.addEventListener(
            "click",
            adminGenerateCaptcha
          );
        adminGenerateCaptcha();

        // ============================================
        // æ•¸ä½èº«åˆ†æ†‘è­‰ç™»å…¥å‡½æ•¸
        // ============================================
        async function adminLoginWithDigitalID() {
          const vpRef = "00000000_mixcurry_idcard";
          let transactionId = null;
          let remainingSeconds = 300;
          // ä½¿ç”¨ window ç‰©ä»¶ä¾†å­˜å„²è¨ˆæ™‚å™¨ï¼Œä»¥ä¾¿åœ¨å…¶ä»–åœ°æ–¹å¯ä»¥å­˜å–
          window.digitalLoginPollingInterval = null;
          window.digitalLoginCountdownInterval = null;

          const qrImg = document.getElementById("adminQrImage");
          const countdownEl = document.getElementById("adminQrCountdown");

          function updateCountdownDisplay() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            if (countdownEl)
              countdownEl.textContent = `${minutes}:${seconds
                .toString()
                .padStart(2, "0")}`;
          }

          updateCountdownDisplay();
          window.digitalLoginCountdownInterval = setInterval(() => {
            remainingSeconds--;
            if (remainingSeconds <= 0) {
              if (window.digitalLoginPollingInterval)
                clearInterval(window.digitalLoginPollingInterval);
              if (window.digitalLoginCountdownInterval)
                clearInterval(window.digitalLoginCountdownInterval);
              updateCountdownDisplay();
              alert("é©—è­‰é€¾æ™‚ï¼Œè«‹é‡æ–°å˜—è©¦ç™»å…¥");
              return;
            }
            updateCountdownDisplay();
          }, 1000);

          try {
            const result = await fetch(
              `/api/v1/complete-flow/generate-vp-qrcode`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ref: vpRef }),
              }
            );

            const data = await result.json();
            console.log("æ•¸ä½èº«åˆ†é©—è­‰å›æ‡‰:", data);

            if (!data || !data.success) {
              console.warn("generate-vp-qrcode failed or returned no success");
              return;
            }

            if (qrImg && data.qrcode_image) qrImg.src = data.qrcode_image;
            transactionId = data.transaction_id;

            if (transactionId) {
              window.digitalLoginPollingInterval = setInterval(async () => {
                try {
                  const pollResult = await fetch(
                    `/api/v1/complete-flow/verify-vp`,
                    {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ transaction_id: transactionId }),
                    }
                  );
                  const pollData = await pollResult.json();

                  if (pollData && pollData.verified) {
                    console.log("é©—è­‰æˆåŠŸï¼Œä½¿ç”¨è€…è³‡æ–™ï¼š", pollData);
                    if (window.digitalLoginPollingInterval)
                      clearInterval(window.digitalLoginPollingInterval);
                    if (window.digitalLoginCountdownInterval)
                      clearInterval(window.digitalLoginCountdownInterval);
                    try {
                      const loginResponse = await fetch("/api/v1/auth/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                          email: pollData.email,
                          password: "",
                          login_type: "password",
                        }),
                      });

                      if (loginResponse.ok) {
                        const loginData = await loginResponse.json();

                        // æª¢æŸ¥æ¬Šé™
                        if (
                          loginData.user.role !== "reviewer" &&
                          loginData.user.role !== "admin"
                        ) {
                          alert("âŒ æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†æ¬Šé™");
                          return;
                        }

                        accessToken = loginData.access_token;
                        currentUser = loginData.user;
                        localStorage.setItem("admin_token", accessToken);
                        localStorage.setItem(
                          "admin_user",
                          JSON.stringify(currentUser)
                        );
                        location.reload();
                      } else {
                        const error = await loginResponse.json();
                        alert(
                          "ç™»å…¥å¤±æ•—ï¼š" +
                            (error.detail?.message ||
                              error.detail ||
                              "è«‹ç¨å¾Œå†è©¦")
                        );
                      }
                    } catch (error) {
                      console.error("Digital ID login error:", error);
                      alert("ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
                    }
                  }
                } catch (err) {
                  console.error("Polling error:", err);
                }
              }, 2000);
            }
          } catch (error) {
            console.error("æ•¸ä½èº«åˆ†é©—è­‰éŒ¯èª¤:", error);
          }
        }
      }

      function initDashboard() {
        document.getElementById("adminName").textContent =
          currentUser.full_name;
        document.getElementById("adminAvatar").textContent =
          currentUser.full_name.charAt(0);
        loadDashboardStats();
        loadPendingApplications();
      }

      function showPage(page) {
        [
          "dashboard-page",
          "applications-page",
          "map-page",
          "history-page",
          "statistics-page",
        ].forEach((id) => {
          document.getElementById(id).classList.add("hidden");
        });
        document.getElementById(`${page}-page`).classList.remove("hidden");

        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        event.target.classList.add("active");

        if (page === "statistics") {
          loadStatistics();
        } else if (page === "map") {
          // åˆå§‹åŒ–åœ°åœ–ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
          if (!map) {
            setTimeout(() => {
              initializeMap();
            }, 100);
          }
        }
      }

      async function loadDashboardStats() {
        const result = await fetch(`${API_BASE}/applications/status/pending`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        if (result.ok) {
          const response = await result.json();

          // è™•ç†ä¸åŒçš„å›æ‡‰æ ¼å¼
          let apps = [];
          if (Array.isArray(response)) {
            apps = response;
          } else if (response.data) {
            // è™•ç†åµŒå¥—çµæ§‹: {data: {applications: [...]}}
            if (
              response.data.applications &&
              Array.isArray(response.data.applications)
            ) {
              apps = response.data.applications;
            } else if (Array.isArray(response.data)) {
              apps = response.data;
            } else {
              apps = [response.data];
            }
          } else if (response.applications) {
            apps = Array.isArray(response.applications)
              ? response.applications
              : [response.applications];
          }

          document.getElementById("statPending").textContent = apps.length;

          // ç°¡å–®çµ±è¨ˆ
          let totalAmount = 0;
          apps.forEach((app) => {
            totalAmount += app.requested_amount || 0;
          });
          document.getElementById("statTotal").textContent = `$${(
            totalAmount / 10000
          ).toFixed(1)}è¬`;
        }
      }

      async function loadPendingApplications() {
        const result = await fetch(`${API_BASE}/applications/status/pending`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        if (result.ok) {
          const response = await result.json();
          console.log("API Response:", response); // é™¤éŒ¯ç”¨

          // è™•ç†ä¸åŒçš„å›æ‡‰æ ¼å¼
          let apps = [];
          if (Array.isArray(response)) {
            apps = response;
          } else if (response.data) {
            // è™•ç†åµŒå¥—çµæ§‹: {data: {applications: [...]}}
            if (
              response.data.applications &&
              Array.isArray(response.data.applications)
            ) {
              apps = response.data.applications;
            } else if (Array.isArray(response.data)) {
              apps = response.data;
            } else {
              apps = [response.data];
            }
          } else if (response.applications) {
            apps = Array.isArray(response.applications)
              ? response.applications
              : [response.applications];
          }

          console.log("Parsed apps:", apps); // é™¤éŒ¯ç”¨
          displayApplications(apps, "recentApplications");
          displayApplications(apps, "applicationsList");
        }
      }

      function displayApplications(apps, containerId) {
        const container = document.getElementById(containerId);

        if (apps.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸æ¡ˆä»¶</p></div>';
          return;
        }

        const html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ¡ˆä»¶ç·¨è™Ÿ</th>
                            <th>ç”³è«‹äºº</th>
                            <th>ç½å®³é¡å‹</th>
                            <th>ç”³è«‹é‡‘é¡</th>
                            <th>æäº¤æ™‚é–“</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${apps
                          .map(
                            (app) => `
                            <tr>
                                <td><strong>${app.case_no}</strong></td>
                                <td>${app.applicant_name}</td>
                                <td>${getDisasterTypeText(
                                  app.disaster_type
                                )}</td>
                                <td>NT$ ${app.requested_amount?.toLocaleString()}</td>
                                <td>${new Date(
                                  app.submitted_at
                                ).toLocaleDateString()}</td>
                                <td><span class="badge ${
                                  app.status
                                }">${getStatusText(app.status)}</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick='openReviewModal(${JSON.stringify(
                                      app
                                    )})'>
                                        å¯©æ ¸
                                    </button>
                                </td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = html;
      }

      async function openReviewModal(app) {
        currentApplication = app;

        document.getElementById("applicantInfo").innerHTML = `
                <div class="info-row">
                    <div class="info-label">å§“å</div>
                    <div class="info-value">${app.applicant_name}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">é›»è©±</div>
                    <div class="info-value">${app.phone}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">è¯çµ¡åœ°å€</div>
                    <div class="info-value">${app.address || "æœªæä¾›"}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç½æåœ°é»</div>
                    <div class="info-value">${
                      app.damage_location || "æœªæä¾›"
                    }</div>
                </div>
            `;

        document.getElementById("disasterInfo").innerHTML = `
                <div class="info-row">
                    <div class="info-label">ç½å®³æ—¥æœŸ</div>
                    <div class="info-value">${app.disaster_date}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç½å®³é¡å‹</div>
                    <div class="info-value">${getDisasterTypeText(
                      app.disaster_type
                    )}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç½ææè¿°</div>
                    <div class="info-value">${app.damage_description}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç”³è«‹é‡‘é¡</div>
                    <div class="info-value">NT$ ${app.requested_amount?.toLocaleString()}</div>
                </div>
            `;

        document.getElementById("approvedAmount").value = app.requested_amount;

        // è¼‰å…¥è­‰æ˜æ–‡ä»¶
        await loadApplicationDocuments(app.id);

        document.getElementById("reviewModal").classList.add("show");
      }

      function closeReviewModal() {
        document.getElementById("reviewModal").classList.remove("show");
        currentApplication = null;
      }

      async function approveApplication() {
        const amount = document.getElementById("approvedAmount").value;
        const comments = document.getElementById("reviewComments").value;

        if (!amount) {
          alert("è«‹è¼¸å…¥æ ¸å‡†é‡‘é¡");
          return;
        }

        // ä½¿ç”¨æ–°çš„å®Œæ•´æµç¨‹ APIï¼ˆæ•´åˆæ”¿åºœç™¼è¡Œç«¯ï¼‰
        try {
          const result = await fetch(`/api/v1/complete-flow/review-and-issue`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              application_id: currentApplication.id,
              approved: true,
              review_notes: comments,
              approved_amount: amount,
            }),
          });

          const data = await result.json();
          console.log("å¯©æ ¸å›æ‡‰æ•¸æ“š:", data); // èª¿è©¦ç”¨
          console.log("data.qr_code å­˜åœ¨?", !!data.qr_code);
          console.log("data.qr_code é¡å‹:", typeof data.qr_code);
          console.log("data æ‰€æœ‰éµ:", Object.keys(data));

          if (data.success) {
            // æ ¸å‡†æˆåŠŸï¼ŒQR Code å·²å„²å­˜è‡³ç”³è«‹äººçš„ç”³è«‹è¨˜éŒ„ä¸­
            alert(
              "âœ… æ ¸å‡†æˆåŠŸï¼\n\n" +
                "æ•¸ä½æ†‘è­‰å·²ç”¢ç”Ÿä¸¦ç™¼é€çµ¦ç½æ°‘ã€‚\n" +
                "ç½æ°‘å¯åœ¨ã€ŒæŸ¥è©¢ç”³è«‹æ­·å²ç´€éŒ„ã€ä¸­æŸ¥çœ‹ QR Code ä¸¦æƒæé ˜å–è£œåŠ©ã€‚\n\n" +
                `æ¡ˆä»¶ç·¨è™Ÿï¼š${currentApplication.case_no}`
            );

            closeReviewModal();
            loadDashboardStats();
            loadPendingApplications();
          } else {
            alert(`æ“ä½œå¤±æ•—ï¼š${data.message || "è«‹ç¨å¾Œå†è©¦"}`);
          }
        } catch (error) {
          console.error("å¯©æ ¸éŒ¯èª¤:", error);
          alert(`ç³»çµ±éŒ¯èª¤ï¼š${error.message}`);
        }
      }

      async function rejectApplication() {
        const comments = document.getElementById("reviewComments").value;
        const amount = 0;

        if (!comments) {
          alert("è«‹å¡«å¯«é§å›åŸå› ");
          return;
        }

        try {
          const result = await fetch(`/api/v1/complete-flow/review-and-issue`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              application_id: currentApplication.id,
              approved: false,
              review_notes: comments,
              approved_amount: amount,
            }),
          });

          const data = await result.json();
          console.log("é§å›å›æ‡‰æ•¸æ“š:", data); // èª¿è©¦ç”¨
          console.log("data.qr_code å­˜åœ¨?", !!data.qr_code);
          console.log("data.qr_code é¡å‹:", typeof data.qr_code);
          console.log("data æ‰€æœ‰éµ:", Object.keys(data));

          if (data.success) {
            // é§å›æˆåŠŸï¼ŒQR Code å·²å„²å­˜è‡³ç”³è«‹äººçš„ç”³è«‹è¨˜éŒ„ä¸­
            alert(
              "âœ… é§å›æˆåŠŸï¼\n\n" +
                "é§å›åŸå› å·²ç™¼é€çµ¦ç”³è«‹äººã€‚\n" +
                "ç”³è«‹äººå¯åœ¨ã€ŒæŸ¥è©¢ç”³è«‹æ­·å²ç´€éŒ„ã€ä¸­æŸ¥çœ‹é§å›åŸå› ã€‚\n\n" +
                `æ¡ˆä»¶ç·¨è™Ÿï¼š${currentApplication.case_no}`
            );

            closeReviewModal();
            loadDashboardStats();
            loadPendingApplications();
          } else {
            alert(`æ“ä½œå¤±æ•—ï¼š${data.message || "è«‹ç¨å¾Œå†è©¦"}`);
          }
        } catch (error) {
          console.error("å¯©æ ¸éŒ¯èª¤:", error);
          alert(`ç³»çµ±éŒ¯èª¤ï¼š${error.message}`);
        }
      }

      function loadStatistics() {
        document.getElementById("statisticsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <p>çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            `;
      }

      function logout() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          localStorage.removeItem("admin_token");
          localStorage.removeItem("admin_user");
          location.reload();
        }
      }

      function getStatusText(status) {
        const map = {
          pending: "å¾…å¯©æ ¸",
          under_review: "å¯©æ ¸ä¸­",
          approved: "å·²æ ¸å‡†",
          rejected: "å·²é§å›",
        };
        return map[status] || status;
      }

      function getDisasterTypeText(type) {
        const map = {
          flood: "æ°´ç½",
          typhoon: "é¢±é¢¨",
          earthquake: "åœ°éœ‡",
          other: "å…¶ä»–",
        };
        return map[type] || type;
      }

      // ============================================
      // Google Maps åŠŸèƒ½
      // ============================================
      let map = null;
      let markers = [];
      let selectedApplications = [];
      let allMapApplications = [];
      let directionsService = null;
      let directionsRenderers = [];

      // åˆå§‹åŒ–åœ°åœ–
      function initializeMap() {
        // é è¨­ä¸­å¿ƒé»ï¼ˆå°å—å¸‚æ”¿åºœï¼‰
        const defaultCenter = { lat: 22.9917, lng: 120.2009 };

        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultCenter,
          zoom: 13,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
        });

        directionsService = new google.maps.DirectionsService();

        console.log("åœ°åœ–åˆå§‹åŒ–å®Œæˆ");
      }

      // è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨ï¼ˆç”¨æ–¼åœ°åœ–é¸æ“‡ï¼‰
      async function loadMapApplications() {
        try {
          // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰ district_id
          if (!currentUser.district_id) {
            console.warn("ä½¿ç”¨è€…æ²’æœ‰ district_idï¼Œç„¡æ³•è¼‰å…¥æ¡ˆä»¶");
            document.getElementById("mapApplicationsList").innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <p style="color: #ff9800; margin-bottom: 10px;">âš ï¸ æ‚¨çš„å¸³è™Ÿå°šæœªè¨­å®šç®¡è½„å€åŸŸ</p>
                            <p style="color: #999; font-size: 14px;">è«‹è¯ç¹«ç®¡ç†å“¡è¨­å®šæ‚¨çš„ç®¡è½„å€åŸŸ</p>
                        </div>
                    `;
            return;
          }

          const response = await fetch(
            `${API_BASE}/applications/district/${currentUser.district_id}`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          if (response.ok) {
            const data = await response.json();
            allMapApplications = data.data?.applications || data.data || [];
            displayMapApplicationsList();
          } else {
            alert("è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨å¤±æ•—");
          }
        } catch (error) {
          console.error("Error loading map applications:", error);
          alert("è¼‰å…¥å¤±æ•—ï¼š" + error.message);
        }
      }

      // é¡¯ç¤ºæ¡ˆä»¶åˆ—è¡¨ï¼ˆå‹¾é¸æ¡†ï¼‰
      function displayMapApplicationsList() {
        const container = document.getElementById("mapApplicationsList");

        if (allMapApplications.length === 0) {
          container.innerHTML = `
                    <p style="color: #999; text-align: center; padding: 20px;">
                        ç›®å‰æ²’æœ‰å¯ç”¨çš„æ¡ˆä»¶
                    </p>
                `;
          return;
        }

        container.innerHTML = allMapApplications
          .map(
            (app) => `
                <div class="application-item-checkbox" onclick="toggleApplicationSelection('${
                  app.id
                }')">
                    <input type="checkbox" 
                           id="app_${app.id}" 
                           value="${app.id}"
                           ${
                             selectedApplications.includes(app.id)
                               ? "checked"
                               : ""
                           }
                           onclick="event.stopPropagation()">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 5px;">
                            ${app.case_no} - ${app.applicant_name}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            ğŸ“ ${
                              app.damage_location || app.address || "åœ°å€æœªæä¾›"
                            }
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 3px;">
                            ${getDisasterTypeText(app.disaster_type)} | 
                            ç”³è«‹é‡‘é¡: NT$ ${app.requested_amount?.toLocaleString()}
                        </div>
                    </div>
                    <span class="badge ${app.status}">${getStatusText(
              app.status
            )}</span>
                </div>
            `
          )
          .join("");

        updateSelectedCount();
      }

      // åˆ‡æ›æ¡ˆä»¶é¸æ“‡ç‹€æ…‹
      function toggleApplicationSelection(appId) {
        const checkbox = document.getElementById(`app_${appId}`);
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
          if (!selectedApplications.includes(appId)) {
            selectedApplications.push(appId);
          }
        } else {
          selectedApplications = selectedApplications.filter(
            (id) => id !== appId
          );
        }

        updateSelectedCount();
      }

      // æ›´æ–°é¸æ“‡æ•¸é‡
      function updateSelectedCount() {
        document.getElementById("selectedCount").textContent =
          selectedApplications.length;
      }

      // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºé¸ä¸­çš„æ¡ˆä»¶
      async function showSelectedOnMap() {
        if (selectedApplications.length === 0) {
          alert("è«‹å…ˆé¸æ“‡è¦æŸ¥çœ‹çš„æ¡ˆä»¶");
          return;
        }

        // åˆå§‹åŒ–åœ°åœ–ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
        if (!map) {
          initializeMap();
        }

        // æ¸…é™¤èˆŠçš„æ¨™è¨˜
        clearMarkers();

        try {
          // å–å¾—æ¡ˆä»¶çš„åœ°ç†ä½ç½®è³‡è¨Š
          const response = await fetch(
            `${API_BASE}/maps/applications-map-data`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({
                application_ids: selectedApplications,
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            const applications = data.applications;

            if (applications.length === 0) {
              alert("æ²’æœ‰å¯é¡¯ç¤ºçš„æ¡ˆä»¶ä½ç½®");
              return;
            }

            // å»ºç«‹åœ°åœ–é‚Šç•Œ
            const bounds = new google.maps.LatLngBounds();

            // ç‚ºæ¯å€‹æ¡ˆä»¶å»ºç«‹æ¨™è¨˜
            applications.forEach((app, index) => {
              if (app.latitude && app.longitude) {
                const position = {
                  lat: parseFloat(app.latitude),
                  lng: parseFloat(app.longitude),
                };

                // å»ºç«‹æ¨™è¨˜
                const marker = new google.maps.Marker({
                  position: position,
                  map: map,
                  title: app.case_no,
                  label: {
                    text: (index + 1).toString(),
                    color: "white",
                  },
                  animation: google.maps.Animation.DROP,
                });

                // å»ºç«‹è³‡è¨Šè¦–çª—
                const infoWindow = new google.maps.InfoWindow({
                  content: `
                                    <div style="padding: 10px; min-width: 200px;">
                                        <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">
                                            ${app.case_no}
                                        </h3>
                                        <p style="margin: 5px 0;"><strong>ç”³è«‹äºº:</strong> ${
                                          app.applicant_name
                                        }</p>
                                        <p style="margin: 5px 0;"><strong>ç½æåœ°é»:</strong> ${
                                          app.damage_location ||
                                          app.address ||
                                          "æœªæä¾›"
                                        }</p>
                                        <p style="margin: 5px 0;"><strong>ç½å®³é¡å‹:</strong> ${getDisasterTypeText(
                                          app.disaster_type
                                        )}</p>
                                        <p style="margin: 5px 0;"><strong>ç”³è«‹é‡‘é¡:</strong> NT$ ${app.requested_amount?.toLocaleString()}</p>
                                        <p style="margin: 5px 0;">
                                            <span class="badge ${
                                              app.status
                                            }">${getStatusText(
                    app.status
                  )}</span>
                                        </p>
                                    </div>
                                `,
                });

                // é»æ“Šæ¨™è¨˜æ™‚é¡¯ç¤ºè³‡è¨Š
                marker.addListener("click", () => {
                  // é—œé–‰æ‰€æœ‰å…¶ä»–è³‡è¨Šè¦–çª—
                  markers.forEach((m) => {
                    if (m.infoWindow) {
                      m.infoWindow.close();
                    }
                  });

                  infoWindow.open(map, marker);
                });

                marker.infoWindow = infoWindow;
                markers.push(marker);
                bounds.extend(position);
              }
            });

            // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
            map.fitBounds(bounds);

            alert(`âœ… å·²åœ¨åœ°åœ–ä¸Šæ¨™ç¤º ${applications.length} å€‹æ¡ˆä»¶ä½ç½®`);
          } else {
            alert("å–å¾—ä½ç½®è³‡è¨Šå¤±æ•—");
          }
        } catch (error) {
          console.error("Error showing on map:", error);
          alert("é¡¯ç¤ºå¤±æ•—ï¼š" + error.message);
        }
      }

      // æ¸…é™¤åœ°åœ–æ¨™è¨˜
      function clearMarkers() {
        markers.forEach((marker) => marker.setMap(null));
        markers = [];
      }

      // æ¸…é™¤è·¯ç·šæ¸²æŸ“
      function clearDirectionsRenderers() {
        directionsRenderers.forEach((renderer) => renderer.setMap(null));
        directionsRenderers = [];
      }

      // è¦åŠƒæœ€ä½³è·¯ç·š
      async function planRoutes() {
        console.log("ğŸš€ é–‹å§‹è¦åŠƒè·¯ç·š...");
        console.log("ğŸ“Š ç•¶å‰ç‹€æ…‹:", {
          selectedApplications: selectedApplications,
          selectedCount: selectedApplications.length,
          allMapApplications: allMapApplications,
          allMapCount: allMapApplications.length,
        });

        if (selectedApplications.length < 2) {
          alert("è«‹è‡³å°‘é¸æ“‡ 2 å€‹æ¡ˆä»¶æ‰èƒ½è¦åŠƒè·¯ç·š");
          return;
        }

        if (selectedApplications.length > 10) {
          alert("ä¸€æ¬¡æœ€å¤šåªèƒ½è¦åŠƒ 10 å€‹åœ°é»çš„è·¯ç·š");
          return;
        }

        try {
          // é¡¯ç¤ºè¼‰å…¥ä¸­
          document.getElementById("routesList").innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—ºï¸</div>
                        <p style="color: #666;">æ­£åœ¨è¨ˆç®—æœ€ä½³è·¯ç·š...</p>
                        <p style="color: #999; font-size: 14px;">é€™å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
                    </div>
                `;
          document.getElementById("routesContainer").classList.remove("hidden");

          // ç›´æ¥å¾å·²è¼‰å…¥çš„æ¡ˆä»¶åˆ—è¡¨ä¸­å–å¾—é¸ä¸­çš„æ¡ˆä»¶
          const applications = allMapApplications.filter((app) =>
            selectedApplications.includes(app.id)
          );

          console.log("âœ… é¸ä¸­çš„æ¡ˆä»¶:", {
            total: applications.length,
            selectedIds: selectedApplications,
            matchedApps: applications.map((a) => ({
              id: a.id,
              case_no: a.case_no,
              address: a.address,
              damage_location: a.damage_location,
            })),
          });

          // é©—è­‰æ¡ˆä»¶è³‡æ–™
          if (!applications || applications.length === 0) {
            throw new Error("æ²’æœ‰æ‰¾åˆ°é¸ä¸­çš„æ¡ˆä»¶è³‡æ–™");
          }

          // æå–åœ°å€ï¼Œéæ¿¾æ‰ç©ºå€¼
          const destinations = applications
            .map((app) => {
              const addr =
                app.damage_location || app.address || app.formatted_address;
              console.log(`ğŸ“Œ æ¡ˆä»¶ ${app.case_no}:`, {
                damage_location: app.damage_location,
                address: app.address,
                formatted_address: app.formatted_address,
                selected: addr,
              });
              return addr;
            })
            .filter((addr) => addr && addr.trim().length > 0);

          // é©—è­‰ç›®çš„åœ°
          if (destinations.length === 0) {
            throw new Error(
              `âŒ æ‰€æœ‰ ${applications.length} å€‹æ¡ˆä»¶éƒ½æ²’æœ‰åœ°å€è³‡è¨Šï¼\n\n` +
                `è«‹æª¢æŸ¥æ¡ˆä»¶è³‡æ–™ï¼š\n` +
                applications
                  .map(
                    (a) =>
                      `- ${a.case_no}: damage_location=${a.damage_location}, address=${a.address}`
                  )
                  .join("\n")
            );
          }

          console.log("ğŸ“ è·¯ç·šè¦åŠƒè³‡æ–™:", {
            applications: applications.length,
            destinations: destinations,
            selectedApplications,
            currentUser: currentUser,
          });

          // ä½¿ç”¨é‡Œé•·æ‰€åœ¨å€åŸŸè¾¦å…¬è™•ä½œç‚ºèµ·é»ï¼ˆæˆ–ä½¿ç”¨ç¬¬ä¸€å€‹æ¡ˆä»¶åœ°å€ï¼‰
          let startLocation = destinations[0]; // é è¨­ä½¿ç”¨ç¬¬ä¸€å€‹æ¡ˆä»¶åœ°å€

          if (currentUser && currentUser.district_name) {
            startLocation = `${currentUser.district_name}è¾¦å…¬è™•`;
            console.log("âœ“ ä½¿ç”¨å€åŸŸè¾¦å…¬è™•ä½œç‚ºèµ·é»:", startLocation);
          } else {
            console.log(
              "âš ï¸ æœªè¨­å®šå€åŸŸï¼Œä½¿ç”¨ç¬¬ä¸€å€‹æ¡ˆä»¶åœ°å€ä½œç‚ºèµ·é»:",
              startLocation
            );
          }

          // æº–å‚™è«‹æ±‚è³‡æ–™
          const requestData = {
            start_location: startLocation,
            destinations: destinations,
            mode: "driving",
          };

          console.log("ğŸš— ç™¼é€è·¯ç·šè¦åŠƒè«‹æ±‚:", requestData);

          // å‘¼å«è·¯ç·šè¦åŠƒ API
          const routeResponse = await fetch(`${API_BASE}/maps/optimal-routes`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify(requestData),
          });

          if (!routeResponse.ok) {
            const errorData = await routeResponse.json().catch(() => ({}));
            console.error("è·¯ç·šè¦åŠƒéŒ¯èª¤:", {
              status: routeResponse.status,
              statusText: routeResponse.statusText,
              error: errorData,
            });

            // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
            let errorMessage = errorData.detail || "è·¯ç·šè¦åŠƒå¤±æ•—";
            if (Array.isArray(errorData.detail)) {
              errorMessage = errorData.detail
                .map((e) => `${e.loc?.join(".")}: ${e.msg}`)
                .join("\\n");
            }

            throw new Error(errorMessage);
          }

          const routeData = await routeResponse.json();
          console.log("âœ… è·¯ç·šè¦åŠƒæˆåŠŸ:", routeData);
          displayRoutes(routeData.routes, applications);
        } catch (error) {
          console.error("Error planning routes:", error);
          document.getElementById("routesList").innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <p style="color: #ef4444; font-weight: bold; margin-bottom: 10px;">è·¯ç·šè¦åŠƒå¤±æ•—</p>
                        <p style="color: #666; margin-top: 8px; white-space: pre-wrap;">${error.message}</p>
                        <button onclick="document.getElementById('routesContainer').classList.add('hidden')" 
                                style="margin-top: 20px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            é—œé–‰
                        </button>
                    </div>
                `;
        }
      }

      // é¡¯ç¤ºè·¯ç·šè¦åŠƒçµæœ
      function displayRoutes(routes, applications) {
        if (!routes || routes.length === 0) {
          document.getElementById("routesList").innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #999;">æ²’æœ‰æ‰¾åˆ°å¯ç”¨çš„è·¯ç·š</p>
                    </div>
                `;
          return;
        }

        const routesHtml = routes
          .slice(0, 3)
          .map((route) => {
            const waypointInfo = route.ordered_addresses
              .map((addr, idx) => {
                const app = applications.find(
                  (a) => a.formatted_address === addr || a.address === addr
                );
                return `
                        <li class="waypoint-item">
                            <strong>ç¬¬ ${idx + 1} ç«™</strong> - ${
                  app?.applicant_name || "æœªçŸ¥"
                }
                            <div style="font-size: 13px; color: #666; margin-top: 3px;">
                                ${addr}
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 3px;">
                                ${app?.case_no || ""} | ${getDisasterTypeText(
                  app?.disaster_type
                )}
                            </div>
                        </li>
                    `;
              })
              .join("");

            return `
                    <div class="route-card rank-${route.rank}">
                        <div class="route-header">
                            <div class="route-rank rank-${route.rank}">
                                ${
                                  route.rank === 1
                                    ? "ğŸ¥‡"
                                    : route.rank === 2
                                    ? "ğŸ¥ˆ"
                                    : "ğŸ¥‰"
                                }
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #333;">
                                    ${
                                      route.rank === 1
                                        ? "æœ€ä½³è·¯ç·š"
                                        : route.rank === 2
                                        ? "æ¬¡ä½³è·¯ç·š"
                                        : "ç¬¬ä¸‰è·¯ç·š"
                                    }
                                </h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                    å…± ${
                                      route.ordered_addresses.length
                                    } å€‹è¨ªå•åœ°é»
                                </p>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="showRouteOnMap(${
                              route.rank - 1
                            })">
                                åœ¨åœ°åœ–ä¸Šé¡¯ç¤º
                            </button>
                        </div>

                        <div class="route-stats">
                            <div class="route-stat">
                                <div class="route-stat-label">ç¸½è·é›¢</div>
                                <div class="route-stat-value">${
                                  route.total_distance.text
                                }</div>
                            </div>
                            <div class="route-stat">
                                <div class="route-stat-label">é ä¼°æ™‚é–“</div>
                                <div class="route-stat-value">${
                                  route.total_duration.text
                                }</div>
                            </div>
                            <div class="route-stat">
                                <div class="route-stat-label">è¨ªå•é †åº</div>
                                <div class="route-stat-value">${route.waypoint_order
                                  .map((i) => i + 1)
                                  .join(" â†’ ")}</div>
                            </div>
                        </div>

                        <div>
                            <h4 style="margin: 15px 0 10px 0; color: #666; font-size: 14px;">ğŸ“ è¨ªå•é †åºï¼š</h4>
                            <ul class="waypoint-list">
                                ${waypointInfo}
                            </ul>
                        </div>
                    </div>
                `;
          })
          .join("");

        document.getElementById("routesList").innerHTML = routesHtml;
      }

      // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºç‰¹å®šè·¯ç·š
      async function showRouteOnMap(routeIndex) {
        if (!map) {
          initializeMap();
        }

        // æ¸…é™¤èˆŠçš„è·¯ç·š
        clearDirectionsRenderers();

        try {
          // å–å¾—è·¯ç·šè³‡æ–™
          const response = await fetch(
            `${API_BASE}/maps/applications-map-data`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({
                application_ids: selectedApplications,
              }),
            }
          );

          if (!response.ok) {
            throw new Error("å–å¾—æ¡ˆä»¶è³‡æ–™å¤±æ•—");
          }

          const data = await response.json();
          const applications = data.applications;
          const destinations = applications.map(
            (app) => app.formatted_address || app.address
          );

          // ä½¿ç”¨é‡Œé•·æ‰€åœ¨å€åŸŸè¾¦å…¬è™•ä½œç‚ºèµ·é»
          const startLocation = currentUser.district_name
            ? `å°å—å¸‚${currentUser.district_name}è¾¦å…¬è™•`
            : destinations[0];

          // é‡æ–°è¨ˆç®—è·¯ç·šä»¥å–å¾—å®Œæ•´çš„è·¯ç·šè³‡æ–™
          const routeResponse = await fetch(`${API_BASE}/maps/optimal-routes`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({
              start_location: startLocation,
              destinations: destinations,
              mode: "driving",
            }),
          });

          if (!routeResponse.ok) {
            throw new Error("è·¯ç·šè¦åŠƒå¤±æ•—");
          }

          const routeData = await routeResponse.json();
          const selectedRoute = routeData.routes[routeIndex];

          if (!selectedRoute) {
            throw new Error("æ‰¾ä¸åˆ°æŒ‡å®šçš„è·¯ç·š");
          }

          // å»ºç«‹è·¯ç·šæ¸²æŸ“å™¨
          const directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false, // é¡¯ç¤ºèµ·é»çµ‚é»æ¨™è¨˜
            polylineOptions: {
              strokeColor:
                routeIndex === 0
                  ? "#3b82f6"
                  : routeIndex === 1
                  ? "#10b981"
                  : "#f59e0b",
              strokeWeight: 6,
              strokeOpacity: 0.8,
            },
          });

          // å»ºç«‹è·¯ç·šè«‹æ±‚
          const waypoints = selectedRoute.ordered_addresses
            .slice(0, -1)
            .map((addr) => ({
              location: addr,
              stopover: true,
            }));

          const request = {
            origin: startLocation,
            destination:
              selectedRoute.ordered_addresses[
                selectedRoute.ordered_addresses.length - 1
              ],
            waypoints: waypoints,
            travelMode: google.maps.TravelMode.DRIVING,
            optimizeWaypoints: false, // å·²ç¶“æœ€ä½³åŒ–éäº†
          };

          // ç¹ªè£½è·¯ç·š
          directionsService.route(request, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
              directionsRenderer.setDirections(result);
              directionsRenderers.push(directionsRenderer);

              // æç¤ºæˆåŠŸ
              const routeName =
                routeIndex === 0
                  ? "æœ€ä½³è·¯ç·š"
                  : routeIndex === 1
                  ? "æ¬¡ä½³è·¯ç·š"
                  : "ç¬¬ä¸‰è·¯ç·š";
              alert(
                `âœ… ${routeName}å·²é¡¯ç¤ºåœ¨åœ°åœ–ä¸Š\n\n` +
                  `ç¸½è·é›¢: ${selectedRoute.total_distance.text}\n` +
                  `é ä¼°æ™‚é–“: ${selectedRoute.total_duration.text}`
              );
            } else {
              console.error("è·¯ç·šç¹ªè£½å¤±æ•—:", status);
              alert("è·¯ç·šç¹ªè£½å¤±æ•—ï¼š" + status);
            }
          });
        } catch (error) {
          console.error("Error showing route on map:", error);
          alert("é¡¯ç¤ºè·¯ç·šå¤±æ•—ï¼š" + error.message);
        }
      }

      // æ¸…é™¤åœ°åœ–é¸æ“‡
      function clearMapSelection() {
        selectedApplications = [];
        const checkboxes = document.querySelectorAll(
          '#mapApplicationsList input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = false));
        updateSelectedCount();
        clearMarkers();
        clearDirectionsRenderers();
        document.getElementById("routesContainer").classList.add("hidden");
      }

      // ============================================
      // æ–‡ä»¶ç®¡ç†åŠŸèƒ½
      // ============================================

      async function loadApplicationDocuments(applicationId) {
        const documentsContainer = document.getElementById("documentsInfo");
        documentsContainer.innerHTML =
          '<p style="color: #999; font-size: 14px;">è¼‰å…¥ä¸­...</p>';

        try {
          const response = await fetch(
            `${API_BASE}/documents/application/${applicationId}`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          if (response.ok) {
            const result = await response.json();
            const documents = result.data?.documents || [];

            if (documents.length === 0) {
              documentsContainer.innerHTML = `
                            <div style="padding: 20px; text-align: center; background: #f9fafb; border-radius: 8px; color: #999;">
                                ğŸ“„ æ­¤æ¡ˆä»¶æš«ç„¡ä¸Šå‚³è­‰æ˜æ–‡ä»¶
                            </div>
                        `;
              return;
            }

            // é¡¯ç¤ºæ–‡ä»¶åˆ—è¡¨
            const html = documents
              .map((doc) => {
                const sizeInMB = (doc.file_size / (1024 * 1024)).toFixed(2);
                const icon = getDocumentIcon(doc.file_name);
                const isDocx =
                  doc.mime_type ===
                  "application/vnd.openxmlformats-officedocument.wordprocessingml.document";

                return `
                            <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 32px; margin-right: 15px;">${icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #333; margin-bottom: 4px;">${
                                      doc.file_name
                                    }</div>
                                    <div style="font-size: 12px; color: #666;">
                                        ${sizeInMB} MB Â· ${getDocumentTypeText(
                  doc.document_type
                )} Â· ${new Date(doc.uploaded_at).toLocaleString()}
                                    </div>
                                    ${
                                      doc.description
                                        ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">ğŸ“ ${doc.description}</div>`
                                        : ""
                                    }
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${
                                      isDocx
                                        ? `
                                        <button class="btn btn-sm" onclick="previewDocument('${doc.id}', '${doc.file_name}')" style="background: #3b82f6; color: white;" title="é è¦½ï¼ˆè‡ªå‹•è½‰ PDFï¼‰">
                                            ğŸ‘ï¸ é è¦½
                                        </button>
                                    `
                                        : doc.mime_type.startsWith("image/") ||
                                          doc.mime_type === "application/pdf"
                                        ? `
                                        <button class="btn btn-sm" onclick="previewDocument('${doc.id}', '${doc.file_name}')" style="background: #3b82f6; color: white;">
                                            ğŸ‘ï¸ é è¦½
                                        </button>
                                    `
                                        : ""
                                    }
                                    <button class="btn btn-sm" onclick="downloadDocument('${
                                      doc.id
                                    }', '${
                  doc.file_name
                }')" style="background: #10b981; color: white;">
                                        â¬‡ï¸ ä¸‹è¼‰
                                    </button>
                                </div>
                            </div>
                        `;
              })
              .join("");

            documentsContainer.innerHTML = `
                        <div style="background: #eff6ff; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; color: #1e40af;">
                            ğŸ“‹ å…± ${documents.length} å€‹è­‰æ˜æ–‡ä»¶
                        </div>
                        ${html}
                    `;
          } else {
            documentsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                            âŒ è¼‰å…¥æ–‡ä»¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                        </div>
                    `;
          }
        } catch (error) {
          console.error("è¼‰å…¥æ–‡ä»¶éŒ¯èª¤:", error);
          documentsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                        âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}
                    </div>
                `;
        }
      }

      function getDocumentIcon(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const icons = {
          pdf: "ğŸ“„",
          doc: "ğŸ“",
          docx: "ğŸ“",
          jpg: "ğŸ–¼ï¸",
          jpeg: "ğŸ–¼ï¸",
          png: "ğŸ–¼ï¸",
          xls: "ğŸ“Š",
          xlsx: "ğŸ“Š",
        };
        return icons[ext] || "ğŸ“";
      }

      function getDocumentTypeText(type) {
        const types = {
          household_registration: "æˆ¶ç±è¬„æœ¬",
          income_proof: "æ”¶å…¥è­‰æ˜",
          property_proof: "è²¡ç”¢è­‰æ˜",
          damage_assessment: "ç½æé‘‘å®š",
          supporting_document: "è­‰æ˜æ–‡ä»¶",
          other: "å…¶ä»–æ–‡ä»¶",
        };
        return types[type] || type;
      }

      async function previewDocument(documentId, fileName) {
        try {
          // æ‰“é–‹æ–°è¦–çª—é€²è¡Œé è¦½
          const previewUrl = `${API_BASE}/documents/${documentId}/preview`;
          const previewWindow = window.open(
            "",
            "_blank",
            "width=900,height=700"
          );

          if (!previewWindow) {
            alert("ç„¡æ³•é–‹å•Ÿé è¦½è¦–çª—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨çš„å½ˆå‡ºè¦–çª—è¨­å®š");
            return;
          }

          previewWindow.document.write(`
                    <html>
                    <head>
                        <title>é è¦½ - ${fileName}</title>
                        <style>
                            body {
                                margin: 0;
                                padding: 0;
                                background: #f0f0f0;
                                font-family: Arial, sans-serif;
                            }
                            .header {
                                background: white;
                                padding: 15px 20px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                            }
                            .header h3 {
                                margin: 0;
                                color: #333;
                            }
                            .btn {
                                padding: 8px 16px;
                                background: #3b82f6;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                text-decoration: none;
                            }
                            .btn:hover {
                                background: #2563eb;
                            }
                            .loading {
                                text-align: center;
                                padding: 50px;
                                color: #666;
                            }
                            iframe, embed, img {
                                width: 100%;
                                height: calc(100vh - 70px);
                                border: none;
                            }
                            .error {
                                text-align: center;
                                padding: 50px;
                                color: #dc2626;
                                background: white;
                                margin: 20px;
                                border-radius: 8px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3>ğŸ“„ ${fileName}</h3>
                            <a href="${API_BASE}/documents/${documentId}/download" class="btn" download>â¬‡ï¸ ä¸‹è¼‰åŸæª”</a>
                        </div>
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                        <iframe id="previewFrame" style="display:none;"></iframe>
                    </body>
                    </html>
                `);

          // ä½¿ç”¨ iframe è¼‰å…¥é è¦½
          const iframe = previewWindow.document.getElementById("previewFrame");
          const loading = previewWindow.document.querySelector(".loading");

          iframe.onload = () => {
            loading.style.display = "none";
            iframe.style.display = "block";
          };

          iframe.onerror = () => {
            loading.innerHTML =
              '<div class="error">âŒ é è¦½å¤±æ•—<br><small>å»ºè­°ç›´æ¥ä¸‹è¼‰æª”æ¡ˆæŸ¥çœ‹</small></div>';
          };

          iframe.src = previewUrl;
        } catch (error) {
          console.error("é è¦½éŒ¯èª¤:", error);
          alert("é è¦½å¤±æ•—: " + error.message);
        }
      }

      async function downloadDocument(documentId, fileName) {
        try {
          const response = await fetch(
            `${API_BASE}/documents/${documentId}/download`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          if (!response.ok) {
            throw new Error("ä¸‹è¼‰å¤±æ•—");
          }

          // å–å¾— blob
          const blob = await response.blob();

          // å»ºç«‹ä¸‹è¼‰é€£çµ
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();

          // æ¸…ç†
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          console.log(`âœ“ æª”æ¡ˆ ${fileName} ä¸‹è¼‰æˆåŠŸ`);
        } catch (error) {
          console.error("ä¸‹è¼‰éŒ¯èª¤:", error);
          alert("ä¸‹è¼‰å¤±æ•—: " + error.message);
        }
      }
    </script>
  </body>
</html>
