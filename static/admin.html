<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‡Œé•·å¯©æ ¸å¾Œå° - ç½æ°‘è£œåŠ©ç®¡ç†ç³»çµ±</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
      }

      /* Header */
      .header {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 0 24px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .logo {
        font-size: 20px;
        font-weight: 600;
        color: #333;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      /* Sidebar */
      .layout {
        display: flex;
        height: calc(100vh - 64px);
      }

      .sidebar {
        width: 240px;
        background: white;
        border-right: 1px solid #e0e0e0;
        padding: 20px 0;
      }

      .nav-item {
        padding: 12px 24px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #666;
      }

      .nav-item:hover {
        background: #f5f5f5;
        color: #333;
      }

      .nav-item.active {
        background: #eff6ff;
        color: #1d4ed8;
        border-right: 3px solid #1d4ed8;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      .page-header {
        margin-bottom: 24px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }

      .page-subtitle {
        color: #666;
        font-size: 14px;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .stat-label {
        font-size: 13px;
        color: #666;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #333;
      }

      .stat-change {
        font-size: 12px;
        margin-top: 4px;
      }

      .stat-change.positive {
        color: #10b981;
      }
      .stat-change.negative {
        color: #ef4444;
      }

      /* Card */
      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
      }

      .card-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .card-body {
        padding: 20px;
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        text-align: left;
        padding: 12px;
        background: #f9fafb;
        font-weight: 600;
        font-size: 13px;
        color: #666;
        border-bottom: 2px solid #e0e0e0;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
      }

      tr:hover {
        background: #f9fafb;
      }

      /* Badge */
      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge.pending {
        background: #fef3c7;
        color: #92400e;
      }
      .badge.under_review {
        background: #dbeafe;
        color: #1e3a8a;
      }
      .badge.approved {
        background: #d1fae5;
        color: #065f46;
      }
      .badge.rejected {
        background: #fee2e2;
        color: #991b1b;
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #1d4ed8;
        color: white;
      }

      .btn-primary:hover {
        background: #1e40af;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      /* Form */
      .form-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: #333;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .info-row {
        display: flex;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .info-label {
        width: 120px;
        font-weight: 500;
        color: #666;
      }

      .info-value {
        flex: 1;
        color: #333;
      }

      .hidden {
        display: none;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      /* Google Maps Styles */
      #map {
        width: 100%;
        height: 600px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .map-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .application-checkbox {
        margin-right: 8px;
      }

      .route-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid #e0e0e0;
        transition: all 0.3s;
      }

      .route-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
      }

      .route-card.rank-1 {
        border-color: #fbbf24;
        background: linear-gradient(to right, #fef3c7 0%, white 50%);
      }

      .route-card.rank-2 {
        border-color: #c0c0c0;
      }

      .route-card.rank-3 {
        border-color: #cd7f32;
      }

      .route-rank {
        display: inline-block;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: bold;
        font-size: 20px;
        text-align: center;
        line-height: 40px;
        margin-right: 15px;
      }

      .route-rank.rank-1 {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      }

      .route-rank.rank-2 {
        background: linear-gradient(135deg, #c0c0c0 0%, #9ca3af 100%);
      }

      .route-rank.rank-3 {
        background: linear-gradient(135deg, #cd7f32 0%, #92400e 100%);
      }

      .route-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .route-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }

      .route-stat {
        flex: 1;
        padding: 10px;
        background: #f9fafb;
        border-radius: 6px;
      }

      .route-stat-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
      }

      .route-stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .waypoint-list {
        list-style: none;
        padding: 0;
      }

      .waypoint-item {
        padding: 10px;
        border-left: 3px solid #667eea;
        margin-left: 20px;
        margin-bottom: 10px;
        background: #f9fafb;
        border-radius: 0 6px 6px 0;
      }

      .waypoint-item::before {
        content: "ğŸ“";
        margin-right: 8px;
      }

      .select-applications-box {
        background: #eff6ff;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .application-item-checkbox {
        display: flex;
        align-items: center;
        padding: 10px;
        background: white;
        border-radius: 6px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .application-item-checkbox:hover {
        background: #f0f9ff;
        transform: translateX(5px);
      }

      .application-item-checkbox input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
      }
    </style>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbuTGzgDiR9WfXuvbPOZSc5nNm7NDucuQ&libraries=places,geometry"></script>
  </head>
  <body>
    <div class="header">
      <div class="logo">ğŸ‘¨â€ğŸ’¼ é‡Œé•·å¯©æ ¸å¾Œå°</div>
      <div class="user-info">
        <div>
          <div style="font-size: 14px; font-weight: 500" id="adminName">
            é‡Œé•·
          </div>
          <div style="font-size: 12px; color: #999" id="adminDistrict">
            å€åŸŸ
          </div>
        </div>
        <div class="user-avatar" id="adminAvatar">é‡Œ</div>
        <button
          class="btn btn-sm"
          onclick="logout()"
          style="background: #f3f4f6; color: #666"
        >
          ç™»å‡º
        </button>
      </div>
    </div>

    <div class="layout">
      <div class="sidebar">
        <div class="nav-item active" onclick="showPage('dashboard')">
          ğŸ“Š å„€è¡¨æ¿
        </div>
        <div class="nav-item" onclick="showPage('applications')">
          ğŸ“‹ å¾…å¯©æ ¸æ¡ˆä»¶
        </div>
        <div class="nav-item" onclick="showPage('map')">ğŸ—ºï¸ æ¡ˆä»¶åœ°åœ–</div>
        <div class="nav-item" onclick="showPage('history')">ğŸ“œ å¯©æ ¸æ­·å²</div>
        <div class="nav-item" onclick="showPage('statistics')">ğŸ“ˆ çµ±è¨ˆå ±è¡¨</div>
      </div>

      <div class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboard-page">
          <div class="page-header">
            <h1 class="page-title">å„€è¡¨æ¿</h1>
            <p class="page-subtitle">ç¸½è¦½æœ¬å€ç”³è«‹æ¡ˆä»¶ç‹€æ…‹</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">å¾…å¯©æ ¸</div>
              <div class="stat-value" id="statPending">-</div>
              <div class="stat-change">éœ€è™•ç†çš„æ¡ˆä»¶</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">å¯©æ ¸ä¸­</div>
              <div class="stat-value" id="statReview">-</div>
              <div class="stat-change">è™•ç†ä¸­</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">å·²æ ¸å‡†</div>
              <div class="stat-value" id="statApproved">-</div>
              <div class="stat-change positive">âœ“ å®Œæˆå¯©æ ¸</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">ç¸½ç”³è«‹é¡</div>
              <div class="stat-value" id="statTotal" style="font-size: 24px">
                -
              </div>
              <div class="stat-change">æœ¬æœˆçµ±è¨ˆ</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">æœ€è¿‘å¾…å¯©æ ¸æ¡ˆä»¶</h3>
              <button
                class="btn btn-primary btn-sm"
                onclick="loadPendingApplications()"
              >
                é‡æ–°æ•´ç†
              </button>
            </div>
            <div class="card-body">
              <div id="recentApplications"></div>
            </div>
          </div>
        </div>

        <!-- Applications Page -->
        <div id="applications-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">å¾…å¯©æ ¸æ¡ˆä»¶</h1>
            <p class="page-subtitle">å¯©æ ¸æœ¬å€ç½æ°‘çš„è£œåŠ©ç”³è«‹</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">æ¡ˆä»¶åˆ—è¡¨</h3>
              <button
                class="btn btn-primary btn-sm"
                onclick="loadPendingApplications()"
              >
                é‡æ–°æ•´ç†
              </button>
            </div>
            <div class="card-body">
              <div id="applicationsList"></div>
            </div>
          </div>
        </div>

        <!-- Map Page -->
        <div id="map-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">ğŸ—ºï¸ æ¡ˆä»¶åœ°åœ–è¦–åœ–</h1>
            <p class="page-subtitle">æŸ¥çœ‹æ¡ˆä»¶åˆ†å¸ƒä¸¦è¦åŠƒè¨ªå•è·¯ç·š</p>
          </div>

          <!-- é¸æ“‡æ¡ˆä»¶ -->
          <div class="select-applications-box">
            <h3 style="margin-bottom: 15px">ğŸ“‹ é¸æ“‡è¦æŸ¥çœ‹çš„æ¡ˆä»¶</h3>
            <div class="map-controls">
              <button
                class="btn btn-primary btn-sm"
                onclick="loadMapApplications()"
              >
                è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨
              </button>
              <button
                class="btn btn-success btn-sm"
                onclick="showSelectedOnMap()"
              >
                åœ¨åœ°åœ–ä¸Šé¡¯ç¤º (<span id="selectedCount">0</span>)
              </button>
              <button class="btn btn-primary btn-sm" onclick="planRoutes()">
                ğŸ¯ è¦åŠƒæœ€ä½³è·¯ç·š
              </button>
              <button
                class="btn btn-sm"
                onclick="clearMapSelection()"
                style="background: #f3f4f6; color: #666"
              >
                æ¸…é™¤é¸æ“‡
              </button>
            </div>
            <div id="mapApplicationsList" style="margin-top: 15px">
              <p style="color: #666; text-align: center; padding: 20px">
                é»æ“Šã€Œè¼‰å…¥æ¡ˆä»¶åˆ—è¡¨ã€é–‹å§‹
              </p>
            </div>
          </div>

          <!-- Google åœ°åœ– -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“ æ¡ˆä»¶åˆ†å¸ƒåœ°åœ–</h3>
              <div style="font-size: 14px; color: #666">
                é»æ“Šæ¨™è¨˜æŸ¥çœ‹æ¡ˆä»¶è©³æƒ…
              </div>
            </div>
            <div class="card-body">
              <div id="map"></div>
            </div>
          </div>

          <!-- è·¯ç·šè¦åŠƒçµæœ -->
          <div id="routesContainer" class="hidden">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ğŸ¯ Top 3 æœ€ä½³è·¯ç·šæ–¹æ¡ˆ</h3>
              </div>
              <div class="card-body">
                <div id="routesList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- History Page -->
        <div id="history-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">å¯©æ ¸æ­·å²</h1>
            <p class="page-subtitle">æŸ¥çœ‹å·²å®Œæˆçš„å¯©æ ¸è¨˜éŒ„</p>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“œ</div>
                <p>å¯©æ ¸æ­·å²è¨˜éŒ„</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Page -->
        <div id="statistics-page" class="hidden">
          <div class="page-header">
            <h1 class="page-title">çµ±è¨ˆå ±è¡¨</h1>
            <p class="page-subtitle">æœ¬å€ç”³è«‹æ¡ˆä»¶çµ±è¨ˆåˆ†æ</p>
          </div>

          <div class="card">
            <div class="card-body">
              <div id="statisticsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>å¯©æ ¸ç”³è«‹æ¡ˆä»¶</h3>
          <button class="close-btn" onclick="closeReviewModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <h4 style="margin-bottom: 16px">ç”³è«‹äººè³‡è¨Š</h4>
          <div id="applicantInfo"></div>

          <h4 style="margin: 24px 0 16px">ç½å®³è³‡è¨Š</h4>
          <div id="disasterInfo"></div>

          <h4 style="margin: 24px 0 16px">è­‰æ˜æ–‡ä»¶</h4>
          <div id="documentsInfo">
            <p style="color: #999; font-size: 14px">è¼‰å…¥ä¸­...</p>
          </div>

          <h4 style="margin: 24px 0 16px">å¯©æ ¸å‹•ä½œ</h4>
          <div class="form-group">
            <label>å¯©æ ¸æ„è¦‹</label>
            <textarea
              id="reviewComments"
              placeholder="è«‹å¡«å¯«å¯©æ ¸æ„è¦‹..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>æ ¸å‡†é‡‘é¡ï¼ˆæ ¸å‡†æ™‚å¿…å¡«ï¼‰</label>
            <input
              type="number"
              id="approvedAmount"
              placeholder="è«‹è¼¸å…¥æ ¸å‡†é‡‘é¡"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            onclick="closeReviewModal()"
            style="background: #f3f4f6; color: #666"
          >
            å–æ¶ˆ
          </button>
          <button class="btn btn-danger" onclick="rejectApplication()">
            âŒ é§å›
          </button>
          <button class="btn btn-success" onclick="approveApplication()">
            âœ… æ ¸å‡†
          </button>
        </div>
      </div>
    </div>

    <!-- è¼‰å…¥é…ç½®ç®¡ç†æ¨¡çµ„ -->
    <script src="/static/js/config.js"></script>
    <script>
      // å…¨åŸŸè®Šæ•¸
      let API_BASE = null; // å°‡ç”±é…ç½®æ¨¡çµ„è¨­å®š
      let accessToken = localStorage.getItem("admin_token");
      let currentUser = JSON.parse(
        localStorage.getItem("admin_user") || "null"
      );
      let currentApplication = null;

      // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
      async function initializeApp() {
        // è¼‰å…¥é…ç½®
        await initializeConfig();
        API_BASE = getApiBase();

        // æª¢æŸ¥ç™»å…¥
        if (!accessToken || !currentUser || currentUser.role !== "reviewer") {
          showLoginPrompt();
        } else {
          showDashboard();
        }
      }

      // é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", initializeApp);

      function showDashboard() {
        document.getElementById("adminName").textContent =
          currentUser.full_name;
        document.getElementById("adminAvatar").textContent =
          currentUser.full_name.charAt(0);
        loadDashboardStats();
        loadPendingApplications();
      }

      function showLoginPrompt() {
        // å‰µå»ºç™»å…¥å°è©±æ¡†
        const loginModal = document.createElement("div");
        loginModal.id = "adminLoginModal";
        loginModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h2 style="margin-bottom: 20px; color: #333;">ğŸ‘¨â€ğŸ’¼ é‡Œé•·/ç®¡ç†å“¡ç™»å…¥</h2>
                        
                        <!-- æ•¸ä½æ†‘è­‰ç™»å…¥ï¼ˆæ¨è–¦ï¼‰ -->
                        <div style="margin-bottom: 25px; padding: 20px; background: #f0f7ff; border-radius: 8px; border: 2px solid #667eea;">
                            <h3 style="color: #667eea; margin-bottom: 10px; font-size: 16px;">ğŸ“± æ•¸ä½æ†‘è­‰ç™»å…¥ï¼ˆæ¨è–¦ï¼‰</h3>
                            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">ä½¿ç”¨æ”¿åºœæ•¸ä½æ†‘è­‰ï¼Œå¿«é€Ÿä¸”å®‰å…¨</p>
                            <textarea id="adminDigitalQrCode" placeholder="è²¼ä¸Šæ•¸ä½æ†‘è­‰ QR Code è³‡æ–™" style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: monospace; font-size: 12px;"></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                <a href="/docs#/èº«ä»½é©—è­‰/generate_test_qr_api_v1_auth_digital_id_generate_test_qr_get" target="_blank" style="color: #667eea;">ä¸çŸ¥é“å¦‚ä½•å–å¾—ï¼Ÿé»æ­¤ç”¢ç”Ÿæ¸¬è©¦ç”¨ QR Code</a>
                            </small>
                            <button id="btnDigitalLogin" style="width: 100%; margin-top: 15px; padding: 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">
                                ğŸ” ä½¿ç”¨æ•¸ä½æ†‘è­‰ç™»å…¥
                            </button>
                        </div>

                        <div style="text-align: center; margin: 25px 0; color: #999; position: relative;">
                            <span style="background: white; padding: 0 15px; position: relative; z-index: 1;">æˆ–ä½¿ç”¨ Email é©—è­‰</span>
                            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #e0e0e0; z-index: 0;"></div>
                        </div>
                        
                        <!-- Email é©—è­‰ç™»å…¥ -->
                        <div style="padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            <h3 style="color: #666; margin-bottom: 10px; font-size: 16px;">ğŸ“§ Email é©—è­‰ç™»å…¥</h3>
                            <p style="color: #999; font-size: 13px; margin-bottom: 15px;">æˆ‘å€‘æœƒç™¼é€é©—è­‰ç¢¼åˆ°æ‚¨çš„ä¿¡ç®±</p>
                            
                            <!-- æ­¥é©Ÿ 1: è¼¸å…¥ Email -->
                            <div id="adminEmailStep">
                                <input type="email" id="adminEmail" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                                <button id="btnSendAdminCode" style="width: 100%; padding: 12px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500;">
                                    ç™¼é€é©—è­‰ç¢¼
                                </button>
                            </div>

                            <!-- æ­¥é©Ÿ 2: è¼¸å…¥é©—è­‰ç¢¼ -->
                            <div id="adminVerificationStep" style="display: none;">
                                <div style="padding: 12px; background: #e0f2fe; border-radius: 6px; margin-bottom: 12px; font-size: 13px;">
                                    âœ‰ï¸ é©—è­‰ç¢¼å·²ç™¼é€åˆ° <strong id="adminVerifyEmailDisplay"></strong><br>
                                    è«‹åœ¨ <strong id="adminCountdown" style="color: #667eea;">3:00</strong> å…§å®Œæˆé©—è­‰
                                </div>

                                <input type="text" id="adminVerificationCode" placeholder="è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼" maxlength="6" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; font-size: 20px; letter-spacing: 6px; text-align: center;">
                                
                                <button id="btnVerifyAdmin" style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 500; margin-bottom: 8px;">
                                    é©—è­‰ä¸¦ç™»å…¥
                                </button>
                                
                                <button id="btnResendAdmin" style="width: 100%; padding: 10px; background: #e5e7eb; color: #666; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" disabled>
                                    é‡æ–°ç™¼é€ (<span id="adminResendCountdown">60</span>)
                                </button>
                                
                                <button id="btnBackToEmail" style="width: 100%; padding: 10px; background: transparent; color: #666; border: none; cursor: pointer; font-size: 14px; margin-top: 8px;">
                                    â† è¿”å›ä¿®æ”¹ Email
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        document.body.appendChild(loginModal);

        // æ•¸ä½æ†‘è­‰ç™»å…¥äº‹ä»¶
        document
          .getElementById("btnDigitalLogin")
          .addEventListener("click", async () => {
            // ç¢ºä¿é…ç½®å·²è¼‰å…¥
            if (!API_BASE) {
              await initializeConfig();
              API_BASE = getApiBase();
            }

            const qrCodeData = document
              .getElementById("adminDigitalQrCode")
              .value.trim();

            if (!qrCodeData) {
              alert("è«‹è¼¸å…¥æ•¸ä½æ†‘è­‰ QR Code è³‡æ–™");
              return;
            }

            try {
              console.log("Admin ä½¿ç”¨ API_BASE:", API_BASE);

              const result = await fetch(`${API_BASE}/auth/digital-id/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  qr_code_data: qrCodeData,
                }),
              });

              if (result.ok) {
                const data = await result.json();
                if (
                  data.user.role === "reviewer" ||
                  data.user.role === "admin"
                ) {
                  accessToken = data.access_token;
                  currentUser = data.user;
                  localStorage.setItem("admin_token", accessToken);
                  localStorage.setItem(
                    "admin_user",
                    JSON.stringify(currentUser)
                  );
                  location.reload();
                } else {
                  alert("æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†æ¬Šé™");
                }
              } else {
                const error = await result.json();

                // å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦è£œå……è³‡æ–™
                if (error.detail && error.detail.includes("é¦–æ¬¡ä½¿ç”¨")) {
                  const role = prompt(
                    "é¦–æ¬¡ä½¿ç”¨ï¼Œè«‹é¸æ“‡è§’è‰²ï¼ˆè¼¸å…¥ reviewer ç‚ºé‡Œé•·ï¼Œadmin ç‚ºç®¡ç†å“¡ï¼‰ï¼š",
                    "reviewer"
                  );
                  const phone = prompt("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼š", "09");

                  if (role && phone) {
                    let districtId = null;
                    if (role === "reviewer") {
                      // å–å¾—å€åŸŸåˆ—è¡¨
                      const districtsRes = await fetch(
                        `${API_BASE}/districts/`
                      );
                      if (districtsRes.ok) {
                        const districts = await districtsRes.json();
                        const districtOptions = districts
                          .map((d) => `${d.district_code}: ${d.district_name}`)
                          .join("\\n");
                        const selectedCode = prompt(
                          `è«‹é¸æ“‡ç®¡è½„å€åŸŸï¼ˆè¼¸å…¥ä»£ç¢¼ï¼‰ï¼š\\n${districtOptions}`
                        );
                        const selectedDistrict = districts.find(
                          (d) => d.district_code === selectedCode
                        );
                        districtId = selectedDistrict
                          ? selectedDistrict.id
                          : null;
                      }
                    }

                    // å†æ¬¡æäº¤ï¼ŒåŒ…å«è£œå……è³‡æ–™
                    const retryResult = await fetch(
                      `${API_BASE}/auth/digital-id/login`,
                      {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                          qr_code_data: qrCodeData,
                          role: role,
                          phone: phone,
                          district_id: districtId,
                        }),
                      }
                    );

                    if (retryResult.ok) {
                      const data = await retryResult.json();
                      accessToken = data.access_token;
                      currentUser = data.user;
                      localStorage.setItem("admin_token", accessToken);
                      localStorage.setItem(
                        "admin_user",
                        JSON.stringify(currentUser)
                      );
                      location.reload();
                    } else {
                      const retryError = await retryResult.json();
                      alert(`ç™»å…¥å¤±æ•—ï¼š${retryError.detail}`);
                    }
                  }
                } else {
                  alert(`ç™»å…¥å¤±æ•—ï¼š${error.detail}`);
                }
              }
            } catch (error) {
              console.error("Digital ID login error:", error);
              alert("æ•¸ä½æ†‘è­‰ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
          });

        // ============================================
        // Email é©—è­‰ç™»å…¥äº‹ä»¶è™•ç†å™¨
        // ============================================
        let adminStoredCode = null;
        let adminVerificationEmail = null;
        let adminCountdownTimer = null;
        let adminResendTimer = null;

        // ç™¼é€é©—è­‰ç¢¼
        document
          .getElementById("btnSendAdminCode")
          .addEventListener("click", async () => {
            if (!API_BASE) {
              await initializeConfig();
              API_BASE = getApiBase();
            }

            const email = document.getElementById("adminEmail").value.trim();

            if (!email) {
              alert("è«‹è¼¸å…¥ Email");
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email æ ¼å¼");
              return;
            }

            try {
              const response = await fetch(`${API_BASE}/auth/email/auth`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, is_verified: false }),
              });

              if (response.ok) {
                const data = await response.json();
                adminStoredCode = data.verification_code || null;
                adminVerificationEmail = email;

                // åˆ‡æ›åˆ°é©—è­‰ç¢¼è¼¸å…¥ç•«é¢
                document.getElementById("adminEmailStep").style.display =
                  "none";
                document.getElementById("adminVerificationStep").style.display =
                  "block";
                document.getElementById("adminVerifyEmailDisplay").textContent =
                  email;

                // é–‹å§‹å€’æ•¸
                startAdminCountdown(180);
                startAdminResendCountdown(60);

                if (adminStoredCode) {
                  console.log("ğŸ”‘ ç®¡ç†å“¡é©—è­‰ç¢¼ï¼ˆé–‹ç™¼ç”¨ï¼‰:", adminStoredCode);
                  alert("âœ… é©—è­‰ç¢¼å·²ç™¼é€ï¼\\n\\nï¼ˆé–‹ç™¼ç’°å¢ƒï¼šè«‹æŸ¥çœ‹ Consoleï¼‰");
                } else {
                  alert("âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„ Emailï¼Œè«‹æŸ¥æ”¶ï¼");
                }
              } else {
                const error = await response.json();
                alert("ç™¼é€å¤±æ•—ï¼š" + (error.detail || "è«‹ç¨å¾Œå†è©¦"));
              }
            } catch (error) {
              console.error("ç™¼é€é©—è­‰ç¢¼éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });

        // é©—è­‰ä¸¦ç™»å…¥
        document
          .getElementById("btnVerifyAdmin")
          .addEventListener("click", async () => {
            const userCode = document
              .getElementById("adminVerificationCode")
              .value.trim();

            if (!userCode || userCode.length !== 6) {
              alert("è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼");
              return;
            }

            // å‰ç«¯é©—è­‰
            let isValid = true;
            if (adminStoredCode) {
              isValid = userCode === adminStoredCode;
              if (!isValid) {
                alert("âŒ é©—è­‰ç¢¼éŒ¯èª¤");
                document.getElementById("adminVerificationCode").value = "";
                return;
              }
            }

            try {
              const response = await fetch(`${API_BASE}/auth/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  email: adminVerificationEmail,
                  login_type: "password",
                  verify: isValid,
                }),
              });

              if (response.ok) {
                const data = await response.json();

                // æª¢æŸ¥æ¬Šé™
                if (
                  data.user.role !== "reviewer" &&
                  data.user.role !== "admin"
                ) {
                  alert("âŒ æ­¤å¸³è™Ÿæ²’æœ‰ç®¡ç†æ¬Šé™");
                  return;
                }

                accessToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem("admin_token", accessToken);
                localStorage.setItem("admin_user", JSON.stringify(currentUser));

                // æ¸…é™¤è¨ˆæ™‚å™¨
                if (adminCountdownTimer) clearInterval(adminCountdownTimer);
                if (adminResendTimer) clearInterval(adminResendTimer);

                location.reload();
              } else {
                const error = await response.json();
                alert(
                  "ç™»å…¥å¤±æ•—ï¼š" +
                    (error.detail?.message || error.detail || "è«‹ç¨å¾Œå†è©¦")
                );
              }
            } catch (error) {
              console.error("ç™»å…¥éŒ¯èª¤:", error);
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });

        // é‡æ–°ç™¼é€é©—è­‰ç¢¼
        document
          .getElementById("btnResendAdmin")
          .addEventListener("click", async () => {
            if (!adminVerificationEmail) return;

            try {
              const response = await fetch(`${API_BASE}/auth/email/resend`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: adminVerificationEmail }),
              });

              if (response.ok) {
                const data = await response.json();
                adminStoredCode = data.verification_code || null;

                alert("âœ… é©—è­‰ç¢¼å·²é‡æ–°ç™¼é€ï¼");
                if (adminStoredCode) {
                  console.log("ğŸ”‘ ç®¡ç†å“¡é©—è­‰ç¢¼ï¼ˆé–‹ç™¼ç”¨ï¼‰:", adminStoredCode);
                }

                if (adminCountdownTimer) clearInterval(adminCountdownTimer);
                if (adminResendTimer) clearInterval(adminResendTimer);
                startAdminCountdown(180);
                startAdminResendCountdown(60);
              } else {
                alert("é‡ç™¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
              }
            } catch (error) {
              alert("ç¶²è·¯éŒ¯èª¤ï¼š" + error.message);
            }
          });

        // è¿”å›ä¿®æ”¹ Email
        document
          .getElementById("btnBackToEmail")
          .addEventListener("click", () => {
            if (adminCountdownTimer) clearInterval(adminCountdownTimer);
            if (adminResendTimer) clearInterval(adminResendTimer);
            adminStoredCode = null;
            adminVerificationEmail = null;
            document.getElementById("adminVerificationCode").value = "";
            document.getElementById("adminVerificationStep").style.display =
              "none";
            document.getElementById("adminEmailStep").style.display = "block";
          });

        // å€’æ•¸è¨ˆæ™‚å‡½æ•¸
        function startAdminCountdown(seconds) {
          let remaining = seconds;
          const updateDisplay = () => {
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            document.getElementById(
              "adminCountdown"
            ).textContent = `${mins}:${secs.toString().padStart(2, "0")}`;
          };
          updateDisplay();
          adminCountdownTimer = setInterval(() => {
            remaining--;
            updateDisplay();
            if (remaining <= 0) {
              clearInterval(adminCountdownTimer);
              alert("é©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°ç™¼é€");
              document.getElementById("btnBackToEmail").click();
            }
          }, 1000);
        }

        function startAdminResendCountdown(seconds) {
          let remaining = seconds;
          const btn = document.getElementById("btnResendAdmin");
          const countdown = document.getElementById("adminResendCountdown");
          btn.disabled = true;
          const updateDisplay = () => {
            countdown.textContent = remaining;
          };
          updateDisplay();
          adminResendTimer = setInterval(() => {
            remaining--;
            updateDisplay();
            if (remaining <= 0) {
              clearInterval(adminResendTimer);
              btn.disabled = false;
              btn.innerHTML = "é‡æ–°ç™¼é€é©—è­‰ç¢¼";
            }
          }, 1000);
        }
      }

      function initDashboard() {
        document.getElementById("adminName").textContent =
          currentUser.full_name;
        document.getElementById("adminAvatar").textContent =
          currentUser.full_name.charAt(0);
        loadDashboardStats();
        loadPendingApplications();
      }

      function showPage(page) {
        [
          "dashboard-page",
          "applications-page",
          "map-page",
          "history-page",
          "statistics-page",
        ].forEach((id) => {
          document.getElementById(id).classList.add("hidden");
        });
        document.getElementById(`${page}-page`).classList.remove("hidden");

        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        event.target.classList.add("active");

        if (page === "statistics") {
          loadStatistics();
        } else if (page === "map") {
          // åˆå§‹åŒ–åœ°åœ–ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
          if (!map) {
            setTimeout(() => {
              initializeMap();
            }, 100);
          }
        }
      }

      async function loadDashboardStats() {
        const result = await fetch(`${API_BASE}/applications/status/pending`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        if (result.ok) {
          const response = await result.json();

          // è™•ç†ä¸åŒçš„å›æ‡‰æ ¼å¼
          let apps = [];
          if (Array.isArray(response)) {
            apps = response;
          } else if (response.data) {
            // è™•ç†åµŒå¥—çµæ§‹: {data: {applications: [...]}}
            if (
              response.data.applications &&
              Array.isArray(response.data.applications)
            ) {
              apps = response.data.applications;
            } else if (Array.isArray(response.data)) {
              apps = response.data;
            } else {
              apps = [response.data];
            }
          } else if (response.applications) {
            apps = Array.isArray(response.applications)
              ? response.applications
              : [response.applications];
          }

          document.getElementById("statPending").textContent = apps.length;

          // ç°¡å–®çµ±è¨ˆ
          let totalAmount = 0;
          apps.forEach((app) => {
            totalAmount += app.requested_amount || 0;
          });
          document.getElementById("statTotal").textContent = `$${(
            totalAmount / 10000
          ).toFixed(1)}è¬`;
        }
      }

      async function loadPendingApplications() {
        const result = await fetch(`${API_BASE}/applications/status/pending`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        if (result.ok) {
          const response = await result.json();
          console.log("API Response:", response); // é™¤éŒ¯ç”¨

          // è™•ç†ä¸åŒçš„å›æ‡‰æ ¼å¼
          let apps = [];
          if (Array.isArray(response)) {
            apps = response;
          } else if (response.data) {
            // è™•ç†åµŒå¥—çµæ§‹: {data: {applications: [...]}}
            if (
              response.data.applications &&
              Array.isArray(response.data.applications)
            ) {
              apps = response.data.applications;
            } else if (Array.isArray(response.data)) {
              apps = response.data;
            } else {
              apps = [response.data];
            }
          } else if (response.applications) {
            apps = Array.isArray(response.applications)
              ? response.applications
              : [response.applications];
          }

          console.log("Parsed apps:", apps); // é™¤éŒ¯ç”¨
          displayApplications(apps, "recentApplications");
          displayApplications(apps, "applicationsList");
        }
      }

      function displayApplications(apps, containerId) {
        const container = document.getElementById(containerId);

        if (apps.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸æ¡ˆä»¶</p></div>';
          return;
        }

        const html = `
                <table>
                    <thead>
                        <tr>
                            <th>æ¡ˆä»¶ç·¨è™Ÿ</th>
                            <th>ç”³è«‹äºº</th>
                            <th>ç½å®³é¡å‹</th>
                            <th>ç”³è«‹é‡‘é¡</th>
                            <th>æäº¤æ™‚é–“</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${apps
                          .map(
                            (app) => `
                            <tr>
                                <td><strong>${app.case_no}</strong></td>
                                <td>${app.applicant_name}</td>
                                <td>${getDisasterTypeText(
                                  app.disaster_type
                                )}</td>
                                <td>NT$ ${app.requested_amount?.toLocaleString()}</td>
                                <td>${new Date(
                                  app.submitted_at
                                ).toLocaleDateString()}</td>
                                <td><span class="badge ${
                                  app.status
                                }">${getStatusText(app.status)}</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick='openReviewModal(${JSON.stringify(
                                      app
                                    )})'>
                                        å¯©æ ¸
                                    </button>
                                </td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
        container.innerHTML = html;
      }

      async function openReviewModal(app) {
        currentApplication = app;

        document.getElementById("applicantInfo").innerHTML = `
                <div class="info-row">
                    <div class="info-label">å§“å</div>
                    <div class="info-value">${app.applicant_name}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">èº«åˆ†è­‰å­—è™Ÿ</div>
                    <div class="info-value">${app.id_number}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">é›»è©±</div>
                    <div class="info-value">${app.phone}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">è¯çµ¡åœ°å€</div>
                    <div class="info-value">${app.address || "æœªæä¾›"}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç½æåœ°é»</div>
                    <div class="info-value">${
                      app.damage_location || "æœªæä¾›"
                    }</div>
                </div>
            `;

        document.getElementById("disasterInfo").innerHTML = `
                <div class="info-row">
                    <div class="info-label">ç½å®³æ—¥æœŸ</div>
                    <div class="info-value">${app.disaster_date}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç½å®³é¡å‹</div>
                    <div class="info-value">${getDisasterTypeText(
                      app.disaster_type
                    )}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç½ææè¿°</div>
                    <div class="info-value">${app.damage_description}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ç”³è«‹é‡‘é¡</div>
                    <div class="info-value">NT$ ${app.requested_amount?.toLocaleString()}</div>
                </div>
            `;

        document.getElementById("approvedAmount").value = app.requested_amount;

        // è¼‰å…¥è­‰æ˜æ–‡ä»¶
        await loadApplicationDocuments(app.id);

        document.getElementById("reviewModal").classList.add("show");
      }

      function closeReviewModal() {
        document.getElementById("reviewModal").classList.remove("show");
        currentApplication = null;
      }

      async function approveApplication() {
        const amount = document.getElementById("approvedAmount").value;
        const comments = document.getElementById("reviewComments").value;

        if (!amount) {
          alert("è«‹è¼¸å…¥æ ¸å‡†é‡‘é¡");
          return;
        }

        // ä½¿ç”¨æ–°çš„å®Œæ•´æµç¨‹ APIï¼ˆæ•´åˆæ”¿åºœç™¼è¡Œç«¯ï¼‰
        try {
          const result = await fetch(`/api/v1/complete-flow/review-and-issue`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              application_id: currentApplication.id,
              approved: true,
              review_notes: comments,
              approved_amount: amount,
            }),
          });

          const data = await result.json();
          console.log("å¯©æ ¸å›æ‡‰æ•¸æ“š:", data); // èª¿è©¦ç”¨
          console.log("data.qr_code å­˜åœ¨?", !!data.qr_code);
          console.log("data.qr_code é¡å‹:", typeof data.qr_code);
          console.log("data æ‰€æœ‰éµ:", Object.keys(data));

          if (data.success) {
            // é¡¯ç¤º QR Code çµ¦ç½æ°‘
            showQRCodeModal(data);

            closeReviewModal();
            loadDashboardStats();
            loadPendingApplications();
          } else {
            alert(`æ“ä½œå¤±æ•—ï¼š${data.message || "è«‹ç¨å¾Œå†è©¦"}`);
          }
        } catch (error) {
          console.error("å¯©æ ¸éŒ¯èª¤:", error);
          alert(`ç³»çµ±éŒ¯èª¤ï¼š${error.message}`);
        }
      }

      // é¡¯ç¤º QR Code çµ¦ç½æ°‘æƒæ
      function showQRCodeModal(data) {
        console.log("QR Code Modal æ•¸æ“š:", data); // èª¿è©¦ç”¨
        console.log("qr_code å­˜åœ¨å—?", !!data.qr_code); // èª¿è©¦ç”¨
        console.log("qr_code é•·åº¦:", data.qr_code?.length); // èª¿è©¦ç”¨

        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";

        const qrCodeDisplay = data.qr_code
          ? `<img src="${data.qr_code}" style="max-width: 300px; border: 3px solid #4CAF50; border-radius: 10px; padding: 10px;" onload="console.log('QR Code åœ–ç‰‡è¼‰å…¥æˆåŠŸ')" onerror="console.error('QR Code åœ–ç‰‡è¼‰å…¥å¤±æ•—')">`
          : `<div style="padding: 20px; background: #f0f0f0; border-radius: 10px;">âŒ QR Code æœªç”Ÿæˆ<br>Transaction ID: ${data.transaction_id}</div>`;

        modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2 style="color: #4CAF50;">âœ… æ ¸å‡†æˆåŠŸï¼</h2>
                    <div style="text-align: center; margin: 30px 0;">
                        <h3>æ•¸ä½æ†‘è­‰ QR Code</h3>
                        <p style="color: #666; margin: 10px 0;">è«‹è½‰ç™¼çµ¦ç½æ°‘æƒæ</p>
                        ${qrCodeDisplay}
                        <p style="margin-top: 15px; font-size: 14px; color: #888;">
                            Transaction ID: ${data.transaction_id || "N/A"}
                        </p>
                        ${
                          data.deep_link &&
                          data.deep_link.startsWith("twfido://")
                            ? `
                            <a href="${data.deep_link}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px;">
                                ğŸ“± é–‹å•Ÿæ•¸ä½æ†‘è­‰ APP
                            </a>
                        `
                            : ""
                        }
                        ${
                          data.deep_link &&
                          !data.deep_link.startsWith("twfido://")
                            ? `
                            <p style="margin-top: 10px; font-size: 12px; color: #999;">Deep Link: ${data.deep_link.substring(
                              0,
                              50
                            )}...</p>
                        `
                            : ""
                        }
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>ğŸ“± ç½æ°‘æ“ä½œæ­¥é©Ÿï¼š</strong>
                        <ol style="margin: 10px 0 0 20px; text-align: left;">
                            <li>æ‰“é–‹ã€ŒTW FidO æ•¸ä½æ†‘è­‰çš®å¤¾ã€APP</li>
                            <li>æƒææ­¤ QR Code</li>
                            <li>ç¢ºèªä¸¦å„²å­˜æ†‘è­‰</li>
                            <li>åˆ° 7-11 æ©Ÿå°é ˜å–è£œåŠ©</li>
                        </ol>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; font-size: 16px;">
                        é—œé–‰
                    </button>
                </div>
            `;

        document.body.appendChild(modal);
      }

      async function rejectApplication() {
        const comments = document.getElementById("reviewComments").value;

        if (!comments) {
          alert("è«‹å¡«å¯«é§å›åŸå› ");
          return;
        }

        const result = await fetch(
          `${API_BASE}/reviews/reject/${currentApplication.id}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({
              rejection_reason: comments,
              comments: comments,
            }),
          }
        );

        if (result.ok) {
          alert("âŒ å·²é§å›ç”³è«‹");
          closeReviewModal();
          loadDashboardStats();
          loadPendingApplications();
        } else {
          alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      function loadStatistics() {
        document.getElementById("statisticsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <p>çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            `;
      }

      function logout() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          localStorage.removeItem("admin_token");
          localStorage.removeItem("admin_user");
          location.reload();
        }
      }

      function getStatusText(status) {
        const map = {
          pending: "å¾…å¯©æ ¸",
          under_review: "å¯©æ ¸ä¸­",
          approved: "å·²æ ¸å‡†",
          rejected: "å·²é§å›",
        };
        return map[status] || status;
      }

      function getDisasterTypeText(type) {
        const map = {
          flood: "æ°´ç½",
          typhoon: "é¢±é¢¨",
          earthquake: "åœ°éœ‡",
          other: "å…¶ä»–",
        };
        return map[type] || type;
      }

      // ============================================
      // Google Maps åŠŸèƒ½
      // ============================================
      let map = null;
      let markers = [];
      let selectedApplications = [];
      let allMapApplications = [];
      let directionsService = null;
      let directionsRenderers = [];

      // åˆå§‹åŒ–åœ°åœ–
      function initializeMap() {
        // é è¨­ä¸­å¿ƒé»ï¼ˆå°å—å¸‚æ”¿åºœï¼‰
        const defaultCenter = { lat: 22.9917, lng: 120.2009 };

        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultCenter,
          zoom: 13,
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
        });

        directionsService = new google.maps.DirectionsService();

        console.log("åœ°åœ–åˆå§‹åŒ–å®Œæˆ");
      }

      // è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨ï¼ˆç”¨æ–¼åœ°åœ–é¸æ“‡ï¼‰
      async function loadMapApplications() {
        try {
          // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰ district_id
          if (!currentUser.district_id) {
            console.warn("ä½¿ç”¨è€…æ²’æœ‰ district_idï¼Œç„¡æ³•è¼‰å…¥æ¡ˆä»¶");
            document.getElementById("mapApplicationsList").innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <p style="color: #ff9800; margin-bottom: 10px;">âš ï¸ æ‚¨çš„å¸³è™Ÿå°šæœªè¨­å®šç®¡è½„å€åŸŸ</p>
                            <p style="color: #999; font-size: 14px;">è«‹è¯ç¹«ç®¡ç†å“¡è¨­å®šæ‚¨çš„ç®¡è½„å€åŸŸ</p>
                        </div>
                    `;
            return;
          }

          const response = await fetch(
            `${API_BASE}/applications/district/${currentUser.district_id}`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          if (response.ok) {
            const data = await response.json();
            allMapApplications = data.data?.applications || data.data || [];
            displayMapApplicationsList();
          } else {
            alert("è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨å¤±æ•—");
          }
        } catch (error) {
          console.error("Error loading map applications:", error);
          alert("è¼‰å…¥å¤±æ•—ï¼š" + error.message);
        }
      }

      // é¡¯ç¤ºæ¡ˆä»¶åˆ—è¡¨ï¼ˆå‹¾é¸æ¡†ï¼‰
      function displayMapApplicationsList() {
        const container = document.getElementById("mapApplicationsList");

        if (allMapApplications.length === 0) {
          container.innerHTML = `
                    <p style="color: #999; text-align: center; padding: 20px;">
                        ç›®å‰æ²’æœ‰å¯ç”¨çš„æ¡ˆä»¶
                    </p>
                `;
          return;
        }

        container.innerHTML = allMapApplications
          .map(
            (app) => `
                <div class="application-item-checkbox" onclick="toggleApplicationSelection('${
                  app.id
                }')">
                    <input type="checkbox" 
                           id="app_${app.id}" 
                           value="${app.id}"
                           ${
                             selectedApplications.includes(app.id)
                               ? "checked"
                               : ""
                           }
                           onclick="event.stopPropagation()">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: 5px;">
                            ${app.case_no} - ${app.applicant_name}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            ğŸ“ ${
                              app.damage_location || app.address || "åœ°å€æœªæä¾›"
                            }
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 3px;">
                            ${getDisasterTypeText(app.disaster_type)} | 
                            ç”³è«‹é‡‘é¡: NT$ ${app.requested_amount?.toLocaleString()}
                        </div>
                    </div>
                    <span class="badge ${app.status}">${getStatusText(
              app.status
            )}</span>
                </div>
            `
          )
          .join("");

        updateSelectedCount();
      }

      // åˆ‡æ›æ¡ˆä»¶é¸æ“‡ç‹€æ…‹
      function toggleApplicationSelection(appId) {
        const checkbox = document.getElementById(`app_${appId}`);
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
          if (!selectedApplications.includes(appId)) {
            selectedApplications.push(appId);
          }
        } else {
          selectedApplications = selectedApplications.filter(
            (id) => id !== appId
          );
        }

        updateSelectedCount();
      }

      // æ›´æ–°é¸æ“‡æ•¸é‡
      function updateSelectedCount() {
        document.getElementById("selectedCount").textContent =
          selectedApplications.length;
      }

      // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºé¸ä¸­çš„æ¡ˆä»¶
      async function showSelectedOnMap() {
        if (selectedApplications.length === 0) {
          alert("è«‹å…ˆé¸æ“‡è¦æŸ¥çœ‹çš„æ¡ˆä»¶");
          return;
        }

        // åˆå§‹åŒ–åœ°åœ–ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
        if (!map) {
          initializeMap();
        }

        // æ¸…é™¤èˆŠçš„æ¨™è¨˜
        clearMarkers();

        try {
          // å–å¾—æ¡ˆä»¶çš„åœ°ç†ä½ç½®è³‡è¨Š
          const response = await fetch(
            `${API_BASE}/maps/applications-map-data`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({
                application_ids: selectedApplications,
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            const applications = data.applications;

            if (applications.length === 0) {
              alert("æ²’æœ‰å¯é¡¯ç¤ºçš„æ¡ˆä»¶ä½ç½®");
              return;
            }

            // å»ºç«‹åœ°åœ–é‚Šç•Œ
            const bounds = new google.maps.LatLngBounds();

            // ç‚ºæ¯å€‹æ¡ˆä»¶å»ºç«‹æ¨™è¨˜
            applications.forEach((app, index) => {
              if (app.latitude && app.longitude) {
                const position = {
                  lat: parseFloat(app.latitude),
                  lng: parseFloat(app.longitude),
                };

                // å»ºç«‹æ¨™è¨˜
                const marker = new google.maps.Marker({
                  position: position,
                  map: map,
                  title: app.case_no,
                  label: {
                    text: (index + 1).toString(),
                    color: "white",
                  },
                  animation: google.maps.Animation.DROP,
                });

                // å»ºç«‹è³‡è¨Šè¦–çª—
                const infoWindow = new google.maps.InfoWindow({
                  content: `
                                    <div style="padding: 10px; min-width: 200px;">
                                        <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">
                                            ${app.case_no}
                                        </h3>
                                        <p style="margin: 5px 0;"><strong>ç”³è«‹äºº:</strong> ${
                                          app.applicant_name
                                        }</p>
                                        <p style="margin: 5px 0;"><strong>ç½æåœ°é»:</strong> ${
                                          app.damage_location ||
                                          app.address ||
                                          "æœªæä¾›"
                                        }</p>
                                        <p style="margin: 5px 0;"><strong>ç½å®³é¡å‹:</strong> ${getDisasterTypeText(
                                          app.disaster_type
                                        )}</p>
                                        <p style="margin: 5px 0;"><strong>ç”³è«‹é‡‘é¡:</strong> NT$ ${app.requested_amount?.toLocaleString()}</p>
                                        <p style="margin: 5px 0;">
                                            <span class="badge ${
                                              app.status
                                            }">${getStatusText(
                    app.status
                  )}</span>
                                        </p>
                                    </div>
                                `,
                });

                // é»æ“Šæ¨™è¨˜æ™‚é¡¯ç¤ºè³‡è¨Š
                marker.addListener("click", () => {
                  // é—œé–‰æ‰€æœ‰å…¶ä»–è³‡è¨Šè¦–çª—
                  markers.forEach((m) => {
                    if (m.infoWindow) {
                      m.infoWindow.close();
                    }
                  });

                  infoWindow.open(map, marker);
                });

                marker.infoWindow = infoWindow;
                markers.push(marker);
                bounds.extend(position);
              }
            });

            // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
            map.fitBounds(bounds);

            alert(`âœ… å·²åœ¨åœ°åœ–ä¸Šæ¨™ç¤º ${applications.length} å€‹æ¡ˆä»¶ä½ç½®`);
          } else {
            alert("å–å¾—ä½ç½®è³‡è¨Šå¤±æ•—");
          }
        } catch (error) {
          console.error("Error showing on map:", error);
          alert("é¡¯ç¤ºå¤±æ•—ï¼š" + error.message);
        }
      }

      // æ¸…é™¤åœ°åœ–æ¨™è¨˜
      function clearMarkers() {
        markers.forEach((marker) => marker.setMap(null));
        markers = [];
      }

      // æ¸…é™¤è·¯ç·šæ¸²æŸ“
      function clearDirectionsRenderers() {
        directionsRenderers.forEach((renderer) => renderer.setMap(null));
        directionsRenderers = [];
      }

      // è¦åŠƒæœ€ä½³è·¯ç·š
      async function planRoutes() {
        console.log("ğŸš€ é–‹å§‹è¦åŠƒè·¯ç·š...");
        console.log("ğŸ“Š ç•¶å‰ç‹€æ…‹:", {
          selectedApplications: selectedApplications,
          selectedCount: selectedApplications.length,
          allMapApplications: allMapApplications,
          allMapCount: allMapApplications.length,
        });

        if (selectedApplications.length < 2) {
          alert("è«‹è‡³å°‘é¸æ“‡ 2 å€‹æ¡ˆä»¶æ‰èƒ½è¦åŠƒè·¯ç·š");
          return;
        }

        if (selectedApplications.length > 10) {
          alert("ä¸€æ¬¡æœ€å¤šåªèƒ½è¦åŠƒ 10 å€‹åœ°é»çš„è·¯ç·š");
          return;
        }

        try {
          // é¡¯ç¤ºè¼‰å…¥ä¸­
          document.getElementById("routesList").innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—ºï¸</div>
                        <p style="color: #666;">æ­£åœ¨è¨ˆç®—æœ€ä½³è·¯ç·š...</p>
                        <p style="color: #999; font-size: 14px;">é€™å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
                    </div>
                `;
          document.getElementById("routesContainer").classList.remove("hidden");

          // ç›´æ¥å¾å·²è¼‰å…¥çš„æ¡ˆä»¶åˆ—è¡¨ä¸­å–å¾—é¸ä¸­çš„æ¡ˆä»¶
          const applications = allMapApplications.filter((app) =>
            selectedApplications.includes(app.id)
          );

          console.log("âœ… é¸ä¸­çš„æ¡ˆä»¶:", {
            total: applications.length,
            selectedIds: selectedApplications,
            matchedApps: applications.map((a) => ({
              id: a.id,
              case_no: a.case_no,
              address: a.address,
              damage_location: a.damage_location,
            })),
          });

          // é©—è­‰æ¡ˆä»¶è³‡æ–™
          if (!applications || applications.length === 0) {
            throw new Error("æ²’æœ‰æ‰¾åˆ°é¸ä¸­çš„æ¡ˆä»¶è³‡æ–™");
          }

          // æå–åœ°å€ï¼Œéæ¿¾æ‰ç©ºå€¼
          const destinations = applications
            .map((app) => {
              const addr =
                app.damage_location || app.address || app.formatted_address;
              console.log(`ğŸ“Œ æ¡ˆä»¶ ${app.case_no}:`, {
                damage_location: app.damage_location,
                address: app.address,
                formatted_address: app.formatted_address,
                selected: addr,
              });
              return addr;
            })
            .filter((addr) => addr && addr.trim().length > 0);

          // é©—è­‰ç›®çš„åœ°
          if (destinations.length === 0) {
            throw new Error(
              `âŒ æ‰€æœ‰ ${applications.length} å€‹æ¡ˆä»¶éƒ½æ²’æœ‰åœ°å€è³‡è¨Šï¼\n\n` +
                `è«‹æª¢æŸ¥æ¡ˆä»¶è³‡æ–™ï¼š\n` +
                applications
                  .map(
                    (a) =>
                      `- ${a.case_no}: damage_location=${a.damage_location}, address=${a.address}`
                  )
                  .join("\n")
            );
          }

          console.log("ğŸ“ è·¯ç·šè¦åŠƒè³‡æ–™:", {
            applications: applications.length,
            destinations: destinations,
            selectedApplications,
            currentUser: currentUser,
          });

          // ä½¿ç”¨é‡Œé•·æ‰€åœ¨å€åŸŸè¾¦å…¬è™•ä½œç‚ºèµ·é»ï¼ˆæˆ–ä½¿ç”¨ç¬¬ä¸€å€‹æ¡ˆä»¶åœ°å€ï¼‰
          let startLocation = destinations[0]; // é è¨­ä½¿ç”¨ç¬¬ä¸€å€‹æ¡ˆä»¶åœ°å€

          if (currentUser && currentUser.district_name) {
            startLocation = `${currentUser.district_name}è¾¦å…¬è™•`;
            console.log("âœ“ ä½¿ç”¨å€åŸŸè¾¦å…¬è™•ä½œç‚ºèµ·é»:", startLocation);
          } else {
            console.log(
              "âš ï¸ æœªè¨­å®šå€åŸŸï¼Œä½¿ç”¨ç¬¬ä¸€å€‹æ¡ˆä»¶åœ°å€ä½œç‚ºèµ·é»:",
              startLocation
            );
          }

          // æº–å‚™è«‹æ±‚è³‡æ–™
          const requestData = {
            start_location: startLocation,
            destinations: destinations,
            mode: "driving",
          };

          console.log("ğŸš— ç™¼é€è·¯ç·šè¦åŠƒè«‹æ±‚:", requestData);

          // å‘¼å«è·¯ç·šè¦åŠƒ API
          const routeResponse = await fetch(`${API_BASE}/maps/optimal-routes`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify(requestData),
          });

          if (!routeResponse.ok) {
            const errorData = await routeResponse.json().catch(() => ({}));
            console.error("è·¯ç·šè¦åŠƒéŒ¯èª¤:", {
              status: routeResponse.status,
              statusText: routeResponse.statusText,
              error: errorData,
            });

            // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
            let errorMessage = errorData.detail || "è·¯ç·šè¦åŠƒå¤±æ•—";
            if (Array.isArray(errorData.detail)) {
              errorMessage = errorData.detail
                .map((e) => `${e.loc?.join(".")}: ${e.msg}`)
                .join("\\n");
            }

            throw new Error(errorMessage);
          }

          const routeData = await routeResponse.json();
          console.log("âœ… è·¯ç·šè¦åŠƒæˆåŠŸ:", routeData);
          displayRoutes(routeData.routes, applications);
        } catch (error) {
          console.error("Error planning routes:", error);
          document.getElementById("routesList").innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <p style="color: #ef4444; font-weight: bold; margin-bottom: 10px;">è·¯ç·šè¦åŠƒå¤±æ•—</p>
                        <p style="color: #666; margin-top: 8px; white-space: pre-wrap;">${error.message}</p>
                        <button onclick="document.getElementById('routesContainer').classList.add('hidden')" 
                                style="margin-top: 20px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            é—œé–‰
                        </button>
                    </div>
                `;
        }
      }

      // é¡¯ç¤ºè·¯ç·šè¦åŠƒçµæœ
      function displayRoutes(routes, applications) {
        if (!routes || routes.length === 0) {
          document.getElementById("routesList").innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #999;">æ²’æœ‰æ‰¾åˆ°å¯ç”¨çš„è·¯ç·š</p>
                    </div>
                `;
          return;
        }

        const routesHtml = routes
          .slice(0, 3)
          .map((route) => {
            const waypointInfo = route.ordered_addresses
              .map((addr, idx) => {
                const app = applications.find(
                  (a) => a.formatted_address === addr || a.address === addr
                );
                return `
                        <li class="waypoint-item">
                            <strong>ç¬¬ ${idx + 1} ç«™</strong> - ${
                  app?.applicant_name || "æœªçŸ¥"
                }
                            <div style="font-size: 13px; color: #666; margin-top: 3px;">
                                ${addr}
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 3px;">
                                ${app?.case_no || ""} | ${getDisasterTypeText(
                  app?.disaster_type
                )}
                            </div>
                        </li>
                    `;
              })
              .join("");

            return `
                    <div class="route-card rank-${route.rank}">
                        <div class="route-header">
                            <div class="route-rank rank-${route.rank}">
                                ${
                                  route.rank === 1
                                    ? "ğŸ¥‡"
                                    : route.rank === 2
                                    ? "ğŸ¥ˆ"
                                    : "ğŸ¥‰"
                                }
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #333;">
                                    ${
                                      route.rank === 1
                                        ? "æœ€ä½³è·¯ç·š"
                                        : route.rank === 2
                                        ? "æ¬¡ä½³è·¯ç·š"
                                        : "ç¬¬ä¸‰è·¯ç·š"
                                    }
                                </h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                    å…± ${
                                      route.ordered_addresses.length
                                    } å€‹è¨ªå•åœ°é»
                                </p>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="showRouteOnMap(${
                              route.rank - 1
                            })">
                                åœ¨åœ°åœ–ä¸Šé¡¯ç¤º
                            </button>
                        </div>

                        <div class="route-stats">
                            <div class="route-stat">
                                <div class="route-stat-label">ç¸½è·é›¢</div>
                                <div class="route-stat-value">${
                                  route.total_distance.text
                                }</div>
                            </div>
                            <div class="route-stat">
                                <div class="route-stat-label">é ä¼°æ™‚é–“</div>
                                <div class="route-stat-value">${
                                  route.total_duration.text
                                }</div>
                            </div>
                            <div class="route-stat">
                                <div class="route-stat-label">è¨ªå•é †åº</div>
                                <div class="route-stat-value">${route.waypoint_order
                                  .map((i) => i + 1)
                                  .join(" â†’ ")}</div>
                            </div>
                        </div>

                        <div>
                            <h4 style="margin: 15px 0 10px 0; color: #666; font-size: 14px;">ğŸ“ è¨ªå•é †åºï¼š</h4>
                            <ul class="waypoint-list">
                                ${waypointInfo}
                            </ul>
                        </div>
                    </div>
                `;
          })
          .join("");

        document.getElementById("routesList").innerHTML = routesHtml;
      }

      // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºç‰¹å®šè·¯ç·š
      async function showRouteOnMap(routeIndex) {
        if (!map) {
          initializeMap();
        }

        // æ¸…é™¤èˆŠçš„è·¯ç·š
        clearDirectionsRenderers();

        try {
          // å–å¾—è·¯ç·šè³‡æ–™
          const response = await fetch(
            `${API_BASE}/maps/applications-map-data`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({
                application_ids: selectedApplications,
              }),
            }
          );

          if (!response.ok) {
            throw new Error("å–å¾—æ¡ˆä»¶è³‡æ–™å¤±æ•—");
          }

          const data = await response.json();
          const applications = data.applications;
          const destinations = applications.map(
            (app) => app.formatted_address || app.address
          );

          // ä½¿ç”¨é‡Œé•·æ‰€åœ¨å€åŸŸè¾¦å…¬è™•ä½œç‚ºèµ·é»
          const startLocation = currentUser.district_name
            ? `å°å—å¸‚${currentUser.district_name}è¾¦å…¬è™•`
            : destinations[0];

          // é‡æ–°è¨ˆç®—è·¯ç·šä»¥å–å¾—å®Œæ•´çš„è·¯ç·šè³‡æ–™
          const routeResponse = await fetch(`${API_BASE}/maps/optimal-routes`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({
              start_location: startLocation,
              destinations: destinations,
              mode: "driving",
            }),
          });

          if (!routeResponse.ok) {
            throw new Error("è·¯ç·šè¦åŠƒå¤±æ•—");
          }

          const routeData = await routeResponse.json();
          const selectedRoute = routeData.routes[routeIndex];

          if (!selectedRoute) {
            throw new Error("æ‰¾ä¸åˆ°æŒ‡å®šçš„è·¯ç·š");
          }

          // å»ºç«‹è·¯ç·šæ¸²æŸ“å™¨
          const directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false, // é¡¯ç¤ºèµ·é»çµ‚é»æ¨™è¨˜
            polylineOptions: {
              strokeColor:
                routeIndex === 0
                  ? "#10b981"
                  : routeIndex === 1
                  ? "#3b82f6"
                  : "#f59e0b",
              strokeWeight: 6,
              strokeOpacity: 0.8,
            },
          });

          // å»ºç«‹è·¯ç·šè«‹æ±‚
          const waypoints = selectedRoute.ordered_addresses
            .slice(0, -1)
            .map((addr) => ({
              location: addr,
              stopover: true,
            }));

          const request = {
            origin: startLocation,
            destination:
              selectedRoute.ordered_addresses[
                selectedRoute.ordered_addresses.length - 1
              ],
            waypoints: waypoints,
            travelMode: google.maps.TravelMode.DRIVING,
            optimizeWaypoints: false, // å·²ç¶“æœ€ä½³åŒ–éäº†
          };

          // ç¹ªè£½è·¯ç·š
          directionsService.route(request, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
              directionsRenderer.setDirections(result);
              directionsRenderers.push(directionsRenderer);

              // æç¤ºæˆåŠŸ
              const routeName =
                routeIndex === 0
                  ? "æœ€ä½³è·¯ç·š"
                  : routeIndex === 1
                  ? "æ¬¡ä½³è·¯ç·š"
                  : "ç¬¬ä¸‰è·¯ç·š";
              alert(
                `âœ… ${routeName}å·²é¡¯ç¤ºåœ¨åœ°åœ–ä¸Š\n\n` +
                  `ç¸½è·é›¢: ${selectedRoute.total_distance.text}\n` +
                  `é ä¼°æ™‚é–“: ${selectedRoute.total_duration.text}`
              );
            } else {
              console.error("è·¯ç·šç¹ªè£½å¤±æ•—:", status);
              alert("è·¯ç·šç¹ªè£½å¤±æ•—ï¼š" + status);
            }
          });
        } catch (error) {
          console.error("Error showing route on map:", error);
          alert("é¡¯ç¤ºè·¯ç·šå¤±æ•—ï¼š" + error.message);
        }
      }

      // æ¸…é™¤åœ°åœ–é¸æ“‡
      function clearMapSelection() {
        selectedApplications = [];
        const checkboxes = document.querySelectorAll(
          '#mapApplicationsList input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = false));
        updateSelectedCount();
        clearMarkers();
        clearDirectionsRenderers();
        document.getElementById("routesContainer").classList.add("hidden");
      }

      // ============================================
      // æ–‡ä»¶ç®¡ç†åŠŸèƒ½
      // ============================================

      async function loadApplicationDocuments(applicationId) {
        const documentsContainer = document.getElementById("documentsInfo");
        documentsContainer.innerHTML =
          '<p style="color: #999; font-size: 14px;">è¼‰å…¥ä¸­...</p>';

        try {
          const response = await fetch(
            `${API_BASE}/documents/application/${applicationId}`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          if (response.ok) {
            const result = await response.json();
            const documents = result.data?.documents || [];

            if (documents.length === 0) {
              documentsContainer.innerHTML = `
                            <div style="padding: 20px; text-align: center; background: #f9fafb; border-radius: 8px; color: #999;">
                                ğŸ“„ æ­¤æ¡ˆä»¶æš«ç„¡ä¸Šå‚³è­‰æ˜æ–‡ä»¶
                            </div>
                        `;
              return;
            }

            // é¡¯ç¤ºæ–‡ä»¶åˆ—è¡¨
            const html = documents
              .map((doc) => {
                const sizeInMB = (doc.file_size / (1024 * 1024)).toFixed(2);
                const icon = getDocumentIcon(doc.file_name);
                const isDocx =
                  doc.mime_type ===
                  "application/vnd.openxmlformats-officedocument.wordprocessingml.document";

                return `
                            <div style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 32px; margin-right: 15px;">${icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #333; margin-bottom: 4px;">${
                                      doc.file_name
                                    }</div>
                                    <div style="font-size: 12px; color: #666;">
                                        ${sizeInMB} MB Â· ${getDocumentTypeText(
                  doc.document_type
                )} Â· ${new Date(doc.uploaded_at).toLocaleString()}
                                    </div>
                                    ${
                                      doc.description
                                        ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">ğŸ“ ${doc.description}</div>`
                                        : ""
                                    }
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${
                                      isDocx
                                        ? `
                                        <button class="btn btn-sm" onclick="previewDocument('${doc.id}', '${doc.file_name}')" style="background: #3b82f6; color: white;" title="é è¦½ï¼ˆè‡ªå‹•è½‰ PDFï¼‰">
                                            ğŸ‘ï¸ é è¦½
                                        </button>
                                    `
                                        : doc.mime_type.startsWith("image/") ||
                                          doc.mime_type === "application/pdf"
                                        ? `
                                        <button class="btn btn-sm" onclick="previewDocument('${doc.id}', '${doc.file_name}')" style="background: #3b82f6; color: white;">
                                            ğŸ‘ï¸ é è¦½
                                        </button>
                                    `
                                        : ""
                                    }
                                    <button class="btn btn-sm" onclick="downloadDocument('${
                                      doc.id
                                    }', '${
                  doc.file_name
                }')" style="background: #10b981; color: white;">
                                        â¬‡ï¸ ä¸‹è¼‰
                                    </button>
                                </div>
                            </div>
                        `;
              })
              .join("");

            documentsContainer.innerHTML = `
                        <div style="background: #eff6ff; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; color: #1e40af;">
                            ğŸ“‹ å…± ${documents.length} å€‹è­‰æ˜æ–‡ä»¶
                        </div>
                        ${html}
                    `;
          } else {
            documentsContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                            âŒ è¼‰å…¥æ–‡ä»¶å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                        </div>
                    `;
          }
        } catch (error) {
          console.error("è¼‰å…¥æ–‡ä»¶éŒ¯èª¤:", error);
          documentsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                        âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}
                    </div>
                `;
        }
      }

      function getDocumentIcon(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const icons = {
          pdf: "ğŸ“„",
          doc: "ğŸ“",
          docx: "ğŸ“",
          jpg: "ğŸ–¼ï¸",
          jpeg: "ğŸ–¼ï¸",
          png: "ğŸ–¼ï¸",
          xls: "ğŸ“Š",
          xlsx: "ğŸ“Š",
        };
        return icons[ext] || "ğŸ“";
      }

      function getDocumentTypeText(type) {
        const types = {
          household_registration: "æˆ¶ç±è¬„æœ¬",
          income_proof: "æ”¶å…¥è­‰æ˜",
          property_proof: "è²¡ç”¢è­‰æ˜",
          damage_assessment: "ç½æé‘‘å®š",
          supporting_document: "è­‰æ˜æ–‡ä»¶",
          other: "å…¶ä»–æ–‡ä»¶",
        };
        return types[type] || type;
      }

      async function previewDocument(documentId, fileName) {
        try {
          // æ‰“é–‹æ–°è¦–çª—é€²è¡Œé è¦½
          const previewUrl = `${API_BASE}/documents/${documentId}/preview`;
          const previewWindow = window.open(
            "",
            "_blank",
            "width=900,height=700"
          );

          if (!previewWindow) {
            alert("ç„¡æ³•é–‹å•Ÿé è¦½è¦–çª—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨çš„å½ˆå‡ºè¦–çª—è¨­å®š");
            return;
          }

          previewWindow.document.write(`
                    <html>
                    <head>
                        <title>é è¦½ - ${fileName}</title>
                        <style>
                            body {
                                margin: 0;
                                padding: 0;
                                background: #f0f0f0;
                                font-family: Arial, sans-serif;
                            }
                            .header {
                                background: white;
                                padding: 15px 20px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                            }
                            .header h3 {
                                margin: 0;
                                color: #333;
                            }
                            .btn {
                                padding: 8px 16px;
                                background: #3b82f6;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                text-decoration: none;
                            }
                            .btn:hover {
                                background: #2563eb;
                            }
                            .loading {
                                text-align: center;
                                padding: 50px;
                                color: #666;
                            }
                            iframe, embed, img {
                                width: 100%;
                                height: calc(100vh - 70px);
                                border: none;
                            }
                            .error {
                                text-align: center;
                                padding: 50px;
                                color: #dc2626;
                                background: white;
                                margin: 20px;
                                border-radius: 8px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h3>ğŸ“„ ${fileName}</h3>
                            <a href="${API_BASE}/documents/${documentId}/download" class="btn" download>â¬‡ï¸ ä¸‹è¼‰åŸæª”</a>
                        </div>
                        <div class="loading">è¼‰å…¥ä¸­...</div>
                        <iframe id="previewFrame" style="display:none;"></iframe>
                    </body>
                    </html>
                `);

          // ä½¿ç”¨ iframe è¼‰å…¥é è¦½
          const iframe = previewWindow.document.getElementById("previewFrame");
          const loading = previewWindow.document.querySelector(".loading");

          iframe.onload = () => {
            loading.style.display = "none";
            iframe.style.display = "block";
          };

          iframe.onerror = () => {
            loading.innerHTML =
              '<div class="error">âŒ é è¦½å¤±æ•—<br><small>å»ºè­°ç›´æ¥ä¸‹è¼‰æª”æ¡ˆæŸ¥çœ‹</small></div>';
          };

          iframe.src = previewUrl;
        } catch (error) {
          console.error("é è¦½éŒ¯èª¤:", error);
          alert("é è¦½å¤±æ•—: " + error.message);
        }
      }

      async function downloadDocument(documentId, fileName) {
        try {
          const response = await fetch(
            `${API_BASE}/documents/${documentId}/download`,
            {
              headers: { Authorization: `Bearer ${accessToken}` },
            }
          );

          if (!response.ok) {
            throw new Error("ä¸‹è¼‰å¤±æ•—");
          }

          // å–å¾— blob
          const blob = await response.blob();

          // å»ºç«‹ä¸‹è¼‰é€£çµ
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();

          // æ¸…ç†
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          console.log(`âœ“ æª”æ¡ˆ ${fileName} ä¸‹è¼‰æˆåŠŸ`);
        } catch (error) {
          console.error("ä¸‹è¼‰éŒ¯èª¤:", error);
          alert("ä¸‹è¼‰å¤±æ•—: " + error.message);
        }
      }

      function closeReviewModal() {
        document.getElementById("reviewModal").classList.remove("show");
        currentApplication = null;
      }

      async function approveApplication() {
        const amount = document.getElementById("approvedAmount").value;
        const comments = document.getElementById("reviewComments").value;

        if (!amount) {
          alert("è«‹è¼¸å…¥æ ¸å‡†é‡‘é¡");
          return;
        }

        // ä½¿ç”¨æ–°çš„å®Œæ•´æµç¨‹ APIï¼ˆæ•´åˆæ”¿åºœç™¼è¡Œç«¯ï¼‰
        try {
          const result = await fetch(`/api/v1/complete-flow/review-and-issue`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              application_id: currentApplication.id,
              approved: true,
              review_notes: comments,
              approved_amount: amount,
            }),
          });

          const data = await result.json();
          console.log("å¯©æ ¸å›æ‡‰æ•¸æ“š:", data); // èª¿è©¦ç”¨
          console.log("data.qr_code å­˜åœ¨?", !!data.qr_code);
          console.log("data.qr_code é¡å‹:", typeof data.qr_code);
          console.log("data æ‰€æœ‰éµ:", Object.keys(data));

          if (data.success) {
            // é¡¯ç¤º QR Code çµ¦ç½æ°‘
            showQRCodeModal(data);

            closeReviewModal();
            loadDashboardStats();
            loadPendingApplications();
          } else {
            alert(`æ“ä½œå¤±æ•—ï¼š${data.message || "è«‹ç¨å¾Œå†è©¦"}`);
          }
        } catch (error) {
          console.error("å¯©æ ¸éŒ¯èª¤:", error);
          alert(`ç³»çµ±éŒ¯èª¤ï¼š${error.message}`);
        }
      }

      // é¡¯ç¤º QR Code çµ¦ç½æ°‘æƒæ
      function showQRCodeModal(data) {
        console.log("QR Code Modal æ•¸æ“š:", data); // èª¿è©¦ç”¨
        console.log("qr_code å­˜åœ¨å—?", !!data.qr_code); // èª¿è©¦ç”¨
        console.log("qr_code é•·åº¦:", data.qr_code?.length); // èª¿è©¦ç”¨

        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";

        const qrCodeDisplay = data.qr_code
          ? `<img src="${data.qr_code}" style="max-width: 300px; border: 3px solid #4CAF50; border-radius: 10px; padding: 10px;" onload="console.log('QR Code åœ–ç‰‡è¼‰å…¥æˆåŠŸ')" onerror="console.error('QR Code åœ–ç‰‡è¼‰å…¥å¤±æ•—')">`
          : `<div style="padding: 20px; background: #f0f0f0; border-radius: 10px;">âŒ QR Code æœªç”Ÿæˆ<br>Transaction ID: ${data.transaction_id}</div>`;

        modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2 style="color: #4CAF50;">âœ… æ ¸å‡†æˆåŠŸï¼</h2>
                    <div style="text-align: center; margin: 30px 0;">
                        <h3>æ•¸ä½æ†‘è­‰ QR Code</h3>
                        <p style="color: #666; margin: 10px 0;">è«‹è½‰ç™¼çµ¦ç½æ°‘æƒæ</p>
                        ${qrCodeDisplay}
                        <p style="margin-top: 15px; font-size: 14px; color: #888;">
                            Transaction ID: ${data.transaction_id || "N/A"}
                        </p>
                        ${
                          data.deep_link &&
                          data.deep_link.startsWith("twfido://")
                            ? `
                            <a href="${data.deep_link}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px;">
                                ğŸ“± é–‹å•Ÿæ•¸ä½æ†‘è­‰ APP
                            </a>
                        `
                            : ""
                        }
                        ${
                          data.deep_link &&
                          !data.deep_link.startsWith("twfido://")
                            ? `
                            <p style="margin-top: 10px; font-size: 12px; color: #999;">Deep Link: ${data.deep_link.substring(
                              0,
                              50
                            )}...</p>
                        `
                            : ""
                        }
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>ğŸ“± ç½æ°‘æ“ä½œæ­¥é©Ÿï¼š</strong>
                        <ol style="margin: 10px 0 0 20px; text-align: left;">
                            <li>æ‰“é–‹ã€ŒTW FidO æ•¸ä½æ†‘è­‰çš®å¤¾ã€APP</li>
                            <li>æƒææ­¤ QR Code</li>
                            <li>ç¢ºèªä¸¦å„²å­˜æ†‘è­‰</li>
                            <li>åˆ° 7-11 æ©Ÿå°é ˜å–è£œåŠ©</li>
                        </ol>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; font-size: 16px;">
                        é—œé–‰
                    </button>
                </div>
            `;

        document.body.appendChild(modal);
      }

      async function rejectApplication() {
        const comments = document.getElementById("reviewComments").value;

        if (!comments) {
          alert("è«‹å¡«å¯«é§å›åŸå› ");
          return;
        }

        const result = await fetch(
          `${API_BASE}/reviews/reject/${currentApplication.id}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({
              rejection_reason: comments,
              comments: comments,
            }),
          }
        );

        if (result.ok) {
          alert("âŒ å·²é§å›ç”³è«‹");
          closeReviewModal();
          loadDashboardStats();
          loadPendingApplications();
        } else {
          alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      function loadStatistics() {
        document.getElementById("statisticsContent").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“Š</div>
                    <p>çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...</p>
                </div>
            `;
      }

      function logout() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          localStorage.removeItem("admin_token");
          localStorage.removeItem("admin_user");
          location.reload();
        }
      }

      function getStatusText(status) {
        const map = {
          pending: "å¾…å¯©æ ¸",
          under_review: "å¯©æ ¸ä¸­",
          approved: "å·²æ ¸å‡†",
          rejected: "å·²é§å›",
        };
        return map[status] || status;
      }

      function getDisasterTypeText(type) {
        const map = {
          flood: "æ°´ç½",
          typhoon: "é¢±é¢¨",
          earthquake: "åœ°éœ‡",
          other: "å…¶ä»–",
        };
        return map[type] || type;
      }
    </script>
  </body>
</html>
