<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœæ•¸ä½æ†‘è­‰ API å®Œæ•´æµç¨‹æ¸¬è©¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .flow-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .step-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .step-card:hover {
            transform: translateY(-5px);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-box.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .result-box.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .qr-code-display {
            text-align: center;
            padding: 20px;
        }

        .qr-code-display img {
            max-width: 300px;
            border: 3px solid #667eea;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }

        .info-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .deep-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .deep-link:hover {
            background: #0056b3;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ æ”¿åºœæ•¸ä½æ†‘è­‰ API å®Œæ•´æµç¨‹</h1>
            <p>ç½å®³è£œåŠ©ç”³è«‹ + æ•¸ä½æ†‘è­‰é©—è­‰ç³»çµ±</p>
        </div>

        <div class="flow-container">
            <!-- æ­¥é©Ÿ 1: ç½æ°‘ç”³è«‹ -->
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">ç½æ°‘ç”³è«‹</div>
                </div>
                
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="applicant_name" value="ç‹å°æ˜">
                </div>
                
                <div class="form-group">
                    <label>èº«åˆ†è­‰å­—è™Ÿ</label>
                    <input type="text" id="id_number" value="A123456789">
                </div>
                
                <div class="form-group">
                    <label>é›»è©±</label>
                    <input type="text" id="phone" value="0912345678">
                </div>
                
                <div class="form-group">
                    <label>æˆ¶ç±åœ°å€</label>
                    <input type="text" id="address" value="å°å—å¸‚ä¸­è¥¿å€æ°‘ç”Ÿè·¯100è™Ÿ">
                </div>
                
                <div class="form-group">
                    <label>å—ç½åœ°å€</label>
                    <input type="text" id="damage_address" value="å°å—å¸‚ä¸­è¥¿å€æ°‘ç”Ÿè·¯100è™Ÿ">
                </div>
                
                <button onclick="submitApplication()">æäº¤ç”³è«‹</button>
                
                <div id="step1_result" class="result-box"></div>
            </div>

            <!-- æ­¥é©Ÿ 2: é‡Œé•·å¯©æ ¸ -->
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">é‡Œé•·å¯©æ ¸ + ç™¼è¡Œæ†‘è­‰</div>
                </div>
                
                <div class="form-group">
                    <label>ç”³è«‹æ¡ˆä»¶ ID</label>
                    <input type="text" id="application_id" placeholder="å¾æ­¥é©Ÿ 1 å–å¾—">
                </div>
                
                <div class="form-group">
                    <label>å¯©æ ¸çµæœ</label>
                    <select id="approved">
                        <option value="true">é€šé</option>
                        <option value="false">é§å›</option>
                    </select>
                </div>
                
                <button onclick="reviewAndIssue()">å¯©æ ¸ä¸¦ç™¼è¡Œæ†‘è­‰</button>
                
                <div id="step2_result" class="result-box"></div>
            </div>

            <!-- æ­¥é©Ÿ 3: QR Code é¡¯ç¤º -->
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">æ•¸ä½æ†‘è­‰ QR Code</div>
                </div>
                
                <div class="qr-code-display" id="qr_code_display">
                    <p class="info-text">å¯©æ ¸é€šéå¾Œï¼ŒQR Code æœƒé¡¯ç¤ºåœ¨é€™è£¡<br>è«‹ç”¨ã€ŒTW FidO æ•¸ä½æ†‘è­‰çš®å¤¾ã€APP æƒæ</p>
                </div>
                
                <div id="step3_result" class="result-box"></div>
            </div>
        </div>

        <div class="flow-container">
            <!-- æ­¥é©Ÿ 4: 7-11 æ©Ÿå°é©—è­‰ -->
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">7-11 æ©Ÿå° - ç”¢ç”Ÿ VP QR Code</div>
                </div>
                
                <div class="form-group">
                    <label>VP é©—è­‰æœå‹™ä»£ç¢¼ (ref)</label>
                    <input type="text" id="vp_ref" value="00000000_subsidy_667">
                    <p class="info-text">å¾ VP é¢æ¿å–å¾—çš„é©—è­‰æœå‹™ä»£ç¢¼</p>
                </div>
                
                <button onclick="generateVPQRCode()">ç”¢ç”Ÿ VP QR Code</button>
                
                <div class="qr-code-display" id="vp_qr_code_display">
                    <p class="info-text">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç”¢ç”Ÿ VP é©—è­‰ QR Code<br>ç½æ°‘ç”¨ APP æƒæå¾Œå‡ºç¤ºæ†‘è­‰</p>
                </div>
                
                <div id="step4_result" class="result-box"></div>
            </div>

            <!-- æ­¥é©Ÿ 5: é©—è­‰çµæœ -->
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div class="step-title">é©—è­‰ VP ä¸¦ç™¼æ”¾è£œåŠ©</div>
                </div>
                
                <div class="form-group">
                    <label>Transaction ID</label>
                    <input type="text" id="vp_transaction_id" placeholder="å¾æ­¥é©Ÿ 4 å–å¾—">
                </div>
                
                <button onclick="verifyVP()">é©—è­‰ä¸¦ç™¼æ”¾</button>
                
                <div id="step5_result" class="result-box"></div>
            </div>

            <!-- API ç‹€æ…‹ -->
            <div class="step-card">
                <div class="step-header">
                    <div class="step-number">â„¹ï¸</div>
                    <div class="step-title">ç³»çµ±ç‹€æ…‹</div>
                </div>
                
                <div id="api_status">
                    <p class="info-text">è¼‰å…¥ä¸­...</p>
                </div>
                
                <button onclick="checkAPIStatus()">æª¢æŸ¥ API ç‹€æ…‹</button>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥å‹•æ…‹é…ç½® -->
    <script src="/static/js/dynamic-config.js"></script>
    <script>
        let API_BASE = '/api/v1/complete-flow'; // é è¨­å€¼
        
        // ç›£è½é…ç½®è¼‰å…¥å®Œæˆ
        window.addEventListener('configLoaded', function(event) {
            API_BASE = event.detail.API_BASE.replace('/api/v1', '/api/v1/complete-flow');
            console.log('é…ç½®å·²è¼‰å…¥ï¼ŒAPI_BASE è¨­ç‚º:', API_BASE);
        });
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ API ç‹€æ…‹
        window.onload = () => {
            checkAPIStatus();
        };

        // æª¢æŸ¥ API ç‹€æ…‹
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                document.getElementById('api_status').innerHTML = `
                    <p><strong>ç‹€æ…‹ï¼š</strong> ${data.status}</p>
                    <p><strong>ç™¼è¡Œç«¯ APIï¼š</strong> <span class="status-badge ${data.issuer_api === 'connected' ? 'success' : 'pending'}">${data.issuer_api === 'connected' ? 'å·²é€£æ¥ âœ…' : 'æ¨¡æ“¬æ¨¡å¼ âš ï¸'}</span></p>
                    <p><strong>é©—è­‰ç«¯ APIï¼š</strong> <span class="status-badge ${data.verifier_api === 'connected' ? 'success' : 'pending'}">${data.verifier_api === 'connected' ? 'å·²é€£æ¥ âœ…' : 'æ¨¡æ“¬æ¨¡å¼ âš ï¸'}</span></p>
                `;
            } catch (error) {
                document.getElementById('api_status').innerHTML = `
                    <p class="status-badge error">âŒ ç„¡æ³•é€£æ¥åˆ° API</p>
                `;
            }
        }

        // æ­¥é©Ÿ 1ï¼šæäº¤ç”³è«‹
        async function submitApplication() {
            const today = new Date().toISOString().split('T')[0];
            
            showResult('step1_result', 'pending', 'æäº¤ä¸­...');
            
            // ç”Ÿæˆå”¯ä¸€çš„ UUID
            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            const userId = generateUUID();
            
            // æäº¤ç”³è«‹ï¼ˆå¾Œç«¯æœƒè‡ªå‹•å‰µå»ºç”¨æˆ¶ï¼‰
            const applicationData = {
                applicant_id: userId,
                applicant_name: document.getElementById('applicant_name').value,
                id_number: document.getElementById('id_number').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                disaster_date: today,
                disaster_type: 'typhoon',
                damage_description: 'æˆ¿å±‹å—é¢±é¢¨æå£ï¼Œå±‹é ‚ç ´æï¼Œå®¶å…·å—æ',
                damage_location: document.getElementById('damage_address').value,
                subsidy_type: 'housing',
                requested_amount: 50000
            };

            try {
                const response = await fetch('/api/v1/applications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(applicationData)
                });

                const data = await response.json();

                if (data.success) {
                    const applicationId = data.data?.id || data.id;
                    document.getElementById('application_id').value = applicationId;
                    
                    showResult('step1_result', 'success', `
                        âœ… ç”³è«‹æäº¤æˆåŠŸï¼<br>
                        <strong>æ¡ˆä»¶ IDï¼š</strong>${applicationId}<br>
                        <span class="info-text">å·²è‡ªå‹•å¡«å…¥æ­¥é©Ÿ 2</span>
                    `);
                } else {
                    // æ›´å¥½çš„éŒ¯èª¤è¨Šæ¯é¡¯ç¤º
                    let errorMsg = 'æœªçŸ¥éŒ¯èª¤';
                    if (data.message) {
                        errorMsg = typeof data.message === 'object' ? JSON.stringify(data.message, null, 2) : data.message;
                    } else if (data.detail) {
                        errorMsg = typeof data.detail === 'object' ? JSON.stringify(data.detail, null, 2) : data.detail;
                    } else {
                        errorMsg = JSON.stringify(data, null, 2);
                    }
                    showResult('step1_result', 'error', `âŒ æäº¤å¤±æ•—ï¼š<pre>${errorMsg}</pre>`);
                }
            } catch (error) {
                showResult('step1_result', 'error', `âŒ éŒ¯èª¤ï¼š${error.message}`);
            }
        }

        // æ­¥é©Ÿ 2ï¼šé‡Œé•·å¯©æ ¸ä¸¦ç™¼è¡Œæ†‘è­‰
        async function reviewAndIssue() {
            const applicationId = document.getElementById('application_id').value;
            const approved = document.getElementById('approved').value === 'true';

            if (!applicationId) {
                showResult('step2_result', 'error', 'è«‹å…ˆå®Œæˆæ­¥é©Ÿ 1 æˆ–è¼¸å…¥æ¡ˆä»¶ ID');
                return;
            }

            showResult('step2_result', 'pending', 'å¯©æ ¸ä¸­...');

            try {
                const response = await fetch(`${API_BASE}/review-and-issue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        application_id: applicationId,
                        approved: approved,
                        review_notes: 'å¯©æ ¸é€šé'
                    })
                });

                const data = await response.json();

                if (data.success && approved) {
                    // é¡¯ç¤º QR Code
                    displayQRCode(data.qr_code, data.deep_link, data.transaction_id);
                    
                    showResult('step2_result', 'success', `
                        âœ… æ†‘è­‰ç™¼è¡ŒæˆåŠŸï¼<br>
                        <strong>Transaction IDï¼š</strong>${data.transaction_id}<br>
                        <span class="info-text">QR Code å·²é¡¯ç¤ºåœ¨æ­¥é©Ÿ 3</span>
                    `);
                } else {
                    showResult('step2_result', 'error', `âŒ ${data.message}`);
                }
            } catch (error) {
                showResult('step2_result', 'error', `âŒ éŒ¯èª¤ï¼š${error.message}`);
            }
        }

        // é¡¯ç¤º QR Code
        function displayQRCode(qrCodeData, deepLink, transactionId) {
            const display = document.getElementById('qr_code_display');
            
            // å¦‚æœ qrCodeData æ˜¯ base64ï¼Œç›´æ¥é¡¯ç¤º
            let qrHTML = '';
            if (qrCodeData) {
                if (qrCodeData.startsWith('data:image')) {
                    qrHTML = `<img src="${qrCodeData}" alt="QR Code">`;
                } else if (qrCodeData.startsWith('iVBOR')) {
                    qrHTML = `<img src="data:image/png;base64,${qrCodeData}" alt="QR Code">`;
                } else {
                    // JSON æ ¼å¼ï¼Œé¡¯ç¤ºæ–‡å­—
                    qrHTML = `<pre>${qrCodeData}</pre>`;
                }
            }
            
            display.innerHTML = `
                ${qrHTML}
                <p class="info-text">ğŸ“± è«‹ä½¿ç”¨ã€ŒTW FidO æ•¸ä½æ†‘è­‰çš®å¤¾ã€APP æƒæ</p>
                ${deepLink ? `<a href="${deepLink}" class="deep-link">ğŸ”— æˆ–é»æ­¤é–‹å•Ÿ APP</a>` : ''}
                <p class="info-text" style="margin-top: 15px;">Transaction ID: ${transactionId}</p>
            `;
            
            showResult('step3_result', 'success', 'âœ… è«‹ç”¨ APP æƒæ QR Code ä¸¦å„²å­˜æ†‘è­‰');
        }

        // æ­¥é©Ÿ 4ï¼šç”¢ç”Ÿ VP QR Code
        async function generateVPQRCode() {
            const vpRef = document.getElementById('vp_ref').value;

            if (!vpRef) {
                showResult('step4_result', 'error', 'è«‹è¼¸å…¥ VP é©—è­‰æœå‹™ä»£ç¢¼');
                return;
            }

            showResult('step4_result', 'pending', 'ç”¢ç”Ÿä¸­...');

            try {
                const response = await fetch(`${API_BASE}/generate-vp-qrcode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ref: vpRef })
                });

                const data = await response.json();

                if (data.success) {
                    // é¡¯ç¤º VP QR Code
                    displayVPQRCode(data.qrcode_image, data.auth_uri, data.transaction_id);
                    
                    // è‡ªå‹•å¡«å…¥ transaction_id
                    document.getElementById('vp_transaction_id').value = data.transaction_id;
                    
                    showResult('step4_result', 'success', `
                        âœ… VP QR Code ç”¢ç”ŸæˆåŠŸï¼<br>
                        <strong>Transaction IDï¼š</strong>${data.transaction_id}<br>
                        <span class="info-text">å·²è‡ªå‹•å¡«å…¥æ­¥é©Ÿ 5</span>
                    `);
                } else {
                    showResult('step4_result', 'error', `âŒ ${data.message}`);
                }
            } catch (error) {
                showResult('step4_result', 'error', `âŒ éŒ¯èª¤ï¼š${error.message}`);
            }
        }

        // é¡¯ç¤º VP QR Code
        function displayVPQRCode(qrcodeImage, authUri, transactionId) {
            const display = document.getElementById('vp_qr_code_display');
            
            let qrHTML = '';
            if (qrcodeImage) {
                if (qrcodeImage.startsWith('data:image') || qrcodeImage.startsWith('http')) {
                    qrHTML = `<img src="${qrcodeImage}" alt="VP QR Code">`;
                } else {
                    qrHTML = `<img src="data:image/png;base64,${qrcodeImage}" alt="VP QR Code">`;
                }
            }
            
            display.innerHTML = `
                ${qrHTML}
                <p class="info-text">ğŸ“± è«‹ä½¿ç”¨ã€ŒTW FidO æ•¸ä½æ†‘è­‰çš®å¤¾ã€APP æƒæ</p>
                ${authUri ? `<a href="${authUri}" class="deep-link">ğŸ”— æˆ–é»æ­¤é–‹å•Ÿ APP</a>` : ''}
                <p class="info-text" style="margin-top: 15px;">Transaction ID: ${transactionId}</p>
            `;
        }

        // æ­¥é©Ÿ 5ï¼šé©—è­‰ VP
        async function verifyVP() {
            const transactionId = document.getElementById('vp_transaction_id').value;

            if (!transactionId) {
                showResult('step5_result', 'error', 'è«‹å…ˆå®Œæˆæ­¥é©Ÿ 4 æˆ–è¼¸å…¥ Transaction ID');
                return;
            }

            showResult('step5_result', 'pending', 'é©—è­‰ä¸­...');

            try {
                const response = await fetch(`${API_BASE}/verify-vp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transaction_id: transactionId })
                });

                const data = await response.json();

                if (data.success && data.verified) {
                    showResult('step5_result', 'success', `
                        âœ… é©—è­‰æˆåŠŸï¼è£œåŠ©å·²ç™¼æ”¾ï¼<br><br>
                        <strong>ç½æ°‘è³‡è¨Šï¼š</strong><br>
                        ${formatCredentialData(data.credential_data)}
                    `);
                } else {
                    showResult('step5_result', 'error', `âŒ ${data.message}`);
                }
            } catch (error) {
                showResult('step5_result', 'error', `âŒ éŒ¯èª¤ï¼š${error.message}`);
            }
        }

        // æ ¼å¼åŒ–æ†‘è­‰è³‡æ–™
        function formatCredentialData(data) {
            if (!data) return '';
            
            let html = '';
            for (const [key, value] of Object.entries(data)) {
                html += `${key}: ${value}<br>`;
            }
            return html;
        }

        // é¡¯ç¤ºçµæœ
        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result-box show ${type}`;
            element.innerHTML = message;
        }
    </script>
</body>
</html>

