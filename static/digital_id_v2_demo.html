<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸ä½æ†‘è­‰ç™»å…¥ V2 - å®Œæ•´æƒææµç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .version-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .qr-container {
            display: none;
            text-align: center;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .qr-container.active {
            display: block;
        }

        #qrcode {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            display: inline-block;
        }

        .status {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .status.verified {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .status.expired {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #333;
        }

        .info-box strong {
            color: #2196F3;
        }

        .countdown {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-top: 10px;
        }

        .user-info {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .user-info.active {
            display: block;
        }

        .user-info h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .user-info p {
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .mock-controls {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .mock-controls h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #ddd;
            z-index: 0;
        }

        .step:last-child::after {
            display: none;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 14px;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .step.active .step-circle {
            background: #667eea;
        }

        .step.completed .step-circle {
            background: #28a745;
        }

        .step-label {
            font-size: 12px;
            color: #999;
        }

        .step.active .step-label {
            color: #667eea;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ•¸ä½æ†‘è­‰ç™»å…¥</h1>
        <p class="subtitle">
            <span class="version-badge">V2 æ­£ç¢ºç‰ˆ</span>
            å®Œæ•´çš„ APP æƒææµç¨‹
        </p>

        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="steps">
            <div class="step" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">ç”¢ç”Ÿ QR</div>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">æƒæé©—è­‰</div>
            </div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-label">å®Œæˆç™»å…¥</div>
            </div>
        </div>

        <!-- åˆå§‹ç•«é¢ -->
        <div id="initialScreen">
            <div class="info-box">
                <strong>ğŸ’¡ é€™æ˜¯ä»€éº¼ï¼Ÿ</strong><br>
                é€™æ˜¯æ­£ç¢ºçš„æ•¸ä½æ†‘è­‰ç™»å…¥æµç¨‹å±•ç¤ºã€‚<br>
                ä½¿ç”¨è€…ç”¨æ”¿åºœ APP æƒæ QR Code å®Œæˆèº«ä»½é©—è­‰ã€‚
            </div>

            <button class="btn btn-primary" onclick="startDigitalIDLogin()">
                ğŸ“± é–‹å§‹æ•¸ä½æ†‘è­‰ç™»å…¥
            </button>

            <button class="btn btn-secondary" onclick="window.location.href='/applicant'">
                â† è¿”å› V1 ç°¡åŒ–ç‰ˆ
            </button>
        </div>

        <!-- QR Code ç•«é¢ -->
        <div id="qrScreen" class="qr-container">
            <h3 style="margin-bottom: 15px;">ğŸ“± è«‹ä½¿ç”¨æ”¿åºœ APP æƒæ</h3>
            <div id="qrcode"></div>
            <div class="status pending">
                <div class="spinner"></div>
                <span id="statusText">ç­‰å¾…æƒæä¸­...</span>
            </div>
            <div class="countdown" id="countdown"></div>
        </div>

        <!-- ç”¨æˆ¶è³‡è¨Šç¢ºèª -->
        <div id="userInfoScreen" class="user-info">
            <h3>âœ… é©—è­‰æˆåŠŸï¼</h3>
            <p><strong>å§“åï¼š</strong><span id="userName"></span></p>
            <p><strong>èº«åˆ†è­‰ï¼š</strong><span id="userID"></span></p>

            <div class="form-group">
                <label>é¸æ“‡è§’è‰²ï¼š</label>
                <select id="userRole">
                    <option value="applicant">ç½æ°‘ï¼ˆç”³è«‹è£œåŠ©ï¼‰</option>
                    <option value="reviewer">é‡Œé•·ï¼ˆå¯©æ ¸æ¡ˆä»¶ï¼‰</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
            </div>

            <div class="form-group">
                <label>æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
                <input type="tel" id="userPhone" placeholder="0912345678">
            </div>

            <div class="form-group" id="districtGroup" style="display: none;">
                <label>ç®¡è½„å€åŸŸï¼š</label>
                <select id="userDistrict"></select>
            </div>

            <button class="btn btn-success" onclick="completeLogin()">
                âœ… å®Œæˆç™»å…¥
            </button>
        </div>

        <!-- æ¨¡æ“¬æ§åˆ¶ï¼ˆæ¸¬è©¦ç”¨ï¼‰ -->
        <div class="mock-controls" id="mockControls" style="display: none;">
            <h4>ğŸ§ª æ¸¬è©¦æ§åˆ¶ï¼ˆæ¨¡æ“¬ APP æƒæï¼‰</h4>
            <p style="font-size: 12px; color: #856404; margin-bottom: 10px;">
                åœ¨æ²’æœ‰çœŸå¯¦æ”¿åºœ APP çš„æƒ…æ³ä¸‹ï¼Œä½¿ç”¨æ­¤åŠŸèƒ½æ¨¡æ“¬æƒæ
            </p>
            <div class="form-group">
                <input type="text" id="mockName" placeholder="å§“å" value="æ¸¬è©¦ç”¨æˆ¶">
            </div>
            <div class="form-group">
                <input type="text" id="mockID" placeholder="èº«åˆ†è­‰å­—è™Ÿ" value="A123456789">
            </div>
            <button class="btn btn-secondary" onclick="mockScan()">
                ğŸ”§ æ¨¡æ“¬ APP æƒæ
            </button>
        </div>
    </div>

    <!-- QR Code ç”Ÿæˆåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- è¼‰å…¥é…ç½®ç®¡ç†æ¨¡çµ„ -->
    <script src="/static/js/config.js"></script>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let API_BASE = null;  // å°‡ç”±é…ç½®æ¨¡çµ„è¨­å®š
        let currentSessionId = null;
        let pollInterval = null;
        let countdownInterval = null;
        let expiresAt = null;

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        async function initializeApp() {
            // è¼‰å…¥é…ç½®
            await initializeConfig();
            API_BASE = getApiBase().replace('/api/v1', ''); // å»é™¤ /api/v1 å¾Œç¶´ï¼Œå› ç‚ºé€™å€‹ demo ç›´æ¥é€£æ¥åˆ°æ ¹è·¯å¾‘
            console.log('Digital ID V2 Demo - API_BASE è¨­ç‚º:', API_BASE);
        }

        // é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeApp);

        // æ›´æ–°æ­¥é©Ÿç‹€æ…‹
        function updateStep(step) {
            ['step1', 'step2', 'step3'].forEach(id => {
                document.getElementById(id).classList.remove('active', 'completed');
            });

            if (step >= 1) document.getElementById('step1').classList.add('completed');
            if (step >= 2) document.getElementById('step2').classList.add('completed');
            if (step >= 3) document.getElementById('step3').classList.add('completed');

            if (step === 1) document.getElementById('step1').classList.add('active');
            if (step === 2) document.getElementById('step2').classList.add('active');
            if (step === 3) document.getElementById('step3').classList.add('active');
        }

        // é–‹å§‹æ•¸ä½æ†‘è­‰ç™»å…¥
        async function startDigitalIDLogin() {
            try {
                updateStep(1);
                document.getElementById('initialScreen').style.display = 'none';

                // å‘¼å« API ç”¢ç”Ÿ QR Code
                const response = await fetch(`${API_BASE}/auth/digital-id-v2/generate-qr`);
                
                if (!response.ok) {
                    throw new Error(`API éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                currentSessionId = data.session_id;
                expiresAt = Date.now() + (data.expires_in * 1000);

                // é¡¯ç¤º QR Code
                document.getElementById('qrScreen').classList.add('active');
                document.getElementById('mockControls').style.display = 'block';

                // ç”Ÿæˆ QR Code
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {
                    text: data.qr_code_data,
                    width: 200,
                    height: 200
                });

                updateStep(2);

                // é–‹å§‹è¼ªè©¢
                startPolling();

                // é–‹å§‹å€’æ•¸è¨ˆæ™‚
                startCountdown();

            } catch (error) {
                console.error('Error:', error);
                alert('ç”¢ç”Ÿ QR Code å¤±æ•—ï¼š' + error.message);
                location.reload();
            }
        }

        // é–‹å§‹è¼ªè©¢ç‹€æ…‹
        function startPolling() {
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(
                        `${API_BASE}/auth/digital-id-v2/check-status/${currentSessionId}`
                    );
                    const status = await response.json();

                    if (status.status === 'verified') {
                        // é©—è­‰æˆåŠŸ
                        clearInterval(pollInterval);
                        clearInterval(countdownInterval);
                        showUserInfo(status.user_info);
                    } else if (status.status === 'expired') {
                        // éæœŸ
                        clearInterval(pollInterval);
                        clearInterval(countdownInterval);
                        showExpired();
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000); // æ¯ 2 ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        // é–‹å§‹å€’æ•¸è¨ˆæ™‚
        function startCountdown() {
            countdownInterval = setInterval(() => {
                const remaining = Math.max(0, Math.floor((expiresAt - Date.now()) / 1000));
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                
                document.getElementById('countdown').textContent = 
                    `QR Code æœ‰æ•ˆæ™‚é–“ï¼š${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (remaining === 0) {
                    clearInterval(countdownInterval);
                    clearInterval(pollInterval);
                    showExpired();
                }
            }, 1000);
        }

        // é¡¯ç¤ºéæœŸè¨Šæ¯
        function showExpired() {
            const statusDiv = document.querySelector('.status');
            statusDiv.className = 'status expired';
            statusDiv.innerHTML = 'âŒ QR Code å·²éæœŸ';
            document.getElementById('mockControls').style.display = 'none';
            
            setTimeout(() => {
                if (confirm('QR Code å·²éæœŸï¼Œæ˜¯å¦é‡æ–°ç”¢ç”Ÿï¼Ÿ')) {
                    location.reload();
                }
            }, 2000);
        }

        // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        async function showUserInfo(userInfo) {
            updateStep(3);
            
            // éš±è— QR Code
            document.getElementById('qrScreen').classList.remove('active');
            document.getElementById('mockControls').style.display = 'none';

            // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
            document.getElementById('userName').textContent = userInfo.full_name;
            document.getElementById('userID').textContent = userInfo.id_number;
            document.getElementById('userInfoScreen').classList.add('active');

            // è¼‰å…¥å€åŸŸåˆ—è¡¨
            await loadDistricts();

            // ç›£è½è§’è‰²è®Šæ›´
            document.getElementById('userRole').addEventListener('change', function() {
                if (this.value === 'reviewer') {
                    document.getElementById('districtGroup').style.display = 'block';
                } else {
                    document.getElementById('districtGroup').style.display = 'none';
                }
            });
        }

        // è¼‰å…¥å€åŸŸåˆ—è¡¨
        async function loadDistricts() {
            try {
                const response = await fetch(`${API_BASE}/districts/`);
                const districts = await response.json();
                
                const select = document.getElementById('userDistrict');
                select.innerHTML = '<option value="">è«‹é¸æ“‡å€åŸŸ</option>';
                
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.id;
                    option.textContent = district.district_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Load districts error:', error);
            }
        }

        // å®Œæˆç™»å…¥
        async function completeLogin() {
            const role = document.getElementById('userRole').value;
            const phone = document.getElementById('userPhone').value;
            const districtId = document.getElementById('userDistrict').value;

            if (!phone) {
                alert('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼');
                return;
            }

            if (role === 'reviewer' && !districtId) {
                alert('é‡Œé•·è«‹é¸æ“‡ç®¡è½„å€åŸŸ');
                return;
            }

            try {
                const payload = {
                    role: role,
                    phone: phone
                };

                if (districtId) {
                    payload.district_id = districtId;
                }

                const response = await fetch(
                    `${API_BASE}/auth/digital-id-v2/complete-login/${currentSessionId}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ç™»å…¥å¤±æ•—');
                }

                const data = await response.json();

                // å„²å­˜ Token
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('user', JSON.stringify(data.user));

                alert(`âœ… ç™»å…¥æˆåŠŸï¼æ­¡è¿ï¼Œ${data.user.full_name}`);

                // æ ¹æ“šè§’è‰²è·³è½‰
                if (role === 'applicant') {
                    window.location.href = '/applicant';
                } else {
                    window.location.href = '/admin';
                }

            } catch (error) {
                console.error('Complete login error:', error);
                alert('å®Œæˆç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        }

        // æ¨¡æ“¬ APP æƒæï¼ˆæ¸¬è©¦ç”¨ï¼‰
        async function mockScan() {
            const name = document.getElementById('mockName').value;
            const idNumber = document.getElementById('mockID').value;

            if (!name || !idNumber) {
                alert('è«‹å¡«å¯«å§“åå’Œèº«åˆ†è­‰å­—è™Ÿ');
                return;
            }

            try {
                const response = await fetch(
                    `${API_BASE}/auth/digital-id-v2/mock-scan`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            id_number: idNumber,
                            full_name: name
                        })
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'æ¨¡æ“¬æƒæå¤±æ•—');
                }

                const data = await response.json();
                alert('âœ… æ¨¡æ“¬æƒææˆåŠŸï¼ç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬åˆ°é©—è­‰å®Œæˆã€‚');

            } catch (error) {
                console.error('Mock scan error:', error);
                alert('æ¨¡æ“¬æƒæå¤±æ•—ï¼š' + error.message);
            }
        }
    </script>
</body>
</html>

