<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email é©—è­‰ç™»å…¥æ¸¬è©¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background: #f5f7ff;
        }
        
        .countdown {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        
        .countdown-time {
            font-size: 36px;
            font-weight: bold;
            color: #f44336;
            font-family: 'Courier New', monospace;
        }
        
        .countdown-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 14px;
            color: #1976d2;
        }
        
        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 14px;
            color: #2e7d32;
        }
        
        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 14px;
            color: #c62828;
        }
        
        .hidden {
            display: none !important;
        }
        
        .code-display {
            background: #f5f5f5;
            border: 2px dashed #999;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .code-display-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .code-display-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
            letter-spacing: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŠ Email é©—è­‰ç™»å…¥</h1>
            <p>ç½å®³è£œåŠ©ç³»çµ±</p>
        </div>
        
        <div class="content">
            <!-- æ­¥é©Ÿ 1ï¼šè¼¸å…¥ Email -->
            <div id="step1" class="step active">
                <h2 style="margin-bottom: 20px; color: #333;">è¼¸å…¥æ‚¨çš„ Email</h2>
                
                <div class="input-group">
                    <label>Email åœ°å€</label>
                    <input type="email" id="emailInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Email">
                </div>
                
                <button class="btn btn-primary" onclick="handleSendCode()">
                    ç™¼é€é©—è­‰ç¢¼
                </button>
                
                <div class="info-box">
                    ğŸ’¡ æˆ‘å€‘æœƒç™¼é€ä¸€å°åŒ…å«é©—è­‰ç¢¼çš„éƒµä»¶åˆ°æ‚¨çš„ä¿¡ç®±
                </div>
            </div>

            <!-- æ­¥é©Ÿ 2ï¼šè¼¸å…¥é©—è­‰ç¢¼ -->
            <div id="step2" class="step">
                <h2 style="margin-bottom: 20px; color: #333;">è¼¸å…¥é©—è­‰ç¢¼</h2>
                
                <div class="success-box">
                    âœ… é©—è­‰ç¢¼å·²ç™¼é€åˆ°æ‚¨çš„ Emailï¼
                </div>
                
                <!-- é¡¯ç¤ºå¾Œç«¯å›å‚³çš„é©—è­‰ç¢¼ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰ -->
                <div id="codeDisplay" class="code-display">
                    <div class="code-display-label">ğŸ“§ å¾Œç«¯å›å‚³çš„é©—è­‰ç¢¼ï¼ˆæ¸¬è©¦ç”¨ï¼‰</div>
                    <div class="code-display-value" id="displayedCode">------</div>
                </div>
                
                <!-- å€’æ•¸è¨ˆæ™‚ -->
                <div class="countdown">
                    <div class="countdown-time" id="countdown">3:00</div>
                    <div class="countdown-label">å‰©é¤˜æ™‚é–“</div>
                </div>
                
                <div class="input-group">
                    <label>è«‹è¼¸å…¥é©—è­‰ç¢¼</label>
                    <input 
                        type="text" 
                        id="codeInput" 
                        placeholder="è«‹è¼¸å…¥ 6 ä½æ•¸é©—è­‰ç¢¼" 
                        maxlength="6"
                        style="text-align: center; font-size: 24px; letter-spacing: 4px; font-family: 'Courier New', monospace;"
                    >
                </div>
                
                <button class="btn btn-primary" onclick="handleVerify()">
                    é©—è­‰ä¸¦ç™»å…¥
                </button>
                
                <button class="btn btn-secondary" onclick="handleResend()">
                    é‡æ–°ç™¼é€é©—è­‰ç¢¼
                </button>
                
                <div class="info-box">
                    ğŸ’¡ è«‹åœ¨ 3 åˆ†é˜å…§å®Œæˆé©—è­‰
                </div>
            </div>

            <!-- æ­¥é©Ÿ 3ï¼šç™»å…¥æˆåŠŸ -->
            <div id="step3" class="step">
                <div style="text-align: center; padding: 40px 0;">
                    <div style="font-size: 64px;">âœ…</div>
                    <h2 style="color: #4caf50; margin: 20px 0;">ç™»å…¥æˆåŠŸï¼</h2>
                    <p style="color: #666; margin-bottom: 30px;">æ­£åœ¨è·³è½‰åˆ°ä¸»é é¢...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let countdownTimer = null;

        // ç™¼é€é©—è­‰ç¢¼
        async function handleSendCode() {
            const email = document.getElementById('emailInput').value.trim();
            
            if (!email || !email.includes('@')) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€');
                return;
            }

            try {
                console.log('ğŸš€ ç™¼é€é©—è­‰ç¢¼è«‹æ±‚...');
                
                const response = await fetch('/api/v1/auth/email/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        is_verified: false
                    })
                });

                const data = await response.json();
                console.log('ğŸ“¨ å¾Œç«¯å›æ‡‰:', data);

                if (data.success && data.verification_code) {
                    // å„²å­˜é©—è­‰ç¢¼å’Œ Email
                    localStorage.setItem('verification_code', data.verification_code);
                    localStorage.setItem('verification_email', email);
                    
                    // é¡¯ç¤ºé©—è­‰ç¢¼ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
                    document.getElementById('displayedCode').textContent = data.verification_code;
                    
                    // åˆ‡æ›åˆ°æ­¥é©Ÿ 2
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    
                    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
                    startCountdown(180);
                    
                    console.log('âœ… é©—è­‰ç¢¼å·²ç™¼é€:', data.verification_code);
                } else {
                    throw new Error(data.message || 'ç™¼é€é©—è­‰ç¢¼å¤±æ•—');
                }
            } catch (error) {
                console.error('âŒ ç™¼é€é©—è­‰ç¢¼å¤±æ•—:', error);
                alert('ç™¼é€é©—è­‰ç¢¼å¤±æ•—ï¼š' + error.message);
            }
        }

        // å€’æ•¸è¨ˆæ™‚
        function startCountdown(seconds) {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            let remaining = seconds;
            const display = document.getElementById('countdown');
            
            function updateDisplay() {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
                
                // æ™‚é–“å¿«åˆ°æ™‚è®Šç´…è‰²
                if (remaining <= 30) {
                    display.style.color = '#f44336';
                }
            }
            
            updateDisplay();
            
            countdownTimer = setInterval(() => {
                remaining--;
                updateDisplay();
                
                if (remaining <= 0) {
                    clearInterval(countdownTimer);
                    display.textContent = 'å·²éæœŸ';
                    alert('é©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°ç™¼é€');
                }
            }, 1000);
        }

        // é©—è­‰ä¸¦ç™»å…¥
        async function handleVerify() {
            const userCode = document.getElementById('codeInput').value.trim();
            const correctCode = localStorage.getItem('verification_code');
            const email = localStorage.getItem('verification_email');

            if (!userCode) {
                alert('è«‹è¼¸å…¥é©—è­‰ç¢¼');
                return;
            }

            console.log('ğŸ” å‰ç«¯é©—è­‰ç¢¼æ¯”å°:');
            console.log('  ç”¨æˆ¶è¼¸å…¥:', userCode);
            console.log('  æ­£ç¢ºé©—è­‰ç¢¼:', correctCode);

            // å‰ç«¯æ¯”å°é©—è­‰ç¢¼
            const isCorrect = (userCode === correctCode);
            console.log('  æ¯”å°çµæœ:', isCorrect ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤');

            try {
                console.log('ğŸš€ èª¿ç”¨ç™»å…¥ API, verify=' + isCorrect);
                
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        login_type: 'password',
                        verify: isCorrect  // å‘Šè¨´å¾Œç«¯å‰ç«¯æ¯”å°çš„çµæœ
                    })
                });

                const data = await response.json();
                console.log('ğŸ“¨ ç™»å…¥å›æ‡‰:', data);

                if (response.ok && data.access_token) {
                    // ç™»å…¥æˆåŠŸ
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    // æ¸…é™¤é©—è­‰ç¢¼
                    localStorage.removeItem('verification_code');
                    localStorage.removeItem('verification_email');
                    
                    // åœæ­¢å€’æ•¸
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                    }
                    
                    // é¡¯ç¤ºæˆåŠŸç•«é¢
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3').classList.add('active');
                    
                    console.log('âœ… ç™»å…¥æˆåŠŸï¼');
                    console.log('ç”¨æˆ¶è³‡è¨Š:', data.user);
                    
                    // 3 ç§’å¾Œè·³è½‰
                    setTimeout(() => {
                        window.location.href = '/static/applicant.html';
                    }, 2000);
                } else {
                    // é©—è­‰å¤±æ•—
                    alert('âŒ é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥');
                    document.getElementById('codeInput').value = '';
                    document.getElementById('codeInput').focus();
                }
            } catch (error) {
                console.error('âŒ ç™»å…¥å¤±æ•—:', error);
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        }

        // é‡æ–°ç™¼é€é©—è­‰ç¢¼
        async function handleResend() {
            const email = localStorage.getItem('verification_email');

            if (!email) {
                alert('æ‰¾ä¸åˆ° Emailï¼Œè«‹é‡æ–°é–‹å§‹');
                return;
            }

            try {
                console.log('ğŸ”„ é‡æ–°ç™¼é€é©—è­‰ç¢¼...');
                
                const response = await fetch('/api/v1/auth/email/resend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();
                console.log('ğŸ“¨ é‡ç™¼å›æ‡‰:', data);

                if (data.success && data.verification_code) {
                    // æ›´æ–°é©—è­‰ç¢¼
                    localStorage.setItem('verification_code', data.verification_code);
                    document.getElementById('displayedCode').textContent = data.verification_code;
                    
                    // é‡æ–°é–‹å§‹å€’æ•¸
                    startCountdown(180);
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    document.getElementById('codeInput').value = '';
                    
                    alert('âœ… é©—è­‰ç¢¼å·²é‡æ–°ç™¼é€ï¼');
                    console.log('æ–°é©—è­‰ç¢¼:', data.verification_code);
                } else {
                    throw new Error(data.message || 'é‡æ–°ç™¼é€å¤±æ•—');
                }
            } catch (error) {
                console.error('âŒ é‡æ–°ç™¼é€å¤±æ•—:', error);
                alert('é‡æ–°ç™¼é€å¤±æ•—ï¼š' + error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„é©—è­‰
        window.addEventListener('DOMContentLoaded', () => {
            const savedEmail = localStorage.getItem('verification_email');
            const savedCode = localStorage.getItem('verification_code');
            
            if (savedEmail && savedCode) {
                console.log('ğŸ”„ æª¢æ¸¬åˆ°æœªå®Œæˆçš„é©—è­‰æµç¨‹');
                const resume = confirm('æª¢æ¸¬åˆ°æœªå®Œæˆçš„é©—è­‰æµç¨‹ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ');
                if (resume) {
                    document.getElementById('emailInput').value = savedEmail;
                    document.getElementById('displayedCode').textContent = savedCode;
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    startCountdown(180);
                } else {
                    localStorage.removeItem('verification_email');
                    localStorage.removeItem('verification_code');
                }
            }
        });
    </script>
</body>
</html>
