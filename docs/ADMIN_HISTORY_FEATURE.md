# 管理員後台 - 歷史紀錄功能

## 📋 功能說明

在管理員後台（admin.html）新增了「📜 歷史紀錄」頁面，用於查看和管理所有憑證的使用歷史。

## 🎯 功能特色

### 1. **側邊欄導航**
```
📋 案件管理
📊 統計數據
📜 歷史紀錄  ← 新增
```

### 2. **統計卡片顯示**
- **總記錄數**: 所有憑證使用記錄總數
- **已發行憑證**: 已發行的憑證數量
- **已驗證憑證**: 已被驗證的憑證次數
- **驗證率**: 驗證次數/發行數量的百分比

### 3. **篩選功能**
- **狀態篩選**: 
  - 全部狀態
  - 已發行 (issued)
  - 已驗證 (verified)
  
- **災害類型篩選**:
  - 全部災害類型
  - 水災
  - 颱風
  - 地震
  - 火災

### 4. **歷史記錄表格**
顯示欄位：
- 案件編號
- 申請人姓名
- 災害類型
- 受災地址
- 核准金額
- 狀態 (已發行/已驗證)
- 發行/驗證機構
- 操作時間

### 5. **機構統計**
- **發行機構統計**: 各機構發行的憑證數量
- **驗證機構統計**: 各機構驗證的憑證次數

## 📊 資料來源

目前歷史紀錄從以下來源整合：

1. **已核准的申請案件** (`status = 'approved'`)
   - 狀態顯示: **已發行**
   - 發行機構: 台南市政府災害救助中心
   - 時間: approved_at

2. **已發放的申請案件** (`status = 'disbursed'`)
   - 狀態顯示: **已驗證**
   - 驗證機構: 7-11 便利商店
   - 時間: disbursed_at

## 🔄 未來整合 credential_history Table

當 `credential_history` table 正式啟用後，可以修改 `loadHistory()` 函數：

```javascript
// 將來可以直接從 credential_history 讀取
const historyResponse = await fetch(`${API_BASE}/complete-flow/credential-history-stats`, {
  headers: { 
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json'
  }
});
```

## 🎨 UI 設計

- 使用現有的 admin.css 樣式系統
- 統計卡片使用不同顏色區分
- 表格使用 data-table 樣式
- 響應式設計，適配各種螢幕大小

## 🚀 使用方式

1. 登入管理員後台
2. 點擊左側「📜 歷史紀錄」選項
3. 使用篩選器查看特定類型的記錄
4. 點擊「🔄 重新整理」更新資料

## 📝 注意事項

- 需要管理員權限才能查看
- 資料會自動從申請記錄中提取
- 支援即時篩選和排序
- 金額以千分位格式顯示

## 🔧 技術細節

### API 端點
- `GET /api/v1/complete-flow/credential-history-stats` - 獲取統計數據
- `GET /api/v1/applications/list` - 獲取申請記錄（用於生成歷史）

### 資料轉換
```javascript
// 申請記錄 → 歷史記錄格式
{
  application_id: app.id,
  applicant_name: app.applicant_name,
  disaster_type: app.disaster_type,
  status: app.status === 'disbursed' ? 'verified' : 'issued',
  action_time: app.status === 'disbursed' ? app.disbursed_at : app.approved_at,
  // ...
}
```

## ✅ 已完成

- ✅ 側邊欄新增「歷史紀錄」選項
- ✅ 統計卡片顯示
- ✅ 篩選功能 (狀態、災害類型)
- ✅ 歷史記錄表格
- ✅ 機構統計圖表
- ✅ 錯誤處理和載入狀態
- ✅ 重新整理功能

## 📸 預覽

```
┌─────────────────────────────────────────────────┐
│ 📜 憑證使用歷史紀錄                               │
├─────────────────────────────────────────────────┤
│ [全部狀態▼] [全部災害類型▼] [🔄 重新整理]        │
├─────────────────────────────────────────────────┤
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐           │
│ │總記錄 │ │已發行│ │已驗證│ │驗證率│           │
│ │  18  │ │  14  │ │  10  │ │ 71% │           │
│ └──────┘ └──────┘ └──────┘ └──────┘           │
├─────────────────────────────────────────────────┤
│ 案件編號 | 申請人 | 災害 | 地址 | 金額 | 狀態... │
│ CASE-001 | 王小明 | 水災 | ... | 10000 | ✓已發行│
│ CASE-002 | 李大華 | 颱風 | ... | 15000 | ✓已驗證│
└─────────────────────────────────────────────────┘
```
