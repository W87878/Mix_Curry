# 憑證記錄頁面改進

## 📋 修改內容

### 1. 表格欄位調整

**修改前**：
```
| 補助類型 | 姓名 | 受災地區 | 驗證目的 | 驗證機構 | 驗證結果 | 驗證時間 |
```

**修改後**：
```
| 補助類型 | 姓名 | 受災地區 | 驗證目的 | 發行機構 | 驗證機構 | 驗證結果 | 驗證時間 |
```

### 2. 空值處理

**所有欄位空值統一顯示為 "N/A"**

| 欄位 | 空值處理 |
|------|----------|
| 補助類型 | `N/A` |
| 姓名 | `N/A` |
| 受災地區 | `N/A` |
| 發行機構 | `N/A` |
| 驗證機構 | `N/A` |
| 驗證時間 | `N/A` |

**修改的函數**：
- `extractRegion()` - 空值返回 `N/A`
- `formatDateTime()` - 空值返回 `N/A`
- 表格渲染 - 所有欄位使用 `|| 'N/A'`

### 3. 受災地區顯示優化

**目標**：只顯示到區/鄉鎮層級，不顯示村里和路名

#### 範例

| 完整地址 | 顯示結果 |
|----------|----------|
| 花蓮縣光復鄉大安村中正路123號 | **花蓮縣光復鄉** |
| 台南市中西區民族路二段100號 | **台南市中西區** |
| 新北市板橋區文化路一段188號 | **新北市板橋區** |
| 高雄市三民區建國三路123巷45號 | **高雄市三民區** |
| null / undefined / 空值 | **N/A** |

#### 實作邏輯

```javascript
function extractRegion(fullAddress) {
  // 1. 檢查空值
  if (!fullAddress || fullAddress === 'null' || fullAddress === 'undefined') {
    return 'N/A';
  }
  
  // 2. 提取到區/鄉鎮層級（使用正則表達式）
  // 格式：{2-3個字}[市縣] + {2-3個字}[區鄉鎮市]
  const match = fullAddress.match(/^(.{2,3}[市縣])(.{2,3}[區鄉鎮市])/);
  if (match) {
    return match[1] + match[2]; // 例如：花蓮縣 + 光復鄉
  }
  
  // 3. 如果只有縣市
  const cityMatch = fullAddress.match(/^(.{2,3}[市縣])/);
  if (cityMatch) {
    return cityMatch[1];
  }
  
  // 4. 無法匹配返回 N/A
  return 'N/A';
}
```

### 4. 驗證結果顯示優化

**修改前**：
- 已發行和已驗證都顯示「✓ 成功」

**修改後**：
- **已發行**：顯示黃色 badge「已發行」
- **已驗證**：顯示綠色 badge「✓ 已驗證」

```javascript
${record.result === 'issued' ? 
  '<span class="badge badge-warning">已發行</span>' : 
  '<span class="badge badge-success">✓ 已驗證</span>'}
```

## 🎨 表格顯示範例

### 範例 1：已發行的憑證

| 補助類型 | 姓名 | 受災地區 | 驗證目的 | 發行機構 | 驗證機構 | 驗證結果 | 驗證時間 |
|---------|------|---------|---------|---------|---------|---------|---------|
| 水災補助 | 王小明 | 花蓮縣光復鄉 | 補助領取 | 台南市政府災害救助中心 | N/A | 🟡 已發行 | 2025/01/15 10:30 |

### 範例 2：已驗證的憑證

| 補助類型 | 姓名 | 受災地區 | 驗證目的 | 發行機構 | 驗證機構 | 驗證結果 | 驗證時間 |
|---------|------|---------|---------|---------|---------|---------|---------|
| 颱風補助 | 李小華 | 台南市中西區 | 補助領取 | 台南市政府災害救助中心 | 7-11 中正門市 | ✅ 已驗證 | 2025/01/16 14:20 |

### 範例 3：資料不完整

| 補助類型 | 姓名 | 受災地區 | 驗證目的 | 發行機構 | 驗證機構 | 驗證結果 | 驗證時間 |
|---------|------|---------|---------|---------|---------|---------|---------|
| N/A | 張大明 | N/A | 補助領取 | N/A | N/A | 🟡 已發行 | N/A |

## 🔧 修改的檔案

### static/admin.html

#### 1. `extractRegion()` 函數

**位置**：約 line 1657

**變更**：
- 加強空值檢查（null, undefined, 空字串）
- 優化正則表達式匹配
- 只提取到區/鄉鎮層級
- 統一空值返回 `N/A`

#### 2. `formatDateTime()` 函數

**位置**：約 line 1680

**變更**：
- 加強空值檢查
- 加入日期有效性驗證
- 統一空值返回 `N/A`

#### 3. 表格 HTML 結構

**位置**：約 line 1585-1640

**變更**：
- 新增「發行機構」欄位
- 調整 colspan 從 7 改為 8
- 所有欄位使用 `|| 'N/A'` 處理空值
- 驗證結果使用不同 badge 樣式

## ✅ 修改完成檢查清單

- [x] 表格新增「發行機構」欄位
- [x] 表格顯示「驗證機構」欄位
- [x] 所有空值統一顯示 "N/A"
- [x] 受災地區只顯示到區/鄉鎮
- [x] `extractRegion()` 函數優化
- [x] `formatDateTime()` 函數優化
- [x] 驗證結果使用不同樣式（已發行/已驗證）
- [x] colspan 調整為 8
- [x] 檔案無語法錯誤

## 🧪 測試步驟

### 1. 刷新頁面

```bash
# 強制刷新（清除快取）
Cmd + Shift + R (macOS)
Ctrl + Shift + R (Windows/Linux)
```

### 2. 檢查表格欄位

應該看到 8 個欄位：
1. 補助類型
2. 姓名
3. 受災地區（只到區/鄉鎮）
4. 驗證目的
5. **發行機構**（新增）
6. **驗證機構**
7. 驗證結果
8. 驗證時間

### 3. 測試空值顯示

確認所有空值欄位都顯示 "N/A"

### 4. 測試受災地區

檢查受災地區是否正確截斷：
- ✅ 花蓮縣光復鄉大安村中正路123號 → **花蓮縣光復鄉**
- ✅ 台南市中西區民族路二段100號 → **台南市中西區**

### 5. 測試驗證結果樣式

- **已發行**：黃色 badge「已發行」
- **已驗證**：綠色 badge「✓ 已驗證」

## 📊 資料流程

```
credential_history table
  ↓
GET /complete-flow/credential-history-list
  ↓
前端 loadHistory()
  ↓
資料轉換：
  - subsidy_type: getDisasterTypeText(disaster_type) + '補助'
  - disaster_region: extractRegion(disaster_address) ← 只到區/鄉鎮
  - issuer_organization: record.issuer_organization || 'N/A'
  - verifier_organization: record.verifier_organization || 'N/A'
  - verification_time: formatDateTime(action_time) || 'N/A'
  ↓
渲染表格（8 個欄位）
```

## 🎯 預期結果

修改後的憑證記錄頁面應該：

1. ✅ 同時顯示「發行機構」和「驗證機構」兩個欄位
2. ✅ 所有空值統一顯示 "N/A"
3. ✅ 受災地區只顯示到區/鄉鎮（如：花蓮縣光復鄉）
4. ✅ 驗證結果有不同的視覺樣式
5. ✅ 資料更清晰易讀
6. ✅ 符合隱私保護要求

## 💡 注意事項

### 資料來源

- **發行機構**：從 `credential_history.issuer_organization` 讀取
- **驗證機構**：從 `credential_history.verifier_organization` 讀取

### 資料何時填入

- **發行時**（補助核准後）：
  - `issuer_organization` ✅ 填入（如：台南市政府災害救助中心）
  - `verifier_organization` ❌ 空值（顯示 N/A）

- **驗證時**（便利商店領取）：
  - `issuer_organization` ✅ 保留原值
  - `verifier_organization` ✅ 填入（如：7-11 中正門市）

這樣可以完整追蹤憑證的發行和驗證流程！
